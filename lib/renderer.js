"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const highlight = require("atom-highlight");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const imageWatcher = require("./image-watch-helper");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(text, filePath, grammar, renderLaTeX, mode, savePath) {
    text = text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, filePath, renderLaTeX);
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (mode === 'normal') {
        await resolveImagePaths(doc, filePath, {
            version: true,
            relativize: false,
        });
    }
    else {
        let behaviour;
        switch (mode) {
            case 'save':
                behaviour = util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour;
                break;
            case 'copy':
                behaviour = util_1.atomConfig().saveConfig.mediaOnCopyAsHTMLBehaviour;
                break;
            default:
                throw invalidMode(mode);
        }
        await handleImages({ doc, filePath, savePath, behaviour });
    }
    let defaultCodeLanguage = 'text';
    if ((grammar && grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        highlightCodeBlocks(doc, defaultCodeLanguage, mode !== 'normal');
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function invalidMode(mode) {
    return new Error(`Invalid render mode ${mode}`);
}
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
async function handleImages(opts) {
    const relativize = opts.behaviour === 'relativized';
    switch (opts.behaviour) {
        case 'relativized':
        case 'absolutized':
            await resolveImagePaths(opts.doc, opts.filePath, {
                version: false,
                relativize,
            }, opts.savePath);
            break;
        case 'untouched':
    }
}
async function resolveImagePaths(doc, filePath, options, savePath) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    await Promise.all(Array.from(media).map(async function (img) {
        let src = img.getAttribute('src');
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (options.relativize &&
                (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (options.version) {
                const v = await imageWatcher.getVersion(src, filePath);
                if (v) {
                    src = `${src}?v=${v}`;
                }
            }
            img.src = src;
        }
        return;
    }));
}
function highlightCodeBlocks(domFragment, defaultLanguage, copyHTML) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const addClass = copyHTML ? 'editor-colors ' : '';
        preElement.outerHTML = highlight({
            fileContents: codeBlock.textContent.replace(/\n$/, ''),
            scopeName: extension_helper_1.scopeForFenceName(fenceName),
            nbsp: false,
            lineDivs: copyHTML ? false : true,
            editorDiv: true,
            editorDivTag: copyHTML ? 'pre' : 'atom-text-editor',
            editorDivClass: fenceName ? `${addClass}lang-${fenceName}` : addClass,
        });
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsNENBQTRDO0FBQzVDLGdEQUFnRDtBQUNoRCxtREFBbUQ7QUFDbkQseURBQXNEO0FBQ3RELHFEQUFxRDtBQUVyRCxpQ0FBK0M7QUFDL0MsK0NBQXdDO0FBRXhDLE1BQU0sRUFBRSxZQUFZLEVBQUUsR0FBRyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUE7QUFDL0MsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQTtBQUlwQyxLQUFLLGlCQUNWLElBQVksRUFDWixRQUE0QixFQUM1QixPQUE0QixFQUM1QixXQUFvQixFQUNwQixJQUFnQixFQUNoQixRQUFpQjtJQUlqQixJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyw0QkFBNEIsRUFBRSxFQUFFLENBQUMsQ0FBQTtJQUVyRCxJQUFJLElBQUksQ0FBQTtJQUNSLElBQUksS0FBSyxDQUFBO0lBQ1QsSUFBSSxpQkFBVSxFQUFFLENBQUMsUUFBUSxLQUFLLFFBQVEsRUFBRTtRQUN0QyxJQUFJO1lBQ0YsSUFBSSxHQUFHLE1BQU0sWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLFdBQVcsQ0FBQyxDQUFBO1NBQ3BFO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLENBQUMsR0FBRyxHQUFnQyxDQUFBO1lBQzFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTO2dCQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBaUIsQ0FBQTtZQUMzQixJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQWMsQ0FBQTtTQUN4QjtLQUNGO1NBQU07UUFDTCxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENB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QztZQUM3QyxDQUFDLENBQUMsZUFBZSxDQUFBO1FBRW5CLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtRQUNqRCxVQUFVLENBQUMsU0FBUyxHQUFHLFNBQVMsQ0FBQztZQUMvQixZQUFZLEVBQUUsU0FBUyxDQUFDLFdBQVksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQztZQUN2RCxTQUFTLEVBQUUsb0NBQWlCLENBQUMsU0FBUyxDQUFDO1lBQ3ZDLElBQUksRUFBRSxLQUFLO1lBQ1gsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJO1lBQ2pDLFNBQVMsRUFBRSxJQUFJO1lBQ2YsWUFBWSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxrQkFBa0I7WUFFbkQsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxRQUFRLFFBQVEsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVE7U0FDdEUsQ0FBQyxDQUFBO0tBQ0g7SUFFRCxPQUFPLFdBQVcsQ0FBQTtBQUNwQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcclxuaW1wb3J0IGhpZ2hsaWdodCA9IHJlcXVpcmUoJ2F0b20taGlnaGxpZ2h0JylcclxuaW1wb3J0IHBhbmRvY0hlbHBlciA9IHJlcXVpcmUoJy4vcGFuZG9jLWhlbHBlcicpXHJcbmltcG9ydCBtYXJrZG93bkl0ID0gcmVxdWlyZSgnLi9tYXJrZG93bi1pdC1oZWxwZXInKSAvLyBEZWZlciB1bnRpbCB1c2VkXHJcbmltcG9ydCB7IHNjb3BlRm9yRmVuY2VOYW1lIH0gZnJvbSAnLi9leHRlbnNpb24taGVscGVyJ1xyXG5pbXBvcnQgaW1hZ2VXYXRjaGVyID0gcmVxdWlyZSgnLi9pbWFnZS13YXRjaC1oZWxwZXInKVxyXG5pbXBvcnQgeyBHcmFtbWFyLCBDb25maWdWYWx1ZXMgfSBmcm9tICdhdG9tJ1xyXG5pbXBvcnQgeyBpc0ZpbGVTeW5jLCBhdG9tQ29uZmlnIH0gZnJvbSAnLi91dGlsJ1xyXG5pbXBvcnQgeyBnZXRNZWRpYSB9IGZyb20gJy4vdXRpbC1jb21tb24nXHJcblxyXG5jb25zdCB7IHJlc291cmNlUGF0aCB9ID0gYXRvbS5nZXRMb2FkU2V0dGluZ3MoKVxyXG5jb25zdCBwYWNrYWdlUGF0aCA9IHBhdGguZGlybmFtZShfX2Rpcm5hbWUpXHJcblxyXG5leHBvcnQgdHlwZSBSZW5kZXJNb2RlID0gJ25vcm1hbCcgfCAnY29weScgfCAnc2F2ZSdcclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXIoXHJcbiAgdGV4dDogc3RyaW5nLFxyXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXHJcbiAgZ3JhbW1hcjogR3JhbW1hciB8IHVuZGVmaW5lZCxcclxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcclxuICBtb2RlOiBSZW5kZXJNb2RlLFxyXG4gIHNhdmVQYXRoPzogc3RyaW5nLFxyXG4pOiBQcm9taXNlPEhUTUxEb2N1bWVudD4ge1xyXG4gIC8vIFJlbW92ZSB0aGUgPCFkb2N0eXBlPiBzaW5jZSBvdGhlcndpc2UgbWFya2VkIHdpbGwgZXNjYXBlIGl0XHJcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2NoamovbWFya2VkL2lzc3Vlcy8zNTRcclxuICB0ZXh0ID0gdGV4dC5yZXBsYWNlKC9eXFxzKjwhZG9jdHlwZShcXHMrLiopPz5cXHMqL2ksICcnKVxyXG5cclxuICBsZXQgaHRtbFxyXG4gIGxldCBlcnJvclxyXG4gIGlmIChhdG9tQ29uZmlnKCkucmVuZGVyZXIgPT09ICdwYW5kb2MnKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBodG1sID0gYXdhaXQgcGFuZG9jSGVscGVyLnJlbmRlclBhbmRvYyh0ZXh0LCBmaWxlUGF0aCwgcmVuZGVyTGFUZVgpXHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgY29uc3QgZSA9IGVyciBhcyBFcnJvciAmIHsgaHRtbD86IHN0cmluZyB9XHJcbiAgICAgIGlmIChlLmh0bWwgPT09IHVuZGVmaW5lZCkgdGhyb3cgZVxyXG4gICAgICBlcnJvciA9IGUubWVzc2FnZSBhcyBzdHJpbmdcclxuICAgICAgaHRtbCA9IGUuaHRtbCBhcyBzdHJpbmdcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgaHRtbCA9IG1hcmtkb3duSXQucmVuZGVyKHRleHQsIHJlbmRlckxhVGVYKVxyXG4gIH1cclxuICBjb25zdCBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKClcclxuICBjb25zdCBkb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGh0bWwsICd0ZXh0L2h0bWwnKVxyXG4gIHNhbml0aXplKGRvYylcclxuICBpZiAobW9kZSA9PT0gJ25vcm1hbCcpIHtcclxuICAgIGF3YWl0IHJlc29sdmVJbWFnZVBhdGhzKGRvYywgZmlsZVBhdGgsIHtcclxuICAgICAgdmVyc2lvbjogdHJ1ZSxcclxuICAgICAgcmVsYXRpdml6ZTogZmFsc2UsXHJcbiAgICB9KVxyXG4gIH0gZWxzZSB7XHJcbiAgICBsZXQgYmVoYXZpb3VyOiBDb25maWdWYWx1ZXNbJ21hcmtkb3duLXByZXZpZXctcGx1cy5zYXZlQ29uZmlnLm1lZGlhT25TYXZlQXNIVE1MQmVoYXZpb3VyJ11cclxuICAgIHN3aXRjaCAobW9kZSkge1xyXG4gICAgICBjYXNlICdzYXZlJzpcclxuICAgICAgICBiZWhhdmlvdXIgPSBhdG9tQ29uZmlnKCkuc2F2ZUNvbmZpZy5tZWRpYU9uU2F2ZUFzSFRNTEJlaGF2aW91clxyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGNhc2UgJ2NvcHknOlxyXG4gICAgICAgIGJlaGF2aW91ciA9IGF0b21Db25maWcoKS5zYXZlQ29uZmlnLm1lZGlhT25Db3B5QXNIVE1MQmVoYXZpb3VyXHJcbiAgICAgICAgYnJlYWtcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICB0aHJvdyBpbnZhbGlkTW9kZShtb2RlKVxyXG4gICAgfVxyXG4gICAgYXdhaXQgaGFuZGxlSW1hZ2VzKHsgZG9jLCBmaWxlUGF0aCwgc2F2ZVBhdGgsIGJlaGF2aW91ciB9KVxyXG4gIH1cclxuICBsZXQgZGVmYXVsdENvZGVMYW5ndWFnZTogc3RyaW5nID0gJ3RleHQnXHJcbiAgLy8gRGVmYXVsdCBjb2RlIGJsb2NrcyB0byBiZSBjb2ZmZWUgaW4gTGl0ZXJhdGUgQ29mZmVlU2NyaXB0IGZpbGVzXHJcbiAgaWYgKChncmFtbWFyICYmIGdyYW1tYXIuc2NvcGVOYW1lKSA9PT0gJ3NvdXJjZS5saXRjb2ZmZWUnKSB7XHJcbiAgICBkZWZhdWx0Q29kZUxhbmd1YWdlID0gJ2NvZmZlZSdcclxuICB9XHJcbiAgaWYgKFxyXG4gICAgIShcclxuICAgICAgYXRvbUNvbmZpZygpLnJlbmRlcmVyID09PSAncGFuZG9jJyAmJlxyXG4gICAgICBhdG9tQ29uZmlnKCkucGFuZG9jQ29uZmlnLnVzZU5hdGl2ZVBhbmRvY0NvZGVTdHlsZXNcclxuICAgIClcclxuICApIHtcclxuICAgIGhpZ2hsaWdodENvZGVCbG9ja3MoZG9jLCBkZWZhdWx0Q29kZUxhbmd1YWdlLCBtb2RlICE9PSAnbm9ybWFsJylcclxuICB9XHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICBjb25zdCBlcnJkID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2RpdicpXHJcbiAgICBjb25zdCBtc2dlbCA9IGRvYy5jcmVhdGVFbGVtZW50KCdjb2RlJylcclxuICAgIG1zZ2VsLmlubmVyVGV4dCA9IGVycm9yXHJcbiAgICBlcnJkLmlubmVySFRNTCA9IGA8aDE+UGFuZG9jIEVycm9yOjwvaDE+JHttc2dlbC5vdXRlckhUTUx9PGhyPmBcclxuICAgIGRvYy5ib2R5Lmluc2VydEJlZm9yZShlcnJkLCBkb2MuYm9keS5maXJzdEVsZW1lbnRDaGlsZClcclxuICB9XHJcbiAgcmV0dXJuIGRvY1xyXG59XHJcblxyXG5mdW5jdGlvbiBpbnZhbGlkTW9kZShtb2RlOiBuZXZlcikge1xyXG4gIHJldHVybiBuZXcgRXJyb3IoYEludmFsaWQgcmVuZGVyIG1vZGUgJHttb2RlfWApXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNhbml0aXplKGRvYzogSFRNTERvY3VtZW50KSB7XHJcbiAgLy8gRG8gbm90IHJlbW92ZSBNYXRoSmF4IHNjcmlwdCBkZWxpbWl0ZWQgYmxvY2tzXHJcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoXCJzY3JpcHQ6bm90KFt0eXBlXj0nbWF0aC90ZXgnXSlcIikuZm9yRWFjaCgoZWxlbSkgPT4ge1xyXG4gICAgZWxlbS5yZW1vdmUoKVxyXG4gIH0pXHJcbiAgY29uc3QgYXR0cmlidXRlc1RvUmVtb3ZlID0gW1xyXG4gICAgJ29uYWJvcnQnLFxyXG4gICAgJ29uYmx1cicsXHJcbiAgICAnb25jaGFuZ2UnLFxyXG4gICAgJ29uY2xpY2snLFxyXG4gICAgJ29uZGJjbGljaycsXHJcbiAgICAnb25lcnJvcicsXHJcbiAgICAnb25mb2N1cycsXHJcbiAgICAnb25rZXlkb3duJyxcclxuICAgICdvbmtleXByZXNzJyxcclxuICAgICdvbmtleXVwJyxcclxuICAgICdvbmxvYWQnLFxyXG4gICAgJ29ubW91c2Vkb3duJyxcclxuICAgICdvbm1vdXNlbW92ZScsXHJcbiAgICAnb25tb3VzZW92ZXInLFxyXG4gICAgJ29ubW91c2VvdXQnLFxyXG4gICAgJ29ubW91c2V1cCcsXHJcbiAgICAnb25yZXNldCcsXHJcbiAgICAnb25yZXNpemUnLFxyXG4gICAgJ29uc2Nyb2xsJyxcclxuICAgICdvbnNlbGVjdCcsXHJcbiAgICAnb25zdWJtaXQnLFxyXG4gICAgJ29udW5sb2FkJyxcclxuICBdXHJcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJyonKS5mb3JFYWNoKChlbGVtKSA9PlxyXG4gICAgYXR0cmlidXRlc1RvUmVtb3ZlLm1hcCgoYXR0cmlidXRlKSA9PiB7XHJcbiAgICAgIGVsZW0ucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZSlcclxuICAgIH0pLFxyXG4gIClcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gaGFuZGxlSW1hZ2VzKG9wdHM6IHtcclxuICBiZWhhdmlvdXI6ICdyZWxhdGl2aXplZCcgfCAnYWJzb2x1dGl6ZWQnIHwgJ3VudG91Y2hlZCdcclxuICBkb2M6IEhUTUxEb2N1bWVudFxyXG4gIGZpbGVQYXRoPzogc3RyaW5nXHJcbiAgc2F2ZVBhdGg/OiBzdHJpbmdcclxufSkge1xyXG4gIGNvbnN0IHJlbGF0aXZpemUgPSBvcHRzLmJlaGF2aW91ciA9PT0gJ3JlbGF0aXZpemVkJ1xyXG4gIHN3aXRjaCAob3B0cy5iZWhhdmlvdXIpIHtcclxuICAgIGNhc2UgJ3JlbGF0aXZpemVkJzpcclxuICAgIGNhc2UgJ2Fic29sdXRpemVkJzpcclxuICAgICAgYXdhaXQgcmVzb2x2ZUltYWdlUGF0aHMoXHJcbiAgICAgICAgb3B0cy5kb2MsXHJcbiAgICAgICAgb3B0cy5maWxlUGF0aCxcclxuICAgICAgICB7XHJcbiAgICAgICAgICB2ZXJzaW9uOiBmYWxzZSxcclxuICAgICAgICAgIHJlbGF0aXZpemUsXHJcbiAgICAgICAgfSxcclxuICAgICAgICBvcHRzLnNhdmVQYXRoLFxyXG4gICAgICApXHJcbiAgICAgIGJyZWFrXHJcbiAgICBjYXNlICd1bnRvdWNoZWQnOlxyXG4gICAgLyogbm9vcCAqL1xyXG4gIH1cclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZUltYWdlUGF0aHMoXHJcbiAgZG9jOiBIVE1MRG9jdW1lbnQsXHJcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcclxuICBvcHRpb25zOiBSZWNvcmQ8J3ZlcnNpb24nIHwgJ3JlbGF0aXZpemUnLCBib29sZWFuPixcclxuICBzYXZlUGF0aD86IHN0cmluZyxcclxuKSB7XHJcbiAgY29uc3QgW3Jvb3REaXJlY3RvcnldID0gYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKGZpbGVQYXRoIHx8ICcnKVxyXG4gIGNvbnN0IG1lZGlhID0gZ2V0TWVkaWEoZG9jKVxyXG4gIGF3YWl0IFByb21pc2UuYWxsKFxyXG4gICAgQXJyYXkuZnJvbShtZWRpYSkubWFwKGFzeW5jIGZ1bmN0aW9uKGltZykge1xyXG4gICAgICBsZXQgc3JjID0gaW1nLmdldEF0dHJpYnV0ZSgnc3JjJylcclxuICAgICAgaWYgKHNyYykge1xyXG4gICAgICAgIGlmIChhdG9tQ29uZmlnKCkucmVuZGVyZXIgIT09ICdwYW5kb2MnKSB7XHJcbiAgICAgICAgICBzcmMgPSBkZWNvZGVVUkkoc3JjKVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHNyYy5tYXRjaCgvXihodHRwcz98YXRvbXxkYXRhKTovKSkge1xyXG4gICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChwcm9jZXNzLnJlc291cmNlc1BhdGggJiYgc3JjLnN0YXJ0c1dpdGgocHJvY2Vzcy5yZXNvdXJjZXNQYXRoKSkge1xyXG4gICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChyZXNvdXJjZVBhdGgpKSB7XHJcbiAgICAgICAgICByZXR1cm5cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHNyYy5zdGFydHNXaXRoKHBhY2thZ2VQYXRoKSkge1xyXG4gICAgICAgICAgcmV0dXJuXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc3JjWzBdID09PSAnLycpIHtcclxuICAgICAgICAgIGlmICghaXNGaWxlU3luYyhzcmMpKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgaWYgKHJvb3REaXJlY3RvcnkgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgIHNyYyA9IHBhdGguam9pbihyb290RGlyZWN0b3J5LCBzcmMuc3Vic3RyaW5nKDEpKVxyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICAgIC8vIG5vb3BcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoZmlsZVBhdGgpIHtcclxuICAgICAgICAgIHNyYyA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVBhdGgpLCBzcmMpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoXHJcbiAgICAgICAgICBvcHRpb25zLnJlbGF0aXZpemUgJiZcclxuICAgICAgICAgIChmaWxlUGF0aCAhPT0gdW5kZWZpbmVkIHx8IHNhdmVQYXRoICE9PSB1bmRlZmluZWQpXHJcbiAgICAgICAgKSB7XHJcbiAgICAgICAgICBjb25zdCBmcCA9IHNhdmVQYXRoICE9PSB1bmRlZmluZWQgPyBzYXZlUGF0aCA6IGZpbGVQYXRoIVxyXG4gICAgICAgICAgc3JjID0gcGF0aC5yZWxhdGl2ZShwYXRoLmRpcm5hbWUoZnApLCBzcmMpXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBVc2UgbW9zdCByZWNlbnQgdmVyc2lvbiBvZiBpbWFnZVxyXG4gICAgICAgIGlmIChvcHRpb25zLnZlcnNpb24pIHtcclxuICAgICAgICAgIGNvbnN0IHYgPSBhd2FpdCBpbWFnZVdhdGNoZXIuZ2V0VmVyc2lvbihzcmMsIGZpbGVQYXRoKVxyXG4gICAgICAgICAgaWYgKHYpIHtcclxuICAgICAgICAgICAgc3JjID0gYCR7c3JjfT92PSR7dn1gXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpbWcuc3JjID0gc3JjXHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuXHJcbiAgICB9KSxcclxuICApXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhpZ2hsaWdodENvZGVCbG9ja3MoXHJcbiAgZG9tRnJhZ21lbnQ6IERvY3VtZW50LFxyXG4gIGRlZmF1bHRMYW5ndWFnZTogc3RyaW5nLFxyXG4gIGNvcHlIVE1MOiBib29sZWFuLFxyXG4pIHtcclxuICBjb25zdCBmb250RmFtaWx5ID0gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IuZm9udEZhbWlseScpXHJcbiAgaWYgKGZvbnRGYW1pbHkpIHtcclxuICAgIGZvciAoY29uc3QgY29kZUVsZW1lbnQgb2YgQXJyYXkuZnJvbShcclxuICAgICAgZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgnY29kZScpLFxyXG4gICAgKSkge1xyXG4gICAgICBjb2RlRWxlbWVudC5zdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZm9yIChjb25zdCBwcmVFbGVtZW50IG9mIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpKSB7XHJcbiAgICBjb25zdCBjb2RlQmxvY2sgPVxyXG4gICAgICBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkICE9PSBudWxsXHJcbiAgICAgICAgPyBwcmVFbGVtZW50LmZpcnN0RWxlbWVudENoaWxkXHJcbiAgICAgICAgOiBwcmVFbGVtZW50XHJcbiAgICBjb25zdCBjYkNsYXNzID0gY29kZUJsb2NrLmNsYXNzTmFtZVxyXG4gICAgY29uc3QgZmVuY2VOYW1lID0gY2JDbGFzc1xyXG4gICAgICA/IGNiQ2xhc3MucmVwbGFjZSgvXihsYW5nLXxzb3VyY2VDb2RlICkvLCAnJylcclxuICAgICAgOiBkZWZhdWx0TGFuZ3VhZ2VcclxuXHJcbiAgICBjb25zdCBhZGRDbGFzcyA9IGNvcHlIVE1MID8gJ2VkaXRvci1jb2xvcnMgJyA6ICcnXHJcbiAgICBwcmVFbGVtZW50Lm91dGVySFRNTCA9IGhpZ2hsaWdodCh7XHJcbiAgICAgIGZpbGVDb250ZW50czogY29kZUJsb2NrLnRleHRDb250ZW50IS5yZXBsYWNlKC9cXG4kLywgJycpLFxyXG4gICAgICBzY29wZU5hbWU6IHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXHJcbiAgICAgIG5ic3A6IGZhbHNlLFxyXG4gICAgICBsaW5lRGl2czogY29weUhUTUwgPyBmYWxzZSA6IHRydWUsXHJcbiAgICAgIGVkaXRvckRpdjogdHJ1ZSxcclxuICAgICAgZWRpdG9yRGl2VGFnOiBjb3B5SFRNTCA/ICdwcmUnIDogJ2F0b20tdGV4dC1lZGl0b3InLFxyXG4gICAgICAvLyBUaGUgYGVkaXRvcmAgY2xhc3MgbWVzc2VzIHRoaW5ncyB1cCBhcyBgLmVkaXRvcmAgaGFzIGFic29sdXRlbHkgcG9zaXRpb25lZCBsaW5lc1xyXG4gICAgICBlZGl0b3JEaXZDbGFzczogZmVuY2VOYW1lID8gYCR7YWRkQ2xhc3N9bGFuZy0ke2ZlbmNlTmFtZX1gIDogYWRkQ2xhc3MsXHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGRvbUZyYWdtZW50XHJcbn1cclxuIl19