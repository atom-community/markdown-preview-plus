"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const pandocHelper = require("./pandoc-helper");
const markdownIt = require("./markdown-it-helper");
const extension_helper_1 = require("./extension-helper");
const atom_1 = require("atom");
const util_1 = require("./util");
const util_common_1 = require("./util-common");
const { resourcePath } = atom.getLoadSettings();
const packagePath = path.dirname(__dirname);
async function render(options) {
    const text = options.text.replace(/^\s*<!doctype(\s+.*)?>\s*/i, '');
    let html;
    let error;
    if (util_1.atomConfig().renderer === 'pandoc') {
        try {
            html = await pandocHelper.renderPandoc(text, options.filePath, options.renderLaTeX);
        }
        catch (err) {
            const e = err;
            if (e.html === undefined)
                throw e;
            error = e.message;
            html = e.html;
        }
    }
    else {
        html = markdownIt.render(text, options.renderLaTeX);
    }
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    sanitize(doc);
    if (options.mode === 'normal') {
        options.imageWatcher.clear();
        resolveImagePaths(doc, options.filePath, false, undefined, options.imageWatcher);
    }
    else {
        switch (options.mode) {
            case 'save':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    savePath: options.savePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnSaveAsHTMLBehaviour,
                });
                break;
            case 'copy':
                handleImages({
                    doc,
                    filePath: options.filePath,
                    behaviour: util_1.atomConfig().saveConfig.mediaOnCopyAsHTMLBehaviour,
                });
                break;
            default:
                throw invalidMode(options.mode);
        }
    }
    let defaultCodeLanguage = 'text';
    if ((options.grammar && options.grammar.scopeName) === 'source.litcoffee') {
        defaultCodeLanguage = 'coffee';
    }
    if (!(util_1.atomConfig().renderer === 'pandoc' &&
        util_1.atomConfig().pandocConfig.useNativePandocCodeStyles)) {
        await highlightCodeBlocks(doc, defaultCodeLanguage);
    }
    if (error) {
        const errd = doc.createElement('div');
        const msgel = doc.createElement('code');
        msgel.innerText = error;
        errd.innerHTML = `<h1>Pandoc Error:</h1>${msgel.outerHTML}<hr>`;
        doc.body.insertBefore(errd, doc.body.firstElementChild);
    }
    return doc;
}
exports.render = render;
function invalidMode(mode) {
    return new Error(`Invalid render mode ${JSON.stringify(mode)}`);
}
function sanitize(doc) {
    doc.querySelectorAll("script:not([type^='math/tex'])").forEach((elem) => {
        elem.remove();
    });
    const attributesToRemove = [
        'onabort',
        'onblur',
        'onchange',
        'onclick',
        'ondbclick',
        'onerror',
        'onfocus',
        'onkeydown',
        'onkeypress',
        'onkeyup',
        'onload',
        'onmousedown',
        'onmousemove',
        'onmouseover',
        'onmouseout',
        'onmouseup',
        'onreset',
        'onresize',
        'onscroll',
        'onselect',
        'onsubmit',
        'onunload',
    ];
    doc.querySelectorAll('*').forEach((elem) => attributesToRemove.map((attribute) => {
        elem.removeAttribute(attribute);
    }));
}
function handleImages(opts) {
    const relativize = opts.behaviour === 'relativized';
    switch (opts.behaviour) {
        case 'relativized':
        case 'absolutized':
            resolveImagePaths(opts.doc, opts.filePath, relativize, opts.savePath);
            break;
        case 'untouched':
    }
}
function resolveImagePaths(doc, filePath, relativize, savePath, imageWatcher) {
    const [rootDirectory] = atom.project.relativizePath(filePath || '');
    const media = util_common_1.getMedia(doc);
    Array.from(media).map(function (img) {
        let attrName;
        if (img.tagName === 'LINK')
            attrName = 'href';
        else
            attrName = 'src';
        let src = img.getAttribute(attrName);
        if (src) {
            if (util_1.atomConfig().renderer !== 'pandoc') {
                src = decodeURI(src);
            }
            if (src.match(/^(https?|atom|data):/)) {
                return;
            }
            if (process.resourcesPath && src.startsWith(process.resourcesPath)) {
                return;
            }
            if (src.startsWith(resourcePath)) {
                return;
            }
            if (src.startsWith(packagePath)) {
                return;
            }
            if (src[0] === '/') {
                if (!util_1.isFileSync(src)) {
                    try {
                        if (rootDirectory !== null) {
                            src = path.join(rootDirectory, src.substring(1));
                        }
                    }
                    catch (e) {
                    }
                }
            }
            else if (filePath) {
                src = path.resolve(path.dirname(filePath), src);
            }
            if (relativize && (filePath !== undefined || savePath !== undefined)) {
                const fp = savePath !== undefined ? savePath : filePath;
                src = path.relative(path.dirname(fp), src);
            }
            if (imageWatcher) {
                const v = imageWatcher.watch(src);
                if (v !== undefined)
                    src = `${src}?v=${v}`;
            }
            img[attrName] = src;
        }
    });
}
async function highlightCodeBlocks(domFragment, defaultLanguage) {
    const fontFamily = atom.config.get('editor.fontFamily');
    if (fontFamily) {
        for (const codeElement of Array.from(domFragment.querySelectorAll('code'))) {
            codeElement.style.fontFamily = fontFamily;
        }
    }
    await Promise.all(Array.from(domFragment.querySelectorAll('pre')).map(async (preElement) => {
        const codeBlock = preElement.firstElementChild !== null
            ? preElement.firstElementChild
            : preElement;
        const cbClass = codeBlock.className || preElement.className;
        const fenceName = cbClass
            ? cbClass.replace(/^(lang-|sourceCode )/, '')
            : defaultLanguage;
        const ctw = util_1.atomConfig().codeTabWidth;
        const ed = new atom_1.TextEditor({
            readonly: true,
            keyboardInputEnabled: false,
            showInvisibles: false,
            tabLength: ctw === 0 ? atom.config.get('editor.tabLength') : ctw,
        });
        const el = atom.views.getView(ed);
        try {
            el.setUpdatedSynchronously(true);
            el.style.pointerEvents = 'none';
            el.style.position = 'absolute';
            el.style.width = '0px';
            el.style.height = '1px';
            atom.views.getView(atom.workspace).appendChild(el);
            atom.grammars.assignLanguageMode(ed.getBuffer(), extension_helper_1.scopeForFenceName(fenceName));
            ed.setText(codeBlock.textContent.replace(/\r?\n$/, ''));
            await editorTokenized(ed);
            const html = Array.from(el.querySelectorAll('.line:not(.dummy)'));
            preElement.classList.add('editor-colors');
            preElement.innerHTML = html.map((x) => x.innerHTML).join('\n');
            if (fenceName)
                preElement.classList.add(`lang-${fenceName}`);
        }
        finally {
            el.remove();
        }
    }));
    return domFragment;
}
async function editorTokenized(editor) {
    return new Promise((resolve) => {
        if (editor.getBuffer().getLanguageMode().fullyTokenized) {
            resolve();
        }
        else {
            const disp = editor.onDidTokenize(() => {
                disp.dispose();
                resolve();
            });
        }
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw2QkFBNkI7QUFDN0IsZ0RBQWdEO0FBQ2hELG1EQUFtRDtBQUNuRCx5REFBc0Q7QUFDdEQsK0JBQTBDO0FBQzFDLGlDQUErQztBQUMvQywrQ0FBd0M7QUFHeEMsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQTtBQUMvQyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFBO0FBaUJwQyxLQUFLLFVBQVUsTUFBTSxDQUFDLE9BQXNCO0lBR2pELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLDRCQUE0QixFQUFFLEVBQUUsQ0FBQyxDQUFBO0lBRW5FLElBQUksSUFBSSxDQUFBO0lBQ1IsSUFBSSxLQUFLLENBQUE7SUFDVCxJQUFJLGlCQUFVLEVBQUUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO1FBQ3RDLElBQUk7WUFDRixJQUFJLEdBQUcsTUFBTSxZQUFZLENBQUMsWUFBWSxDQUNwQyxJQUFJLEVBQ0osT0FBTyxDQUFDLFFBQVEsRUFDaEIsT0FBTyxDQUFDLFdBQVcsQ0FDcEIsQ0FBQTtTQUNGO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLENBQUMsR0FBRyxHQUFnQyxDQUFBO1lBQzFDLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTO2dCQUFFLE1BQU0sQ0FBQyxDQUFBO1lBQ2pDLEtBQUssR0FBRyxDQUFDLENBQUMsT0FBaUIsQ0FBQTtZQUMzQixJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQWMsQ0FBQTtTQUN4QjtLQUNGO1NBQU07UUFDTCxJQUFJLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFBO0tBQ3BEO0lBQ0Qs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QWEsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3JDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtnQkFDZCxPQUFPLEVBQUUsQ0FBQTtZQUNYLENBQUMsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxyXG5pbXBvcnQgcGFuZG9jSGVscGVyID0gcmVxdWlyZSgnLi9wYW5kb2MtaGVscGVyJylcclxuaW1wb3J0IG1hcmtkb3duSXQgPSByZXF1aXJlKCcuL21hcmtkb3duLWl0LWhlbHBlcicpIC8vIERlZmVyIHVudGlsIHVzZWRcclxuaW1wb3J0IHsgc2NvcGVGb3JGZW5jZU5hbWUgfSBmcm9tICcuL2V4dGVuc2lvbi1oZWxwZXInXHJcbmltcG9ydCB7IEdyYW1tYXIsIFRleHRFZGl0b3IgfSBmcm9tICdhdG9tJ1xyXG5pbXBvcnQgeyBpc0ZpbGVTeW5jLCBhdG9tQ29uZmlnIH0gZnJvbSAnLi91dGlsJ1xyXG5pbXBvcnQgeyBnZXRNZWRpYSB9IGZyb20gJy4vdXRpbC1jb21tb24nXHJcbmltcG9ydCB7IEltYWdlV2F0Y2hlciB9IGZyb20gJy4vaW1hZ2Utd2F0Y2gtaGVscGVyJ1xyXG5cclxuY29uc3QgeyByZXNvdXJjZVBhdGggfSA9IGF0b20uZ2V0TG9hZFNldHRpbmdzKClcclxuY29uc3QgcGFja2FnZVBhdGggPSBwYXRoLmRpcm5hbWUoX19kaXJuYW1lKVxyXG5cclxuZXhwb3J0IHR5cGUgUmVuZGVyTW9kZSA9ICdub3JtYWwnIHwgJ2NvcHknIHwgJ3NhdmUnXHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIENvbW1vblJlbmRlck9wdGlvbnM8VCBleHRlbmRzIFJlbmRlck1vZGU+IHtcclxuICB0ZXh0OiBzdHJpbmdcclxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkXHJcbiAgZ3JhbW1hcj86IEdyYW1tYXJcclxuICByZW5kZXJMYVRlWDogYm9vbGVhblxyXG4gIG1vZGU6IFRcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgUmVuZGVyT3B0aW9ucyA9XHJcbiAgfCAoQ29tbW9uUmVuZGVyT3B0aW9uczwnbm9ybWFsJyB8ICdjb3B5Jz4gJiB7IGltYWdlV2F0Y2hlcjogSW1hZ2VXYXRjaGVyIH0pXHJcbiAgfCAoQ29tbW9uUmVuZGVyT3B0aW9uczwnc2F2ZSc+ICYgeyBzYXZlUGF0aDogc3RyaW5nIH0pXHJcbiAgfCAoQ29tbW9uUmVuZGVyT3B0aW9uczwnY29weSc+KVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbmRlcihvcHRpb25zOiBSZW5kZXJPcHRpb25zKTogUHJvbWlzZTxIVE1MRG9jdW1lbnQ+IHtcclxuICAvLyBSZW1vdmUgdGhlIDwhZG9jdHlwZT4gc2luY2Ugb3RoZXJ3aXNlIG1hcmtlZCB3aWxsIGVzY2FwZSBpdFxyXG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGpqL21hcmtlZC9pc3N1ZXMvMzU0XHJcbiAgY29uc3QgdGV4dCA9IG9wdGlvbnMudGV4dC5yZXBsYWNlKC9eXFxzKjwhZG9jdHlwZShcXHMrLiopPz5cXHMqL2ksICcnKVxyXG5cclxuICBsZXQgaHRtbFxyXG4gIGxldCBlcnJvclxyXG4gIGlmIChhdG9tQ29uZmlnKCkucmVuZGVyZXIgPT09ICdwYW5kb2MnKSB7XHJcbiAgICB0cnkge1xyXG4gICAgICBodG1sID0gYXdhaXQgcGFuZG9jSGVscGVyLnJlbmRlclBhbmRvYyhcclxuICAgICAgICB0ZXh0LFxyXG4gICAgICAgIG9wdGlvbnMuZmlsZVBhdGgsXHJcbiAgICAgICAgb3B0aW9ucy5yZW5kZXJMYVRlWCxcclxuICAgICAgKVxyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIGNvbnN0IGUgPSBlcnIgYXMgRXJyb3IgJiB7IGh0bWw/OiBzdHJpbmcgfVxyXG4gICAgICBpZiAoZS5odG1sID09PSB1bmRlZmluZWQpIHRocm93IGVcclxuICAgICAgZXJyb3IgPSBlLm1lc3NhZ2UgYXMgc3RyaW5nXHJcbiAgICAgIGh0bWwgPSBlLmh0bWwgYXMgc3RyaW5nXHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIGh0bWwgPSBtYXJrZG93bkl0LnJlbmRlcih0ZXh0LCBvcHRpb25zLnJlbmRlckxhVGVYKVxyXG4gIH1cclxuICBjb25zdCBwYXJzZXIgPSBuZXcgRE9NUGFyc2VyKClcclxuICBjb25zdCBkb2MgPSBwYXJzZXIucGFyc2VGcm9tU3RyaW5nKGh0bWwsICd0ZXh0L2h0bWwnKVxyXG4gIHNhbml0aXplKGRvYylcclxuICBpZiAob3B0aW9ucy5tb2RlID09PSAnbm9ybWFsJykge1xyXG4gICAgb3B0aW9ucy5pbWFnZVdhdGNoZXIuY2xlYXIoKVxyXG4gICAgcmVzb2x2ZUltYWdlUGF0aHMoXHJcbiAgICAgIGRvYyxcclxuICAgICAgb3B0aW9ucy5maWxlUGF0aCxcclxuICAgICAgZmFsc2UsXHJcbiAgICAgIHVuZGVmaW5lZCxcclxuICAgICAgb3B0aW9ucy5pbWFnZVdhdGNoZXIsXHJcbiAgICApXHJcbiAgfSBlbHNlIHtcclxuICAgIHN3aXRjaCAob3B0aW9ucy5tb2RlKSB7XHJcbiAgICAgIGNhc2UgJ3NhdmUnOlxyXG4gICAgICAgIGhhbmRsZUltYWdlcyh7XHJcbiAgICAgICAgICBkb2MsXHJcbiAgICAgICAgICBmaWxlUGF0aDogb3B0aW9ucy5maWxlUGF0aCxcclxuICAgICAgICAgIHNhdmVQYXRoOiBvcHRpb25zLnNhdmVQYXRoLFxyXG4gICAgICAgICAgYmVoYXZpb3VyOiBhdG9tQ29uZmlnKCkuc2F2ZUNvbmZpZy5tZWRpYU9uU2F2ZUFzSFRNTEJlaGF2aW91cixcclxuICAgICAgICB9KVxyXG4gICAgICAgIGJyZWFrXHJcbiAgICAgIGNhc2UgJ2NvcHknOlxyXG4gICAgICAgIGhhbmRsZUltYWdlcyh7XHJcbiAgICAgICAgICBkb2MsXHJcbiAgICAgICAgICBmaWxlUGF0aDogb3B0aW9ucy5maWxlUGF0aCxcclxuICAgICAgICAgIGJlaGF2aW91cjogYXRvbUNvbmZpZygpLnNhdmVDb25maWcubWVkaWFPbkNvcHlBc0hUTUxCZWhhdmlvdXIsXHJcbiAgICAgICAgfSlcclxuICAgICAgICBicmVha1xyXG4gICAgICBkZWZhdWx0OlxyXG4gICAgICAgIHRocm93IGludmFsaWRNb2RlKG9wdGlvbnMubW9kZSlcclxuICAgIH1cclxuICB9XHJcbiAgbGV0IGRlZmF1bHRDb2RlTGFuZ3VhZ2U6IHN0cmluZyA9ICd0ZXh0J1xyXG4gIC8vIERlZmF1bHQgY29kZSBibG9ja3MgdG8gYmUgY29mZmVlIGluIExpdGVyYXRlIENvZmZlZVNjcmlwdCBmaWxlc1xyXG4gIGlmICgob3B0aW9ucy5ncmFtbWFyICYmIG9wdGlvbnMuZ3JhbW1hci5zY29wZU5hbWUpID09PSAnc291cmNlLmxpdGNvZmZlZScpIHtcclxuICAgIGRlZmF1bHRDb2RlTGFuZ3VhZ2UgPSAnY29mZmVlJ1xyXG4gIH1cclxuICBpZiAoXHJcbiAgICAhKFxyXG4gICAgICBhdG9tQ29uZmlnKCkucmVuZGVyZXIgPT09ICdwYW5kb2MnICYmXHJcbiAgICAgIGF0b21Db25maWcoKS5wYW5kb2NDb25maWcudXNlTmF0aXZlUGFuZG9jQ29kZVN0eWxlc1xyXG4gICAgKVxyXG4gICkge1xyXG4gICAgYXdhaXQgaGlnaGxpZ2h0Q29kZUJsb2Nrcyhkb2MsIGRlZmF1bHRDb2RlTGFuZ3VhZ2UpXHJcbiAgfVxyXG4gIGlmIChlcnJvcikge1xyXG4gICAgY29uc3QgZXJyZCA9IGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKVxyXG4gICAgY29uc3QgbXNnZWwgPSBkb2MuY3JlYXRlRWxlbWVudCgnY29kZScpXHJcbiAgICBtc2dlbC5pbm5lclRleHQgPSBlcnJvclxyXG4gICAgZXJyZC5pbm5lckhUTUwgPSBgPGgxPlBhbmRvYyBFcnJvcjo8L2gxPiR7bXNnZWwub3V0ZXJIVE1MfTxocj5gXHJcbiAgICBkb2MuYm9keS5pbnNlcnRCZWZvcmUoZXJyZCwgZG9jLmJvZHkuZmlyc3RFbGVtZW50Q2hpbGQpXHJcbiAgfVxyXG4gIHJldHVybiBkb2NcclxufVxyXG5cclxuZnVuY3Rpb24gaW52YWxpZE1vZGUobW9kZTogbmV2ZXIpIHtcclxuICByZXR1cm4gbmV3IEVycm9yKGBJbnZhbGlkIHJlbmRlciBtb2RlICR7SlNPTi5zdHJpbmdpZnkobW9kZSl9YClcclxufVxyXG5cclxuZnVuY3Rpb24gc2FuaXRpemUoZG9jOiBIVE1MRG9jdW1lbnQpIHtcclxuICAvLyBEbyBub3QgcmVtb3ZlIE1hdGhKYXggc2NyaXB0IGRlbGltaXRlZCBibG9ja3NcclxuICBkb2MucXVlcnlTZWxlY3RvckFsbChcInNjcmlwdDpub3QoW3R5cGVePSdtYXRoL3RleCddKVwiKS5mb3JFYWNoKChlbGVtKSA9PiB7XHJcbiAgICBlbGVtLnJlbW92ZSgpXHJcbiAgfSlcclxuICBjb25zdCBhdHRyaWJ1dGVzVG9SZW1vdmUgPSBbXHJcbiAgICAnb25hYm9ydCcsXHJcbiAgICAnb25ibHVyJyxcclxuICAgICdvbmNoYW5nZScsXHJcbiAgICAnb25jbGljaycsXHJcbiAgICAnb25kYmNsaWNrJyxcclxuICAgICdvbmVycm9yJyxcclxuICAgICdvbmZvY3VzJyxcclxuICAgICdvbmtleWRvd24nLFxyXG4gICAgJ29ua2V5cHJlc3MnLFxyXG4gICAgJ29ua2V5dXAnLFxyXG4gICAgJ29ubG9hZCcsXHJcbiAgICAnb25tb3VzZWRvd24nLFxyXG4gICAgJ29ubW91c2Vtb3ZlJyxcclxuICAgICdvbm1vdXNlb3ZlcicsXHJcbiAgICAnb25tb3VzZW91dCcsXHJcbiAgICAnb25tb3VzZXVwJyxcclxuICAgICdvbnJlc2V0JyxcclxuICAgICdvbnJlc2l6ZScsXHJcbiAgICAnb25zY3JvbGwnLFxyXG4gICAgJ29uc2VsZWN0JyxcclxuICAgICdvbnN1Ym1pdCcsXHJcbiAgICAnb251bmxvYWQnLFxyXG4gIF1cclxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnKicpLmZvckVhY2goKGVsZW0pID0+XHJcbiAgICBhdHRyaWJ1dGVzVG9SZW1vdmUubWFwKChhdHRyaWJ1dGUpID0+IHtcclxuICAgICAgZWxlbS5yZW1vdmVBdHRyaWJ1dGUoYXR0cmlidXRlKVxyXG4gICAgfSksXHJcbiAgKVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVJbWFnZXMob3B0czoge1xyXG4gIGJlaGF2aW91cjogJ3JlbGF0aXZpemVkJyB8ICdhYnNvbHV0aXplZCcgfCAndW50b3VjaGVkJ1xyXG4gIGRvYzogSFRNTERvY3VtZW50XHJcbiAgZmlsZVBhdGg/OiBzdHJpbmdcclxuICBzYXZlUGF0aD86IHN0cmluZ1xyXG59KSB7XHJcbiAgY29uc3QgcmVsYXRpdml6ZSA9IG9wdHMuYmVoYXZpb3VyID09PSAncmVsYXRpdml6ZWQnXHJcbiAgc3dpdGNoIChvcHRzLmJlaGF2aW91cikge1xyXG4gICAgY2FzZSAncmVsYXRpdml6ZWQnOlxyXG4gICAgY2FzZSAnYWJzb2x1dGl6ZWQnOlxyXG4gICAgICByZXNvbHZlSW1hZ2VQYXRocyhvcHRzLmRvYywgb3B0cy5maWxlUGF0aCwgcmVsYXRpdml6ZSwgb3B0cy5zYXZlUGF0aClcclxuICAgICAgYnJlYWtcclxuICAgIGNhc2UgJ3VudG91Y2hlZCc6XHJcbiAgICAvKiBub29wICovXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXNvbHZlSW1hZ2VQYXRocyhcclxuICBkb2M6IEhUTUxEb2N1bWVudCxcclxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxyXG4gIHJlbGF0aXZpemU6IGJvb2xlYW4sXHJcbiAgc2F2ZVBhdGg/OiBzdHJpbmcsXHJcbiAgaW1hZ2VXYXRjaGVyPzogSW1hZ2VXYXRjaGVyLFxyXG4pIHtcclxuICBjb25zdCBbcm9vdERpcmVjdG9yeV0gPSBhdG9tLnByb2plY3QucmVsYXRpdml6ZVBhdGgoZmlsZVBhdGggfHwgJycpXHJcbiAgY29uc3QgbWVkaWEgPSBnZXRNZWRpYShkb2MpXHJcbiAgQXJyYXkuZnJvbShtZWRpYSkubWFwKGZ1bmN0aW9uKGltZykge1xyXG4gICAgbGV0IGF0dHJOYW1lOiAnaHJlZicgfCAnc3JjJ1xyXG4gICAgaWYgKGltZy50YWdOYW1lID09PSAnTElOSycpIGF0dHJOYW1lID0gJ2hyZWYnXHJcbiAgICBlbHNlIGF0dHJOYW1lID0gJ3NyYydcclxuICAgIGxldCBzcmMgPSBpbWcuZ2V0QXR0cmlidXRlKGF0dHJOYW1lKVxyXG4gICAgaWYgKHNyYykge1xyXG4gICAgICBpZiAoYXRvbUNvbmZpZygpLnJlbmRlcmVyICE9PSAncGFuZG9jJykge1xyXG4gICAgICAgIHNyYyA9IGRlY29kZVVSSShzcmMpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChzcmMubWF0Y2goL14oaHR0cHM/fGF0b218ZGF0YSk6LykpIHtcclxuICAgICAgICByZXR1cm5cclxuICAgICAgfVxyXG4gICAgICBpZiAocHJvY2Vzcy5yZXNvdXJjZXNQYXRoICYmIHNyYy5zdGFydHNXaXRoKHByb2Nlc3MucmVzb3VyY2VzUGF0aCkpIHtcclxuICAgICAgICByZXR1cm5cclxuICAgICAgfVxyXG4gICAgICBpZiAoc3JjLnN0YXJ0c1dpdGgocmVzb3VyY2VQYXRoKSkge1xyXG4gICAgICAgIHJldHVyblxyXG4gICAgICB9XHJcbiAgICAgIGlmIChzcmMuc3RhcnRzV2l0aChwYWNrYWdlUGF0aCkpIHtcclxuICAgICAgICByZXR1cm5cclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHNyY1swXSA9PT0gJy8nKSB7XHJcbiAgICAgICAgaWYgKCFpc0ZpbGVTeW5jKHNyYykpIHtcclxuICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChyb290RGlyZWN0b3J5ICE9PSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgc3JjID0gcGF0aC5qb2luKHJvb3REaXJlY3RvcnksIHNyYy5zdWJzdHJpbmcoMSkpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgLy8gbm9vcFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIGlmIChmaWxlUGF0aCkge1xyXG4gICAgICAgIHNyYyA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUoZmlsZVBhdGgpLCBzcmMpXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmIChyZWxhdGl2aXplICYmIChmaWxlUGF0aCAhPT0gdW5kZWZpbmVkIHx8IHNhdmVQYXRoICE9PSB1bmRlZmluZWQpKSB7XHJcbiAgICAgICAgY29uc3QgZnAgPSBzYXZlUGF0aCAhPT0gdW5kZWZpbmVkID8gc2F2ZVBhdGggOiBmaWxlUGF0aCFcclxuICAgICAgICBzcmMgPSBwYXRoLnJlbGF0aXZlKHBhdGguZGlybmFtZShmcCksIHNyYylcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gV2F0Y2ggaW1hZ2UgZm9yIGNoYW5nZXNcclxuICAgICAgaWYgKGltYWdlV2F0Y2hlcikge1xyXG4gICAgICAgIGNvbnN0IHYgPSBpbWFnZVdhdGNoZXIud2F0Y2goc3JjKVxyXG4gICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQpIHNyYyA9IGAke3NyY30/dj0ke3Z9YFxyXG4gICAgICB9XHJcblxyXG4gICAgICBpbWdbYXR0ck5hbWVdID0gc3JjXHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG5cclxuYXN5bmMgZnVuY3Rpb24gaGlnaGxpZ2h0Q29kZUJsb2NrcyhcclxuICBkb21GcmFnbWVudDogRG9jdW1lbnQsXHJcbiAgZGVmYXVsdExhbmd1YWdlOiBzdHJpbmcsXHJcbikge1xyXG4gIGNvbnN0IGZvbnRGYW1pbHkgPSBhdG9tLmNvbmZpZy5nZXQoJ2VkaXRvci5mb250RmFtaWx5JylcclxuICBpZiAoZm9udEZhbWlseSkge1xyXG4gICAgZm9yIChjb25zdCBjb2RlRWxlbWVudCBvZiBBcnJheS5mcm9tKFxyXG4gICAgICBkb21GcmFnbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdjb2RlJyksXHJcbiAgICApKSB7XHJcbiAgICAgIGNvZGVFbGVtZW50LnN0eWxlLmZvbnRGYW1pbHkgPSBmb250RmFtaWx5XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBhd2FpdCBQcm9taXNlLmFsbChcclxuICAgIEFycmF5LmZyb20oZG9tRnJhZ21lbnQucXVlcnlTZWxlY3RvckFsbCgncHJlJykpLm1hcChhc3luYyAocHJlRWxlbWVudCkgPT4ge1xyXG4gICAgICBjb25zdCBjb2RlQmxvY2sgPVxyXG4gICAgICAgIHByZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQgIT09IG51bGxcclxuICAgICAgICAgID8gcHJlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZFxyXG4gICAgICAgICAgOiBwcmVFbGVtZW50XHJcbiAgICAgIGNvbnN0IGNiQ2xhc3MgPSBjb2RlQmxvY2suY2xhc3NOYW1lIHx8IHByZUVsZW1lbnQuY2xhc3NOYW1lXHJcbiAgICAgIGNvbnN0IGZlbmNlTmFtZSA9IGNiQ2xhc3NcclxuICAgICAgICA/IGNiQ2xhc3MucmVwbGFjZSgvXihsYW5nLXxzb3VyY2VDb2RlICkvLCAnJylcclxuICAgICAgICA6IGRlZmF1bHRMYW5ndWFnZVxyXG5cclxuICAgICAgY29uc3QgY3R3ID0gYXRvbUNvbmZpZygpLmNvZGVUYWJXaWR0aFxyXG4gICAgICBjb25zdCBlZCA9IG5ldyBUZXh0RWRpdG9yKHtcclxuICAgICAgICByZWFkb25seTogdHJ1ZSxcclxuICAgICAgICBrZXlib2FyZElucHV0RW5hYmxlZDogZmFsc2UsXHJcbiAgICAgICAgc2hvd0ludmlzaWJsZXM6IGZhbHNlLFxyXG4gICAgICAgIHRhYkxlbmd0aDogY3R3ID09PSAwID8gYXRvbS5jb25maWcuZ2V0KCdlZGl0b3IudGFiTGVuZ3RoJykgOiBjdHcsXHJcbiAgICAgIH0pXHJcbiAgICAgIGNvbnN0IGVsID0gYXRvbS52aWV3cy5nZXRWaWV3KGVkKVxyXG4gICAgICB0cnkge1xyXG4gICAgICAgIGVsLnNldFVwZGF0ZWRTeW5jaHJvbm91c2x5KHRydWUpXHJcbiAgICAgICAgZWwuc3R5bGUucG9pbnRlckV2ZW50cyA9ICdub25lJ1xyXG4gICAgICAgIGVsLnN0eWxlLnBvc2l0aW9uID0gJ2Fic29sdXRlJ1xyXG4gICAgICAgIGVsLnN0eWxlLndpZHRoID0gJzBweCdcclxuICAgICAgICBlbC5zdHlsZS5oZWlnaHQgPSAnMXB4J1xyXG4gICAgICAgIGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZSkuYXBwZW5kQ2hpbGQoZWwpXHJcbiAgICAgICAgYXRvbS5ncmFtbWFycy5hc3NpZ25MYW5ndWFnZU1vZGUoXHJcbiAgICAgICAgICBlZC5nZXRCdWZmZXIoKSxcclxuICAgICAgICAgIHNjb3BlRm9yRmVuY2VOYW1lKGZlbmNlTmFtZSksXHJcbiAgICAgICAgKVxyXG4gICAgICAgIGVkLnNldFRleHQoY29kZUJsb2NrLnRleHRDb250ZW50IS5yZXBsYWNlKC9cXHI/XFxuJC8sICcnKSlcclxuICAgICAgICBhd2FpdCBlZGl0b3JUb2tlbml6ZWQoZWQpXHJcbiAgICAgICAgY29uc3QgaHRtbCA9IEFycmF5LmZyb20oZWwucXVlcnlTZWxlY3RvckFsbCgnLmxpbmU6bm90KC5kdW1teSknKSlcclxuICAgICAgICBwcmVFbGVtZW50LmNsYXNzTGlzdC5hZGQoJ2VkaXRvci1jb2xvcnMnKVxyXG4gICAgICAgIHByZUVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbC5tYXAoKHgpID0+IHguaW5uZXJIVE1MKS5qb2luKCdcXG4nKVxyXG4gICAgICAgIGlmIChmZW5jZU5hbWUpIHByZUVsZW1lbnQuY2xhc3NMaXN0LmFkZChgbGFuZy0ke2ZlbmNlTmFtZX1gKVxyXG4gICAgICB9IGZpbmFsbHkge1xyXG4gICAgICAgIGVsLnJlbW92ZSgpXHJcbiAgICAgIH1cclxuICAgIH0pLFxyXG4gIClcclxuXHJcbiAgcmV0dXJuIGRvbUZyYWdtZW50XHJcbn1cclxuXHJcbmFzeW5jIGZ1bmN0aW9uIGVkaXRvclRva2VuaXplZChlZGl0b3I6IFRleHRFZGl0b3IpIHtcclxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcclxuICAgIGlmIChlZGl0b3IuZ2V0QnVmZmVyKCkuZ2V0TGFuZ3VhZ2VNb2RlKCkuZnVsbHlUb2tlbml6ZWQpIHtcclxuICAgICAgcmVzb2x2ZSgpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBkaXNwID0gZWRpdG9yLm9uRGlkVG9rZW5pemUoKCkgPT4ge1xyXG4gICAgICAgIGRpc3AuZGlzcG9zZSgpXHJcbiAgICAgICAgcmVzb2x2ZSgpXHJcbiAgICAgIH0pXHJcbiAgICB9XHJcbiAgfSlcclxufVxyXG4iXX0=