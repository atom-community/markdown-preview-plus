"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const request_handler_1 = require("./request-handler");
const util_1 = require("../../util");
const should_scroll_sync_1 = require("./should-scroll-sync");
class RemoteEditorServer {
    constructor(editor) {
        this.editor = editor;
        this.disposables = new atom_1.CompositeDisposable();
        this.windowId = electron_1.remote.getCurrentWindow().id;
        this.destroyTimeoutLength = 60000;
        this.usageCounter = 0;
        this.eventHandlers = {
            scrollToBufferRange: ([min, max]) => {
                if (min === 0) {
                    this.editor.scrollToBufferPosition([min, 0]);
                }
                else if (max >= this.editor.getLastBufferRow() - 1) {
                    this.editor.scrollToBufferPosition([max, 0]);
                }
                else {
                    const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
                    this.editor.scrollToScreenRange(this.editor.screenRangeForBufferRange(range), {
                        center: false,
                    });
                }
            },
            destroy: () => {
                this.usageCounter -= 1;
                if (this.usageCounter <= 0) {
                    this.resetTimeout();
                    this.destroyTimeout = window.setTimeout(() => {
                        this.dispose();
                    }, this.destroyTimeoutLength);
                }
            },
            init: () => {
                this.usageCounter += 1;
                this.resetTimeout();
                return {
                    path: this.editor.getPath(),
                    title: this.editor.getTitle(),
                    grammar: this.editor.getGrammar().scopeName,
                    text: this.editor.getText(),
                };
            },
            openSource: (row) => {
                if (row !== undefined) {
                    this.editor.setCursorBufferPosition([row, 0]);
                }
                electron_1.remote.getCurrentWindow().focus();
                const pane = atom.workspace.paneForItem(this.editor);
                if (!pane)
                    return;
                pane.activateItem(this.editor);
                pane.activate();
            },
        };
        this.disposables.add(new request_handler_1.RequestHandler(this.windowId, editor.id, this.eventHandlers));
        this.handleEditorEvents();
    }
    static create(editor) {
        const res = RemoteEditorServer.editorMap.get(editor);
        if (res)
            return res;
        const newRes = new RemoteEditorServer(editor);
        RemoteEditorServer.editorMap.set(editor, newRes);
        return newRes;
    }
    dispose() {
        RemoteEditorServer.editorMap.delete(this.editor);
        this.disposables.dispose();
    }
    resetTimeout() {
        if (this.destroyTimeout !== undefined) {
            window.clearTimeout(this.destroyTimeout);
            this.destroyTimeout = undefined;
        }
    }
    handleEditorEvents() {
        this.disposables.add(this.editor.getBuffer().onDidStopChanging(() => {
            if (util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
            if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
                this.emit('syncPreview', {
                    pos: this.editor.getCursorBufferPosition().row,
                    flash: false,
                });
            }
        }), this.editor.onDidChangePath(() => {
            this.emit('changePath', {
                path: this.editor.getPath(),
                title: this.editor.getTitle(),
            });
        }), this.editor.onDidChangeGrammar((grammar) => {
            this.emit('changeGrammar', grammar.scopeName);
        }), this.editor.onDidDestroy(() => {
            this.dispose();
            if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
                this.emit('destroy', undefined);
            }
        }), this.editor.getBuffer().onDidSave(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), this.editor.getBuffer().onDidReload(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), atom.views.getView(this.editor).onDidChangeScrollTop(() => {
            if (!should_scroll_sync_1.shouldScrollSync('editor'))
                return;
            const [first, last] = this.editor.getVisibleRowRange();
            const firstLine = this.editor.bufferRowForScreenRow(first);
            const lastLine = this.editor.bufferRowForScreenRow(last);
            this.emit('scrollSync', [firstLine, lastLine]);
        }), atom.commands.add(atom.views.getView(this.editor), {
            'markdown-preview-plus:sync-preview': () => {
                this.emit('syncPreview', {
                    pos: this.editor.getCursorBufferPosition().row,
                    flash: true,
                });
            },
        }));
    }
    emit(event, arg) {
        electron_1.remote.ipcMain.emit('markdown-preview-plus:editor-event', {
            editorId: this.editor.id,
            windowId: this.windowId,
            event,
            arg,
        });
    }
}
RemoteEditorServer.editorMap = new WeakMap();
exports.RemoteEditorServer = RemoteEditorServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAtZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy9pcGMvc2V0dXAtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQTZEO0FBQzdELHVDQUFpQztBQUNqQyx1REFBa0Q7QUFDbEQscUNBQXVDO0FBQ3ZDLDZEQUF1RDtBQWtCdkQsTUFBYSxrQkFBa0I7SUFzRDdCLFlBQXFDLE1BQWtCO1FBQWxCLFdBQU0sR0FBTixNQUFNLENBQVk7UUFwRHRDLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBQ3ZDLGFBQVEsR0FBRyxpQkFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsRUFBRSxDQUFBO1FBQ3ZDLHlCQUFvQixHQUFHLEtBQUssQ0FBQTtRQUNyQyxpQkFBWSxHQUFHLENBQUMsQ0FBQTtRQUVoQixrQkFBYSxHQUFHO1lBQ3RCLG1CQUFtQixFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFtQixFQUFFLEVBQUU7Z0JBQ3BELElBQUksR0FBRyxLQUFLLENBQUMsRUFBRTtvQkFDYixJQUFJLENBQUMsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUE7aUJBQzdDO3FCQUFNLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxDQUFDLEVBQUU7b0JBQ3BELElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDN0M7cUJBQU07b0JBQ0wsTUFBTSxLQUFLLEdBQUcsWUFBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtvQkFDcEQsSUFBSSxDQUFD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SSxDQUFDLENBQUE7WUFDeEQsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQTtRQUNoRCxDQUFDLENBQUMsRUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDakQsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO2dCQUN6QyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTtvQkFDdkIsR0FBRyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxHQUFHO29CQUM5QyxLQUFLLEVBQUUsSUFBSTtpQkFDWixDQUFDLENBQUE7WUFDSixDQUFDO1NBQ0YsQ0FBQyxDQUNILENBQUE7SUFDSCxDQUFDO0lBRU8sSUFBSSxDQUE0QixLQUFRLEVBQUUsR0FBaUI7UUFDakUsaUJBQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxFQUFFO1lBQ3hELFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDeEIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3ZCLEtBQUs7WUFDTCxHQUFHO1NBQ0osQ0FBQyxDQUFBO0lBQ0osQ0FBQzs7QUEvSWMsNEJBQVMsR0FBRyxJQUFJLE9BQU8sRUFBa0MsQ0FBQTtBQUQxRSxnREFpSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0RWRpdG9yLCBDb21wb3NpdGVEaXNwb3NhYmxlLCBSYW5nZSB9IGZyb20gJ2F0b20nXHJcbmltcG9ydCB7IHJlbW90ZSB9IGZyb20gJ2VsZWN0cm9uJ1xyXG5pbXBvcnQgeyBSZXF1ZXN0SGFuZGxlciB9IGZyb20gJy4vcmVxdWVzdC1oYW5kbGVyJ1xyXG5pbXBvcnQgeyBhdG9tQ29uZmlnIH0gZnJvbSAnLi4vLi4vdXRpbCdcclxuaW1wb3J0IHsgc2hvdWxkU2Nyb2xsU3luYyB9IGZyb20gJy4vc2hvdWxkLXNjcm9sbC1zeW5jJ1xyXG5pbXBvcnQgeyBJUENFdmVudHMgfSBmcm9tICcuL2V2ZW50LWhhbmRsZXInXHJcblxyXG4vKiBOT1RFOiBXZWlyZCByZWZlcmVuY2UgY291bnRpbmcgYW5kIFdlYWtNYXAgYXJlIGhlcmUgYmVjYXVzZVxyXG4gKiB0aGVyZSBjYW4gYmUgaW4gdGhlb3J5IG11bHRpcGxlIHdpbmRvd3Mgd2l0aFxyXG4gKiBNYXJrZG93blByZXZpZXdWaWV3RWRpdG9yUmVtb3RlIHJlZmVyZW5jaW5nIHRoZSBzYW1lXHJcbiAqIGVkaXRvciBieSB3aW5kb3dJZC9lZGl0b3JJZCwgd2hpY2ggd291bGQgbGVhZCB0b1xyXG4gKiBtdWx0aXBsZSB0cmlnZ2VycyBpZiBuZXcgXCJzZXJ2ZXJcIiB3b3VsZCBiZSBjcmVhdGVkIGZvciBldmVyeSBuZXdcclxuICogcHJldmlldyBpbnN0YW5jZTtcclxuICogV2VpcmQgZGVmZXJyZWQgZGlzcG9zYWwgaXMgaGVyZSBiZWNhdXNlIG5ldy13aW5kb3cgZXhlY3V0ZWQgb25cclxuICogTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvclJlbW90ZSB3aWxsIGZpcnN0IGRlc3Ryb3kgdGhlIGN1cnJlbnRcclxuICogaW5zdGFuY2UsIGFuZCBvbmx5IHRoZW4sIGFmdGVyIGEgbmV3IEF0b20gd2luZG93IGluaXRpYWxpemVzLFxyXG4gKiB3aWxsIGNyZWF0ZSBhIG5ldyBvbmUuIFdoaWNoIG1pZ2h0IGVhc2lseSB0YWtlIHRlbnMgb2Ygc2Vjb25kcy5cclxuICogV2hhdCBtYWtlcyB0aGlzIGV2ZW4gbW9yZSBjb21wbGljYXRlZCwgdGhlcmUgaXMgbm8gc2FuZSB3YXkgdG9cclxuICogY3JlYXRlIGEgbmV3IGluc3RhbmNlIG9mIFJlbW90ZUVkaXRvclNlcnZlciByZW1vdGVseTsgaGVuY2UsXHJcbiAqIGl0IHdhaXRzIGp1c3QgaW4gY2FzZSBuZXcgY2xpZW50cyBhcHBlYXIgYmVmb3JlIGRpc3Bvc2luZyBvZiBpdHNlbGYuXHJcbiAqL1xyXG5cclxuZXhwb3J0IGNsYXNzIFJlbW90ZUVkaXRvclNlcnZlciB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgZWRpdG9yTWFwID0gbmV3IFdlYWtNYXA8VGV4dEVkaXRvciwgUmVtb3RlRWRpdG9yU2VydmVyPigpXHJcbiAgcHJpdmF0ZSByZWFkb25seSBkaXNwb3NhYmxlcyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKClcclxuICBwcml2YXRlIHJlYWRvbmx5IHdpbmRvd0lkID0gcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5pZFxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveVRpbWVvdXRMZW5ndGggPSA2MDAwMFxyXG4gIHByaXZhdGUgdXNhZ2VDb3VudGVyID0gMFxyXG4gIHByaXZhdGUgZGVzdHJveVRpbWVvdXQ6IG51bWJlciB8IHVuZGVmaW5lZFxyXG4gIHByaXZhdGUgZXZlbnRIYW5kbGVycyA9IHtcclxuICAgIHNjcm9sbFRvQnVmZmVyUmFuZ2U6IChbbWluLCBtYXhdOiBbbnVtYmVyLCBudW1iZXJdKSA9PiB7XHJcbiAgICAgIGlmIChtaW4gPT09IDApIHtcclxuICAgICAgICB0aGlzLmVkaXRvci5zY3JvbGxUb0J1ZmZlclBvc2l0aW9uKFttaW4sIDBdKVxyXG4gICAgICB9IGVsc2UgaWYgKG1heCA+PSB0aGlzLmVkaXRvci5nZXRMYXN0QnVmZmVyUm93KCkgLSAxKSB7XHJcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWF4LCAwXSlcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCByYW5nZSA9IFJhbmdlLmZyb21PYmplY3QoW1ttaW4sIDBdLCBbbWF4LCAwXV0pXHJcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9TY3JlZW5SYW5nZShcclxuICAgICAgICAgIHRoaXMuZWRpdG9yLnNjcmVlblJhbmdlRm9yQnVmZmVyUmFuZ2UocmFuZ2UpLFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBjZW50ZXI6IGZhbHNlLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICApXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBkZXN0cm95OiAoKSA9PiB7XHJcbiAgICAgIHRoaXMudXNhZ2VDb3VudGVyIC09IDFcclxuICAgICAgaWYgKHRoaXMudXNhZ2VDb3VudGVyIDw9IDApIHtcclxuICAgICAgICB0aGlzLnJlc2V0VGltZW91dCgpXHJcbiAgICAgICAgdGhpcy5kZXN0cm95VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICAgIHRoaXMuZGlzcG9zZSgpXHJcbiAgICAgICAgfSwgdGhpcy5kZXN0cm95VGltZW91dExlbmd0aClcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIGluaXQ6ICgpID0+IHtcclxuICAgICAgdGhpcy51c2FnZUNvdW50ZXIgKz0gMVxyXG4gICAgICB0aGlzLnJlc2V0VGltZW91dCgpXHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgcGF0aDogdGhpcy5lZGl0b3IuZ2V0UGF0aCgpLFxyXG4gICAgICAgIHRpdGxlOiB0aGlzLmVkaXRvci5nZXRUaXRsZSgpLFxyXG4gICAgICAgIGdyYW1tYXI6IHRoaXMuZWRpdG9yLmdldEdyYW1tYXIoKS5zY29wZU5hbWUsXHJcbiAgICAgICAgdGV4dDogdGhpcy5lZGl0b3IuZ2V0VGV4dCgpLFxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgb3BlblNvdXJjZTogKHJvdz86IG51bWJlcikgPT4ge1xyXG4gICAgICBpZiAocm93ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICB0aGlzLmVkaXRvci5zZXRDdXJzb3JCdWZmZXJQb3NpdGlvbihbcm93LCAwXSlcclxuICAgICAgfVxyXG4gICAgICByZW1vdGUuZ2V0Q3VycmVudFdpbmRvdygpLmZvY3VzKClcclxuICAgICAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKHRoaXMuZWRpdG9yKVxyXG4gICAgICBpZiAoIXBhbmUpIHJldHVyblxyXG4gICAgICBwYW5lLmFjdGl2YXRlSXRlbSh0aGlzLmVkaXRvcilcclxuICAgICAgcGFuZS5hY3RpdmF0ZSgpXHJcbiAgICB9LFxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGVkaXRvcjogVGV4dEVkaXRvcikge1xyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXHJcbiAgICAgIG5ldyBSZXF1ZXN0SGFuZGxlcih0aGlzLndpbmRvd0lkLCBlZGl0b3IuaWQsIHRoaXMuZXZlbnRIYW5kbGVycyksXHJcbiAgICApXHJcbiAgICB0aGlzLmhhbmRsZUVkaXRvckV2ZW50cygpXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RhdGljIGNyZWF0ZShlZGl0b3I6IFRleHRFZGl0b3IpIHtcclxuICAgIGNvbnN0IHJlcyA9IFJlbW90ZUVkaXRvclNlcnZlci5lZGl0b3JNYXAuZ2V0KGVkaXRvcilcclxuICAgIGlmIChyZXMpIHJldHVybiByZXNcclxuICAgIGNvbnN0IG5ld1JlcyA9IG5ldyBSZW1vdGVFZGl0b3JTZXJ2ZXIoZWRpdG9yKVxyXG4gICAgUmVtb3RlRWRpdG9yU2VydmVyLmVkaXRvck1hcC5zZXQoZWRpdG9yLCBuZXdSZXMpXHJcbiAgICByZXR1cm4gbmV3UmVzXHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGlzcG9zZSgpIHtcclxuICAgIFJlbW90ZUVkaXRvclNlcnZlci5lZGl0b3JNYXAuZGVsZXRlKHRoaXMuZWRpdG9yKVxyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVzZXRUaW1lb3V0KCkge1xyXG4gICAgaWYgKHRoaXMuZGVzdHJveVRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRoaXMuZGVzdHJveVRpbWVvdXQpXHJcbiAgICAgIHRoaXMuZGVzdHJveVRpbWVvdXQgPSB1bmRlZmluZWRcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlRWRpdG9yRXZlbnRzKCkge1xyXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoXHJcbiAgICAgIHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkU3RvcENoYW5naW5nKCgpID0+IHtcclxuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xyXG4gICAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2VUZXh0JywgdGhpcy5lZGl0b3IuZ2V0VGV4dCgpKVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnN5bmNDb25maWcuc3luY1ByZXZpZXdPbkNoYW5nZSkge1xyXG4gICAgICAgICAgdGhpcy5lbWl0KCdzeW5jUHJldmlldycsIHtcclxuICAgICAgICAgICAgcG9zOiB0aGlzLmVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdyxcclxuICAgICAgICAgICAgZmxhc2g6IGZhbHNlLFxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICB0aGlzLmVkaXRvci5vbkRpZENoYW5nZVBhdGgoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlUGF0aCcsIHtcclxuICAgICAgICAgIHBhdGg6IHRoaXMuZWRpdG9yLmdldFBhdGgoKSxcclxuICAgICAgICAgIHRpdGxlOiB0aGlzLmVkaXRvci5nZXRUaXRsZSgpLFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH0pLFxyXG4gICAgICB0aGlzLmVkaXRvci5vbkRpZENoYW5nZUdyYW1tYXIoKGdyYW1tYXIpID0+IHtcclxuICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZUdyYW1tYXInLCBncmFtbWFyLnNjb3BlTmFtZSlcclxuICAgICAgfSksXHJcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlKClcclxuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuY2xvc2VQcmV2aWV3V2l0aEVkaXRvcikge1xyXG4gICAgICAgICAgdGhpcy5lbWl0KCdkZXN0cm95JywgdW5kZWZpbmVkKVxyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkU2F2ZSgoKSA9PiB7XHJcbiAgICAgICAgaWYgKCFhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5saXZlVXBkYXRlKSB7XHJcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZVRleHQnLCB0aGlzLmVkaXRvci5nZXRUZXh0KCkpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRSZWxvYWQoKCkgPT4ge1xyXG4gICAgICAgIGlmICghYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xyXG4gICAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2VUZXh0JywgdGhpcy5lZGl0b3IuZ2V0VGV4dCgpKVxyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvcikub25EaWRDaGFuZ2VTY3JvbGxUb3AoKCkgPT4ge1xyXG4gICAgICAgIGlmICghc2hvdWxkU2Nyb2xsU3luYygnZWRpdG9yJykpIHJldHVyblxyXG4gICAgICAgIGNvbnN0IFtmaXJzdCwgbGFzdF0gPSB0aGlzLmVkaXRvci5nZXRWaXNpYmxlUm93UmFuZ2UoKVxyXG4gICAgICAgIGNvbnN0IGZpcnN0TGluZSA9IHRoaXMuZWRpdG9yLmJ1ZmZlclJvd0ZvclNjcmVlblJvdyhmaXJzdClcclxuICAgICAgICBjb25zdCBsYXN0TGluZSA9IHRoaXMuZWRpdG9yLmJ1ZmZlclJvd0ZvclNjcmVlblJvdyhsYXN0KVxyXG4gICAgICAgIHRoaXMuZW1pdCgnc2Nyb2xsU3luYycsIFtmaXJzdExpbmUsIGxhc3RMaW5lXSlcclxuICAgICAgfSksXHJcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvciksIHtcclxuICAgICAgICAnbWFya2Rvd24tcHJldmlldy1wbHVzOnN5bmMtcHJldmlldyc6ICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuZW1pdCgnc3luY1ByZXZpZXcnLCB7XHJcbiAgICAgICAgICAgIHBvczogdGhpcy5lZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3csXHJcbiAgICAgICAgICAgIGZsYXNoOiB0cnVlLFxyXG4gICAgICAgICAgfSlcclxuICAgICAgICB9LFxyXG4gICAgICB9KSxcclxuICAgIClcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW1pdDxUIGV4dGVuZHMga2V5b2YgSVBDRXZlbnRzPihldmVudDogVCwgYXJnOiBJUENFdmVudHNbVF0pIHtcclxuICAgIHJlbW90ZS5pcGNNYWluLmVtaXQoJ21hcmtkb3duLXByZXZpZXctcGx1czplZGl0b3ItZXZlbnQnLCB7XHJcbiAgICAgIGVkaXRvcklkOiB0aGlzLmVkaXRvci5pZCxcclxuICAgICAgd2luZG93SWQ6IHRoaXMud2luZG93SWQsXHJcbiAgICAgIGV2ZW50LFxyXG4gICAgICBhcmcsXHJcbiAgICB9KVxyXG4gIH1cclxufVxyXG4iXX0=