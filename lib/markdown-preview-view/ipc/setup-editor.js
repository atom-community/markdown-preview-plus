"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const request_handler_1 = require("./request-handler");
const util_1 = require("../../util");
const should_scroll_sync_1 = require("./should-scroll-sync");
class RemoteEditorServer {
    constructor(editor) {
        this.editor = editor;
        this.disposables = new atom_1.CompositeDisposable();
        this.windowId = electron_1.remote.getCurrentWindow().id;
        this.destroyTimeoutLength = 60000;
        this.usageCounter = 0;
        this.eventHandlers = {
            scrollToBufferRange: ([min, max]) => {
                if (min === 0) {
                    this.editor.scrollToBufferPosition([min, 0]);
                }
                else if (max >= this.editor.getLastBufferRow() - 1) {
                    this.editor.scrollToBufferPosition([max, 0]);
                }
                else {
                    const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
                    this.editor.scrollToScreenRange(this.editor.screenRangeForBufferRange(range), {
                        center: false,
                    });
                }
            },
            destroy: () => {
                this.usageCounter -= 1;
                if (this.usageCounter <= 0) {
                    this.resetTimeout();
                    this.destroyTimeout = window.setTimeout(() => {
                        this.dispose();
                    }, this.destroyTimeoutLength);
                }
            },
            init: () => {
                this.usageCounter += 1;
                this.resetTimeout();
                return {
                    path: this.editor.getPath(),
                    title: this.editor.getTitle(),
                    grammar: this.editor.getGrammar().scopeName,
                    text: this.editor.getText(),
                };
            },
            openSource: (row) => {
                if (row !== undefined) {
                    this.editor.setCursorBufferPosition([row, 0]);
                }
                electron_1.remote.getCurrentWindow().focus();
                const pane = atom.workspace.paneForItem(this.editor);
                if (!pane)
                    return;
                pane.activateItem(this.editor);
                pane.activate();
            },
        };
        this.disposables.add(new request_handler_1.RequestHandler(this.windowId, editor.id, this.eventHandlers));
        this.handleEditorEvents();
    }
    static create(editor) {
        const res = RemoteEditorServer.editorMap.get(editor);
        if (res)
            return res;
        const newRes = new RemoteEditorServer(editor);
        RemoteEditorServer.editorMap.set(editor, newRes);
        return newRes;
    }
    dispose() {
        RemoteEditorServer.editorMap.delete(this.editor);
        this.disposables.dispose();
    }
    resetTimeout() {
        if (this.destroyTimeout !== undefined) {
            window.clearTimeout(this.destroyTimeout);
            this.destroyTimeout = undefined;
        }
    }
    handleEditorEvents() {
        this.disposables.add(this.editor.getBuffer().onDidStopChanging(() => {
            if (util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
            if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
                this.emit('syncPreview', {
                    pos: this.editor.getCursorBufferPosition().row,
                    flash: false,
                });
            }
        }), this.editor.onDidChangePath(() => {
            this.emit('changePath', {
                path: this.editor.getPath(),
                title: this.editor.getTitle(),
            });
        }), this.editor.onDidChangeGrammar((grammar) => {
            this.emit('changeGrammar', grammar.scopeName);
        }), this.editor.onDidDestroy(() => {
            this.dispose();
            if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
                this.emit('destroy', undefined);
            }
        }), this.editor.getBuffer().onDidSave(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), this.editor.getBuffer().onDidReload(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), atom.views.getView(this.editor).onDidChangeScrollTop(() => {
            if (!should_scroll_sync_1.shouldScrollSync('editor'))
                return;
            const [first, last] = this.editor.getVisibleRowRange();
            const firstLine = this.editor.bufferRowForScreenRow(first);
            const lastLine = this.editor.bufferRowForScreenRow(last);
            this.emit('scrollSync', [firstLine, lastLine]);
        }), atom.commands.add(atom.views.getView(this.editor), {
            'markdown-preview-plus:sync-preview': () => {
                this.emit('syncPreview', {
                    pos: this.editor.getCursorBufferPosition().row,
                    flash: true,
                });
            },
        }));
    }
    emit(event, arg) {
        electron_1.remote.ipcMain.emit('markdown-preview-plus:editor-event', {
            editorId: this.editor.id,
            windowId: this.windowId,
            event,
            arg,
        });
    }
}
RemoteEditorServer.editorMap = new WeakMap();
exports.RemoteEditorServer = RemoteEditorServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAtZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy9pcGMvc2V0dXAtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQTZEO0FBQzdELHVDQUFpQztBQUNqQyx1REFBa0Q7QUFDbEQscUNBQXVDO0FBQ3ZDLDZEQUF1RDtBQWtCdkQ7SUFzREUsWUFBcUMsTUFBa0I7UUFBbEIsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQXBEdEMsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDdkMsYUFBUSxHQUFHLGlCQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLENBQUE7UUFDdkMseUJBQW9CLEdBQUcsS0FBSyxDQUFBO1FBQ3JDLGlCQUFZLEdBQUcsQ0FBQyxDQUFBO1FBRWhCLGtCQUFhLEdBQUc7WUFDdEIsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQW1CLEVBQUUsRUFBRTtnQkFDcEQsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO29CQUNiLElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDN0M7cUJBQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsRUFBRTtvQkFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO2lCQUM3QztxQkFBTTtvQkFDTCxNQUFNLEtBQUssR0FBRyxZQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUM3QixJQUFJLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDLEtBQUssQ0FBQyxFQUM1Qzt3QkFDRSxNQUFNLEVBQUUsS0FBSztxQkFDZCxDQUNGLENBQUE7aUJBQ0Y7WUFDSCxDQUFDO1lBQ0QsT0FBTyxFQUFFLEdBQUcsRUFBRTtnQkFDWixJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQTtnQkFDdEIsSUFBSSxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsRUFBRTtvQkFDMUIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO29CQUNuQixJQUFJLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFO3dCQUMzQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7b0JBQ2hCLENBQUMsRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQTtpQkFDOUI7WUFDSCxDQUFDO1lBQ0QsSUFBSSxFQUFFLEdBQUcsRUFBRTtnQkFDVCxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsQ0FBQTtnQkFDdEIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO2dCQUNuQixPQUFPO29CQUNMLElBQUksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDM0IsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFO29CQUM3QixPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxTQUFTO29CQUMzQyxJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7aUJBQzVCLENBQUE7WUFDSCxDQUFDO1lBQ0QsVUFBVSxFQUFFLENBQUMsR0FBWSxFQUFFLEVBQUU7Z0JBQzNCLElBQUksR0FBRyxLQUFLLFNBQVMsRUFBRTtvQkFDckIsSUFBSSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO2lCQUM5QztnQkFDRCxpQkFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUMsS0FBSyxFQUFFLENBQUE7Z0JBQ2pDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFDcEQsSUFBSSxDQUFDLElBQUk7b0JBQUUsT0FBTTtnQkFDakIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7Z0JBQzlCLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtZQUNqQixDQUFDO1NBQ0YsQ0FBQTtRQUdDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUNsQixJQUFJLGdDQUFjLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FDakUsQ0FBQTtRQUNELElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO0lBQzNCLENBQUM7SUFFTSxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQWtCO1FBQ3JDLE1BQU0sR0FBRyxHQUFHLGtCQUFrQixDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDcEQsSUFBSSxHQUFHO1lBQUUsT0FBTyxHQUFHLENBQUE7UUFDbkIsTUFBTSxNQUFNLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUM3QyxrQkFBa0IsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQTtRQUNoRCxPQUFPLE1BQU0sQ0FBQTtJQUNmLENBQUM7SUFFTSxPQUFPO1FBQ1osa0JBQWtCLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDaEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUM1QixDQUFDO0lBRU8sWUFBWTtRQUNsQixJQUFJLElBQUksQ0FBQyxjQUFjLEtBQUssU0FBUyxFQUFFO1lBQ3JDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFBO1lBQ3hDLElBQUksQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFBO1NBQ2hDO0lBQ0gsQ0FBQztJQUVPLGtCQUFrQjtRQUN4QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDbEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLEVBQUU7WUFDN0MsSUFBSSxpQkFBVSxFQUFFLENBQUMsYUFBYSxDQUFDLFVBQVUsRUFBRTtnQkFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFBO2FBQy9DO1lBQ0QsSUFBSSxpQkFBVSxFQUFFLENBQUMsVUFBVSxDQUFDLG1CQUFtQixFQUFFO2dCQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTtvQkFDdkIsR0FBRyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxHQUFHO29CQUM5QyxLQUFLLEVBQUUsS0FBSztpQkFDYixDQUFDLENBQUE7YUFDSDtRQUNILENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsRUFBRTtZQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRTtnQkFDdEIsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO2dCQUMzQixLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLEVBQUU7YUFDOUIsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLEVBQ0YsSUFBSSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQ3pDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUMvQyxDQUFDLENBQUMsRUFDRixJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7WUFDNUIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1lBQ2QsSUFBSSxpQkFBVSxFQUFFLENBQUMsYUFBYSxDQUFDLHNCQUFzQixFQUFFO2dCQUNyRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsQ0FBQTthQUNoQztRQUNILENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNyQyxJQUFJLENBQUMsaUJBQVUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUU7Z0JBQzFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTthQUMvQztRQUNILENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRTtZQUN2QyxJQUFJLENBQUMsaUJBQVUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxVQUFVLEVBQUU7Z0JBQzFDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQTthQUMvQztRQUNILENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLEVBQUU7WUFDeEQsSUFBSSxDQUFDLHFDQUFnQixDQUFDLFFBQVEsQ0FBQztnQkFBRSxPQUFNO1lBQ3ZDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSxDQUFBO1lBQ3RELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDMUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsQ0FBQTtZQUN4RCxJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFBO1FBQ2hELENBQUMsQ0FBQyxFQUNGLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUNqRCxvQ0FBb0MsRUFBRSxHQUFHLEVBQUU7Z0JBQ3pDLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFO29CQUN2QixHQUFHLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsRUFBRSxDQUFDLEdBQUc7b0JBQzlDLEtBQUssRUFBRSxJQUFJO2lCQUNaLENBQUMsQ0FBQTtZQUNKLENBQUM7U0FDRixDQUFDLENBQ0gsQ0FBQTtJQUNILENBQUM7SUFFTyxJQUFJLENBQTRCLEtBQVEsRUFBRSxHQUFpQjtRQUNqRSxpQkFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsb0NBQW9DLEVBQUU7WUFDeEQsUUFBUSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN4QixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsS0FBSztZQUNMLEdBQUc7U0FDSixDQUFDLENBQUE7SUFDSixDQUFDOztBQS9JYyw0QkFBUyxHQUFHLElBQUksT0FBTyxFQUFrQyxDQUFBO0FBRDFFLGdEQWlKQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFZGl0b3IsIENvbXBvc2l0ZURpc3Bvc2FibGUsIFJhbmdlIH0gZnJvbSAnYXRvbSdcbmltcG9ydCB7IHJlbW90ZSB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIgfSBmcm9tICcuL3JlcXVlc3QtaGFuZGxlcidcbmltcG9ydCB7IGF0b21Db25maWcgfSBmcm9tICcuLi8uLi91dGlsJ1xuaW1wb3J0IHsgc2hvdWxkU2Nyb2xsU3luYyB9IGZyb20gJy4vc2hvdWxkLXNjcm9sbC1zeW5jJ1xuaW1wb3J0IHsgSVBDRXZlbnRzIH0gZnJvbSAnLi9ldmVudC1oYW5kbGVyJ1xuXG4vKiBOT1RFOiBXZWlyZCByZWZlcmVuY2UgY291bnRpbmcgYW5kIFdlYWtNYXAgYXJlIGhlcmUgYmVjYXVzZVxuICogdGhlcmUgY2FuIGJlIGluIHRoZW9yeSBtdWx0aXBsZSB3aW5kb3dzIHdpdGhcbiAqIE1hcmtkb3duUHJldmlld1ZpZXdFZGl0b3JSZW1vdGUgcmVmZXJlbmNpbmcgdGhlIHNhbWVcbiAqIGVkaXRvciBieSB3aW5kb3dJZC9lZGl0b3JJZCwgd2hpY2ggd291bGQgbGVhZCB0b1xuICogbXVsdGlwbGUgdHJpZ2dlcnMgaWYgbmV3IFwic2VydmVyXCIgd291bGQgYmUgY3JlYXRlZCBmb3IgZXZlcnkgbmV3XG4gKiBwcmV2aWV3IGluc3RhbmNlO1xuICogV2VpcmQgZGVmZXJyZWQgZGlzcG9zYWwgaXMgaGVyZSBiZWNhdXNlIG5ldy13aW5kb3cgZXhlY3V0ZWQgb25cbiAqIE1hcmtkb3duUHJldmlld1ZpZXdFZGl0b3JSZW1vdGUgd2lsbCBmaXJzdCBkZXN0cm95IHRoZSBjdXJyZW50XG4gKiBpbnN0YW5jZSwgYW5kIG9ubHkgdGhlbiwgYWZ0ZXIgYSBuZXcgQXRvbSB3aW5kb3cgaW5pdGlhbGl6ZXMsXG4gKiB3aWxsIGNyZWF0ZSBhIG5ldyBvbmUuIFdoaWNoIG1pZ2h0IGVhc2lseSB0YWtlIHRlbnMgb2Ygc2Vjb25kcy5cbiAqIFdoYXQgbWFrZXMgdGhpcyBldmVuIG1vcmUgY29tcGxpY2F0ZWQsIHRoZXJlIGlzIG5vIHNhbmUgd2F5IHRvXG4gKiBjcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgUmVtb3RlRWRpdG9yU2VydmVyIHJlbW90ZWx5OyBoZW5jZSxcbiAqIGl0IHdhaXRzIGp1c3QgaW4gY2FzZSBuZXcgY2xpZW50cyBhcHBlYXIgYmVmb3JlIGRpc3Bvc2luZyBvZiBpdHNlbGYuXG4gKi9cblxuZXhwb3J0IGNsYXNzIFJlbW90ZUVkaXRvclNlcnZlciB7XG4gIHByaXZhdGUgc3RhdGljIGVkaXRvck1hcCA9IG5ldyBXZWFrTWFwPFRleHRFZGl0b3IsIFJlbW90ZUVkaXRvclNlcnZlcj4oKVxuICBwcml2YXRlIHJlYWRvbmx5IGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIHJlYWRvbmx5IHdpbmRvd0lkID0gcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5pZFxuICBwcml2YXRlIHJlYWRvbmx5IGRlc3Ryb3lUaW1lb3V0TGVuZ3RoID0gNjAwMDBcbiAgcHJpdmF0ZSB1c2FnZUNvdW50ZXIgPSAwXG4gIHByaXZhdGUgZGVzdHJveVRpbWVvdXQ6IG51bWJlciB8IHVuZGVmaW5lZFxuICBwcml2YXRlIGV2ZW50SGFuZGxlcnMgPSB7XG4gICAgc2Nyb2xsVG9CdWZmZXJSYW5nZTogKFttaW4sIG1heF06IFtudW1iZXIsIG51bWJlcl0pID0+IHtcbiAgICAgIGlmIChtaW4gPT09IDApIHtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWluLCAwXSlcbiAgICAgIH0gZWxzZSBpZiAobWF4ID49IHRoaXMuZWRpdG9yLmdldExhc3RCdWZmZXJSb3coKSAtIDEpIHtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWF4LCAwXSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHJhbmdlID0gUmFuZ2UuZnJvbU9iamVjdChbW21pbiwgMF0sIFttYXgsIDBdXSlcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9TY3JlZW5SYW5nZShcbiAgICAgICAgICB0aGlzLmVkaXRvci5zY3JlZW5SYW5nZUZvckJ1ZmZlclJhbmdlKHJhbmdlKSxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBjZW50ZXI6IGZhbHNlLFxuICAgICAgICAgIH0sXG4gICAgICAgIClcbiAgICAgIH1cbiAgICB9LFxuICAgIGRlc3Ryb3k6ICgpID0+IHtcbiAgICAgIHRoaXMudXNhZ2VDb3VudGVyIC09IDFcbiAgICAgIGlmICh0aGlzLnVzYWdlQ291bnRlciA8PSAwKSB7XG4gICAgICAgIHRoaXMucmVzZXRUaW1lb3V0KClcbiAgICAgICAgdGhpcy5kZXN0cm95VGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLmRpc3Bvc2UoKVxuICAgICAgICB9LCB0aGlzLmRlc3Ryb3lUaW1lb3V0TGVuZ3RoKVxuICAgICAgfVxuICAgIH0sXG4gICAgaW5pdDogKCkgPT4ge1xuICAgICAgdGhpcy51c2FnZUNvdW50ZXIgKz0gMVxuICAgICAgdGhpcy5yZXNldFRpbWVvdXQoKVxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcGF0aDogdGhpcy5lZGl0b3IuZ2V0UGF0aCgpLFxuICAgICAgICB0aXRsZTogdGhpcy5lZGl0b3IuZ2V0VGl0bGUoKSxcbiAgICAgICAgZ3JhbW1hcjogdGhpcy5lZGl0b3IuZ2V0R3JhbW1hcigpLnNjb3BlTmFtZSxcbiAgICAgICAgdGV4dDogdGhpcy5lZGl0b3IuZ2V0VGV4dCgpLFxuICAgICAgfVxuICAgIH0sXG4gICAgb3BlblNvdXJjZTogKHJvdz86IG51bWJlcikgPT4ge1xuICAgICAgaWYgKHJvdyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLnNldEN1cnNvckJ1ZmZlclBvc2l0aW9uKFtyb3csIDBdKVxuICAgICAgfVxuICAgICAgcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5mb2N1cygpXG4gICAgICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0odGhpcy5lZGl0b3IpXG4gICAgICBpZiAoIXBhbmUpIHJldHVyblxuICAgICAgcGFuZS5hY3RpdmF0ZUl0ZW0odGhpcy5lZGl0b3IpXG4gICAgICBwYW5lLmFjdGl2YXRlKClcbiAgICB9LFxuICB9XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGVkaXRvcjogVGV4dEVkaXRvcikge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgbmV3IFJlcXVlc3RIYW5kbGVyKHRoaXMud2luZG93SWQsIGVkaXRvci5pZCwgdGhpcy5ldmVudEhhbmRsZXJzKSxcbiAgICApXG4gICAgdGhpcy5oYW5kbGVFZGl0b3JFdmVudHMoKVxuICB9XG5cbiAgcHVibGljIHN0YXRpYyBjcmVhdGUoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XG4gICAgY29uc3QgcmVzID0gUmVtb3RlRWRpdG9yU2VydmVyLmVkaXRvck1hcC5nZXQoZWRpdG9yKVxuICAgIGlmIChyZXMpIHJldHVybiByZXNcbiAgICBjb25zdCBuZXdSZXMgPSBuZXcgUmVtb3RlRWRpdG9yU2VydmVyKGVkaXRvcilcbiAgICBSZW1vdGVFZGl0b3JTZXJ2ZXIuZWRpdG9yTWFwLnNldChlZGl0b3IsIG5ld1JlcylcbiAgICByZXR1cm4gbmV3UmVzXG4gIH1cblxuICBwdWJsaWMgZGlzcG9zZSgpIHtcbiAgICBSZW1vdGVFZGl0b3JTZXJ2ZXIuZWRpdG9yTWFwLmRlbGV0ZSh0aGlzLmVkaXRvcilcbiAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxuICB9XG5cbiAgcHJpdmF0ZSByZXNldFRpbWVvdXQoKSB7XG4gICAgaWYgKHRoaXMuZGVzdHJveVRpbWVvdXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmRlc3Ryb3lUaW1lb3V0KVxuICAgICAgdGhpcy5kZXN0cm95VGltZW91dCA9IHVuZGVmaW5lZFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFuZGxlRWRpdG9yRXZlbnRzKCkge1xuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRTdG9wQ2hhbmdpbmcoKCkgPT4ge1xuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xuICAgICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlVGV4dCcsIHRoaXMuZWRpdG9yLmdldFRleHQoKSlcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnN5bmNDb25maWcuc3luY1ByZXZpZXdPbkNoYW5nZSkge1xuICAgICAgICAgIHRoaXMuZW1pdCgnc3luY1ByZXZpZXcnLCB7XG4gICAgICAgICAgICBwb3M6IHRoaXMuZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkucm93LFxuICAgICAgICAgICAgZmxhc2g6IGZhbHNlLFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3Iub25EaWRDaGFuZ2VQYXRoKCgpID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2VQYXRoJywge1xuICAgICAgICAgIHBhdGg6IHRoaXMuZWRpdG9yLmdldFBhdGgoKSxcbiAgICAgICAgICB0aXRsZTogdGhpcy5lZGl0b3IuZ2V0VGl0bGUoKSxcbiAgICAgICAgfSlcbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3Iub25EaWRDaGFuZ2VHcmFtbWFyKChncmFtbWFyKSA9PiB7XG4gICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlR3JhbW1hcicsIGdyYW1tYXIuc2NvcGVOYW1lKVxuICAgICAgfSksXG4gICAgICB0aGlzLmVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICB0aGlzLmRpc3Bvc2UoKVxuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuY2xvc2VQcmV2aWV3V2l0aEVkaXRvcikge1xuICAgICAgICAgIHRoaXMuZW1pdCgnZGVzdHJveScsIHVuZGVmaW5lZClcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICB0aGlzLmVkaXRvci5nZXRCdWZmZXIoKS5vbkRpZFNhdmUoKCkgPT4ge1xuICAgICAgICBpZiAoIWF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZVRleHQnLCB0aGlzLmVkaXRvci5nZXRUZXh0KCkpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRSZWxvYWQoKCkgPT4ge1xuICAgICAgICBpZiAoIWF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZVRleHQnLCB0aGlzLmVkaXRvci5nZXRUZXh0KCkpXG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgYXRvbS52aWV3cy5nZXRWaWV3KHRoaXMuZWRpdG9yKS5vbkRpZENoYW5nZVNjcm9sbFRvcCgoKSA9PiB7XG4gICAgICAgIGlmICghc2hvdWxkU2Nyb2xsU3luYygnZWRpdG9yJykpIHJldHVyblxuICAgICAgICBjb25zdCBbZmlyc3QsIGxhc3RdID0gdGhpcy5lZGl0b3IuZ2V0VmlzaWJsZVJvd1JhbmdlKClcbiAgICAgICAgY29uc3QgZmlyc3RMaW5lID0gdGhpcy5lZGl0b3IuYnVmZmVyUm93Rm9yU2NyZWVuUm93KGZpcnN0KVxuICAgICAgICBjb25zdCBsYXN0TGluZSA9IHRoaXMuZWRpdG9yLmJ1ZmZlclJvd0ZvclNjcmVlblJvdyhsYXN0KVxuICAgICAgICB0aGlzLmVtaXQoJ3Njcm9sbFN5bmMnLCBbZmlyc3RMaW5lLCBsYXN0TGluZV0pXG4gICAgICB9KSxcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvciksIHtcbiAgICAgICAgJ21hcmtkb3duLXByZXZpZXctcGx1czpzeW5jLXByZXZpZXcnOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5lbWl0KCdzeW5jUHJldmlldycsIHtcbiAgICAgICAgICAgIHBvczogdGhpcy5lZGl0b3IuZ2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oKS5yb3csXG4gICAgICAgICAgICBmbGFzaDogdHJ1ZSxcbiAgICAgICAgICB9KVxuICAgICAgICB9LFxuICAgICAgfSksXG4gICAgKVxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0PFQgZXh0ZW5kcyBrZXlvZiBJUENFdmVudHM+KGV2ZW50OiBULCBhcmc6IElQQ0V2ZW50c1tUXSkge1xuICAgIHJlbW90ZS5pcGNNYWluLmVtaXQoJ21hcmtkb3duLXByZXZpZXctcGx1czplZGl0b3ItZXZlbnQnLCB7XG4gICAgICBlZGl0b3JJZDogdGhpcy5lZGl0b3IuaWQsXG4gICAgICB3aW5kb3dJZDogdGhpcy53aW5kb3dJZCxcbiAgICAgIGV2ZW50LFxuICAgICAgYXJnLFxuICAgIH0pXG4gIH1cbn1cbiJdfQ==