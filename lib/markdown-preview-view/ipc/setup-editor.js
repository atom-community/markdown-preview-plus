"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const atom_1 = require("atom");
const electron_1 = require("electron");
const request_handler_1 = require("./request-handler");
const util_1 = require("../../util");
const should_scroll_sync_1 = require("./should-scroll-sync");
class RemoteEditorServer {
    constructor(editor) {
        this.editor = editor;
        this.disposables = new atom_1.CompositeDisposable();
        this.windowId = electron_1.remote.getCurrentWindow().id;
        this.destroyTimeoutLength = 60000;
        this.usageCounter = 0;
        this.eventHandlers = {
            scrollToBufferRange: ([min, max]) => {
                if (min === 0) {
                    this.editor.scrollToBufferPosition([min, 0]);
                }
                else if (max >= this.editor.getLastBufferRow() - 1) {
                    this.editor.scrollToBufferPosition([max, 0]);
                }
                else {
                    const range = atom_1.Range.fromObject([[min, 0], [max, 0]]);
                    this.editor.scrollToScreenRange(this.editor.screenRangeForBufferRange(range), {
                        center: false,
                    });
                }
            },
            destroy: () => {
                this.usageCounter -= 1;
                if (this.usageCounter <= 0) {
                    this.resetTimeout();
                    this.destroyTimeout = window.setTimeout(() => {
                        this.dispose();
                    }, this.destroyTimeoutLength);
                }
            },
            init: () => {
                this.usageCounter += 1;
                this.resetTimeout();
                return {
                    path: this.editor.getPath(),
                    title: this.editor.getTitle(),
                    grammar: this.editor.getGrammar().scopeName,
                    text: this.editor.getText(),
                };
            },
            openSource: (row) => {
                if (row !== undefined) {
                    this.editor.setCursorBufferPosition([row, 0]);
                }
                electron_1.remote.getCurrentWindow().focus();
                const pane = atom.workspace.paneForItem(this.editor);
                if (!pane)
                    return;
                pane.activateItem(this.editor);
                pane.activate();
            },
        };
        this.disposables.add(new request_handler_1.RequestHandler(this.windowId, editor.id, this.eventHandlers));
        this.handleEditorEvents();
    }
    static create(editor) {
        const res = RemoteEditorServer.editorMap.get(editor);
        if (res)
            return res;
        const newRes = new RemoteEditorServer(editor);
        RemoteEditorServer.editorMap.set(editor, newRes);
        return newRes;
    }
    dispose() {
        RemoteEditorServer.editorMap.delete(this.editor);
        this.disposables.dispose();
    }
    resetTimeout() {
        if (this.destroyTimeout !== undefined) {
            window.clearTimeout(this.destroyTimeout);
            this.destroyTimeout = undefined;
        }
    }
    handleEditorEvents() {
        this.disposables.add(this.editor.getBuffer().onDidStopChanging(() => {
            if (util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
            if (util_1.atomConfig().syncConfig.syncPreviewOnChange) {
                this.emit('syncPreview', this.editor.getCursorBufferPosition().row);
            }
        }), this.editor.onDidChangePath(() => {
            this.emit('changePath', {
                path: this.editor.getPath(),
                title: this.editor.getTitle(),
            });
        }), this.editor.onDidChangeGrammar((grammar) => {
            this.emit('changeGrammar', grammar.scopeName);
        }), this.editor.onDidDestroy(() => {
            this.dispose();
            if (util_1.atomConfig().previewConfig.closePreviewWithEditor) {
                this.emit('destroy', undefined);
            }
        }), this.editor.getBuffer().onDidSave(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), this.editor.getBuffer().onDidReload(() => {
            if (!util_1.atomConfig().previewConfig.liveUpdate) {
                this.emit('changeText', this.editor.getText());
            }
        }), atom.views.getView(this.editor).onDidChangeScrollTop(() => {
            if (!should_scroll_sync_1.shouldScrollSync('editor'))
                return;
            const [first, last] = this.editor.getVisibleRowRange();
            const firstLine = this.editor.bufferRowForScreenRow(first);
            const lastLine = this.editor.bufferRowForScreenRow(last);
            this.emit('scrollSync', [firstLine, lastLine]);
        }), atom.commands.add(atom.views.getView(this.editor), {
            'markdown-preview-plus:sync-preview': () => {
                this.emit('syncPreview', this.editor.getCursorBufferPosition().row);
            },
        }));
    }
    emit(event, arg) {
        electron_1.remote.ipcMain.emit('markdown-preview-plus:editor-event', {
            editorId: this.editor.id,
            windowId: this.windowId,
            event,
            arg,
        });
    }
}
RemoteEditorServer.editorMap = new WeakMap();
exports.RemoteEditorServer = RemoteEditorServer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dXAtZWRpdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy9pcGMvc2V0dXAtZWRpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsK0JBQTZEO0FBQzdELHVDQUFpQztBQUNqQyx1REFBa0Q7QUFDbEQscUNBQXVDO0FBQ3ZDLDZEQUF1RDtBQWtCdkQ7SUFzREUsWUFBcUMsTUFBa0I7UUFBbEIsV0FBTSxHQUFOLE1BQU0sQ0FBWTtRQXBEdEMsZ0JBQVcsR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7UUFDdkMsYUFBUSxHQUFHLGlCQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLENBQUE7UUFDdkMseUJBQW9CLEdBQUcsS0FBSyxDQUFBO1FBQ3JDLGlCQUFZLEdBQUcsQ0FBQyxDQUFBO1FBRWhCLGtCQUFhLEdBQUc7WUFDdEIsbUJBQW1CLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQW1CLEVBQUUsRUFBRTtnQkFDcEQsSUFBSSxHQUFHLEtBQUssQ0FBQyxFQUFFO29CQUNiLElBQUksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQTtpQkFDN0M7cUJBQU0sSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxHQUFHLENBQUMsRUFBRTtvQkFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFBO2lCQUM3QztxQkFBTTtvQkFDTCxNQUFNLEtBQUssR0FBRyxZQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO29CQUNwRCxJQUFJLENBQUMsTUFBTSxDQUFDLG1C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LEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQTtRQUNoRCxDQUFDLENBQUMsRUFDRixJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDakQsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO2dCQUN6QyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLHVCQUF1QixFQUFFLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDckUsQ0FBQztTQUNGLENBQUMsQ0FDSCxDQUFBO0lBQ0gsQ0FBQztJQUVPLElBQUksQ0FBNEIsS0FBUSxFQUFFLEdBQWlCO1FBQ2pFLGlCQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsRUFBRTtZQUN4RCxRQUFRLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixLQUFLO1lBQ0wsR0FBRztTQUNKLENBQUMsQ0FBQTtJQUNKLENBQUM7O0FBekljLDRCQUFTLEdBQUcsSUFBSSxPQUFPLEVBQWtDLENBQUE7QUFEMUUsZ0RBMklDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEVkaXRvciwgQ29tcG9zaXRlRGlzcG9zYWJsZSwgUmFuZ2UgfSBmcm9tICdhdG9tJ1xyXG5pbXBvcnQgeyByZW1vdGUgfSBmcm9tICdlbGVjdHJvbidcclxuaW1wb3J0IHsgUmVxdWVzdEhhbmRsZXIgfSBmcm9tICcuL3JlcXVlc3QtaGFuZGxlcidcclxuaW1wb3J0IHsgYXRvbUNvbmZpZyB9IGZyb20gJy4uLy4uL3V0aWwnXHJcbmltcG9ydCB7IHNob3VsZFNjcm9sbFN5bmMgfSBmcm9tICcuL3Nob3VsZC1zY3JvbGwtc3luYydcclxuaW1wb3J0IHsgSVBDRXZlbnRzIH0gZnJvbSAnLi9ldmVudC1oYW5kbGVyJ1xyXG5cclxuLyogTk9URTogV2VpcmQgcmVmZXJlbmNlIGNvdW50aW5nIGFuZCBXZWFrTWFwIGFyZSBoZXJlIGJlY2F1c2VcclxuICogdGhlcmUgY2FuIGJlIGluIHRoZW9yeSBtdWx0aXBsZSB3aW5kb3dzIHdpdGhcclxuICogTWFya2Rvd25QcmV2aWV3Vmlld0VkaXRvclJlbW90ZSByZWZlcmVuY2luZyB0aGUgc2FtZVxyXG4gKiBlZGl0b3IgYnkgd2luZG93SWQvZWRpdG9ySWQsIHdoaWNoIHdvdWxkIGxlYWQgdG9cclxuICogbXVsdGlwbGUgdHJpZ2dlcnMgaWYgbmV3IFwic2VydmVyXCIgd291bGQgYmUgY3JlYXRlZCBmb3IgZXZlcnkgbmV3XHJcbiAqIHByZXZpZXcgaW5zdGFuY2U7XHJcbiAqIFdlaXJkIGRlZmVycmVkIGRpc3Bvc2FsIGlzIGhlcmUgYmVjYXVzZSBuZXctd2luZG93IGV4ZWN1dGVkIG9uXHJcbiAqIE1hcmtkb3duUHJldmlld1ZpZXdFZGl0b3JSZW1vdGUgd2lsbCBmaXJzdCBkZXN0cm95IHRoZSBjdXJyZW50XHJcbiAqIGluc3RhbmNlLCBhbmQgb25seSB0aGVuLCBhZnRlciBhIG5ldyBBdG9tIHdpbmRvdyBpbml0aWFsaXplcyxcclxuICogd2lsbCBjcmVhdGUgYSBuZXcgb25lLiBXaGljaCBtaWdodCBlYXNpbHkgdGFrZSB0ZW5zIG9mIHNlY29uZHMuXHJcbiAqIFdoYXQgbWFrZXMgdGhpcyBldmVuIG1vcmUgY29tcGxpY2F0ZWQsIHRoZXJlIGlzIG5vIHNhbmUgd2F5IHRvXHJcbiAqIGNyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBSZW1vdGVFZGl0b3JTZXJ2ZXIgcmVtb3RlbHk7IGhlbmNlLFxyXG4gKiBpdCB3YWl0cyBqdXN0IGluIGNhc2UgbmV3IGNsaWVudHMgYXBwZWFyIGJlZm9yZSBkaXNwb3Npbmcgb2YgaXRzZWxmLlxyXG4gKi9cclxuXHJcbmV4cG9ydCBjbGFzcyBSZW1vdGVFZGl0b3JTZXJ2ZXIge1xyXG4gIHByaXZhdGUgc3RhdGljIGVkaXRvck1hcCA9IG5ldyBXZWFrTWFwPFRleHRFZGl0b3IsIFJlbW90ZUVkaXRvclNlcnZlcj4oKVxyXG4gIHByaXZhdGUgcmVhZG9ubHkgZGlzcG9zYWJsZXMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXHJcbiAgcHJpdmF0ZSByZWFkb25seSB3aW5kb3dJZCA9IHJlbW90ZS5nZXRDdXJyZW50V2luZG93KCkuaWRcclxuICBwcml2YXRlIHJlYWRvbmx5IGRlc3Ryb3lUaW1lb3V0TGVuZ3RoID0gNjAwMDBcclxuICBwcml2YXRlIHVzYWdlQ291bnRlciA9IDBcclxuICBwcml2YXRlIGRlc3Ryb3lUaW1lb3V0OiBudW1iZXIgfCB1bmRlZmluZWRcclxuICBwcml2YXRlIGV2ZW50SGFuZGxlcnMgPSB7XHJcbiAgICBzY3JvbGxUb0J1ZmZlclJhbmdlOiAoW21pbiwgbWF4XTogW251bWJlciwgbnVtYmVyXSkgPT4ge1xyXG4gICAgICBpZiAobWluID09PSAwKSB7XHJcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Nyb2xsVG9CdWZmZXJQb3NpdGlvbihbbWluLCAwXSlcclxuICAgICAgfSBlbHNlIGlmIChtYXggPj0gdGhpcy5lZGl0b3IuZ2V0TGFzdEJ1ZmZlclJvdygpIC0gMSkge1xyXG4gICAgICAgIHRoaXMuZWRpdG9yLnNjcm9sbFRvQnVmZmVyUG9zaXRpb24oW21heCwgMF0pXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgcmFuZ2UgPSBSYW5nZS5mcm9tT2JqZWN0KFtbbWluLCAwXSwgW21heCwgMF1dKVxyXG4gICAgICAgIHRoaXMuZWRpdG9yLnNjcm9sbFRvU2NyZWVuUmFuZ2UoXHJcbiAgICAgICAgICB0aGlzLmVkaXRvci5zY3JlZW5SYW5nZUZvckJ1ZmZlclJhbmdlKHJhbmdlKSxcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgY2VudGVyOiBmYWxzZSxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgKVxyXG4gICAgICB9XHJcbiAgICB9LFxyXG4gICAgZGVzdHJveTogKCkgPT4ge1xyXG4gICAgICB0aGlzLnVzYWdlQ291bnRlciAtPSAxXHJcbiAgICAgIGlmICh0aGlzLnVzYWdlQ291bnRlciA8PSAwKSB7XHJcbiAgICAgICAgdGhpcy5yZXNldFRpbWVvdXQoKVxyXG4gICAgICAgIHRoaXMuZGVzdHJveVRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLmRpc3Bvc2UoKVxyXG4gICAgICAgIH0sIHRoaXMuZGVzdHJveVRpbWVvdXRMZW5ndGgpXHJcbiAgICAgIH1cclxuICAgIH0sXHJcbiAgICBpbml0OiAoKSA9PiB7XHJcbiAgICAgIHRoaXMudXNhZ2VDb3VudGVyICs9IDFcclxuICAgICAgdGhpcy5yZXNldFRpbWVvdXQoKVxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHBhdGg6IHRoaXMuZWRpdG9yLmdldFBhdGgoKSxcclxuICAgICAgICB0aXRsZTogdGhpcy5lZGl0b3IuZ2V0VGl0bGUoKSxcclxuICAgICAgICBncmFtbWFyOiB0aGlzLmVkaXRvci5nZXRHcmFtbWFyKCkuc2NvcGVOYW1lLFxyXG4gICAgICAgIHRleHQ6IHRoaXMuZWRpdG9yLmdldFRleHQoKSxcclxuICAgICAgfVxyXG4gICAgfSxcclxuICAgIG9wZW5Tb3VyY2U6IChyb3c/OiBudW1iZXIpID0+IHtcclxuICAgICAgaWYgKHJvdyAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0Q3Vyc29yQnVmZmVyUG9zaXRpb24oW3JvdywgMF0pXHJcbiAgICAgIH1cclxuICAgICAgcmVtb3RlLmdldEN1cnJlbnRXaW5kb3coKS5mb2N1cygpXHJcbiAgICAgIGNvbnN0IHBhbmUgPSBhdG9tLndvcmtzcGFjZS5wYW5lRm9ySXRlbSh0aGlzLmVkaXRvcilcclxuICAgICAgaWYgKCFwYW5lKSByZXR1cm5cclxuICAgICAgcGFuZS5hY3RpdmF0ZUl0ZW0odGhpcy5lZGl0b3IpXHJcbiAgICAgIHBhbmUuYWN0aXZhdGUoKVxyXG4gICAgfSxcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBlZGl0b3I6IFRleHRFZGl0b3IpIHtcclxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxyXG4gICAgICBuZXcgUmVxdWVzdEhhbmRsZXIodGhpcy53aW5kb3dJZCwgZWRpdG9yLmlkLCB0aGlzLmV2ZW50SGFuZGxlcnMpLFxyXG4gICAgKVxyXG4gICAgdGhpcy5oYW5kbGVFZGl0b3JFdmVudHMoKVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXRpYyBjcmVhdGUoZWRpdG9yOiBUZXh0RWRpdG9yKSB7XHJcbiAgICBjb25zdCByZXMgPSBSZW1vdGVFZGl0b3JTZXJ2ZXIuZWRpdG9yTWFwLmdldChlZGl0b3IpXHJcbiAgICBpZiAocmVzKSByZXR1cm4gcmVzXHJcbiAgICBjb25zdCBuZXdSZXMgPSBuZXcgUmVtb3RlRWRpdG9yU2VydmVyKGVkaXRvcilcclxuICAgIFJlbW90ZUVkaXRvclNlcnZlci5lZGl0b3JNYXAuc2V0KGVkaXRvciwgbmV3UmVzKVxyXG4gICAgcmV0dXJuIG5ld1Jlc1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGRpc3Bvc2UoKSB7XHJcbiAgICBSZW1vdGVFZGl0b3JTZXJ2ZXIuZWRpdG9yTWFwLmRlbGV0ZSh0aGlzLmVkaXRvcilcclxuICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlc2V0VGltZW91dCgpIHtcclxuICAgIGlmICh0aGlzLmRlc3Ryb3lUaW1lb3V0ICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzLmRlc3Ryb3lUaW1lb3V0KVxyXG4gICAgICB0aGlzLmRlc3Ryb3lUaW1lb3V0ID0gdW5kZWZpbmVkXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUVkaXRvckV2ZW50cygpIHtcclxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxyXG4gICAgICB0aGlzLmVkaXRvci5nZXRCdWZmZXIoKS5vbkRpZFN0b3BDaGFuZ2luZygoKSA9PiB7XHJcbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5wcmV2aWV3Q29uZmlnLmxpdmVVcGRhdGUpIHtcclxuICAgICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlVGV4dCcsIHRoaXMuZWRpdG9yLmdldFRleHQoKSlcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGF0b21Db25maWcoKS5zeW5jQ29uZmlnLnN5bmNQcmV2aWV3T25DaGFuZ2UpIHtcclxuICAgICAgICAgIHRoaXMuZW1pdCgnc3luY1ByZXZpZXcnLCB0aGlzLmVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdylcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICB0aGlzLmVkaXRvci5vbkRpZENoYW5nZVBhdGgoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuZW1pdCgnY2hhbmdlUGF0aCcsIHtcclxuICAgICAgICAgIHBhdGg6IHRoaXMuZWRpdG9yLmdldFBhdGgoKSxcclxuICAgICAgICAgIHRpdGxlOiB0aGlzLmVkaXRvci5nZXRUaXRsZSgpLFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH0pLFxyXG4gICAgICB0aGlzLmVkaXRvci5vbkRpZENoYW5nZUdyYW1tYXIoKGdyYW1tYXIpID0+IHtcclxuICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZUdyYW1tYXInLCBncmFtbWFyLnNjb3BlTmFtZSlcclxuICAgICAgfSksXHJcbiAgICAgIHRoaXMuZWRpdG9yLm9uRGlkRGVzdHJveSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5kaXNwb3NlKClcclxuICAgICAgICBpZiAoYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcuY2xvc2VQcmV2aWV3V2l0aEVkaXRvcikge1xyXG4gICAgICAgICAgdGhpcy5lbWl0KCdkZXN0cm95JywgdW5kZWZpbmVkKVxyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIHRoaXMuZWRpdG9yLmdldEJ1ZmZlcigpLm9uRGlkU2F2ZSgoKSA9PiB7XHJcbiAgICAgICAgaWYgKCFhdG9tQ29uZmlnKCkucHJldmlld0NvbmZpZy5saXZlVXBkYXRlKSB7XHJcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NoYW5nZVRleHQnLCB0aGlzLmVkaXRvci5nZXRUZXh0KCkpXHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgdGhpcy5lZGl0b3IuZ2V0QnVmZmVyKCkub25EaWRSZWxvYWQoKCkgPT4ge1xyXG4gICAgICAgIGlmICghYXRvbUNvbmZpZygpLnByZXZpZXdDb25maWcubGl2ZVVwZGF0ZSkge1xyXG4gICAgICAgICAgdGhpcy5lbWl0KCdjaGFuZ2VUZXh0JywgdGhpcy5lZGl0b3IuZ2V0VGV4dCgpKVxyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvcikub25EaWRDaGFuZ2VTY3JvbGxUb3AoKCkgPT4ge1xyXG4gICAgICAgIGlmICghc2hvdWxkU2Nyb2xsU3luYygnZWRpdG9yJykpIHJldHVyblxyXG4gICAgICAgIGNvbnN0IFtmaXJzdCwgbGFzdF0gPSB0aGlzLmVkaXRvci5nZXRWaXNpYmxlUm93UmFuZ2UoKVxyXG4gICAgICAgIGNvbnN0IGZpcnN0TGluZSA9IHRoaXMuZWRpdG9yLmJ1ZmZlclJvd0ZvclNjcmVlblJvdyhmaXJzdClcclxuICAgICAgICBjb25zdCBsYXN0TGluZSA9IHRoaXMuZWRpdG9yLmJ1ZmZlclJvd0ZvclNjcmVlblJvdyhsYXN0KVxyXG4gICAgICAgIHRoaXMuZW1pdCgnc2Nyb2xsU3luYycsIFtmaXJzdExpbmUsIGxhc3RMaW5lXSlcclxuICAgICAgfSksXHJcbiAgICAgIGF0b20uY29tbWFuZHMuYWRkKGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLmVkaXRvciksIHtcclxuICAgICAgICAnbWFya2Rvd24tcHJldmlldy1wbHVzOnN5bmMtcHJldmlldyc6ICgpID0+IHtcclxuICAgICAgICAgIHRoaXMuZW1pdCgnc3luY1ByZXZpZXcnLCB0aGlzLmVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdylcclxuICAgICAgICB9LFxyXG4gICAgICB9KSxcclxuICAgIClcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW1pdDxUIGV4dGVuZHMga2V5b2YgSVBDRXZlbnRzPihldmVudDogVCwgYXJnOiBJUENFdmVudHNbVF0pIHtcclxuICAgIHJlbW90ZS5pcGNNYWluLmVtaXQoJ21hcmtkb3duLXByZXZpZXctcGx1czplZGl0b3ItZXZlbnQnLCB7XHJcbiAgICAgIGVkaXRvcklkOiB0aGlzLmVkaXRvci5pZCxcclxuICAgICAgd2luZG93SWQ6IHRoaXMud2luZG93SWQsXHJcbiAgICAgIGV2ZW50LFxyXG4gICAgICBhcmcsXHJcbiAgICB9KVxyXG4gIH1cclxufVxyXG4iXX0=