"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const atom_1 = require("atom");
const electron_1 = require("electron");
const fileUriToPath = require("file-uri-to-path");
const util_1 = require("../util");
class WebviewHandler {
    constructor(init) {
        this.emitter = new atom_1.Emitter();
        this.disposables = new atom_1.CompositeDisposable();
        this.destroyed = false;
        this.zoomLevel = 0;
        this.replyCallbacks = new Map();
        this.replyCallbackId = 0;
        this._element = document.createElement('webview');
        this._element.classList.add('markdown-preview-plus', 'native-key-bindings');
        this._element.disablewebsecurity = 'true';
        this._element.nodeintegration = 'true';
        this._element.src = `file:///${__dirname}/../../client/template.html`;
        this._element.style.width = '100%';
        this._element.style.height = '100%';
        this._element.addEventListener('ipc-message', (e) => {
            switch (e.channel) {
                case 'zoom-in':
                    this.zoomIn();
                    break;
                case 'zoom-out':
                    this.zoomOut();
                    break;
                case 'did-scroll-preview':
                    this.emitter.emit('did-scroll-preview', e.args[0]);
                    break;
                case 'request-reply': {
                    const { id, request, result } = e.args[0];
                    const cb = this.replyCallbacks.get(id);
                    if (cb && request === cb.request) {
                        const callback = cb.callback;
                        callback(result);
                    }
                    break;
                }
            }
        });
        this._element.addEventListener('will-navigate', async (e) => {
            if (e.url.startsWith('file://')) {
                util_1.handlePromise(atom.workspace.open(fileUriToPath(e.url)));
            }
            else {
                electron_1.shell.openExternal(e.url);
            }
        });
        this.disposables.add(atom.styles.onDidAddStyleElement(() => {
            this.updateStyles();
        }), atom.styles.onDidRemoveStyleElement(() => {
            this.updateStyles();
        }), atom.styles.onDidUpdateStyleElement(() => {
            this.updateStyles();
        }));
        const onload = () => {
            if (this.destroyed)
                return;
            this._element.setZoomLevel(this.zoomLevel);
            this.updateStyles();
            init();
        };
        this._element.addEventListener('dom-ready', onload);
    }
    get element() {
        return this._element;
    }
    async runJS(js) {
        return new Promise((resolve) => this._element.executeJavaScript(js, false, resolve));
    }
    destroy() {
        if (this.destroyed)
            return;
        this.destroyed = true;
        this.disposables.dispose();
        this._element.remove();
    }
    async update(html, renderLaTeX) {
        if (this.destroyed)
            return undefined;
        return this.runRequest('update-preview', {
            html,
            renderLaTeX,
        });
    }
    setSourceMap(map) {
        this._element.send('set-source-map', { map });
    }
    setUseGitHubStyle(value) {
        this._element.send('use-github-style', { value });
    }
    setBasePath(path) {
        this._element.send('set-base-path', { path });
    }
    init(atomHome, mathJaxConfig, mathJaxRenderer = util_1.atomConfig().mathConfig.latexRenderer) {
        this._element.send('init', {
            atomHome,
            mathJaxConfig,
            mathJaxRenderer,
        });
    }
    updateImages(oldSource, version) {
        this._element.send('update-images', {
            oldsrc: oldSource,
            v: version,
        });
    }
    async saveToPDF(filePath) {
        const opts = util_1.atomConfig().saveConfig.saveToPDFOptions;
        const customPageSize = parsePageSize(opts.customPageSize);
        const pageSize = opts.pageSize === 'Custom' ? customPageSize : opts.pageSize;
        if (pageSize === undefined) {
            throw new Error(`Failed to parse custom page size: ${opts.customPageSize}`);
        }
        const selection = await this.getSelection();
        const printSelectionOnly = selection ? opts.printSelectionOnly : false;
        const newOpts = Object.assign({}, opts, { pageSize,
            printSelectionOnly });
        await this.prepareSaveToPDF(newOpts);
        try {
            const data = await new Promise((resolve, reject) => {
                this._element.printToPDF(newOpts, (error, data) => {
                    if (error) {
                        reject(error);
                        return;
                    }
                    resolve(data);
                });
            });
            await new Promise((resolve, reject) => {
                fs.writeFile(filePath, data, (error) => {
                    if (error) {
                        reject(error);
                        return;
                    }
                    resolve();
                });
            });
        }
        finally {
            util_1.handlePromise(this.finishSaveToPDF());
        }
    }
    sync(line, flash) {
        this._element.send('sync', { line, flash });
    }
    async syncSource() {
        return this.runRequest('sync-source', {});
    }
    scrollSync(firstLine, lastLine) {
        this._element.send('scroll-sync', { firstLine, lastLine });
    }
    zoomIn() {
        this.zoomLevel += 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    zoomOut() {
        this.zoomLevel -= 0.1;
        this._element.setZoomLevel(this.zoomLevel);
    }
    resetZoom() {
        this.zoomLevel = 0;
        this._element.setZoomLevel(this.zoomLevel);
    }
    print() {
        this._element.print();
    }
    openDevTools() {
        this._element.openDevTools();
    }
    async reload() {
        await this.runRequest('reload', {});
        this._element.reload();
    }
    error(msg) {
        this._element.send('error', { msg });
    }
    async getTeXConfig() {
        return this.runRequest('get-tex-config', {});
    }
    async getSelection() {
        return this.runRequest('get-selection', {});
    }
    async runRequest(request, args) {
        const id = this.replyCallbackId++;
        return new Promise((resolve) => {
            this.replyCallbacks.set(id, {
                request: request,
                callback: (result) => {
                    this.replyCallbacks.delete(id);
                    resolve(result);
                },
            });
            const newargs = Object.assign({ id }, args);
            this._element.send(request, newargs);
        });
    }
    async prepareSaveToPDF(opts) {
        const [width, height] = getPageWidth(opts.pageSize);
        return this.runRequest('set-width', {
            width: opts.landscape ? height : width,
        });
    }
    async finishSaveToPDF() {
        return this.runRequest('set-width', { width: undefined });
    }
    updateStyles() {
        const styles = [];
        for (const se of atom.styles.getStyleElements()) {
            styles.push(se.innerHTML);
        }
        this._element.send('style', { styles });
    }
}
exports.WebviewHandler = WebviewHandler;
function parsePageSize(size) {
    if (!size)
        return undefined;
    const rx = /^([\d.,]+)(cm|mm|in)?x([\d.,]+)(cm|mm|in)?$/i;
    const res = size.replace(/\s*/g, '').match(rx);
    if (res) {
        const width = parseFloat(res[1]);
        const wunit = res[2];
        const height = parseFloat(res[3]);
        const hunit = res[4];
        return {
            width: convert(width, wunit),
            height: convert(height, hunit),
        };
    }
    else {
        return undefined;
    }
}
function convert(val, unit) {
    return val * unitInMicrons(unit);
}
function unitInMicrons(unit = 'mm') {
    switch (unit) {
        case 'mm':
            return 1000;
        case 'cm':
            return 10000;
        case 'in':
            return 25400;
    }
}
function getPageWidth(pageSize) {
    switch (pageSize) {
        case 'A3':
            return [297, 420];
        case 'A4':
            return [210, 297];
        case 'A5':
            return [148, 210];
        case 'Legal':
            return [216, 356];
        case 'Letter':
            return [216, 279];
        case 'Tabloid':
            return [279, 432];
        default:
            return [pageSize.width / 1000, pageSize.height / 1000];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2Vidmlldy1oYW5kbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL21hcmtkb3duLXByZXZpZXctdmlldy93ZWJ2aWV3LWhhbmRsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx5QkFBd0I7QUFDeEIsK0JBQWlFO0FBQ2pFLHVDQUE0QztBQUM1QyxrREFBa0Q7QUFFbEQsa0NBQW1EO0FBWW5EO0lBY0UsWUFBWSxJQUFnQjtRQWJaLFlBQU8sR0FBRyxJQUFJLGNBQU8sRUFLbEMsQ0FBQTtRQUNPLGdCQUFXLEdBQUcsSUFBSSwwQkFBbUIsRUFBRSxDQUFBO1FBRXpDLGNBQVMsR0FBRyxLQUFLLENBQUE7UUFDakIsY0FBUyxHQUFHLENBQUMsQ0FBQTtRQUNiLG1CQUFjLEdBQUcsSUFBSSxHQUFHLEVBQStCLENBQUE7UUFDdkQsb0JBQWUsR0FBRyxDQUFDLENBQUE7UUFHekIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ2pELElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsRUFBRSxxQkFBcUIsQ0FBQyxDQUFBO1FBQzNFLElBQUksQ0FBQyxRQUFRLENBQUMsa0JBQWtCLEdBQUcsTUFBTSxDQUFBO1FBQ3pDLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQTtRQUN0QyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsR0FBRyxXQUFXLFNBQVMsNkJBQTZCLENBQUE7UUFDckUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQTtRQUNsQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1FBQ25DLElBQUksQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLENBQzVCLGFBQWEsRUFDYixDQUFDLENBQWlDLEVBQUUsRUFBRTtZQUNwQyxR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RSxHQUFHLENBQUMsQ0FBQTtRQUNuQixLQUFLLElBQUk7WUFDUCxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQ25CLEtBQUssSUFBSTtZQUNQLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDbkIsS0FBSyxPQUFPO1lBQ1YsT0FBTyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQTtRQUNuQixLQUFLLFFBQVE7WUFDWCxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFBO1FBQ25CLEtBQUssU0FBUztZQUNaLE9BQU8sQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUE7UUFDbkI7WUFDRSxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssR0FBRyxJQUFJLEVBQUUsUUFBUSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQTtLQUN6RDtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcbmltcG9ydCB7IEVtaXR0ZXIsIENvbXBvc2l0ZURpc3Bvc2FibGUsIENvbmZpZ1ZhbHVlcyB9IGZyb20gJ2F0b20nXG5pbXBvcnQgeyBXZWJ2aWV3VGFnLCBzaGVsbCB9IGZyb20gJ2VsZWN0cm9uJ1xuaW1wb3J0IGZpbGVVcmlUb1BhdGggPSByZXF1aXJlKCdmaWxlLXVyaS10by1wYXRoJylcblxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgYXRvbUNvbmZpZyB9IGZyb20gJy4uL3V0aWwnXG5pbXBvcnQgeyBSZXF1ZXN0UmVwbHlNYXAsIENoYW5uZWxNYXAgfSBmcm9tICcuLi8uLi9zcmMtY2xpZW50L2lwYydcblxuZXhwb3J0IHR5cGUgUmVwbHlDYWxsYmFja1N0cnVjdDxcbiAgVCBleHRlbmRzIGtleW9mIFJlcXVlc3RSZXBseU1hcCA9IGtleW9mIFJlcXVlc3RSZXBseU1hcFxuPiA9IHtcbiAgW0sgaW4ga2V5b2YgUmVxdWVzdFJlcGx5TWFwXToge1xuICAgIHJlcXVlc3Q6IEtcbiAgICBjYWxsYmFjazogKHJlcGx5OiBSZXF1ZXN0UmVwbHlNYXBbS10pID0+IHZvaWRcbiAgfVxufVtUXVxuXG5leHBvcnQgY2xhc3MgV2Vidmlld0hhbmRsZXIge1xuICBwdWJsaWMgcmVhZG9ubHkgZW1pdHRlciA9IG5ldyBFbWl0dGVyPFxuICAgIHt9LFxuICAgIHtcbiAgICAgICdkaWQtc2Nyb2xsLXByZXZpZXcnOiB7IG1pbjogbnVtYmVyOyBtYXg6IG51bWJlciB9XG4gICAgfVxuICA+KClcbiAgcHJvdGVjdGVkIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKVxuICBwcml2YXRlIHJlYWRvbmx5IF9lbGVtZW50OiBXZWJ2aWV3VGFnXG4gIHByaXZhdGUgZGVzdHJveWVkID0gZmFsc2VcbiAgcHJpdmF0ZSB6b29tTGV2ZWwgPSAwXG4gIHByaXZhdGUgcmVwbHlDYWxsYmFja3MgPSBuZXcgTWFwPG51bWJlciwgUmVwbHlDYWxsYmFja1N0cnVjdD4oKVxuICBwcml2YXRlIHJlcGx5Q2FsbGJhY2tJZCA9IDBcblxuICBjb25zdHJ1Y3Rvcihpbml0OiAoKSA9PiB2b2lkKSB7XG4gICAgdGhpcy5fZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3dlYnZpZXcnKVxuICAgIHRoaXMuX2VsZW1lbnQuY2xhc3NMaXN0LmFkZCgnbWFya2Rvd24tcHJldmlldy1wbHVzJywgJ25hdGl2ZS1rZXktYmluZGluZ3MnKVxuICAgIHRoaXMuX2VsZW1lbnQuZGlzYWJsZXdlYnNlY3VyaXR5ID0gJ3RydWUnXG4gICAgdGhpcy5fZWxlbWVudC5ub2RlaW50ZWdyYXRpb24gPSAndHJ1ZSdcbiAgICB0aGlzLl9lbGVtZW50LnNyYyA9IGBmaWxlOi8vLyR7X19kaXJuYW1lfS8uLi8uLi9jbGllbnQvdGVtcGxhdGUuaHRtbGBcbiAgICB0aGlzLl9lbGVtZW50LnN0eWxlLndpZHRoID0gJzEwMCUnXG4gICAgdGhpcy5fZWxlbWVudC5zdHlsZS5oZWlnaHQgPSAnMTAwJSdcbiAgICB0aGlzLl9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICAnaXBjLW1lc3NhZ2UnLFxuICAgICAgKGU6IEVsZWN0cm9uLklwY01lc3NhZ2VFdmVudEN1c3RvbSkgPT4ge1xuICAgICAgICBzd2l0Y2ggKGUuY2hhbm5lbCkge1xuICAgICAgICAgIGNhc2UgJ3pvb20taW4nOlxuICAgICAgICAgICAgdGhpcy56b29tSW4oKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBjYXNlICd6b29tLW91dCc6XG4gICAgICAgICAgICB0aGlzLnpvb21PdXQoKVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICBjYXNlICdkaWQtc2Nyb2xsLXByZXZpZXcnOlxuICAgICAgICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2RpZC1zY3JvbGwtcHJldmlldycsIGUuYXJnc1swXSlcbiAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgLy8gcmVwbGllc1xuICAgICAgICAgIGNhc2UgJ3JlcXVlc3QtcmVwbHknOiB7XG4gICAgICAgICAgICBjb25zdCB7IGlkLCByZXF1ZXN0LCByZXN1bHQgfSA9IGUuYXJnc1swXVxuICAgICAgICAgICAgY29uc3QgY2IgPSB0aGlzLnJlcGx5Q2FsbGJhY2tzLmdldChpZClcbiAgICAgICAgICAgIGlmIChjYiAmJiByZXF1ZXN0ID09PSBjYi5yZXF1ZXN0KSB7XG4gICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrOiAocjogYW55KSA9PiB2b2lkID0gY2IuY2FsbGJhY2tcbiAgICAgICAgICAgICAgY2FsbGJhY2socmVzdWx0KVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgKVxuICAgIHRoaXMuX2VsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignd2lsbC1uYXZpZ2F0ZScsIGFzeW5jIChlKSA9PiB7XG4gICAgICBpZiAoZS51cmwuc3RhcnRzV2l0aCgnZmlsZTovLycpKSB7XG4gICAgICAgIGhhbmRsZVByb21pc2UoYXRvbS53b3Jrc3BhY2Uub3BlbihmaWxlVXJpVG9QYXRoKGUudXJsKSkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzaGVsbC5vcGVuRXh0ZXJuYWwoZS51cmwpXG4gICAgICB9XG4gICAgfSlcblxuICAgIHRoaXMuZGlzcG9zYWJsZXMuYWRkKFxuICAgICAgYXRvbS5zdHlsZXMub25EaWRBZGRTdHlsZUVsZW1lbnQoKCkgPT4ge1xuICAgICAgICB0aGlzLnVwZGF0ZVN0eWxlcygpXG4gICAgICB9KSxcbiAgICAgIGF0b20uc3R5bGVzLm9uRGlkUmVtb3ZlU3R5bGVFbGVtZW50KCgpID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVTdHlsZXMoKVxuICAgICAgfSksXG4gICAgICBhdG9tLnN0eWxlcy5vbkRpZFVwZGF0ZVN0eWxlRWxlbWVudCgoKSA9PiB7XG4gICAgICAgIHRoaXMudXBkYXRlU3R5bGVzKClcbiAgICAgIH0pLFxuICAgIClcblxuICAgIGNvbnN0IG9ubG9hZCA9ICgpID0+IHtcbiAgICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuXG4gICAgICB0aGlzLl9lbGVtZW50LnNldFpvb21MZXZlbCh0aGlzLnpvb21MZXZlbClcbiAgICAgIHRoaXMudXBkYXRlU3R5bGVzKClcbiAgICAgIGluaXQoKVxuICAgIH1cbiAgICB0aGlzLl9lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2RvbS1yZWFkeScsIG9ubG9hZClcbiAgfVxuXG4gIHB1YmxpYyBnZXQgZWxlbWVudCgpOiBIVE1MRWxlbWVudCB7XG4gICAgcmV0dXJuIHRoaXMuX2VsZW1lbnRcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBydW5KUzxUPihqczogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPFQ+KChyZXNvbHZlKSA9PlxuICAgICAgdGhpcy5fZWxlbWVudC5leGVjdXRlSmF2YVNjcmlwdChqcywgZmFsc2UsIHJlc29sdmUpLFxuICAgIClcbiAgfVxuXG4gIHB1YmxpYyBkZXN0cm95KCkge1xuICAgIGlmICh0aGlzLmRlc3Ryb3llZCkgcmV0dXJuXG4gICAgdGhpcy5kZXN0cm95ZWQgPSB0cnVlXG4gICAgdGhpcy5kaXNwb3NhYmxlcy5kaXNwb3NlKClcbiAgICB0aGlzLl9lbGVtZW50LnJlbW92ZSgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgdXBkYXRlKGh0bWw6IHN0cmluZywgcmVuZGVyTGFUZVg6IGJvb2xlYW4pIHtcbiAgICBpZiAodGhpcy5kZXN0cm95ZWQpIHJldHVybiB1bmRlZmluZWRcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCd1cGRhdGUtcHJldmlldycsIHtcbiAgICAgIGh0bWwsXG4gICAgICByZW5kZXJMYVRlWCxcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHNldFNvdXJjZU1hcChtYXA6IHtcbiAgICBbbGluZTogbnVtYmVyXTogeyB0YWc6IHN0cmluZzsgaW5kZXg6IG51bWJlciB9W11cbiAgfSkge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc2V0LXNvdXJjZS1tYXAnPignc2V0LXNvdXJjZS1tYXAnLCB7IG1hcCB9KVxuICB9XG5cbiAgcHVibGljIHNldFVzZUdpdEh1YlN0eWxlKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCd1c2UtZ2l0aHViLXN0eWxlJz4oJ3VzZS1naXRodWItc3R5bGUnLCB7IHZhbHVlIH0pXG4gIH1cblxuICBwdWJsaWMgc2V0QmFzZVBhdGgocGF0aD86IHN0cmluZykge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwnc2V0LWJhc2UtcGF0aCc+KCdzZXQtYmFzZS1wYXRoJywgeyBwYXRoIH0pXG4gIH1cblxuICBwdWJsaWMgaW5pdChcbiAgICBhdG9tSG9tZTogc3RyaW5nLFxuICAgIG1hdGhKYXhDb25maWc6IE1hdGhKYXhDb25maWcsXG4gICAgbWF0aEpheFJlbmRlcmVyID0gYXRvbUNvbmZpZygpLm1hdGhDb25maWcubGF0ZXhSZW5kZXJlcixcbiAgKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdpbml0Jz4oJ2luaXQnLCB7XG4gICAgICBhdG9tSG9tZSxcbiAgICAgIG1hdGhKYXhDb25maWcsXG4gICAgICBtYXRoSmF4UmVuZGVyZXIsXG4gICAgfSlcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVJbWFnZXMob2xkU291cmNlOiBzdHJpbmcsIHZlcnNpb246IG51bWJlciB8IHVuZGVmaW5lZCkge1xuICAgIHRoaXMuX2VsZW1lbnQuc2VuZDwndXBkYXRlLWltYWdlcyc+KCd1cGRhdGUtaW1hZ2VzJywge1xuICAgICAgb2xkc3JjOiBvbGRTb3VyY2UsXG4gICAgICB2OiB2ZXJzaW9uLFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc2F2ZVRvUERGKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgICBjb25zdCBvcHRzID0gYXRvbUNvbmZpZygpLnNhdmVDb25maWcuc2F2ZVRvUERGT3B0aW9uc1xuICAgIGNvbnN0IGN1c3RvbVBhZ2VTaXplID0gcGFyc2VQYWdlU2l6ZShvcHRzLmN1c3RvbVBhZ2VTaXplKVxuICAgIGNvbnN0IHBhZ2VTaXplID0gb3B0cy5wYWdlU2l6ZSA9PT0gJ0N1c3RvbScgPyBjdXN0b21QYWdlU2l6ZSA6IG9wdHMucGFnZVNpemVcbiAgICBpZiAocGFnZVNpemUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIHBhcnNlIGN1c3RvbSBwYWdlIHNpemU6ICR7b3B0cy5jdXN0b21QYWdlU2l6ZX1gLFxuICAgICAgKVxuICAgIH1cbiAgICBjb25zdCBzZWxlY3Rpb24gPSBhd2FpdCB0aGlzLmdldFNlbGVjdGlvbigpXG4gICAgY29uc3QgcHJpbnRTZWxlY3Rpb25Pbmx5ID0gc2VsZWN0aW9uID8gb3B0cy5wcmludFNlbGVjdGlvbk9ubHkgOiBmYWxzZVxuICAgIGNvbnN0IG5ld09wdHMgPSB7XG4gICAgICAuLi5vcHRzLFxuICAgICAgcGFnZVNpemUsXG4gICAgICBwcmludFNlbGVjdGlvbk9ubHksXG4gICAgfVxuICAgIGF3YWl0IHRoaXMucHJlcGFyZVNhdmVUb1BERihuZXdPcHRzKVxuICAgIHRyeSB7XG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgbmV3IFByb21pc2U8QnVmZmVyPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIC8vIFRPRE86IENvbXBsYWluIG9uIEVsZWN0cm9uXG4gICAgICAgIHRoaXMuX2VsZW1lbnQucHJpbnRUb1BERihuZXdPcHRzIGFzIGFueSwgKGVycm9yLCBkYXRhKSA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICB9XG4gICAgICAgICAgcmVzb2x2ZShkYXRhKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlPHZvaWQ+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgZnMud3JpdGVGaWxlKGZpbGVQYXRoLCBkYXRhLCAoZXJyb3IpID0+IHtcbiAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnJvcilcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgIH1cbiAgICAgICAgICByZXNvbHZlKClcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGhhbmRsZVByb21pc2UodGhpcy5maW5pc2hTYXZlVG9QREYoKSlcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc3luYyhsaW5lOiBudW1iZXIsIGZsYXNoOiBib29sZWFuKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdzeW5jJz4oJ3N5bmMnLCB7IGxpbmUsIGZsYXNoIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgc3luY1NvdXJjZSgpIHtcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCdzeW5jLXNvdXJjZScsIHt9KVxuICB9XG5cbiAgcHVibGljIHNjcm9sbFN5bmMoZmlyc3RMaW5lOiBudW1iZXIsIGxhc3RMaW5lOiBudW1iZXIpIHtcbiAgICB0aGlzLl9lbGVtZW50LnNlbmQ8J3Njcm9sbC1zeW5jJz4oJ3Njcm9sbC1zeW5jJywgeyBmaXJzdExpbmUsIGxhc3RMaW5lIH0pXG4gIH1cblxuICBwdWJsaWMgem9vbUluKCkge1xuICAgIHRoaXMuem9vbUxldmVsICs9IDAuMVxuICAgIHRoaXMuX2VsZW1lbnQuc2V0Wm9vbUxldmVsKHRoaXMuem9vbUxldmVsKVxuICB9XG5cbiAgcHVibGljIHpvb21PdXQoKSB7XG4gICAgdGhpcy56b29tTGV2ZWwgLT0gMC4xXG4gICAgdGhpcy5fZWxlbWVudC5zZXRab29tTGV2ZWwodGhpcy56b29tTGV2ZWwpXG4gIH1cblxuICBwdWJsaWMgcmVzZXRab29tKCkge1xuICAgIHRoaXMuem9vbUxldmVsID0gMFxuICAgIHRoaXMuX2VsZW1lbnQuc2V0Wm9vbUxldmVsKHRoaXMuem9vbUxldmVsKVxuICB9XG5cbiAgcHVibGljIHByaW50KCkge1xuICAgIHRoaXMuX2VsZW1lbnQucHJpbnQoKVxuICB9XG5cbiAgcHVibGljIG9wZW5EZXZUb29scygpIHtcbiAgICB0aGlzLl9lbGVtZW50Lm9wZW5EZXZUb29scygpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVsb2FkKCkge1xuICAgIGF3YWl0IHRoaXMucnVuUmVxdWVzdCgncmVsb2FkJywge30pXG4gICAgdGhpcy5fZWxlbWVudC5yZWxvYWQoKVxuICB9XG5cbiAgcHVibGljIGVycm9yKG1zZzogc3RyaW5nKSB7XG4gICAgdGhpcy5fZWxlbWVudC5zZW5kPCdlcnJvcic+KCdlcnJvcicsIHsgbXNnIH0pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0VGVYQ29uZmlnKCkge1xuICAgIHJldHVybiB0aGlzLnJ1blJlcXVlc3QoJ2dldC10ZXgtY29uZmlnJywge30pXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0U2VsZWN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLnJ1blJlcXVlc3QoJ2dldC1zZWxlY3Rpb24nLCB7fSlcbiAgfVxuXG4gIHByb3RlY3RlZCBhc3luYyBydW5SZXF1ZXN0PFQgZXh0ZW5kcyBrZXlvZiBSZXF1ZXN0UmVwbHlNYXA+KFxuICAgIHJlcXVlc3Q6IFQsXG4gICAgYXJnczogeyBbSyBpbiBFeGNsdWRlPGtleW9mIENoYW5uZWxNYXBbVF0sICdpZCc+XTogQ2hhbm5lbE1hcFtUXVtLXSB9LFxuICApIHtcbiAgICBjb25zdCBpZCA9IHRoaXMucmVwbHlDYWxsYmFja0lkKytcbiAgICByZXR1cm4gbmV3IFByb21pc2U8UmVxdWVzdFJlcGx5TWFwW1RdPigocmVzb2x2ZSkgPT4ge1xuICAgICAgdGhpcy5yZXBseUNhbGxiYWNrcy5zZXQoaWQsIHtcbiAgICAgICAgcmVxdWVzdDogcmVxdWVzdCxcbiAgICAgICAgY2FsbGJhY2s6IChyZXN1bHQ6IFJlcXVlc3RSZXBseU1hcFtUXSkgPT4ge1xuICAgICAgICAgIHRoaXMucmVwbHlDYWxsYmFja3MuZGVsZXRlKGlkKVxuICAgICAgICAgIHJlc29sdmUocmVzdWx0KVxuICAgICAgICB9LFxuICAgICAgfSBhcyBSZXBseUNhbGxiYWNrU3RydWN0PFQ+KVxuICAgICAgY29uc3QgbmV3YXJncyA9IE9iamVjdC5hc3NpZ24oeyBpZCB9LCBhcmdzKVxuICAgICAgdGhpcy5fZWxlbWVudC5zZW5kPFQ+KHJlcXVlc3QsIG5ld2FyZ3MpXG4gICAgfSlcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcHJlcGFyZVNhdmVUb1BERihvcHRzOiB7XG4gICAgcGFnZVNpemU6IFBhZ2VTaXplXG4gICAgbGFuZHNjYXBlOiBib29sZWFuXG4gIH0pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBbd2lkdGgsIGhlaWdodF0gPSBnZXRQYWdlV2lkdGgob3B0cy5wYWdlU2l6ZSlcbiAgICByZXR1cm4gdGhpcy5ydW5SZXF1ZXN0KCdzZXQtd2lkdGgnLCB7XG4gICAgICB3aWR0aDogb3B0cy5sYW5kc2NhcGUgPyBoZWlnaHQgOiB3aWR0aCxcbiAgICB9KVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmaW5pc2hTYXZlVG9QREYoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMucnVuUmVxdWVzdCgnc2V0LXdpZHRoJywgeyB3aWR0aDogdW5kZWZpbmVkIH0pXG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVN0eWxlcygpIHtcbiAgICBjb25zdCBzdHlsZXM6IHN0cmluZ1tdID0gW11cbiAgICBmb3IgKGNvbnN0IHNlIG9mIGF0b20uc3R5bGVzLmdldFN0eWxlRWxlbWVudHMoKSkge1xuICAgICAgc3R5bGVzLnB1c2goc2UuaW5uZXJIVE1MKVxuICAgIH1cbiAgICB0aGlzLl9lbGVtZW50LnNlbmQ8J3N0eWxlJz4oJ3N0eWxlJywgeyBzdHlsZXMgfSlcbiAgfVxufVxuXG50eXBlIFVuaXQgPSAnbW0nIHwgJ2NtJyB8ICdpbidcblxuZnVuY3Rpb24gcGFyc2VQYWdlU2l6ZShzaXplOiBzdHJpbmcpIHtcbiAgaWYgKCFzaXplKSByZXR1cm4gdW5kZWZpbmVkXG4gIGNvbnN0IHJ4ID0gL14oW1xcZC4sXSspKGNtfG1tfGluKT94KFtcXGQuLF0rKShjbXxtbXxpbik/JC9pXG4gIGNvbnN0IHJlcyA9IHNpemUucmVwbGFjZSgvXFxzKi9nLCAnJykubWF0Y2gocngpXG4gIGlmIChyZXMpIHtcbiAgICBjb25zdCB3aWR0aCA9IHBhcnNlRmxvYXQocmVzWzFdKVxuICAgIGNvbnN0IHd1bml0ID0gcmVzWzJdIGFzIFVuaXQgfCB1bmRlZmluZWRcbiAgICBjb25zdCBoZWlnaHQgPSBwYXJzZUZsb2F0KHJlc1szXSlcbiAgICBjb25zdCBodW5pdCA9IHJlc1s0XSBhcyBVbml0IHwgdW5kZWZpbmVkXG4gICAgcmV0dXJuIHtcbiAgICAgIHdpZHRoOiBjb252ZXJ0KHdpZHRoLCB3dW5pdCksXG4gICAgICBoZWlnaHQ6IGNvbnZlcnQoaGVpZ2h0LCBodW5pdCksXG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiB1bmRlZmluZWRcbiAgfVxufVxuXG50eXBlIFBhZ2VTaXplID1cbiAgfCBFeGNsdWRlPFxuICAgICAgQ29uZmlnVmFsdWVzWydtYXJrZG93bi1wcmV2aWV3LXBsdXMuc2F2ZUNvbmZpZy5zYXZlVG9QREZPcHRpb25zLnBhZ2VTaXplJ10sXG4gICAgICAnQ3VzdG9tJ1xuICAgID5cbiAgfCB7IHdpZHRoOiBudW1iZXI7IGhlaWdodDogbnVtYmVyIH1cblxuZnVuY3Rpb24gY29udmVydCh2YWw6IG51bWJlciwgdW5pdD86IFVuaXQpIHtcbiAgcmV0dXJuIHZhbCAqIHVuaXRJbk1pY3JvbnModW5pdClcbn1cblxuZnVuY3Rpb24gdW5pdEluTWljcm9ucyh1bml0OiBVbml0ID0gJ21tJykge1xuICBzd2l0Y2ggKHVuaXQpIHtcbiAgICBjYXNlICdtbSc6XG4gICAgICByZXR1cm4gMTAwMFxuICAgIGNhc2UgJ2NtJzpcbiAgICAgIHJldHVybiAxMDAwMFxuICAgIGNhc2UgJ2luJzpcbiAgICAgIHJldHVybiAyNTQwMFxuICB9XG59XG5cbmZ1bmN0aW9uIGdldFBhZ2VXaWR0aChwYWdlU2l6ZTogUGFnZVNpemUpIHtcbiAgc3dpdGNoIChwYWdlU2l6ZSkge1xuICAgIGNhc2UgJ0EzJzpcbiAgICAgIHJldHVybiBbMjk3LCA0MjBdXG4gICAgY2FzZSAnQTQnOlxuICAgICAgcmV0dXJuIFsyMTAsIDI5N11cbiAgICBjYXNlICdBNSc6XG4gICAgICByZXR1cm4gWzE0OCwgMjEwXVxuICAgIGNhc2UgJ0xlZ2FsJzpcbiAgICAgIHJldHVybiBbMjE2LCAzNTZdXG4gICAgY2FzZSAnTGV0dGVyJzpcbiAgICAgIHJldHVybiBbMjE2LCAyNzldXG4gICAgY2FzZSAnVGFibG9pZCc6XG4gICAgICByZXR1cm4gWzI3OSwgNDMyXVxuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gW3BhZ2VTaXplLndpZHRoIC8gMTAwMCwgcGFnZVNpemUuaGVpZ2h0IC8gMTAwMF1cbiAgfVxufVxuIl19