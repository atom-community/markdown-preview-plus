"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function getStyles(context) {
    if (getStylesOverride)
        return getStylesOverride(context);
    const textEditorStyles = document.createElement('atom-styles');
    textEditorStyles.initialize(atom.styles);
    textEditorStyles.setAttribute('context', context);
    return Array.from(textEditorStyles.childNodes).map((styleElement) => styleElement.innerText);
}
exports.getStyles = getStyles;
function getMarkdownPreviewCSS() {
    const markdowPreviewRules = ['body { padding: 0; margin: 0; }'];
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return markdowPreviewRules
        .concat(getStyles('markdown-preview-plus'))
        .concat(getStyles('atom-text-editor'))
        .join('\n')
        .replace(/\batom-text-editor\b/g, 'pre.editor-colors')
        .replace(/\bmarkdown-preview-plus-view\b/g, '.markdown-preview-plus-view')
        .replace(/\b\.\.markdown-preview-plus-view\b/g, '.markdown-preview-plus-view')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'atom-text-editor';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
function buildLineMap(tokens) {
    const lineMap = {};
    const tokenTagCount = {};
    tokenTagCount[0] = {};
    for (const token of tokens) {
        if (token.hidden)
            continue;
        if (token.map == null)
            continue;
        const tag = decodeTag(token);
        if (tag === null)
            continue;
        if (token.nesting === 1) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
            tokenTagCount[token.level + 1] = {};
        }
        else if (token.nesting === 0) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
        }
        const ttc = tokenTagCount[token.level][tag];
        tokenTagCount[token.level][tag] = ttc ? ttc + 1 : 1;
    }
    return lineMap;
}
exports.buildLineMap = buildLineMap;
function mathJaxScript(texConfig) {
    return `\
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    'HTML-CSS': {
      availableFonts: [],
      webFont: 'TeX',
      undefinedFamily: "${util_1.atomConfig().mathConfig.undefinedFamily}",
      mtextFontInherit: true,
    },
    TeX: ${JSON.stringify(texConfig, undefined, 2)},
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>`;
}
function mkHtml(title, html, renderLaTeX, useGithubStyle, texConfig) {
    const githubStyle = useGithubStyle ? ' data-use-github-style' : '';
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = mathJaxScript(texConfig);
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body class="markdown-preview-plus-view"${githubStyle}>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQW1EO0FBRW5ELHFCQUE0QixRQUFnQjtJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUU7UUFDcEQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBRTtZQUMxQixPQUFPLE1BQU0sQ0FBQTtTQUNkO0tBQ0Y7SUFDRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUFpQyxTQUFTLENBQUE7QUFFL0QsZ0NBQXVDLENBQW9CO0lBQ3pELGlCQUFpQixHQUFHLENBQUMsQ0FBQTtBQUN2QixDQUFDO0FBRkQsd0RBRUM7QUFFRCxtQkFBMEIsT0FBZTtJQUN2QyxJQUFJLGlCQUFpQjtRQUFFLE9BQU8saUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDeEQsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUM3QyxhQUFhLENBQzhDLENBQUE7SUFDN0QsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUN4QyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBR2pELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQ2hELENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBRSxZQUFpQyxDQUFDLFNBQVMsQ0FDL0QsQ0FBQTtBQUNILENBQUM7QUFaRCw4QkFZQztBQUVEO0lBQ0UsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLENBQUE7SUFDL0QsTUFBTSxZ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QUFTLENBQUMsQ0FBQTtLQUM5QztTQUFNO1FBQ0wsa0JBQWtCLEdBQUcsRUFBRSxDQUFBO0tBQ3hCO0lBQ0QsT0FBTzs7Ozs7YUFLSSxLQUFLLFdBQVcsa0JBQWtCO2FBQ2xDLHFCQUFxQixFQUFFO0VBQ2xDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUzs7NENBRXVCLFdBQVc7TUFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTOzs7Q0FHeEIsQ0FBQTtBQUNELENBQUM7QUE1QkQsd0JBNEJDO0FBRUQsaUJBQXdCLElBQVk7SUFDbEMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDN0MsSUFBSSxJQUFJO1FBQUUsb0JBQWEsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7QUFDakQsQ0FBQztBQUhELDBCQUdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGV4dEVkaXRvciwgU3R5bGVNYW5hZ2VyIH0gZnJvbSAnYXRvbSdcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcclxuaW1wb3J0IHsgVG9rZW4gfSBmcm9tICdtYXJrZG93bi1pdCdcclxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgYXRvbUNvbmZpZyB9IGZyb20gJy4uL3V0aWwnXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZWRpdG9yRm9ySWQoZWRpdG9ySWQ6IG51bWJlcik6IFRleHRFZGl0b3IgfCB1bmRlZmluZWQge1xyXG4gIGZvciAoY29uc3QgZWRpdG9yIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcclxuICAgIGlmIChlZGl0b3IuaWQgPT09IGVkaXRvcklkKSB7XHJcbiAgICAgIHJldHVybiBlZGl0b3JcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHVuZGVmaW5lZFxyXG59XHJcblxyXG4vLyB0aGlzIHdlaXJkbmVzcyBhbGxvd3Mgb3ZlcnJpZGluZyBpbiB0ZXN0c1xyXG5sZXQgZ2V0U3R5bGVzT3ZlcnJpZGU6IHR5cGVvZiBnZXRTdHlsZXMgfCB1bmRlZmluZWQgPSB1bmRlZmluZWRcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBfX3NldEdldFN0eWxlc092ZXJyaWRlKGY/OiB0eXBlb2YgZ2V0U3R5bGVzKSB7XHJcbiAgZ2V0U3R5bGVzT3ZlcnJpZGUgPSBmXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTdHlsZXMoY29udGV4dDogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gIGlmIChnZXRTdHlsZXNPdmVycmlkZSkgcmV0dXJuIGdldFN0eWxlc092ZXJyaWRlKGNvbnRleHQpXHJcbiAgY29uc3QgdGV4dEVkaXRvclN0eWxlcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXHJcbiAgICAnYXRvbS1zdHlsZXMnLFxyXG4gICkgYXMgSFRNTEVsZW1lbnQgJiB7IGluaXRpYWxpemUoc3R5bGVzOiBTdHlsZU1hbmFnZXIpOiB2b2lkIH1cclxuICB0ZXh0RWRpdG9yU3R5bGVzLmluaXRpYWxpemUoYXRvbS5zdHlsZXMpXHJcbiAgdGV4dEVkaXRvclN0eWxlcy5zZXRBdHRyaWJ1dGUoJ2NvbnRleHQnLCBjb250ZXh0KVxyXG5cclxuICAvLyBFeHRyYWN0IHN0eWxlIGVsZW1lbnRzIGNvbnRlbnRcclxuICByZXR1cm4gQXJyYXkuZnJvbSh0ZXh0RWRpdG9yU3R5bGVzLmNoaWxkTm9kZXMpLm1hcChcclxuICAgIChzdHlsZUVsZW1lbnQpID0+IChzdHlsZUVsZW1lbnQgYXMgSFRNTFN0eWxlRWxlbWVudCkuaW5uZXJUZXh0LFxyXG4gIClcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0TWFya2Rvd25QcmV2aWV3Q1NTKCkge1xyXG4gIGNvbnN0IG1hcmtkb3dQcmV2aWV3UnVsZXMgPSBbJ2JvZHkgeyBwYWRkaW5nOiAwOyBtYXJnaW46IDA7IH0nXVxyXG4gIGNvbnN0IGNzc1VybFJlZkV4cCA9IC91cmxcXChhdG9tOlxcL1xcL21hcmtkb3duLXByZXZpZXctcGx1c1xcL2Fzc2V0c1xcLyguKilcXCkvXHJcblxyXG4gIHJldHVybiBtYXJrZG93UHJldmlld1J1bGVzXHJcbiAgICAuY29uY2F0KGdldFN0eWxlcygnbWFya2Rvd24tcHJldmlldy1wbHVzJykpXHJcbiAgICAuY29uY2F0KGdldFN0eWxlcygnYXRvbS10ZXh0LWVkaXRvcicpKVxyXG4gICAgLmpvaW4oJ1xcbicpXHJcbiAgICAucmVwbGFjZSgvXFxiYXRvbS10ZXh0LWVkaXRvclxcYi9nLCAncHJlLmVkaXRvci1jb2xvcnMnKVxyXG4gICAgLnJlcGxhY2UoL1xcYm1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3XFxiL2csICcubWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXcnKVxyXG4gICAgLnJlcGxhY2UoXHJcbiAgICAgIC9cXGJcXC5cXC5tYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlld1xcYi9nLFxyXG4gICAgICAnLm1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3JyxcclxuICAgIClcclxuICAgIC5yZXBsYWNlKGNzc1VybFJlZkV4cCwgZnVuY3Rpb24oXHJcbiAgICAgIF9tYXRjaCxcclxuICAgICAgYXNzZXRzTmFtZTogc3RyaW5nLFxyXG4gICAgICBfb2Zmc2V0LFxyXG4gICAgICBfc3RyaW5nLFxyXG4gICAgKSB7XHJcbiAgICAgIC8vIGJhc2U2NCBlbmNvZGUgYXNzZXRzXHJcbiAgICAgIGNvbnN0IGFzc2V0UGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9hc3NldHMnLCBhc3NldHNOYW1lKVxyXG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBmcy5yZWFkRmlsZVN5bmMoYXNzZXRQYXRoLCAnYmluYXJ5JylcclxuICAgICAgY29uc3QgYmFzZTY0RGF0YSA9IG5ldyBCdWZmZXIob3JpZ2luYWxEYXRhLCAnYmluYXJ5JykudG9TdHJpbmcoJ2Jhc2U2NCcpXHJcbiAgICAgIHJldHVybiBgdXJsKCdkYXRhOmltYWdlL2pwZWc7YmFzZTY0LCR7YmFzZTY0RGF0YX0nKWBcclxuICAgIH0pXHJcbn1cclxuXHJcbi8vXHJcbi8vIERlY29kZSB0YWdzIHVzZWQgYnkgbWFya2Rvd24taXRcclxuLy9cclxuLy8gQHBhcmFtIHttYXJrZG93bi1pdC5Ub2tlbn0gdG9rZW4gRGVjb2RlIHRoZSB0YWcgb2YgdG9rZW4uXHJcbi8vIEByZXR1cm4ge3N0cmluZ3xudWxsfSBEZWNvZGVkIHRhZyBvciBgbnVsbGAgaWYgdGhlIHRva2VuIGhhcyBubyB0YWcuXHJcbi8vXHJcbmZ1bmN0aW9uIGRlY29kZVRhZyh0b2tlbjogVG9rZW4pOiBzdHJpbmcgfCBudWxsIHtcclxuICBpZiAodG9rZW4udGFnID09PSAnbWF0aCcpIHtcclxuICAgIHJldHVybiAnc3BhbidcclxuICB9XHJcbiAgaWYgKHRva2VuLnRhZyA9PT0gJ2NvZGUnKSB7XHJcbiAgICByZXR1cm4gJ2F0b20tdGV4dC1lZGl0b3InXHJcbiAgfVxyXG4gIGlmICh0b2tlbi50YWcgPT09ICcnKSB7XHJcbiAgICByZXR1cm4gbnVsbFxyXG4gIH1cclxuICByZXR1cm4gdG9rZW4udGFnXHJcbn1cclxuXHJcbi8vXHJcbi8vIERldGVybWluZSBwYXRoIHRvIGEgdGFyZ2V0IHRva2VuLlxyXG4vL1xyXG4vLyBAcGFyYW0geyhtYXJrZG93bi1pdC5Ub2tlbilbXX0gdG9rZW5zIEFycmF5IG9mIHRva2VucyBhcyByZXR1cm5lZCBieVxyXG4vLyAgIGBtYXJrZG93bi1pdC5wYXJzZSgpYC5cclxuLy8gQHBhcmFtIHtudW1iZXJ9IGxpbmUgTGluZSByZXByZXNlbnRpbmcgdGhlIHRhcmdldCB0b2tlbi5cclxuLy8gQHJldHVybiB7KHRhZzogPHRhZz4sIGluZGV4OiA8aW5kZXg+KVtdfSBBcnJheSByZXByZXNlbnRpbmcgYSBwYXRoIHRvIHRoZVxyXG4vLyAgIHRhcmdldCB0b2tlbi4gVGhlIHJvb3QgdG9rZW4gaXMgcmVwcmVzZW50ZWQgYnkgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlXHJcbi8vICAgYXJyYXkgYW5kIHRoZSB0YXJnZXQgdG9rZW4gYnkgdGhlIGxhc3QgZWxtZW50LiBFYWNoIGVsZW1lbnQgY29uc2lzdHMgb2YgYVxyXG4vLyAgIGB0YWdgIGFuZCBgaW5kZXhgIHJlcHJlc2VudGluZyBpdHMgaW5kZXggYW1vbmdzdCBpdHMgc2libGluZyB0b2tlbnMgaW5cclxuLy8gICBgdG9rZW5zYCBvZiB0aGUgc2FtZSBgdGFnYC4gYGxpbmVgIHdpbGwgbGllIGJldHdlZW4gdGhlIHByb3BlcnRpZXNcclxuLy8gICBgbWFwWzBdYCBhbmQgYG1hcFsxXWAgb2YgdGhlIHRhcmdldCB0b2tlbi5cclxuLy9cclxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkTGluZU1hcCh0b2tlbnM6IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHk8VG9rZW4+Pikge1xyXG4gIGNvbnN0IGxpbmVNYXA6IHsgW2xpbmU6IG51bWJlcl06IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4gfSA9IHt9XHJcbiAgY29uc3QgdG9rZW5UYWdDb3VudDogeyBbbGluZTogbnVtYmVyXTogeyBbdGFnOiBzdHJpbmddOiBudW1iZXIgfSB9ID0ge31cclxuICB0b2tlblRhZ0NvdW50WzBdID0ge31cclxuXHJcbiAgZm9yIChjb25zdCB0b2tlbiBvZiB0b2tlbnMpIHtcclxuICAgIGlmICh0b2tlbi5oaWRkZW4pIGNvbnRpbnVlXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlcyAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxyXG4gICAgaWYgKHRva2VuLm1hcCA9PSBudWxsKSBjb250aW51ZVxyXG5cclxuICAgIGNvbnN0IHRhZyA9IGRlY29kZVRhZyh0b2tlbilcclxuICAgIGlmICh0YWcgPT09IG51bGwpIGNvbnRpbnVlXHJcblxyXG4gICAgaWYgKHRva2VuLm5lc3RpbmcgPT09IDEpIHtcclxuICAgICAgLy8gb3BlbmluZyB0YWdcclxuICAgICAgZm9yIChsZXQgbGluZSA9IHRva2VuLm1hcFswXTsgbGluZSA8IHRva2VuLm1hcFsxXTsgbGluZSArPSAxKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcclxuICAgICAgICBpZiAobGluZU1hcFtsaW5lXSA9PSBudWxsKSBsaW5lTWFwW2xpbmVdID0gW11cclxuICAgICAgICBsaW5lTWFwW2xpbmVdLnB1c2goe1xyXG4gICAgICAgICAgdGFnOiB0YWcsXHJcbiAgICAgICAgICBpbmRleDogdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbF1bdGFnXSB8fCAwLFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgICAgdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbCArIDFdID0ge31cclxuICAgIH0gZWxzZSBpZiAodG9rZW4ubmVzdGluZyA9PT0gMCkge1xyXG4gICAgICAvLyBzZWxmLWNsb3NpbmcgdGFnXHJcbiAgICAgIGZvciAobGV0IGxpbmUgPSB0b2tlbi5tYXBbMF07IGxpbmUgPCB0b2tlbi5tYXBbMV07IGxpbmUgKz0gMSkge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzXHJcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXHJcbiAgICAgICAgbGluZU1hcFtsaW5lXS5wdXNoKHtcclxuICAgICAgICAgIHRhZzogdGFnLFxyXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCB0dGMgPSB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddXHJcbiAgICB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddID0gdHRjID8gdHRjICsgMSA6IDFcclxuICB9XHJcblxyXG4gIHJldHVybiBsaW5lTWFwXHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1hdGhKYXhTY3JpcHQodGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yKSB7XHJcbiAgcmV0dXJuIGBcXFxyXG48c2NyaXB0IHR5cGU9XCJ0ZXh0L3gtbWF0aGpheC1jb25maWdcIj5cclxuICBNYXRoSmF4Lkh1Yi5Db25maWcoe1xyXG4gICAgamF4OiBbXCJpbnB1dC9UZVhcIixcIm91dHB1dC9IVE1MLUNTU1wiXSxcclxuICAgIGV4dGVuc2lvbnM6IFtcIlthMTF5XS9hY2Nlc3NpYmlsaXR5LW1lbnUuanNcIl0sXHJcbiAgICAnSFRNTC1DU1MnOiB7XHJcbiAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcclxuICAgICAgd2ViRm9udDogJ1RlWCcsXHJcbiAgICAgIHVuZGVmaW5lZEZhbWlseTogXCIke2F0b21Db25maWcoKS5tYXRoQ29uZmlnLnVuZGVmaW5lZEZhbWlseX1cIixcclxuICAgICAgbXRleHRGb250SW5oZXJpdDogdHJ1ZSxcclxuICAgIH0sXHJcbiAgICBUZVg6ICR7SlNPTi5zdHJpbmdpZnkodGV4Q29uZmlnLCB1bmRlZmluZWQsIDIpfSxcclxuICAgIHNob3dNYXRoTWVudTogdHJ1ZVxyXG4gIH0pO1xyXG48L3NjcmlwdD5cclxuPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCIgc3JjPVwiaHR0cHM6Ly9jZG5qcy5jbG91ZGZsYXJlLmNvbS9hamF4L2xpYnMvbWF0aGpheC8yLjcuNC9NYXRoSmF4LmpzXCI+PC9zY3JpcHQ+YFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWtIdG1sKFxyXG4gIHRpdGxlOiBzdHJpbmcsXHJcbiAgaHRtbDogSFRNTERvY3VtZW50LFxyXG4gIHJlbmRlckxhVGVYOiBib29sZWFuLFxyXG4gIHVzZUdpdGh1YlN0eWxlOiBib29sZWFuLFxyXG4gIHRleENvbmZpZzogTWF0aEpheC5UZVhJbnB1dFByb2Nlc3NvcixcclxuKSB7XHJcbiAgY29uc3QgZ2l0aHViU3R5bGUgPSB1c2VHaXRodWJTdHlsZSA/ICcgZGF0YS11c2UtZ2l0aHViLXN0eWxlJyA6ICcnXHJcbiAgbGV0IG1heWJlTWF0aEpheFNjcmlwdDogc3RyaW5nXHJcbiAgaWYgKHJlbmRlckxhVGVYKSB7XHJcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSBtYXRoSmF4U2NyaXB0KHRleENvbmZpZylcclxuICB9IGVsc2Uge1xyXG4gICAgbWF5YmVNYXRoSmF4U2NyaXB0ID0gJydcclxuICB9XHJcbiAgcmV0dXJuIGBcXFxyXG48IURPQ1RZUEUgaHRtbD5cclxuPGh0bWw+XHJcbiAgPGhlYWQ+XHJcbiAgICA8bWV0YSBjaGFyc2V0PVwidXRmLThcIiAvPlxyXG4gICAgPHRpdGxlPiR7dGl0bGV9PC90aXRsZT4ke21heWJlTWF0aEpheFNjcmlwdH1cclxuICAgIDxzdHlsZT4ke2dldE1hcmtkb3duUHJldmlld0NTUygpfTwvc3R5bGU+XHJcbiR7aHRtbC5oZWFkLmlubmVySFRNTH1cclxuICA8L2hlYWQ+XHJcbiAgPGJvZHkgY2xhc3M9XCJtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlld1wiJHtnaXRodWJTdHlsZX0+XHJcbiAgICAke2h0bWwuYm9keS5pbm5lckhUTUx9XHJcbiAgPC9ib2R5PlxyXG48L2h0bWw+XHJcbmAgLy8gRW5zdXJlIHRyYWlsaW5nIG5ld2xpbmVcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGRlc3Ryb3koaXRlbTogb2JqZWN0KSB7XHJcbiAgY29uc3QgcGFuZSA9IGF0b20ud29ya3NwYWNlLnBhbmVGb3JJdGVtKGl0ZW0pXHJcbiAgaWYgKHBhbmUpIGhhbmRsZVByb21pc2UocGFuZS5kZXN0cm95SXRlbShpdGVtKSlcclxufVxyXG4iXX0=