"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function* getStyles(context) {
    const elements = atom.styles.getStyleElements();
    for (const element of elements) {
        if (context === undefined || element.getAttribute('context') === context) {
            yield element.innerText;
        }
    }
}
function getClientStyle(file) {
    return atom.themes.loadStylesheet(path.join(__dirname, '..', '..', 'styles-client', `${file}.less`));
}
function getUserStyles() {
    const el = atom.styles.styleElementsBySourcePath[atom.styles.getUserStyleSheetPath()];
    if (!el)
        return [];
    return [el.innerText];
}
exports.getUserStyles = getUserStyles;
function getSyntaxTheme(themeName) {
    if (themeName !== '') {
        const themes = atom.themes.getLoadedThemes();
        if (themes) {
            const [theme] = themes.filter((x) => x.name === themeName);
            if (theme) {
                const stshts = theme
                    .getStylesheetPaths()
                    .map((p) => atom.themes.loadStylesheet(p));
                return processEditorStyles(stshts);
            }
        }
        atom.notifications.addWarning('Failed to load syntax theme', {
            detail: `Markdown-preview-plus couldn't find '${themeName}'`,
        });
    }
    return processEditorStyles(getStyles('atom-text-editor'));
}
function* getActivePackageStyles(packageName) {
    const pack = atom.packages.getActivePackage(packageName);
    if (!pack)
        return undefined;
    const stylesheets = pack.getStylesheetPaths();
    for (const ss of stylesheets) {
        const element = atom.styles.styleElementsBySourcePath[ss];
        if (element)
            yield element.innerText;
    }
}
function getPreviewStyles(display) {
    if (getStylesOverride)
        return getStylesOverride(display);
    const styles = [];
    if (display) {
        const globalStyles = atom.styles.styleElementsBySourcePath['global-text-editor-styles'];
        if (globalStyles) {
            styles.push(...processWorkspaceStyles([globalStyles.innerText]));
        }
        styles.push(getClientStyle('editor-global-font'));
        const packList = util_1.atomConfig().importPackageStyles;
        if (packList.includes('*')) {
            styles.push(...processEditorStyles(getStyles()));
            styles.push(getClientStyle('patch'));
        }
        else {
            for (const pack of packList) {
                styles.push(...processEditorStyles(getActivePackageStyles(pack)));
            }
            if (packList.includes('fonts')) {
                const fontsVar = atom.styles.styleElementsBySourcePath['fonts-package-editorfont'];
                if (fontsVar)
                    styles.push(...processEditorStyles([fontsVar.innerText]));
            }
        }
    }
    styles.push(getClientStyle('generic'));
    if (display)
        styles.push(getClientStyle('display'));
    if (util_1.atomConfig().useGitHubStyle) {
        styles.push(getClientStyle('github'));
    }
    else {
        styles.push(getClientStyle('default'));
    }
    styles.push(...getSyntaxTheme(util_1.atomConfig().syntaxThemeName));
    styles.push(...processEditorStyles(getUserStyles()));
    styles.push(getClientStyle('less-api'));
    return styles;
}
exports.getPreviewStyles = getPreviewStyles;
function* processEditorStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-text-editor\b/g, 'pre.editor-colors');
    }
}
function* processWorkspaceStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-workspace\b/g, ':root');
    }
}
function getMarkdownPreviewCSS() {
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return getPreviewStyles(false)
        .join('\n')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'atom-text-editor';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
function buildLineMap(tokens) {
    const lineMap = {};
    const tokenTagCount = {};
    tokenTagCount[0] = {};
    for (const token of tokens) {
        if (token.hidden)
            continue;
        if (token.map == null)
            continue;
        const tag = decodeTag(token);
        if (tag === null)
            continue;
        if (token.nesting === 1) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
            tokenTagCount[token.level + 1] = {};
        }
        else if (token.nesting === 0) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
        }
        const ttc = tokenTagCount[token.level][tag];
        tokenTagCount[token.level][tag] = ttc ? ttc + 1 : 1;
    }
    return lineMap;
}
exports.buildLineMap = buildLineMap;
function mathJaxScript(texConfig) {
    return `\
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    'HTML-CSS': {
      availableFonts: [],
      webFont: 'TeX',
      undefinedFamily: ${JSON.stringify(util_1.atomConfig().mathConfig.undefinedFamily)},
      mtextFontInherit: true,
    },
    TeX: ${JSON.stringify(texConfig, undefined, 2)},
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>`;
}
function mkHtml(title, html, renderLaTeX, texConfig) {
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = mathJaxScript(texConfig);
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQW1EO0FBRW5ELFNBQWdCLFdBQVcsQ0FBQyxRQUFnQjtJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUU7UUFDcEQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBRTtZQUMxQixPQUFPLE1BQU0sQ0FBQTtTQUNkO0tBQ0Y7SUFDRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUF3QyxTQUFTLENBQUE7QUFFdEUsU0FBZ0Isc0JBQXNCLENBQUMsQ0FBMkI7SUFDaEUsaUJBQWlCLEdBQUcsQ0FBQyxDQUFBO0FBQ3ZCLENBQUM7QUFGRCx3REFFQztBQUVELFFBQVEsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUF1QjtJQUN6QyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixFQUFFLENBQUE7SUFFL0MsS0FBSyxNQUFNLE9BQU8sSUFBSSxRQUFRLEVBQUU7UUFDOUIsSUFBSSxPQUFPLEtBQUssU0FBUyxJQUFJLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLEtBQUssT0FBTyxFQUFFO1lBQ3hFLE1BQU0sT0FBTyxDQUFDLFNBQVMsQ0FBQTtTQUN4QjtLQUNGO0FBQ0gsQ0FBQztBQUVELFNBQVMsY0FBYyxDQUFDLElBQVk7SUFDbEMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxlQUFlLEVBQUUsR0FBRyxJQUFJLE9BQU8sQ0FBQyxDQUNsRSxDQUFBO0FBQ0gs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YixJQUFrQixFQUNsQixXQUFvQixFQUNwQixTQUFvQztJQUVwQyxJQUFJLGtCQUEwQixDQUFBO0lBQzlCLElBQUksV0FBVyxFQUFFO1FBQ2Ysa0JBQWtCLEdBQUcsYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFBO0tBQzlDO1NBQU07UUFDTCxrQkFBa0IsR0FBRyxFQUFFLENBQUE7S0FDeEI7SUFDRCxPQUFPOzs7OzthQUtJLEtBQUssV0FBVyxrQkFBa0I7YUFDbEMscUJBQXFCLEVBQUU7RUFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTOzs7TUFHZixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7OztDQUd4QixDQUFBO0FBQ0QsQ0FBQztBQTFCRCx3QkEwQkM7QUFFRCxTQUFnQixPQUFPLENBQUMsSUFBWTtJQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM3QyxJQUFJLElBQUk7UUFBRSxvQkFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtBQUNqRCxDQUFDO0FBSEQsMEJBR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0RWRpdG9yIH0gZnJvbSAnYXRvbSdcclxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJ1xyXG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcydcclxuaW1wb3J0IHsgVG9rZW4gfSBmcm9tICdtYXJrZG93bi1pdCdcclxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgYXRvbUNvbmZpZyB9IGZyb20gJy4uL3V0aWwnXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZWRpdG9yRm9ySWQoZWRpdG9ySWQ6IG51bWJlcik6IFRleHRFZGl0b3IgfCB1bmRlZmluZWQge1xyXG4gIGZvciAoY29uc3QgZWRpdG9yIG9mIGF0b20ud29ya3NwYWNlLmdldFRleHRFZGl0b3JzKCkpIHtcclxuICAgIGlmIChlZGl0b3IuaWQgPT09IGVkaXRvcklkKSB7XHJcbiAgICAgIHJldHVybiBlZGl0b3JcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIHVuZGVmaW5lZFxyXG59XHJcblxyXG4vLyB0aGlzIHdlaXJkbmVzcyBhbGxvd3Mgb3ZlcnJpZGluZyBpbiB0ZXN0c1xyXG5sZXQgZ2V0U3R5bGVzT3ZlcnJpZGU6IHR5cGVvZiBnZXRQcmV2aWV3U3R5bGVzIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gX19zZXRHZXRTdHlsZXNPdmVycmlkZShmPzogdHlwZW9mIGdldFByZXZpZXdTdHlsZXMpIHtcclxuICBnZXRTdHlsZXNPdmVycmlkZSA9IGZcclxufVxyXG5cclxuZnVuY3Rpb24qIGdldFN0eWxlcyhjb250ZXh0Pzogc3RyaW5nIHwgbnVsbCk6IEl0ZXJhYmxlSXRlcmF0b3I8c3RyaW5nPiB7XHJcbiAgY29uc3QgZWxlbWVudHMgPSBhdG9tLnN0eWxlcy5nZXRTdHlsZUVsZW1lbnRzKClcclxuXHJcbiAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7XHJcbiAgICBpZiAoY29udGV4dCA9PT0gdW5kZWZpbmVkIHx8IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjb250ZXh0JykgPT09IGNvbnRleHQpIHtcclxuICAgICAgeWllbGQgZWxlbWVudC5pbm5lclRleHRcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldENsaWVudFN0eWxlKGZpbGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgcmV0dXJuIGF0b20udGhlbWVzLmxvYWRTdHlsZXNoZWV0KFxyXG4gICAgcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3N0eWxlcy1jbGllbnQnLCBgJHtmaWxlfS5sZXNzYCksXHJcbiAgKVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VXNlclN0eWxlcygpIHtcclxuICBjb25zdCBlbCA9XHJcbiAgICBhdG9tLnN0eWxlcy5zdHlsZUVsZW1lbnRzQnlTb3VyY2VQYXRoW2F0b20uc3R5bGVzLmdldFVzZXJTdHlsZVNoZWV0UGF0aCgpXVxyXG4gIGlmICghZWwpIHJldHVybiBbXVxyXG4gIHJldHVybiBbZWwuaW5uZXJUZXh0XVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRTeW50YXhUaGVtZSh0aGVtZU5hbWU6IHN0cmluZyk6IEl0ZXJhYmxlPHN0cmluZz4ge1xyXG4gIGlmICh0aGVtZU5hbWUgIT09ICcnKSB7XHJcbiAgICBjb25zdCB0aGVtZXMgPSBhdG9tLnRoZW1lcy5nZXRMb2FkZWRUaGVtZXMoKVxyXG4gICAgaWYgKHRoZW1lcykge1xyXG4gICAgICBjb25zdCBbdGhlbWVdID0gdGhlbWVzLmZpbHRlcigoeCkgPT4geC5uYW1lID09PSB0aGVtZU5hbWUpXHJcbiAgICAgIGlmICh0aGVtZSkge1xyXG4gICAgICAgIGNvbnN0IHN0c2h0cyA9IHRoZW1lXHJcbiAgICAgICAgICAuZ2V0U3R5bGVzaGVldFBhdGhzKClcclxuICAgICAgICAgIC5tYXAoKHApID0+IGF0b20udGhlbWVzLmxvYWRTdHlsZXNoZWV0KHApKVxyXG4gICAgICAgIHJldHVybiBwcm9jZXNzRWRpdG9yU3R5bGVzKHN0c2h0cylcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoJ0ZhaWxlZCB0byBsb2FkIHN5bnRheCB0aGVtZScsIHtcclxuICAgICAgZGV0YWlsOiBgTWFya2Rvd24tcHJldmlldy1wbHVzIGNvdWxkbid0IGZpbmQgJyR7dGhlbWVOYW1lfSdgLFxyXG4gICAgfSlcclxuICB9XHJcbiAgLy8gZGVmYXVsdFxyXG4gIHJldHVybiBwcm9jZXNzRWRpdG9yU3R5bGVzKGdldFN0eWxlcygnYXRvbS10ZXh0LWVkaXRvcicpKVxyXG59XHJcblxyXG5mdW5jdGlvbiogZ2V0QWN0aXZlUGFja2FnZVN0eWxlcyhcclxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxyXG4pOiBJdGVyYWJsZUl0ZXJhdG9yPHN0cmluZz4ge1xyXG4gIGNvbnN0IHBhY2sgPSBhdG9tLnBhY2thZ2VzLmdldEFjdGl2ZVBhY2thZ2UocGFja2FnZU5hbWUpXHJcbiAgaWYgKCFwYWNrKSByZXR1cm4gdW5kZWZpbmVkXHJcbiAgY29uc3Qgc3R5bGVzaGVldHMgPSBwYWNrLmdldFN0eWxlc2hlZXRQYXRocygpXHJcbiAgZm9yIChjb25zdCBzcyBvZiBzdHlsZXNoZWV0cykge1xyXG4gICAgY29uc3QgZWxlbWVudCA9IGF0b20uc3R5bGVzLnN0eWxlRWxlbWVudHNCeVNvdXJjZVBhdGhbc3NdXHJcbiAgICBpZiAoZWxlbWVudCkgeWllbGQgZWxlbWVudC5pbm5lclRleHRcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQcmV2aWV3U3R5bGVzKGRpc3BsYXk6IGJvb2xlYW4pOiBzdHJpbmdbXSB7XHJcbiAgaWYgKGdldFN0eWxlc092ZXJyaWRlKSByZXR1cm4gZ2V0U3R5bGVzT3ZlcnJpZGUoZGlzcGxheSlcclxuICBjb25zdCBzdHlsZXMgPSBbXVxyXG4gIGlmIChkaXNwbGF5KSB7XHJcbiAgICAvLyBnbG9iYWwgZWRpdG9yIHN0eWxlc1xyXG4gICAgY29uc3QgZ2xvYmFsU3R5bGVzID1cclxuICAgICAgYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFsnZ2xvYmFsLXRleHQtZWRpdG9yLXN0eWxlcyddXHJcbiAgICBpZiAoZ2xvYmFsU3R5bGVzKSB7XHJcbiAgICAgIHN0eWxlcy5wdXNoKC4uLnByb2Nlc3NXb3Jrc3BhY2VTdHlsZXMoW2dsb2JhbFN0eWxlcy5pbm5lclRleHRdKSlcclxuICAgIH1cclxuICAgIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdlZGl0b3ItZ2xvYmFsLWZvbnQnKSlcclxuICAgIC8vIHBhY2thZ2Ugc3R5bGVzXHJcbiAgICBjb25zdCBwYWNrTGlzdCA9IGF0b21Db25maWcoKS5pbXBvcnRQYWNrYWdlU3R5bGVzXHJcbiAgICBpZiAocGFja0xpc3QuaW5jbHVkZXMoJyonKSkge1xyXG4gICAgICBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKGdldFN0eWxlcygpKSlcclxuICAgICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ3BhdGNoJykpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBmb3IgKGNvbnN0IHBhY2sgb2YgcGFja0xpc3QpIHtcclxuICAgICAgICBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKGdldEFjdGl2ZVBhY2thZ2VTdHlsZXMocGFjaykpKVxyXG4gICAgICB9XHJcbiAgICAgIC8vIGV4cGxpY2l0IGNvbXBhdGliaWxpdHkgd2l0aCB0aGUgZm9udHMgcGFja2FnZVxyXG4gICAgICBpZiAocGFja0xpc3QuaW5jbHVkZXMoJ2ZvbnRzJykpIHtcclxuICAgICAgICBjb25zdCBmb250c1ZhciA9XHJcbiAgICAgICAgICBhdG9tLnN0eWxlcy5zdHlsZUVsZW1lbnRzQnlTb3VyY2VQYXRoWydmb250cy1wYWNrYWdlLWVkaXRvcmZvbnQnXVxyXG4gICAgICAgIGlmIChmb250c1Zhcikgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc0VkaXRvclN0eWxlcyhbZm9udHNWYXIuaW5uZXJUZXh0XSkpXHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdnZW5lcmljJykpXHJcbiAgaWYgKGRpc3BsYXkpIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdkaXNwbGF5JykpXHJcbiAgaWYgKGF0b21Db25maWcoKS51c2VHaXRIdWJTdHlsZSkge1xyXG4gICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2dpdGh1YicpKVxyXG4gIH0gZWxzZSB7XHJcbiAgICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZGVmYXVsdCcpKVxyXG4gIH1cclxuICBzdHlsZXMucHVzaCguLi5nZXRTeW50YXhUaGVtZShhdG9tQ29uZmlnKCkuc3ludGF4VGhlbWVOYW1lKSlcclxuICBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKGdldFVzZXJTdHlsZXMoKSkpXHJcbiAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2xlc3MtYXBpJykpXHJcbiAgcmV0dXJuIHN0eWxlc1xyXG59XHJcblxyXG5mdW5jdGlvbiogcHJvY2Vzc0VkaXRvclN0eWxlcyhzdHlsZXM6IEl0ZXJhYmxlPHN0cmluZz4pIHtcclxuICBmb3IgKGNvbnN0IHN0eWxlIG9mIHN0eWxlcykge1xyXG4gICAgeWllbGQgc3R5bGUucmVwbGFjZSgvXFxiYXRvbS10ZXh0LWVkaXRvclxcYi9nLCAncHJlLmVkaXRvci1jb2xvcnMnKVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24qIHByb2Nlc3NXb3Jrc3BhY2VTdHlsZXMoc3R5bGVzOiBJdGVyYWJsZTxzdHJpbmc+KSB7XHJcbiAgZm9yIChjb25zdCBzdHlsZSBvZiBzdHlsZXMpIHtcclxuICAgIHlpZWxkIHN0eWxlLnJlcGxhY2UoL1xcYmF0b20td29ya3NwYWNlXFxiL2csICc6cm9vdCcpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRNYXJrZG93blByZXZpZXdDU1MoKSB7XHJcbiAgY29uc3QgY3NzVXJsUmVmRXhwID0gL3VybFxcKGF0b206XFwvXFwvbWFya2Rvd24tcHJldmlldy1wbHVzXFwvYXNzZXRzXFwvKC4qKVxcKS9cclxuXHJcbiAgcmV0dXJuIGdldFByZXZpZXdTdHlsZXMoZmFsc2UpXHJcbiAgICAuam9pbignXFxuJylcclxuICAgIC5yZXBsYWNlKGNzc1VybFJlZkV4cCwgZnVuY3Rpb24oXHJcbiAgICAgIF9tYXRjaCxcclxuICAgICAgYXNzZXRzTmFtZTogc3RyaW5nLFxyXG4gICAgICBfb2Zmc2V0LFxyXG4gICAgICBfc3RyaW5nLFxyXG4gICAgKSB7XHJcbiAgICAgIC8vIGJhc2U2NCBlbmNvZGUgYXNzZXRzXHJcbiAgICAgIGNvbnN0IGFzc2V0UGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi9hc3NldHMnLCBhc3NldHNOYW1lKVxyXG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBmcy5yZWFkRmlsZVN5bmMoYXNzZXRQYXRoLCAnYmluYXJ5JylcclxuICAgICAgY29uc3QgYmFzZTY0RGF0YSA9IG5ldyBCdWZmZXIob3JpZ2luYWxEYXRhLCAnYmluYXJ5JykudG9TdHJpbmcoJ2Jhc2U2NCcpXHJcbiAgICAgIHJldHVybiBgdXJsKCdkYXRhOmltYWdlL2pwZWc7YmFzZTY0LCR7YmFzZTY0RGF0YX0nKWBcclxuICAgIH0pXHJcbn1cclxuXHJcbi8vXHJcbi8vIERlY29kZSB0YWdzIHVzZWQgYnkgbWFya2Rvd24taXRcclxuLy9cclxuLy8gQHBhcmFtIHttYXJrZG93bi1pdC5Ub2tlbn0gdG9rZW4gRGVjb2RlIHRoZSB0YWcgb2YgdG9rZW4uXHJcbi8vIEByZXR1cm4ge3N0cmluZ3xudWxsfSBEZWNvZGVkIHRhZyBvciBgbnVsbGAgaWYgdGhlIHRva2VuIGhhcyBubyB0YWcuXHJcbi8vXHJcbmZ1bmN0aW9uIGRlY29kZVRhZyh0b2tlbjogVG9rZW4pOiBzdHJpbmcgfCBudWxsIHtcclxuICBpZiAodG9rZW4udGFnID09PSAnbWF0aCcpIHtcclxuICAgIHJldHVybiAnc3BhbidcclxuICB9XHJcbiAgaWYgKHRva2VuLnRhZyA9PT0gJ2NvZGUnKSB7XHJcbiAgICByZXR1cm4gJ2F0b20tdGV4dC1lZGl0b3InXHJcbiAgfVxyXG4gIGlmICh0b2tlbi50YWcgPT09ICcnKSB7XHJcbiAgICByZXR1cm4gbnVsbFxyXG4gIH1cclxuICByZXR1cm4gdG9rZW4udGFnXHJcbn1cclxuXHJcbi8vXHJcbi8vIERldGVybWluZSBwYXRoIHRvIGEgdGFyZ2V0IHRva2VuLlxyXG4vL1xyXG4vLyBAcGFyYW0geyhtYXJrZG93bi1pdC5Ub2tlbilbXX0gdG9rZW5zIEFycmF5IG9mIHRva2VucyBhcyByZXR1cm5lZCBieVxyXG4vLyAgIGBtYXJrZG93bi1pdC5wYXJzZSgpYC5cclxuLy8gQHBhcmFtIHtudW1iZXJ9IGxpbmUgTGluZSByZXByZXNlbnRpbmcgdGhlIHRhcmdldCB0b2tlbi5cclxuLy8gQHJldHVybiB7KHRhZzogPHRhZz4sIGluZGV4OiA8aW5kZXg+KVtdfSBBcnJheSByZXByZXNlbnRpbmcgYSBwYXRoIHRvIHRoZVxyXG4vLyAgIHRhcmdldCB0b2tlbi4gVGhlIHJvb3QgdG9rZW4gaXMgcmVwcmVzZW50ZWQgYnkgdGhlIGZpcnN0IGVsZW1lbnQgaW4gdGhlXHJcbi8vICAgYXJyYXkgYW5kIHRoZSB0YXJnZXQgdG9rZW4gYnkgdGhlIGxhc3QgZWxtZW50LiBFYWNoIGVsZW1lbnQgY29uc2lzdHMgb2YgYVxyXG4vLyAgIGB0YWdgIGFuZCBgaW5kZXhgIHJlcHJlc2VudGluZyBpdHMgaW5kZXggYW1vbmdzdCBpdHMgc2libGluZyB0b2tlbnMgaW5cclxuLy8gICBgdG9rZW5zYCBvZiB0aGUgc2FtZSBgdGFnYC4gYGxpbmVgIHdpbGwgbGllIGJldHdlZW4gdGhlIHByb3BlcnRpZXNcclxuLy8gICBgbWFwWzBdYCBhbmQgYG1hcFsxXWAgb2YgdGhlIHRhcmdldCB0b2tlbi5cclxuLy9cclxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkTGluZU1hcCh0b2tlbnM6IFJlYWRvbmx5QXJyYXk8UmVhZG9ubHk8VG9rZW4+Pikge1xyXG4gIGNvbnN0IGxpbmVNYXA6IHsgW2xpbmU6IG51bWJlcl06IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4gfSA9IHt9XHJcbiAgY29uc3QgdG9rZW5UYWdDb3VudDogeyBbbGluZTogbnVtYmVyXTogeyBbdGFnOiBzdHJpbmddOiBudW1iZXIgfSB9ID0ge31cclxuICB0b2tlblRhZ0NvdW50WzBdID0ge31cclxuXHJcbiAgZm9yIChjb25zdCB0b2tlbiBvZiB0b2tlbnMpIHtcclxuICAgIGlmICh0b2tlbi5oaWRkZW4pIGNvbnRpbnVlXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlcyAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxyXG4gICAgaWYgKHRva2VuLm1hcCA9PSBudWxsKSBjb250aW51ZVxyXG5cclxuICAgIGNvbnN0IHRhZyA9IGRlY29kZVRhZyh0b2tlbilcclxuICAgIGlmICh0YWcgPT09IG51bGwpIGNvbnRpbnVlXHJcblxyXG4gICAgaWYgKHRva2VuLm5lc3RpbmcgPT09IDEpIHtcclxuICAgICAgLy8gb3BlbmluZyB0YWdcclxuICAgICAgZm9yIChsZXQgbGluZSA9IHRva2VuLm1hcFswXTsgbGluZSA8IHRva2VuLm1hcFsxXTsgbGluZSArPSAxKSB7XHJcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcclxuICAgICAgICBpZiAobGluZU1hcFtsaW5lXSA9PSBudWxsKSBsaW5lTWFwW2xpbmVdID0gW11cclxuICAgICAgICBsaW5lTWFwW2xpbmVdLnB1c2goe1xyXG4gICAgICAgICAgdGFnOiB0YWcsXHJcbiAgICAgICAgICBpbmRleDogdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbF1bdGFnXSB8fCAwLFxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuICAgICAgdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbCArIDFdID0ge31cclxuICAgIH0gZWxzZSBpZiAodG9rZW4ubmVzdGluZyA9PT0gMCkge1xyXG4gICAgICAvLyBzZWxmLWNsb3NpbmcgdGFnXHJcbiAgICAgIGZvciAobGV0IGxpbmUgPSB0b2tlbi5tYXBbMF07IGxpbmUgPCB0b2tlbi5tYXBbMV07IGxpbmUgKz0gMSkge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzXHJcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXHJcbiAgICAgICAgbGluZU1hcFtsaW5lXS5wdXNoKHtcclxuICAgICAgICAgIHRhZzogdGFnLFxyXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICBjb25zdCB0dGMgPSB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddXHJcbiAgICB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddID0gdHRjID8gdHRjICsgMSA6IDFcclxuICB9XHJcblxyXG4gIHJldHVybiBsaW5lTWFwXHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1hdGhKYXhTY3JpcHQodGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yKSB7XHJcbiAgcmV0dXJuIGBcXFxyXG48c2NyaXB0IHR5cGU9XCJ0ZXh0L3gtbWF0aGpheC1jb25maWdcIj5cclxuICBNYXRoSmF4Lkh1Yi5Db25maWcoe1xyXG4gICAgamF4OiBbXCJpbnB1dC9UZVhcIixcIm91dHB1dC9IVE1MLUNTU1wiXSxcclxuICAgIGV4dGVuc2lvbnM6IFtcIlthMTF5XS9hY2Nlc3NpYmlsaXR5LW1lbnUuanNcIl0sXHJcbiAgICAnSFRNTC1DU1MnOiB7XHJcbiAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcclxuICAgICAgd2ViRm9udDogJ1RlWCcsXHJcbiAgICAgIHVuZGVmaW5lZEZhbWlseTogJHtKU09OLnN0cmluZ2lmeShcclxuICAgICAgICBhdG9tQ29uZmlnKCkubWF0aENvbmZpZy51bmRlZmluZWRGYW1pbHksXHJcbiAgICAgICl9LFxyXG4gICAgICBtdGV4dEZvbnRJbmhlcml0OiB0cnVlLFxyXG4gICAgfSxcclxuICAgIFRlWDogJHtKU09OLnN0cmluZ2lmeSh0ZXhDb25maWcsIHVuZGVmaW5lZCwgMil9LFxyXG4gICAgc2hvd01hdGhNZW51OiB0cnVlXHJcbiAgfSk7XHJcbjwvc2NyaXB0PlxyXG48c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9tYXRoamF4LzIuNy40L01hdGhKYXguanNcIj48L3NjcmlwdD5gXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBta0h0bWwoXHJcbiAgdGl0bGU6IHN0cmluZyxcclxuICBodG1sOiBIVE1MRG9jdW1lbnQsXHJcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXHJcbiAgdGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yLFxyXG4pIHtcclxuICBsZXQgbWF5YmVNYXRoSmF4U2NyaXB0OiBzdHJpbmdcclxuICBpZiAocmVuZGVyTGFUZVgpIHtcclxuICAgIG1heWJlTWF0aEpheFNjcmlwdCA9IG1hdGhKYXhTY3JpcHQodGV4Q29uZmlnKVxyXG4gIH0gZWxzZSB7XHJcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSAnJ1xyXG4gIH1cclxuICByZXR1cm4gYFxcXHJcbjwhRE9DVFlQRSBodG1sPlxyXG48aHRtbD5cclxuICA8aGVhZD5cclxuICAgIDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+XHJcbiAgICA8dGl0bGU+JHt0aXRsZX08L3RpdGxlPiR7bWF5YmVNYXRoSmF4U2NyaXB0fVxyXG4gICAgPHN0eWxlPiR7Z2V0TWFya2Rvd25QcmV2aWV3Q1NTKCl9PC9zdHlsZT5cclxuJHtodG1sLmhlYWQuaW5uZXJIVE1MfVxyXG4gIDwvaGVhZD5cclxuICA8Ym9keT5cclxuICAgICR7aHRtbC5ib2R5LmlubmVySFRNTH1cclxuICA8L2JvZHk+XHJcbjwvaHRtbD5cclxuYCAvLyBFbnN1cmUgdHJhaWxpbmcgbmV3bGluZVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJveShpdGVtOiBvYmplY3QpIHtcclxuICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oaXRlbSlcclxuICBpZiAocGFuZSkgaGFuZGxlUHJvbWlzZShwYW5lLmRlc3Ryb3lJdGVtKGl0ZW0pKVxyXG59XHJcbiJdfQ==