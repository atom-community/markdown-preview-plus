"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function getStyles(context) {
    if (getStylesOverride)
        return getStylesOverride(context);
    const textEditorStyles = document.createElement('atom-styles');
    textEditorStyles.initialize(atom.styles);
    textEditorStyles.setAttribute('context', context);
    return Array.from(textEditorStyles.childNodes).map((styleElement) => styleElement.innerText);
}
exports.getStyles = getStyles;
function getMarkdownPreviewCSS() {
    const markdowPreviewRules = ['body { padding: 0; margin: 0; }'];
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return markdowPreviewRules
        .concat(getStyles('markdown-preview-plus'))
        .concat(getStyles('atom-text-editor'))
        .join('\n')
        .replace(/\batom-text-editor\b/g, 'pre.editor-colors')
        .replace(/\bmarkdown-preview-plus-view\b/g, '.markdown-preview-plus-view')
        .replace(/\b\.\.markdown-preview-plus-view\b/g, '.markdown-preview-plus-view')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'atom-text-editor';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
function buildLineMap(tokens) {
    const lineMap = {};
    const tokenTagCount = {};
    tokenTagCount[0] = {};
    for (const token of tokens) {
        if (token.hidden)
            continue;
        if (token.map == null)
            continue;
        const tag = decodeTag(token);
        if (tag === null)
            continue;
        if (token.nesting === 1) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
            tokenTagCount[token.level + 1] = {};
        }
        else if (token.nesting === 0) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
        }
        const ttc = tokenTagCount[token.level][tag];
        tokenTagCount[token.level][tag] = ttc ? ttc + 1 : 1;
    }
    return lineMap;
}
exports.buildLineMap = buildLineMap;
function mathJaxScript(texConfig) {
    const cfg = atom.config.get('markdown-preview-plus');
    return `\
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    TeX: ${JSON.stringify(texConfig, undefined, 2)},
    'HTML-CSS': {
        availableFonts: [],
        webFont: 'TeX',
        mtextFontInherit: true,
        undefinedFamily: "'${cfg.mathConfig.mjxUndefinedFamily.join("', '")}'",
      },
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>`;
}
function mkHtml(title, html, renderLaTeX, useGithubStyle, texConfig) {
    const githubStyle = useGithubStyle ? ' data-use-github-style' : '';
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = mathJaxScript(texConfig);
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSS()}</style>
${html.head.innerHTML}
  </head>
  <body class="markdown-preview-plus-view"${githubStyle}>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQXVDO0FBRXZDLHFCQUE0QixRQUFnQjtJQUMxQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxFQUFFLEVBQUU7UUFDcEQsSUFBSSxNQUFNLENBQUMsRUFBRSxLQUFLLFFBQVEsRUFBRTtZQUMxQixPQUFPLE1BQU0sQ0FBQTtTQUNkO0tBQ0Y7SUFDRCxPQUFPLFNBQVMsQ0FBQTtBQUNsQixDQUFDO0FBUEQsa0NBT0M7QUFHRCxJQUFJLGlCQUFpQixHQUFpQyxTQUFTLENBQUE7QUFFL0QsZ0NBQXVDLENBQW9CO0lBQ3pELGlCQUFpQixHQUFHLENBQUMsQ0FBQTtBQUN2QixDQUFDO0FBRkQsd0RBRUM7QUFFRCxtQkFBMEIsT0FBZTtJQUN2QyxJQUFJLGlCQUFpQjtRQUFFLE9BQU8saUJBQWlCLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDeEQsTUFBTSxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUM3QyxhQUFhLENBQzhDLENBQUE7SUFDN0QsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUN4QyxnQkFBZ0IsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFBO0lBR2pELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQ2hELENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBRSxZQUFpQyxDQUFDLFNBQVMsQ0FDL0QsQ0FBQTtBQUNILENBQUM7QUFaRCw4QkFZQztBQUVEO0lBQ0UsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLGlDQUFpQyxDQUFDLENBQUE7SUFDL0QsTUFBTSxZ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LENBQUMsRUFBRSxDQUFBO0lBQ2xFLElBQUksa0JBQTBCLENBQUE7SUFDOUIsSUFBSSxXQUFXLEVBQUU7UUFDZixrQkFBa0IsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUE7S0FDOUM7U0FBTTtRQUNMLGtCQUFrQixHQUFHLEVBQUUsQ0FBQTtLQUN4QjtJQUNELE9BQU87Ozs7O2FBS0ksS0FBSyxXQUFXLGtCQUFrQjthQUNsQyxxQkFBcUIsRUFBRTtFQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7OzRDQUV1QixXQUFXO01BQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUzs7O0NBR3hCLENBQUE7QUFDRCxDQUFDO0FBNUJELHdCQTRCQztBQUVELGlCQUF3QixJQUFZO0lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQzdDLElBQUksSUFBSTtRQUFFLG9CQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO0FBQ2pELENBQUM7QUFIRCwwQkFHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRleHRFZGl0b3IsIFN0eWxlTWFuYWdlciB9IGZyb20gJ2F0b20nXHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcclxuaW1wb3J0ICogYXMgZnMgZnJvbSAnZnMnXHJcbmltcG9ydCB7IFRva2VuIH0gZnJvbSAnbWFya2Rvd24taXQnXHJcbmltcG9ydCB7IGhhbmRsZVByb21pc2UgfSBmcm9tICcuLi91dGlsJ1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGVkaXRvckZvcklkKGVkaXRvcklkOiBudW1iZXIpOiBUZXh0RWRpdG9yIHwgdW5kZWZpbmVkIHtcclxuICBmb3IgKGNvbnN0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7XHJcbiAgICBpZiAoZWRpdG9yLmlkID09PSBlZGl0b3JJZCkge1xyXG4gICAgICByZXR1cm4gZWRpdG9yXHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiB1bmRlZmluZWRcclxufVxyXG5cclxuLy8gdGhpcyB3ZWlyZG5lc3MgYWxsb3dzIG92ZXJyaWRpbmcgaW4gdGVzdHNcclxubGV0IGdldFN0eWxlc092ZXJyaWRlOiB0eXBlb2YgZ2V0U3R5bGVzIHwgdW5kZWZpbmVkID0gdW5kZWZpbmVkXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gX19zZXRHZXRTdHlsZXNPdmVycmlkZShmPzogdHlwZW9mIGdldFN0eWxlcykge1xyXG4gIGdldFN0eWxlc092ZXJyaWRlID0gZlxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0U3R5bGVzKGNvbnRleHQ6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICBpZiAoZ2V0U3R5bGVzT3ZlcnJpZGUpIHJldHVybiBnZXRTdHlsZXNPdmVycmlkZShjb250ZXh0KVxyXG4gIGNvbnN0IHRleHRFZGl0b3JTdHlsZXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFxyXG4gICAgJ2F0b20tc3R5bGVzJyxcclxuICApIGFzIEhUTUxFbGVtZW50ICYgeyBpbml0aWFsaXplKHN0eWxlczogU3R5bGVNYW5hZ2VyKTogdm9pZCB9XHJcbiAgdGV4dEVkaXRvclN0eWxlcy5pbml0aWFsaXplKGF0b20uc3R5bGVzKVxyXG4gIHRleHRFZGl0b3JTdHlsZXMuc2V0QXR0cmlidXRlKCdjb250ZXh0JywgY29udGV4dClcclxuXHJcbiAgLy8gRXh0cmFjdCBzdHlsZSBlbGVtZW50cyBjb250ZW50XHJcbiAgcmV0dXJuIEFycmF5LmZyb20odGV4dEVkaXRvclN0eWxlcy5jaGlsZE5vZGVzKS5tYXAoXHJcbiAgICAoc3R5bGVFbGVtZW50KSA9PiAoc3R5bGVFbGVtZW50IGFzIEhUTUxTdHlsZUVsZW1lbnQpLmlubmVyVGV4dCxcclxuICApXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldE1hcmtkb3duUHJldmlld0NTUygpIHtcclxuICBjb25zdCBtYXJrZG93UHJldmlld1J1bGVzID0gWydib2R5IHsgcGFkZGluZzogMDsgbWFyZ2luOiAwOyB9J11cclxuICBjb25zdCBjc3NVcmxSZWZFeHAgPSAvdXJsXFwoYXRvbTpcXC9cXC9tYXJrZG93bi1wcmV2aWV3LXBsdXNcXC9hc3NldHNcXC8oLiopXFwpL1xyXG5cclxuICByZXR1cm4gbWFya2Rvd1ByZXZpZXdSdWxlc1xyXG4gICAgLmNvbmNhdChnZXRTdHlsZXMoJ21hcmtkb3duLXByZXZpZXctcGx1cycpKVxyXG4gICAgLmNvbmNhdChnZXRTdHlsZXMoJ2F0b20tdGV4dC1lZGl0b3InKSlcclxuICAgIC5qb2luKCdcXG4nKVxyXG4gICAgLnJlcGxhY2UoL1xcYmF0b20tdGV4dC1lZGl0b3JcXGIvZywgJ3ByZS5lZGl0b3ItY29sb3JzJylcclxuICAgIC5yZXBsYWNlKC9cXGJtYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlld1xcYi9nLCAnLm1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3JylcclxuICAgIC5yZXBsYWNlKFxyXG4gICAgICAvXFxiXFwuXFwubWFya2Rvd24tcHJldmlldy1wbHVzLXZpZXdcXGIvZyxcclxuICAgICAgJy5tYXJrZG93bi1wcmV2aWV3LXBsdXMtdmlldycsXHJcbiAgICApXHJcbiAgICAucmVwbGFjZShjc3NVcmxSZWZFeHAsIGZ1bmN0aW9uKFxyXG4gICAgICBfbWF0Y2gsXHJcbiAgICAgIGFzc2V0c05hbWU6IHN0cmluZyxcclxuICAgICAgX29mZnNldCxcclxuICAgICAgX3N0cmluZyxcclxuICAgICkge1xyXG4gICAgICAvLyBiYXNlNjQgZW5jb2RlIGFzc2V0c1xyXG4gICAgICBjb25zdCBhc3NldFBhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vYXNzZXRzJywgYXNzZXRzTmFtZSlcclxuICAgICAgY29uc3Qgb3JpZ2luYWxEYXRhID0gZnMucmVhZEZpbGVTeW5jKGFzc2V0UGF0aCwgJ2JpbmFyeScpXHJcbiAgICAgIGNvbnN0IGJhc2U2NERhdGEgPSBuZXcgQnVmZmVyKG9yaWdpbmFsRGF0YSwgJ2JpbmFyeScpLnRvU3RyaW5nKCdiYXNlNjQnKVxyXG4gICAgICByZXR1cm4gYHVybCgnZGF0YTppbWFnZS9qcGVnO2Jhc2U2NCwke2Jhc2U2NERhdGF9JylgXHJcbiAgICB9KVxyXG59XHJcblxyXG4vL1xyXG4vLyBEZWNvZGUgdGFncyB1c2VkIGJ5IG1hcmtkb3duLWl0XHJcbi8vXHJcbi8vIEBwYXJhbSB7bWFya2Rvd24taXQuVG9rZW59IHRva2VuIERlY29kZSB0aGUgdGFnIG9mIHRva2VuLlxyXG4vLyBAcmV0dXJuIHtzdHJpbmd8bnVsbH0gRGVjb2RlZCB0YWcgb3IgYG51bGxgIGlmIHRoZSB0b2tlbiBoYXMgbm8gdGFnLlxyXG4vL1xyXG5mdW5jdGlvbiBkZWNvZGVUYWcodG9rZW46IFRva2VuKTogc3RyaW5nIHwgbnVsbCB7XHJcbiAgaWYgKHRva2VuLnRhZyA9PT0gJ21hdGgnKSB7XHJcbiAgICByZXR1cm4gJ3NwYW4nXHJcbiAgfVxyXG4gIGlmICh0b2tlbi50YWcgPT09ICdjb2RlJykge1xyXG4gICAgcmV0dXJuICdhdG9tLXRleHQtZWRpdG9yJ1xyXG4gIH1cclxuICBpZiAodG9rZW4udGFnID09PSAnJykge1xyXG4gICAgcmV0dXJuIG51bGxcclxuICB9XHJcbiAgcmV0dXJuIHRva2VuLnRhZ1xyXG59XHJcblxyXG4vL1xyXG4vLyBEZXRlcm1pbmUgcGF0aCB0byBhIHRhcmdldCB0b2tlbi5cclxuLy9cclxuLy8gQHBhcmFtIHsobWFya2Rvd24taXQuVG9rZW4pW119IHRva2VucyBBcnJheSBvZiB0b2tlbnMgYXMgcmV0dXJuZWQgYnlcclxuLy8gICBgbWFya2Rvd24taXQucGFyc2UoKWAuXHJcbi8vIEBwYXJhbSB7bnVtYmVyfSBsaW5lIExpbmUgcmVwcmVzZW50aW5nIHRoZSB0YXJnZXQgdG9rZW4uXHJcbi8vIEByZXR1cm4geyh0YWc6IDx0YWc+LCBpbmRleDogPGluZGV4PilbXX0gQXJyYXkgcmVwcmVzZW50aW5nIGEgcGF0aCB0byB0aGVcclxuLy8gICB0YXJnZXQgdG9rZW4uIFRoZSByb290IHRva2VuIGlzIHJlcHJlc2VudGVkIGJ5IHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZVxyXG4vLyAgIGFycmF5IGFuZCB0aGUgdGFyZ2V0IHRva2VuIGJ5IHRoZSBsYXN0IGVsbWVudC4gRWFjaCBlbGVtZW50IGNvbnNpc3RzIG9mIGFcclxuLy8gICBgdGFnYCBhbmQgYGluZGV4YCByZXByZXNlbnRpbmcgaXRzIGluZGV4IGFtb25nc3QgaXRzIHNpYmxpbmcgdG9rZW5zIGluXHJcbi8vICAgYHRva2Vuc2Agb2YgdGhlIHNhbWUgYHRhZ2AuIGBsaW5lYCB3aWxsIGxpZSBiZXR3ZWVuIHRoZSBwcm9wZXJ0aWVzXHJcbi8vICAgYG1hcFswXWAgYW5kIGBtYXBbMV1gIG9mIHRoZSB0YXJnZXQgdG9rZW4uXHJcbi8vXHJcbmV4cG9ydCBmdW5jdGlvbiBidWlsZExpbmVNYXAodG9rZW5zOiBSZWFkb25seUFycmF5PFJlYWRvbmx5PFRva2VuPj4pIHtcclxuICBjb25zdCBsaW5lTWFwOiB7IFtsaW5lOiBudW1iZXJdOiBBcnJheTx7IHRhZzogc3RyaW5nOyBpbmRleDogbnVtYmVyIH0+IH0gPSB7fVxyXG4gIGNvbnN0IHRva2VuVGFnQ291bnQ6IHsgW2xpbmU6IG51bWJlcl06IHsgW3RhZzogc3RyaW5nXTogbnVtYmVyIH0gfSA9IHt9XHJcbiAgdG9rZW5UYWdDb3VudFswXSA9IHt9XHJcblxyXG4gIGZvciAoY29uc3QgdG9rZW4gb2YgdG9rZW5zKSB7XHJcbiAgICBpZiAodG9rZW4uaGlkZGVuKSBjb250aW51ZVxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXMgLy8gVE9ETzogY29tcGxhaW4gb24gRFRcclxuICAgIGlmICh0b2tlbi5tYXAgPT0gbnVsbCkgY29udGludWVcclxuXHJcbiAgICBjb25zdCB0YWcgPSBkZWNvZGVUYWcodG9rZW4pXHJcbiAgICBpZiAodGFnID09PSBudWxsKSBjb250aW51ZVxyXG5cclxuICAgIGlmICh0b2tlbi5uZXN0aW5nID09PSAxKSB7XHJcbiAgICAgIC8vIG9wZW5pbmcgdGFnXHJcbiAgICAgIGZvciAobGV0IGxpbmUgPSB0b2tlbi5tYXBbMF07IGxpbmUgPCB0b2tlbi5tYXBbMV07IGxpbmUgKz0gMSkge1xyXG4gICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpzdHJpY3QtdHlwZS1wcmVkaWNhdGVzXHJcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXHJcbiAgICAgICAgbGluZU1hcFtsaW5lXS5wdXNoKHtcclxuICAgICAgICAgIHRhZzogdGFnLFxyXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICAgIHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWwgKyAxXSA9IHt9XHJcbiAgICB9IGVsc2UgaWYgKHRva2VuLm5lc3RpbmcgPT09IDApIHtcclxuICAgICAgLy8gc2VsZi1jbG9zaW5nIHRhZ1xyXG4gICAgICBmb3IgKGxldCBsaW5lID0gdG9rZW4ubWFwWzBdOyBsaW5lIDwgdG9rZW4ubWFwWzFdOyBsaW5lICs9IDEpIHtcclxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlc1xyXG4gICAgICAgIGlmIChsaW5lTWFwW2xpbmVdID09IG51bGwpIGxpbmVNYXBbbGluZV0gPSBbXVxyXG4gICAgICAgIGxpbmVNYXBbbGluZV0ucHVzaCh7XHJcbiAgICAgICAgICB0YWc6IHRhZyxcclxuICAgICAgICAgIGluZGV4OiB0b2tlblRhZ0NvdW50W3Rva2VuLmxldmVsXVt0YWddIHx8IDAsXHJcbiAgICAgICAgfSlcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgY29uc3QgdHRjID0gdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbF1bdGFnXVxyXG4gICAgdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbF1bdGFnXSA9IHR0YyA/IHR0YyArIDEgOiAxXHJcbiAgfVxyXG5cclxuICByZXR1cm4gbGluZU1hcFxyXG59XHJcblxyXG5mdW5jdGlvbiBtYXRoSmF4U2NyaXB0KHRleENvbmZpZzogTWF0aEpheC5UZVhJbnB1dFByb2Nlc3Nvcikge1xyXG4gIGNvbnN0IGNmZyA9IGF0b20uY29uZmlnLmdldCgnbWFya2Rvd24tcHJldmlldy1wbHVzJylcclxuICByZXR1cm4gYFxcXHJcbjxzY3JpcHQgdHlwZT1cInRleHQveC1tYXRoamF4LWNvbmZpZ1wiPlxyXG4gIE1hdGhKYXguSHViLkNvbmZpZyh7XHJcbiAgICBqYXg6IFtcImlucHV0L1RlWFwiLFwib3V0cHV0L0hUTUwtQ1NTXCJdLFxyXG4gICAgZXh0ZW5zaW9uczogW1wiW2ExMXldL2FjY2Vzc2liaWxpdHktbWVudS5qc1wiXSxcclxuICAgIFRlWDogJHtKU09OLnN0cmluZ2lmeSh0ZXhDb25maWcsIHVuZGVmaW5lZCwgMil9LFxyXG4gICAgJ0hUTUwtQ1NTJzoge1xyXG4gICAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcclxuICAgICAgICB3ZWJGb250OiAnVGVYJyxcclxuICAgICAgICBtdGV4dEZvbnRJbmhlcml0OiB0cnVlLFxyXG4gICAgICAgIHVuZGVmaW5lZEZhbWlseTogXCInJHtjZmcubWF0aENvbmZpZy5tanhVbmRlZmluZWRGYW1pbHkuam9pbihcIicsICdcIil9J1wiLFxyXG4gICAgICB9LFxyXG4gICAgc2hvd01hdGhNZW51OiB0cnVlXHJcbiAgfSk7XHJcbjwvc2NyaXB0PlxyXG48c2NyaXB0IHR5cGU9XCJ0ZXh0L2phdmFzY3JpcHRcIiBzcmM9XCJodHRwczovL2NkbmpzLmNsb3VkZmxhcmUuY29tL2FqYXgvbGlicy9tYXRoamF4LzIuNy40L01hdGhKYXguanNcIj48L3NjcmlwdD5gXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBta0h0bWwoXHJcbiAgdGl0bGU6IHN0cmluZyxcclxuICBodG1sOiBIVE1MRG9jdW1lbnQsXHJcbiAgcmVuZGVyTGFUZVg6IGJvb2xlYW4sXHJcbiAgdXNlR2l0aHViU3R5bGU6IGJvb2xlYW4sXHJcbiAgdGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yLFxyXG4pIHtcclxuICBjb25zdCBnaXRodWJTdHlsZSA9IHVzZUdpdGh1YlN0eWxlID8gJyBkYXRhLXVzZS1naXRodWItc3R5bGUnIDogJydcclxuICBsZXQgbWF5YmVNYXRoSmF4U2NyaXB0OiBzdHJpbmdcclxuICBpZiAocmVuZGVyTGFUZVgpIHtcclxuICAgIG1heWJlTWF0aEpheFNjcmlwdCA9IG1hdGhKYXhTY3JpcHQodGV4Q29uZmlnKVxyXG4gIH0gZWxzZSB7XHJcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSAnJ1xyXG4gIH1cclxuICByZXR1cm4gYFxcXHJcbjwhRE9DVFlQRSBodG1sPlxyXG48aHRtbD5cclxuICA8aGVhZD5cclxuICAgIDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+XHJcbiAgICA8dGl0bGU+JHt0aXRsZX08L3RpdGxlPiR7bWF5YmVNYXRoSmF4U2NyaXB0fVxyXG4gICAgPHN0eWxlPiR7Z2V0TWFya2Rvd25QcmV2aWV3Q1NTKCl9PC9zdHlsZT5cclxuJHtodG1sLmhlYWQuaW5uZXJIVE1MfVxyXG4gIDwvaGVhZD5cclxuICA8Ym9keSBjbGFzcz1cIm1hcmtkb3duLXByZXZpZXctcGx1cy12aWV3XCIke2dpdGh1YlN0eWxlfT5cclxuICAgICR7aHRtbC5ib2R5LmlubmVySFRNTH1cclxuICA8L2JvZHk+XHJcbjwvaHRtbD5cclxuYCAvLyBFbnN1cmUgdHJhaWxpbmcgbmV3bGluZVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJveShpdGVtOiBvYmplY3QpIHtcclxuICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oaXRlbSlcclxuICBpZiAocGFuZSkgaGFuZGxlUHJvbWlzZShwYW5lLmRlc3Ryb3lJdGVtKGl0ZW0pKVxyXG59XHJcbiJdfQ==