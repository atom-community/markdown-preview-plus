"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const markdown_preview_view_1 = require("./markdown-preview-view");
const atom_1 = require("atom");
const util_1 = require("./util");
let imageRegister = {};
const refreshImages = _.debounce(async function (src) {
    for (const item of atom.workspace.getPaneItems()) {
        if (item instanceof markdown_preview_view_1.MarkdownPreviewView) {
            await item.refreshImages(src);
        }
    }
}, 250);
function srcClosure(src, event) {
    return function () {
        const i = imageRegister[src];
        if (!i)
            return;
        if (event === 'change' && util_1.isFileSync(src)) {
            i.version = Date.now();
        }
        else {
            i.watcher.dispose();
            delete imageRegister[src];
        }
        util_1.handlePromise(refreshImages(src));
    };
}
function removeFile(file) {
    imageRegister = _.mapValues(imageRegister, function (image) {
        if (!image)
            return image;
        image.files = _.without(image.files, file);
        image.files = _.filter(image.files, util_1.isFileSync);
        if (_.isEmpty(image.files)) {
            image.watched = false;
            image.watcher.dispose();
        }
        return image;
    });
}
exports.removeFile = removeFile;
async function getVersion(image, file) {
    let version;
    const i = imageRegister[image];
    if (!i) {
        if (util_1.isFileSync(image)) {
            version = Date.now();
            const watcher = new atom_1.CompositeDisposable();
            const af = new atom_1.File(image);
            watcher.add(af.onDidChange(srcClosure(image, 'change')), af.onDidDelete(srcClosure(image, 'delete')), af.onDidRename(srcClosure(image, 'rename')));
            imageRegister[image] = {
                path: image,
                watched: true,
                files: file ? [file] : [],
                version,
                watcher,
            };
            return version;
        }
        else {
            return false;
        }
    }
    const files = i.files;
    if (file && !_.includes(files, file)) {
        i.files.push(file);
    }
    version = i.version;
    if (!version && util_1.isFileSync(image)) {
        version = Date.now();
        i.version = version;
    }
    return version;
}
exports.getVersion = getVersion;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2Utd2F0Y2gtaGVscGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2ltYWdlLXdhdGNoLWhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRCQUE0QjtBQUM1QixtRUFBNkQ7QUFDN0QsK0JBQWdEO0FBQ2hELGlDQUFrRDtBQVVsRCxJQUFJLGFBQWEsR0FFYixFQUFFLENBQUE7QUFFTixNQUFNLGFBQWEsR0FBRyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssV0FBVSxHQUFXO0lBQ3pELEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEVBQUUsRUFBRTtRQUNoRCxJQUFJLElBQUksWUFBWSwyQ0FBbUIsRUFBRTtZQUV2QyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUE7U0FDOUI7S0FDRjtBQUNILENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQTtBQUVQLG9CQUFvQixHQUFXLEVBQUUsS0FBcUM7SUFDcEUsT0FBTztRQUNMLE1BQU0sQ0FBQyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUM1QixJQUFJLENBQUMsQ0FBQztZQUFFLE9BQU07UUFDZCxJQUFJLEtBQUssS0FBSyxRQUFRLElBQUksaUJBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUN6QyxDQUFDLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQTtTQUN2QjthQUFNO1lBQ0wsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtZQUNuQixPQUFPLGFBQWEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtTQUMxQjtRQUNELG9CQUFhLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDbkMsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUVELG9CQUEyQixJQUFZO0lBQ3JDLGFBQWEsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLGFBQWEsRUFBRSxVQUFTLEtBQUs7UUFDdkQsSUFBSSxDQUFDLEtBQUs7WUFBRSxPQUFPLEtBQUssQ0FBQTtRQUN4QixLQUFLLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUMxQyxLQUFLLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxpQkFBVSxDQUFDLENBQUE7UUFDL0MsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUMxQixLQUFLLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQTtZQUNyQixLQUFLLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFBO1NBQ3hCO1FBQ0QsT0FBTyxLQUFLLENBQUE7SUFDZCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFYRCxnQ0FXQztBQUVNLEtBQUsscUJBQXFCLEtBQWEsRUFBRSxJQUFhO0lBQzNELElBQUksT0FBTyxDQUFBO0lBQ1gsTUFBTSxDQUFDLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQzlCLElBQUksQ0FBQyxDQUFDLEVBQUU7UUFDTixJQUFJLGlCQUFVLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDckIsT0FBTyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQTtZQUNwQixNQUFNLE9BQU8sR0FBRyxJQUFJLDBCQUFtQixFQUFFLENBQUE7WUFDekMsTUFBTSxFQUFFLEdBQUcsSUFBSSxXQUFJLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDMUIsT0FBTyxDQUFDLEdBQUcsQ0FDVCxFQUFFLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUMsRUFDM0MsRUFBRSxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDLEVBQzNDLEVBQUUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUM1QyxDQUFBO1lBQ0QsYUFBYSxDQUFDLEtBQUssQ0FBQyxHQUFHO2dCQUNyQixJQUFJLEVBQUUsS0FBSztnQkFDWCxPQUFPLEVBQUUsSUFBSTtnQkFDYixLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUN6QixPQUFPO2dCQUNQLE9BQU87YUFDUixDQUFBO1lBQ0QsT0FBTyxPQUFPLENBQUE7U0FDZjthQUFNO1lBQ0wsT0FBTyxLQUFLLENBQUE7U0FDYjtLQUNGO0lBRUQsTUFBTSxLQUFLLEdBQWEsQ0FBQyxDQUFDLEtBQUssQ0FBQTtJQUMvQixJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFO1FBQ3BDLENBQUMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO0tBQ25CO0lBRUQsT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUE7SUFDbkIsSUFBSSxDQUFDLE9BQU8sSUFBSSxpQkFBVSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ2pDLE9BQU8sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUE7UUFDcEIsQ0FBQyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUE7S0FDcEI7SUFDRCxPQUFPLE9BQU8sQ0FBQTtBQUNoQixDQUFDO0FBckNELGdDQXFDQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfID0gcmVxdWlyZSgnbG9kYXNoJylcclxuaW1wb3J0IHsgTWFya2Rvd25QcmV2aWV3VmlldyB9IGZyb20gJy4vbWFya2Rvd24tcHJldmlldy12aWV3J1xyXG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBGaWxlIH0gZnJvbSAnYXRvbSdcclxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSwgaXNGaWxlU3luYyB9IGZyb20gJy4vdXRpbCdcclxuXHJcbmludGVyZmFjZSBJbWFnZVJlZ2lzdGVyUmVjIHtcclxuICB2ZXJzaW9uOiBudW1iZXJcclxuICB3YXRjaGVyOiBDb21wb3NpdGVEaXNwb3NhYmxlXHJcbiAgZmlsZXM6IHN0cmluZ1tdXHJcbiAgd2F0Y2hlZDogYm9vbGVhblxyXG4gIHBhdGg6IHN0cmluZ1xyXG59XHJcblxyXG5sZXQgaW1hZ2VSZWdpc3Rlcjoge1xyXG4gIFtrZXk6IHN0cmluZ106IEltYWdlUmVnaXN0ZXJSZWMgfCB1bmRlZmluZWRcclxufSA9IHt9XHJcblxyXG5jb25zdCByZWZyZXNoSW1hZ2VzID0gXy5kZWJvdW5jZShhc3luYyBmdW5jdGlvbihzcmM6IHN0cmluZykge1xyXG4gIGZvciAoY29uc3QgaXRlbSBvZiBhdG9tLndvcmtzcGFjZS5nZXRQYW5lSXRlbXMoKSkge1xyXG4gICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBNYXJrZG93blByZXZpZXdWaWV3KSB7XHJcbiAgICAgIC8vIFRPRE86IGNoZWNrIGFnYWluc3QgaW1hZ2VSZWdpc3RlcltzcmNdLnZlcnNpb24uZmlsZXNcclxuICAgICAgYXdhaXQgaXRlbS5yZWZyZXNoSW1hZ2VzKHNyYylcclxuICAgIH1cclxuICB9XHJcbn0sIDI1MClcclxuXHJcbmZ1bmN0aW9uIHNyY0Nsb3N1cmUoc3JjOiBzdHJpbmcsIGV2ZW50OiAnY2hhbmdlJyB8ICdkZWxldGUnIHwgJ3JlbmFtZScpIHtcclxuICByZXR1cm4gZnVuY3Rpb24oKSB7XHJcbiAgICBjb25zdCBpID0gaW1hZ2VSZWdpc3RlcltzcmNdXHJcbiAgICBpZiAoIWkpIHJldHVyblxyXG4gICAgaWYgKGV2ZW50ID09PSAnY2hhbmdlJyAmJiBpc0ZpbGVTeW5jKHNyYykpIHtcclxuICAgICAgaS52ZXJzaW9uID0gRGF0ZS5ub3coKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaS53YXRjaGVyLmRpc3Bvc2UoKVxyXG4gICAgICBkZWxldGUgaW1hZ2VSZWdpc3RlcltzcmNdXHJcbiAgICB9XHJcbiAgICBoYW5kbGVQcm9taXNlKHJlZnJlc2hJbWFnZXMoc3JjKSlcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVGaWxlKGZpbGU6IHN0cmluZykge1xyXG4gIGltYWdlUmVnaXN0ZXIgPSBfLm1hcFZhbHVlcyhpbWFnZVJlZ2lzdGVyLCBmdW5jdGlvbihpbWFnZSkge1xyXG4gICAgaWYgKCFpbWFnZSkgcmV0dXJuIGltYWdlXHJcbiAgICBpbWFnZS5maWxlcyA9IF8ud2l0aG91dChpbWFnZS5maWxlcywgZmlsZSlcclxuICAgIGltYWdlLmZpbGVzID0gXy5maWx0ZXIoaW1hZ2UuZmlsZXMsIGlzRmlsZVN5bmMpXHJcbiAgICBpZiAoXy5pc0VtcHR5KGltYWdlLmZpbGVzKSkge1xyXG4gICAgICBpbWFnZS53YXRjaGVkID0gZmFsc2VcclxuICAgICAgaW1hZ2Uud2F0Y2hlci5kaXNwb3NlKClcclxuICAgIH1cclxuICAgIHJldHVybiBpbWFnZVxyXG4gIH0pXHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRWZXJzaW9uKGltYWdlOiBzdHJpbmcsIGZpbGU/OiBzdHJpbmcpIHtcclxuICBsZXQgdmVyc2lvblxyXG4gIGNvbnN0IGkgPSBpbWFnZVJlZ2lzdGVyW2ltYWdlXVxyXG4gIGlmICghaSkge1xyXG4gICAgaWYgKGlzRmlsZVN5bmMoaW1hZ2UpKSB7XHJcbiAgICAgIHZlcnNpb24gPSBEYXRlLm5vdygpXHJcbiAgICAgIGNvbnN0IHdhdGNoZXIgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpXHJcbiAgICAgIGNvbnN0IGFmID0gbmV3IEZpbGUoaW1hZ2UpXHJcbiAgICAgIHdhdGNoZXIuYWRkKFxyXG4gICAgICAgIGFmLm9uRGlkQ2hhbmdlKHNyY0Nsb3N1cmUoaW1hZ2UsICdjaGFuZ2UnKSksXHJcbiAgICAgICAgYWYub25EaWREZWxldGUoc3JjQ2xvc3VyZShpbWFnZSwgJ2RlbGV0ZScpKSxcclxuICAgICAgICBhZi5vbkRpZFJlbmFtZShzcmNDbG9zdXJlKGltYWdlLCAncmVuYW1lJykpLFxyXG4gICAgICApXHJcbiAgICAgIGltYWdlUmVnaXN0ZXJbaW1hZ2VdID0ge1xyXG4gICAgICAgIHBhdGg6IGltYWdlLFxyXG4gICAgICAgIHdhdGNoZWQ6IHRydWUsXHJcbiAgICAgICAgZmlsZXM6IGZpbGUgPyBbZmlsZV0gOiBbXSxcclxuICAgICAgICB2ZXJzaW9uLFxyXG4gICAgICAgIHdhdGNoZXIsXHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHZlcnNpb25cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY29uc3QgZmlsZXM6IHN0cmluZ1tdID0gaS5maWxlc1xyXG4gIGlmIChmaWxlICYmICFfLmluY2x1ZGVzKGZpbGVzLCBmaWxlKSkge1xyXG4gICAgaS5maWxlcy5wdXNoKGZpbGUpXHJcbiAgfVxyXG5cclxuICB2ZXJzaW9uID0gaS52ZXJzaW9uXHJcbiAgaWYgKCF2ZXJzaW9uICYmIGlzRmlsZVN5bmMoaW1hZ2UpKSB7XHJcbiAgICB2ZXJzaW9uID0gRGF0ZS5ub3coKVxyXG4gICAgaS52ZXJzaW9uID0gdmVyc2lvblxyXG4gIH1cclxuICByZXR1cm4gdmVyc2lvblxyXG59XHJcbiJdfQ==