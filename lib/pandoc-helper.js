"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const util_1 = require("./util");
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached !== null) {
            return cached;
        }
        try {
            return (cached = require.resolve('mathjax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !atom.project.getPaths().includes(newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath !== undefined) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const config = util_1.atomConfig().pandocConfig;
    const args = {
        from: config.pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: config.pandocFilters,
    };
    if (config.pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, config.pandocBIBFile);
        if (!bibFile) {
            bibFile = config.pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, config.pandocCSLFile);
        if (!cslFile) {
            cslFile = config.pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
function handleError(error, html, renderMath) {
    const err = new Error(error);
    err.html = handleSuccess(html, renderMath);
    throw err;
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => {
        elem.remove();
    });
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (util_1.atomConfig().pandocConfig.pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
async function renderPandoc(text, filePath, renderMath) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    return new Promise((resolve, reject) => {
        const cp = CP.execFile(util_1.atomConfig().pandocConfig.pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    stack: error.stack,
                    dismissable: true,
                });
                reject(error);
            }
            try {
                const result = handleResponse(stderr || '', stdout || '', renderMath);
                resolve(result);
            }
            catch (e) {
                reject(e);
            }
        });
        cp.stdin.write(text);
        cp.stdin.end();
    });
}
exports.renderPandoc = renderPandoc;
function getArguments(iargs) {
    const args = _.reduce(iargs, function (res, val, key) {
        if (val && !_.isEmpty(val)) {
            const nval = _.flatten([val]);
            _.forEach(nval, function (v) {
                if (!_.isEmpty(v)) {
                    res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    const res = [];
    for (const val of [...args, ...util_1.atomConfig().pandocConfig.pandocArguments]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    return res;
}
exports.testing = {
    setPandocOptions,
    getArguments,
    findFileRecursive,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNEJBQTRCO0FBQzVCLG9DQUFvQztBQUNwQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLGlDQUFtQztBQUtuQyxNQUFNLGNBQWMsR0FBRyxDQUFDO0lBQ3RCLElBQUksTUFBTSxHQUFrQixJQUFJLENBQUE7SUFDaEMsT0FBTztRQUNMLElBQUksTUFBTSxLQUFLLElBQUksRUFBRTtZQUNuQixPQUFPLE1BQU0sQ0FBQTtTQUNkO1FBQ0QsSUFBSTtZQUNGLE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1NBQzdDO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLEVBQUUsQ0FBQTtTQUNWO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUVKLDJCQUEyQixRQUFnQixFQUFFLFFBQWdCO0lBQzNELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUNwRCxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDMUIsT0FBTyxPQUFPLENBQUE7S0FDZjtTQUFNO1FBQ0wsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDeEMsSUFBSSxPQUFPLEtBQUssUUFBUSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUU7WUFDdEUsT0FBTyxpQkFBaUIsQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUE7U0FDNUM7YUFBTTtZQUNMLE9BQU8sS0FBSyxDQUFBO1NBQ2I7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QUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUU7b0JBQ2pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtpQkFDMUI7WUFDSCxDQUFDLENBQUMsQ0FBQTtTQUNIO1FBQ0QsT0FBTyxHQUFHLENBQUE7SUFDWixDQUFDLEVBQ0QsRUFBRSxDQUNILENBQUE7SUFDRCxNQUFNLEdBQUcsR0FBYSxFQUFFLENBQUE7SUFDeEIsS0FBSyxNQUFNLEdBQUcsSUFBSSxDQUFDLEdBQUcsSUFBSSxFQUFFLEdBQUcsaUJBQVUsRUFBRSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsRUFBRTtRQUN6RSxNQUFNLE1BQU0sR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLHNCQUFzQixFQUFFLE9BQU8sQ0FBQyxDQUFBO1FBQzNELElBQUksTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQy9CLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUE7U0FDakI7S0FDRjtJQUNELE9BQU8sR0FBRyxDQUFBO0FBQ1osQ0FBQztBQUVZLFFBQUEsT0FBTyxHQUFHO0lBQ3JCLGdCQUFnQjtJQUNoQixZQUFZO0lBQ1osaUJBQWlCO0NBQ2xCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpXG5pbXBvcnQgQ1AgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJylcbmltcG9ydCBmcyA9IHJlcXVpcmUoJ2ZzJylcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgeyBhdG9tQ29uZmlnIH0gZnJvbSAnLi91dGlsJ1xuXG4vKipcbiAqIFNldHMgbG9jYWwgbWF0aGpheFBhdGggaWYgYXZhaWxhYmxlXG4gKi9cbmNvbnN0IGdldE1hdGhKYXhQYXRoID0gKGZ1bmN0aW9uKCkge1xuICBsZXQgY2FjaGVkOiBzdHJpbmcgfCBudWxsID0gbnVsbFxuICByZXR1cm4gZnVuY3Rpb24oKSB7XG4gICAgaWYgKGNhY2hlZCAhPT0gbnVsbCkge1xuICAgICAgcmV0dXJuIGNhY2hlZFxuICAgIH1cbiAgICB0cnkge1xuICAgICAgcmV0dXJuIChjYWNoZWQgPSByZXF1aXJlLnJlc29sdmUoJ21hdGhqYXgnKSlcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gJydcbiAgICB9XG4gIH1cbn0pKClcblxuZnVuY3Rpb24gZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGg6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZyk6IHN0cmluZyB8IGZhbHNlIHtcbiAgY29uc3QgYmliRmlsZSA9IHBhdGguam9pbihmaWxlUGF0aCwgJy4uLycsIGZpbGVOYW1lKVxuICBpZiAoZnMuZXhpc3RzU3luYyhiaWJGaWxlKSkge1xuICAgIHJldHVybiBiaWJGaWxlXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgbmV3UGF0aCA9IHBhdGguam9pbihiaWJGaWxlLCAnLi4nKVxuICAgIGlmIChuZXdQYXRoICE9PSBmaWxlUGF0aCAmJiAhYXRvbS5wcm9qZWN0LmdldFBhdGhzKCkuaW5jbHVkZXMobmV3UGF0aCkpIHtcbiAgICAgIHJldHVybiBmaW5kRmlsZVJlY3Vyc2l2ZShuZXdQYXRoLCBmaWxlTmFtZSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG59XG5cbi8vIGV4cG9ydGVkIGZvciB0ZXN0c1xuZXhwb3J0IGludGVyZmFjZSBBcmdzIHtcbiAgZnJvbTogc3RyaW5nXG4gIHRvOiAnaHRtbCdcbiAgbWF0aGpheD86IHN0cmluZ1xuICBmaWx0ZXI6IHN0cmluZ1tdXG4gIGJpYmxpb2dyYXBoeT86IHN0cmluZ1xuICBjc2w/OiBzdHJpbmdcbn1cblxuZnVuY3Rpb24gc2V0UGFuZG9jT3B0aW9ucyhmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIC8vIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXRvbS1jb21tdW5pdHkvbWFya2Rvd24tcHJldmlldy1wbHVzL2lzc3Vlcy8zMTZcbiAgY29uc3Qgb3B0czogQ1AuRXhlY0ZpbGVPcHRpb25zID0geyBtYXhCdWZmZXI6IEluZmluaXR5IH1cbiAgaWYgKGZpbGVQYXRoICE9PSB1bmRlZmluZWQpIHtcbiAgICBvcHRzLmN3ZCA9IHBhdGguZGlybmFtZShmaWxlUGF0aClcbiAgfVxuICBjb25zdCBtYXRoamF4UGF0aCA9IGdldE1hdGhKYXhQYXRoKClcbiAgY29uc3QgY29uZmlnID0gYXRvbUNvbmZpZygpLnBhbmRvY0NvbmZpZ1xuICBjb25zdCBhcmdzOiBBcmdzID0ge1xuICAgIGZyb206IGNvbmZpZy5wYW5kb2NNYXJrZG93bkZsYXZvcixcbiAgICB0bzogJ2h0bWwnLFxuICAgIG1hdGhqYXg6IHJlbmRlck1hdGggPyBtYXRoamF4UGF0aCA6IHVuZGVmaW5lZCxcbiAgICBmaWx0ZXI6IGNvbmZpZy5wYW5kb2NGaWx0ZXJzLFxuICB9XG4gIGlmIChjb25maWcucGFuZG9jQmlibGlvZ3JhcGh5KSB7XG4gICAgYXJncy5maWx0ZXIucHVzaCgncGFuZG9jLWNpdGVwcm9jJylcbiAgICBsZXQgYmliRmlsZSA9IGZpbGVQYXRoICYmIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBjb25maWcucGFuZG9jQklCRmlsZSlcbiAgICBpZiAoIWJpYkZpbGUpIHtcbiAgICAgIGJpYkZpbGUgPSBjb25maWcucGFuZG9jQklCRmlsZUZhbGxiYWNrXG4gICAgfVxuICAgIGFyZ3MuYmlibGlvZ3JhcGh5ID0gYmliRmlsZSA/IGJpYkZpbGUgOiB1bmRlZmluZWRcbiAgICBsZXQgY3NsRmlsZSA9IGZpbGVQYXRoICYmIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBjb25maWcucGFuZG9jQ1NMRmlsZSlcbiAgICBpZiAoIWNzbEZpbGUpIHtcbiAgICAgIGNzbEZpbGUgPSBjb25maWcucGFuZG9jQ1NMRmlsZUZhbGxiYWNrXG4gICAgfVxuICAgIGFyZ3MuY3NsID0gY3NsRmlsZSA/IGNzbEZpbGUgOiB1bmRlZmluZWRcbiAgfVxuICByZXR1cm4geyBhcmdzLCBvcHRzIH1cbn1cblxuLyoqXG4gKiBIYW5kbGUgZXJyb3IgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSB7ZXJyb3J9IFJldHVybmVkIGVycm9yXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICogQHJldHVybiB7YXJyYXl9IHdpdGggQXJndW1lbnRzIGZvciBjYWxsYmFja0Z1bmN0aW9uIChlcnJvciBzZXQgdG8gbnVsbClcbiAqL1xuZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3I6IHN0cmluZywgaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKTogbmV2ZXIge1xuICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoZXJyb3IpIGFzIEVycm9yICYgeyBodG1sOiBzdHJpbmcgfVxuICBlcnIuaHRtbCA9IGhhbmRsZVN1Y2Nlc3MoaHRtbCwgcmVuZGVyTWF0aClcbiAgdGhyb3cgZXJyXG59XG5cbi8qKlxuICogQWRqdXN0cyBhbGwgbWF0aCBlbnZpcm9ubWVudHMgaW4gSFRNTFxuICogQHBhcmFtIHtzdHJpbmd9IEhUTUwgdG8gYmUgYWRqdXN0ZWRcbiAqIEByZXR1cm4ge3N0cmluZ30gSFRNTCB3aXRoIGFkanVzdGVkIG1hdGggZW52aXJvbm1lbnRzXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZU1hdGgoaHRtbDogc3RyaW5nKTogc3RyaW5nIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5tYXRoJykuZm9yRWFjaChmdW5jdGlvbihlbGVtKSB7XG4gICAgbGV0IG1hdGggPSAoZWxlbSBhcyBIVE1MRWxlbWVudCkuaW5uZXJUZXh0XG4gICAgLy8gU2V0IG1vZGUgaWYgaXQgaXMgYmxvY2sgbWF0aFxuICAgIGNvbnN0IG1vZGUgPSBtYXRoLmluZGV4T2YoJ1xcXFxbJykgPiAtMSA/ICc7IG1vZGU9ZGlzcGxheScgOiAnJ1xuXG4gICAgLy8gUmVtb3ZlIHNvdXJyb3VuZGluZyBcXFsgXFxdIGFuZCBcXCggXFwpXG4gICAgbWF0aCA9IG1hdGgucmVwbGFjZSgvXFxcXFtbKClcXF1dL2csICcnKVxuICAgIHJldHVybiAoZWxlbS5vdXRlckhUTUwgPVxuICAgICAgJzxzcGFuIGNsYXNzPVwibWF0aFwiPicgK1xuICAgICAgYDxzY3JpcHQgdHlwZT0nbWF0aC90ZXgke21vZGV9Jz4ke21hdGh9PC9zY3JpcHQ+YCArXG4gICAgICAnPC9zcGFuPicpXG4gIH0pXG5cbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuZnVuY3Rpb24gcmVtb3ZlUmVmZXJlbmNlcyhodG1sOiBzdHJpbmcpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZWZlcmVuY2VzJykuZm9yRWFjaCgoZWxlbSkgPT4ge1xuICAgIGVsZW0ucmVtb3ZlKClcbiAgfSlcbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuLyoqXG4gKiBIYW5kbGUgc3VjY2Vzc2Z1bCByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIFJldHVybmVkIEhUTUxcbiAqIEByZXR1cm4gUG9zc2libHkgbW9kaWZpZWQgcmV0dXJuZWQgSFRNTFxuICovXG5mdW5jdGlvbiBoYW5kbGVTdWNjZXNzKGh0bWw6IHN0cmluZywgcmVuZGVyTWF0aDogYm9vbGVhbik6IHN0cmluZyB7XG4gIGlmIChyZW5kZXJNYXRoKSB7XG4gICAgaHRtbCA9IGhhbmRsZU1hdGgoaHRtbClcbiAgfVxuICBpZiAoYXRvbUNvbmZpZygpLnBhbmRvY0NvbmZpZy5wYW5kb2NSZW1vdmVSZWZlcmVuY2VzKSB7XG4gICAgaHRtbCA9IHJlbW92ZVJlZmVyZW5jZXMoaHRtbClcbiAgfVxuICByZXR1cm4gaHRtbFxufVxuXG4vKipcbiAqIEhhbmRsZSByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtPYmplY3R9IGVycm9yIGlmIHRocm93blxuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqL1xuZnVuY3Rpb24gaGFuZGxlUmVzcG9uc2UoZXJyb3I6IHN0cmluZywgaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIGlmIChlcnJvcikge1xuICAgIHJldHVybiBoYW5kbGVFcnJvcihlcnJvciwgaHRtbCwgcmVuZGVyTWF0aClcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlU3VjY2VzcyhodG1sLCByZW5kZXJNYXRoKVxuICB9XG59XG5cbi8qKlxuICogUmVuZGVycyBtYXJrZG93biB3aXRoIHBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IGRvY3VtZW50IGluIG1hcmtkb3duXG4gKiBAcGFyYW0ge2Jvb2xlYW59IHdoZXRoZXIgdG8gcmVuZGVyIHRoZSBtYXRoIHdpdGggbWF0aGpheFxuICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2tGdW5jdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVuZGVyUGFuZG9jKFxuICB0ZXh0OiBzdHJpbmcsXG4gIGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsXG4gIHJlbmRlck1hdGg6IGJvb2xlYW4sXG4pOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCB7IGFyZ3MsIG9wdHMgfSA9IHNldFBhbmRvY09wdGlvbnMoZmlsZVBhdGgsIHJlbmRlck1hdGgpXG4gIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBjb25zdCBjcCA9IENQLmV4ZWNGaWxlKFxuICAgICAgYXRvbUNvbmZpZygpLnBhbmRvY0NvbmZpZy5wYW5kb2NQYXRoLFxuICAgICAgZ2V0QXJndW1lbnRzKGFyZ3MpLFxuICAgICAgb3B0cyxcbiAgICAgIGZ1bmN0aW9uKGVycm9yLCBzdGRvdXQsIHN0ZGVycikge1xuICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZXJyb3IudG9TdHJpbmcoKSwge1xuICAgICAgICAgICAgc3RhY2s6IGVycm9yLnN0YWNrLFxuICAgICAgICAgICAgZGlzbWlzc2FibGU6IHRydWUsXG4gICAgICAgICAgfSlcbiAgICAgICAgICByZWplY3QoZXJyb3IpXG4gICAgICAgIH1cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBoYW5kbGVSZXNwb25zZShzdGRlcnIgfHwgJycsIHN0ZG91dCB8fCAnJywgcmVuZGVyTWF0aClcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdClcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgIHJlamVjdChlKVxuICAgICAgICB9XG4gICAgICB9LFxuICAgIClcbiAgICBjcC5zdGRpbi53cml0ZSh0ZXh0KVxuICAgIGNwLnN0ZGluLmVuZCgpXG4gIH0pXG59XG5cbmZ1bmN0aW9uIGdldEFyZ3VtZW50cyhpYXJnczogQXJncykge1xuICBjb25zdCBhcmdzID0gXy5yZWR1Y2UoXG4gICAgaWFyZ3MsXG4gICAgZnVuY3Rpb24ocmVzOiBzdHJpbmdbXSwgdmFsLCBrZXkpIHtcbiAgICAgIGlmICh2YWwgJiYgIV8uaXNFbXB0eSh2YWwpKSB7XG4gICAgICAgIGNvbnN0IG52YWw6IHN0cmluZ1tdID0gXy5mbGF0dGVuKFt2YWxdKVxuICAgICAgICBfLmZvckVhY2gobnZhbCwgZnVuY3Rpb24odjogc3RyaW5nKSB7XG4gICAgICAgICAgaWYgKCFfLmlzRW1wdHkodikpIHtcbiAgICAgICAgICAgIHJlcy5wdXNoKGAtLSR7a2V5fT0ke3Z9YClcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzXG4gICAgfSxcbiAgICBbXSxcbiAgKVxuICBjb25zdCByZXM6IHN0cmluZ1tdID0gW11cbiAgZm9yIChjb25zdCB2YWwgb2YgWy4uLmFyZ3MsIC4uLmF0b21Db25maWcoKS5wYW5kb2NDb25maWcucGFuZG9jQXJndW1lbnRzXSkge1xuICAgIGNvbnN0IG5ld3ZhbCA9IHZhbC5yZXBsYWNlKC9eKC0tW1xcd1xcLV0rKVxccyguKykkL2ksICckMT0kMicpXG4gICAgaWYgKG5ld3ZhbC5zdWJzdHIoMCwgMSkgPT09ICctJykge1xuICAgICAgcmVzLnB1c2gobmV3dmFsKVxuICAgIH1cbiAgfVxuICByZXR1cm4gcmVzXG59XG5cbmV4cG9ydCBjb25zdCB0ZXN0aW5nID0ge1xuICBzZXRQYW5kb2NPcHRpb25zLFxuICBnZXRBcmd1bWVudHMsXG4gIGZpbmRGaWxlUmVjdXJzaXZlLFxufVxuIl19