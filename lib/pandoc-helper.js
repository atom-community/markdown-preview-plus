"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const atomConfig = () => atom.config.get('markdown-preview-plus');
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached !== null) {
            return cached;
        }
        try {
            return (cached = require.resolve('mathjax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !atom.project.getPaths().includes(newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
exports.findFileRecursive = findFileRecursive;
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath !== undefined) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const args = {
        from: atomConfig().pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: atomConfig().pandocFilters,
    };
    if (atomConfig().pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, atomConfig().pandocBIBFile);
        if (!bibFile) {
            bibFile = atomConfig().pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, atomConfig().pandocCSLFile);
        if (!cslFile) {
            cslFile = atomConfig().pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
exports.setPandocOptions = setPandocOptions;
function handleError(error, html, renderMath) {
    html = `<h1>Pandoc Error:</h1><pre>${error}</pre><hr>${html}`;
    return handleSuccess(html, renderMath);
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => {
        elem.remove();
    });
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (atomConfig().pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
async function renderPandoc(text, filePath, renderMath, cb) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    return new Promise((resolve, reject) => {
        const cp = CP.execFile(atomConfig().pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    stack: error.stack,
                    dismissable: true,
                });
                reject(error);
            }
            const result = handleResponse(stderr || '', stdout || '', renderMath);
            resolve(cb(null, result));
        });
        cp.stdin.write(text);
        cp.stdin.end();
    });
}
exports.renderPandoc = renderPandoc;
function getArguments(iargs) {
    const args = Object.entries(iargs).reduce(function (res, [key, val]) {
        if (val !== undefined) {
            const nval = Array.isArray(val) ? val : [val];
            nval.forEach(function (v) {
                if (v.length > 0) {
                    res.push(`--${key}=${v}`);
                }
                else {
                    res.push(`--${key}`);
                }
            });
        }
        return res;
    }, []);
    const res = [];
    for (const val of [
        ...args,
        ...atom.config.get('markdown-preview-plus.pandocArguments'),
    ]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    return res;
}
exports.getArguments = getArguments;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsb0NBQW9DO0FBQ3BDLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFFN0IsTUFBTSxVQUFVLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsdUJBQXVCLENBQUUsQ0FBQTtBQUtsRSxNQUFNLGNBQWMsR0FBRyxDQUFDO0lBQ3RCLElBQUksTUFBTSxHQUFrQixJQUFJLENBQUE7SUFDaEMsTUFBTSxDQUFDO1FBQ0wsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDcEIsTUFBTSxDQUFDLE1BQU0sQ0FBQTtRQUNmLENBQUM7UUFDRCxJQUFJLENBQUM7WUFDSCxNQUFNLENBQUMsQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1FBQzlDLENBQUM7UUFBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxDQUFDLEVBQUUsQ0FBQTtRQUNYLENBQUM7SUFDSCxDQUFDLENBQUE7QUFDSCxDQUFDLENBQUMsRUFBRSxDQUFBO0FBRUosMkJBQ0UsUUFBZ0IsRUFDaEIsUUFBZ0I7SUFFaEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFBO0lBQ3BELEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUE7SUFDaEIsQ0FBQztJQUFDLElBQUksQ0FBQyxDQUFDO1FBQ04sTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENB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QUMsQ0FBQztRQUNGLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsT0FBTyxDQUFDLENBQUE7UUFDM0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNoQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2xCLENBQUM7SUFDSCxDQUFDO0lBQ0QsTUFBTSxDQUFDLEdBQUcsQ0FBQTtBQUNaLENBQUM7QUE3QkQsb0NBNkJDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IENQID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxuXG5jb25zdCBhdG9tQ29uZmlnID0gKCkgPT4gYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMnKSFcblxuLyoqXG4gKiBTZXRzIGxvY2FsIG1hdGhqYXhQYXRoIGlmIGF2YWlsYWJsZVxuICovXG5jb25zdCBnZXRNYXRoSmF4UGF0aCA9IChmdW5jdGlvbigpIHtcbiAgbGV0IGNhY2hlZDogc3RyaW5nIHwgbnVsbCA9IG51bGxcbiAgcmV0dXJuIGZ1bmN0aW9uKCkge1xuICAgIGlmIChjYWNoZWQgIT09IG51bGwpIHtcbiAgICAgIHJldHVybiBjYWNoZWRcbiAgICB9XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiAoY2FjaGVkID0gcmVxdWlyZS5yZXNvbHZlKCdtYXRoamF4JykpXG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgcmV0dXJuICcnXG4gICAgfVxuICB9XG59KSgpXG5cbmV4cG9ydCBmdW5jdGlvbiBmaW5kRmlsZVJlY3Vyc2l2ZShcbiAgZmlsZVBhdGg6IHN0cmluZyxcbiAgZmlsZU5hbWU6IHN0cmluZyxcbik6IHN0cmluZyB8IGZhbHNlIHtcbiAgY29uc3QgYmliRmlsZSA9IHBhdGguam9pbihmaWxlUGF0aCwgJy4uLycsIGZpbGVOYW1lKVxuICBpZiAoZnMuZXhpc3RzU3luYyhiaWJGaWxlKSkge1xuICAgIHJldHVybiBiaWJGaWxlXG4gIH0gZWxzZSB7XG4gICAgY29uc3QgbmV3UGF0aCA9IHBhdGguam9pbihiaWJGaWxlLCAnLi4nKVxuICAgIGlmIChuZXdQYXRoICE9PSBmaWxlUGF0aCAmJiAhYXRvbS5wcm9qZWN0LmdldFBhdGhzKCkuaW5jbHVkZXMobmV3UGF0aCkpIHtcbiAgICAgIHJldHVybiBmaW5kRmlsZVJlY3Vyc2l2ZShuZXdQYXRoLCBmaWxlTmFtZSlcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQXJncyB7XG4gIGZyb206IHN0cmluZ1xuICB0bzogJ2h0bWwnXG4gIG1hdGhqYXg/OiBzdHJpbmdcbiAgZmlsdGVyOiBzdHJpbmdbXVxuICBiaWJsaW9ncmFwaHk/OiBzdHJpbmdcbiAgY3NsPzogc3RyaW5nXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRQYW5kb2NPcHRpb25zKFxuICBmaWxlUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkLFxuICByZW5kZXJNYXRoOiBib29sZWFuLFxuKSB7XG4gIC8vIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXRvbS1jb21tdW5pdHkvbWFya2Rvd24tcHJldmlldy1wbHVzL2lzc3Vlcy8zMTZcbiAgY29uc3Qgb3B0czogQ1AuRXhlY0ZpbGVPcHRpb25zID0geyBtYXhCdWZmZXI6IEluZmluaXR5IH1cbiAgaWYgKGZpbGVQYXRoICE9PSB1bmRlZmluZWQpIHtcbiAgICBvcHRzLmN3ZCA9IHBhdGguZGlybmFtZShmaWxlUGF0aClcbiAgfVxuICBjb25zdCBtYXRoamF4UGF0aCA9IGdldE1hdGhKYXhQYXRoKClcbiAgY29uc3QgYXJnczogQXJncyA9IHtcbiAgICBmcm9tOiBhdG9tQ29uZmlnKCkucGFuZG9jTWFya2Rvd25GbGF2b3IsXG4gICAgdG86ICdodG1sJyxcbiAgICBtYXRoamF4OiByZW5kZXJNYXRoID8gbWF0aGpheFBhdGggOiB1bmRlZmluZWQsXG4gICAgZmlsdGVyOiBhdG9tQ29uZmlnKCkucGFuZG9jRmlsdGVycyxcbiAgfVxuICBpZiAoYXRvbUNvbmZpZygpLnBhbmRvY0JpYmxpb2dyYXBoeSkge1xuICAgIGFyZ3MuZmlsdGVyLnB1c2goJ3BhbmRvYy1jaXRlcHJvYycpXG4gICAgbGV0IGJpYkZpbGUgPVxuICAgICAgZmlsZVBhdGggJiYgZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGF0b21Db25maWcoKS5wYW5kb2NCSUJGaWxlKVxuICAgIGlmICghYmliRmlsZSkge1xuICAgICAgYmliRmlsZSA9IGF0b21Db25maWcoKS5wYW5kb2NCSUJGaWxlRmFsbGJhY2tcbiAgICB9XG4gICAgYXJncy5iaWJsaW9ncmFwaHkgPSBiaWJGaWxlID8gYmliRmlsZSA6IHVuZGVmaW5lZFxuICAgIGxldCBjc2xGaWxlID1cbiAgICAgIGZpbGVQYXRoICYmIGZpbmRGaWxlUmVjdXJzaXZlKGZpbGVQYXRoLCBhdG9tQ29uZmlnKCkucGFuZG9jQ1NMRmlsZSlcbiAgICBpZiAoIWNzbEZpbGUpIHtcbiAgICAgIGNzbEZpbGUgPSBhdG9tQ29uZmlnKCkucGFuZG9jQ1NMRmlsZUZhbGxiYWNrXG4gICAgfVxuICAgIGFyZ3MuY3NsID0gY3NsRmlsZSA/IGNzbEZpbGUgOiB1bmRlZmluZWRcbiAgfVxuICByZXR1cm4geyBhcmdzLCBvcHRzIH1cbn1cblxuLyoqXG4gKiBIYW5kbGUgZXJyb3IgcmVzcG9uc2UgZnJvbSBQYW5kb2NcbiAqIEBwYXJhbSB7ZXJyb3J9IFJldHVybmVkIGVycm9yXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICogQHJldHVybiB7YXJyYXl9IHdpdGggQXJndW1lbnRzIGZvciBjYWxsYmFja0Z1bmN0aW9uIChlcnJvciBzZXQgdG8gbnVsbClcbiAqL1xuZnVuY3Rpb24gaGFuZGxlRXJyb3IoZXJyb3I6IHN0cmluZywgaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIGh0bWwgPSBgPGgxPlBhbmRvYyBFcnJvcjo8L2gxPjxwcmU+JHtlcnJvcn08L3ByZT48aHI+JHtodG1sfWBcbiAgcmV0dXJuIGhhbmRsZVN1Y2Nlc3MoaHRtbCwgcmVuZGVyTWF0aClcbn1cblxuLyoqXG4gKiBBZGp1c3RzIGFsbCBtYXRoIGVudmlyb25tZW50cyBpbiBIVE1MXG4gKiBAcGFyYW0ge3N0cmluZ30gSFRNTCB0byBiZSBhZGp1c3RlZFxuICogQHJldHVybiB7c3RyaW5nfSBIVE1MIHdpdGggYWRqdXN0ZWQgbWF0aCBlbnZpcm9ubWVudHNcbiAqL1xuZnVuY3Rpb24gaGFuZGxlTWF0aChodG1sOiBzdHJpbmcpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5tYXRoJykuZm9yRWFjaChmdW5jdGlvbihlbGVtKSB7XG4gICAgbGV0IG1hdGggPSAoZWxlbSBhcyBIVE1MRWxlbWVudCkuaW5uZXJUZXh0XG4gICAgLy8gU2V0IG1vZGUgaWYgaXQgaXMgYmxvY2sgbWF0aFxuICAgIGNvbnN0IG1vZGUgPSBtYXRoLmluZGV4T2YoJ1xcXFxbJykgPiAtMSA/ICc7IG1vZGU9ZGlzcGxheScgOiAnJ1xuXG4gICAgLy8gUmVtb3ZlIHNvdXJyb3VuZGluZyBcXFsgXFxdIGFuZCBcXCggXFwpXG4gICAgbWF0aCA9IG1hdGgucmVwbGFjZSgvXFxcXFtbKClcXF1dL2csICcnKVxuICAgIHJldHVybiAoZWxlbS5vdXRlckhUTUwgPVxuICAgICAgJzxzcGFuIGNsYXNzPVwibWF0aFwiPicgK1xuICAgICAgYDxzY3JpcHQgdHlwZT0nbWF0aC90ZXgke21vZGV9Jz4ke21hdGh9PC9zY3JpcHQ+YCArXG4gICAgICAnPC9zcGFuPicpXG4gIH0pXG5cbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuZnVuY3Rpb24gcmVtb3ZlUmVmZXJlbmNlcyhodG1sOiBzdHJpbmcpIHtcbiAgY29uc3QgZG9jID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JylcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5yZWZlcmVuY2VzJykuZm9yRWFjaCgoZWxlbSkgPT4ge1xuICAgIGVsZW0ucmVtb3ZlKClcbiAgfSlcbiAgcmV0dXJuIGRvYy5pbm5lckhUTUxcbn1cblxuLyoqXG4gKiBIYW5kbGUgc3VjY2Vzc2Z1bCByZXNwb25zZSBmcm9tIFBhbmRvY1xuICogQHBhcmFtIHtzdHJpbmd9IFJldHVybmVkIEhUTUxcbiAqIEByZXR1cm4ge2FycmF5fSB3aXRoIEFyZ3VtZW50cyBmb3IgY2FsbGJhY2tGdW5jdGlvbiAoZXJyb3Igc2V0IHRvIG51bGwpXG4gKi9cbmZ1bmN0aW9uIGhhbmRsZVN1Y2Nlc3MoaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XG4gIGlmIChyZW5kZXJNYXRoKSB7XG4gICAgaHRtbCA9IGhhbmRsZU1hdGgoaHRtbClcbiAgfVxuICBpZiAoYXRvbUNvbmZpZygpLnBhbmRvY1JlbW92ZVJlZmVyZW5jZXMpIHtcbiAgICBodG1sID0gcmVtb3ZlUmVmZXJlbmNlcyhodG1sKVxuICB9XG4gIHJldHVybiBodG1sXG59XG5cbi8qKlxuICogSGFuZGxlIHJlc3BvbnNlIGZyb20gUGFuZG9jXG4gKiBAcGFyYW0ge09iamVjdH0gZXJyb3IgaWYgdGhyb3duXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxuICovXG5mdW5jdGlvbiBoYW5kbGVSZXNwb25zZShlcnJvcjogc3RyaW5nLCBodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcbiAgaWYgKGVycm9yKSB7XG4gICAgcmV0dXJuIGhhbmRsZUVycm9yKGVycm9yLCBodG1sLCByZW5kZXJNYXRoKVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpXG4gIH1cbn1cblxuLyoqXG4gKiBSZW5kZXJzIG1hcmtkb3duIHdpdGggcGFuZG9jXG4gKiBAcGFyYW0ge3N0cmluZ30gZG9jdW1lbnQgaW4gbWFya2Rvd25cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gd2hldGhlciB0byByZW5kZXIgdGhlIG1hdGggd2l0aCBtYXRoamF4XG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFja0Z1bmN0aW9uXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW5kZXJQYW5kb2M8VD4oXG4gIHRleHQ6IHN0cmluZyxcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgcmVuZGVyTWF0aDogYm9vbGVhbixcbiAgY2I6IChlcnI6IEVycm9yIHwgbnVsbCwgcmVzdWx0OiBzdHJpbmcpID0+IFQsXG4pOiBQcm9taXNlPFQ+IHtcbiAgY29uc3QgeyBhcmdzLCBvcHRzIH0gPSBzZXRQYW5kb2NPcHRpb25zKGZpbGVQYXRoLCByZW5kZXJNYXRoKVxuICByZXR1cm4gbmV3IFByb21pc2U8VD4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIGNvbnN0IGNwID0gQ1AuZXhlY0ZpbGUoXG4gICAgICBhdG9tQ29uZmlnKCkucGFuZG9jUGF0aCxcbiAgICAgIGdldEFyZ3VtZW50cyhhcmdzKSxcbiAgICAgIG9wdHMsXG4gICAgICBmdW5jdGlvbihlcnJvciwgc3Rkb3V0LCBzdGRlcnIpIHtcbiAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKGVycm9yLnRvU3RyaW5nKCksIHtcbiAgICAgICAgICAgIHN0YWNrOiBlcnJvci5zdGFjayxcbiAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgcmVqZWN0KGVycm9yKVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGhhbmRsZVJlc3BvbnNlKHN0ZGVyciB8fCAnJywgc3Rkb3V0IHx8ICcnLCByZW5kZXJNYXRoKVxuICAgICAgICByZXNvbHZlKGNiKG51bGwsIHJlc3VsdCkpXG4gICAgICB9LFxuICAgIClcbiAgICBjcC5zdGRpbi53cml0ZSh0ZXh0KVxuICAgIGNwLnN0ZGluLmVuZCgpXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRBcmd1bWVudHMoaWFyZ3M6IEFyZ3MpIHtcbiAgY29uc3QgYXJncyA9IE9iamVjdC5lbnRyaWVzKGlhcmdzKS5yZWR1Y2U8c3RyaW5nW10+KGZ1bmN0aW9uKFxuICAgIHJlcyxcbiAgICBba2V5LCB2YWxdLFxuICApIHtcbiAgICBpZiAodmFsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGNvbnN0IG52YWwgPSBBcnJheS5pc0FycmF5KHZhbCkgPyB2YWwgOiBbdmFsXVxuICAgICAgbnZhbC5mb3JFYWNoKGZ1bmN0aW9uKHYpIHtcbiAgICAgICAgaWYgKHYubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHJlcy5wdXNoKGAtLSR7a2V5fT0ke3Z9YClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXMucHVzaChgLS0ke2tleX1gKVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgICByZXR1cm4gcmVzXG4gIH0sXG4gIFtdKVxuICBjb25zdCByZXM6IHN0cmluZ1tdID0gW11cbiAgZm9yIChjb25zdCB2YWwgb2YgW1xuICAgIC4uLmFyZ3MsXG4gICAgLi4uYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMucGFuZG9jQXJndW1lbnRzJykhLFxuICBdKSB7XG4gICAgY29uc3QgbmV3dmFsID0gdmFsLnJlcGxhY2UoL14oLS1bXFx3XFwtXSspXFxzKC4rKSQvaSwgJyQxPSQyJylcbiAgICBpZiAobmV3dmFsLnN1YnN0cigwLCAxKSA9PT0gJy0nKSB7XG4gICAgICByZXMucHVzaChuZXd2YWwpXG4gICAgfVxuICB9XG4gIHJldHVybiByZXNcbn1cbiJdfQ==