"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const _ = require("lodash");
const CP = require("child_process");
const fs = require("fs");
const path = require("path");
const util_1 = require("./util");
const getMathJaxPath = (function () {
    let cached = null;
    return function () {
        if (cached !== null) {
            return cached;
        }
        try {
            return (cached = require.resolve('mathjax'));
        }
        catch (e) {
            return '';
        }
    };
})();
function findFileRecursive(filePath, fileName) {
    const bibFile = path.join(filePath, '../', fileName);
    if (fs.existsSync(bibFile)) {
        return bibFile;
    }
    else {
        const newPath = path.join(bibFile, '..');
        if (newPath !== filePath && !_.includes(atom.project.getPaths(), newPath)) {
            return findFileRecursive(newPath, fileName);
        }
        else {
            return false;
        }
    }
}
function setPandocOptions(filePath, renderMath) {
    const opts = { maxBuffer: Infinity };
    if (filePath !== undefined) {
        opts.cwd = path.dirname(filePath);
    }
    const mathjaxPath = getMathJaxPath();
    const config = util_1.atomConfig().pandocConfig;
    const args = {
        from: config.pandocMarkdownFlavor,
        to: 'html',
        mathjax: renderMath ? mathjaxPath : undefined,
        filter: config.pandocFilters,
    };
    if (config.pandocBibliography) {
        args.filter.push('pandoc-citeproc');
        let bibFile = filePath && findFileRecursive(filePath, config.pandocBIBFile);
        if (!bibFile) {
            bibFile = config.pandocBIBFileFallback;
        }
        args.bibliography = bibFile ? bibFile : undefined;
        let cslFile = filePath && findFileRecursive(filePath, config.pandocCSLFile);
        if (!cslFile) {
            cslFile = config.pandocCSLFileFallback;
        }
        args.csl = cslFile ? cslFile : undefined;
    }
    return { args, opts };
}
function handleError(error, html, renderMath) {
    const err = new Error(error);
    err.html = handleSuccess(html, renderMath);
    throw err;
}
function handleMath(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.math').forEach(function (elem) {
        let math = elem.innerText;
        const mode = math.indexOf('\\[') > -1 ? '; mode=display' : '';
        math = math.replace(/\\[[()\]]/g, '');
        return (elem.outerHTML =
            '<span class="math">' +
                `<script type='math/tex${mode}'>${math}</script>` +
                '</span>');
    });
    return doc.innerHTML;
}
function removeReferences(html) {
    const doc = document.createElement('div');
    doc.innerHTML = html;
    doc.querySelectorAll('.references').forEach((elem) => {
        elem.remove();
    });
    return doc.innerHTML;
}
function handleSuccess(html, renderMath) {
    if (renderMath) {
        html = handleMath(html);
    }
    if (util_1.atomConfig().pandocConfig.pandocRemoveReferences) {
        html = removeReferences(html);
    }
    return html;
}
function handleResponse(error, html, renderMath) {
    if (error) {
        return handleError(error, html, renderMath);
    }
    else {
        return handleSuccess(html, renderMath);
    }
}
async function renderPandoc(text, filePath, renderMath) {
    const { args, opts } = setPandocOptions(filePath, renderMath);
    return new Promise((resolve, reject) => {
        const cp = CP.execFile(util_1.atomConfig().pandocConfig.pandocPath, getArguments(args), opts, function (error, stdout, stderr) {
            if (error) {
                atom.notifications.addError(error.toString(), {
                    stack: error.stack,
                    dismissable: true,
                });
                reject(error);
            }
            try {
                const result = handleResponse(stderr || '', stdout || '', renderMath);
                resolve(result);
            }
            catch (e) {
                reject(e);
            }
        });
        cp.stdin.write(text);
        cp.stdin.end();
    });
}
exports.renderPandoc = renderPandoc;
function getArguments(iargs) {
    const args = _.reduce(iargs, function (res, val, key) {
        if (val && !_.isEmpty(val)) {
            const nval = _.flatten([val]);
            _.forEach(nval, function (v) {
                if (!_.isEmpty(v)) {
                    res.push(`--${key}=${v}`);
                }
            });
        }
        return res;
    }, []);
    const res = [];
    for (const val of [...args, ...util_1.atomConfig().pandocConfig.pandocArguments]) {
        const newval = val.replace(/^(--[\w\-]+)\s(.+)$/i, '$1=$2');
        if (newval.substr(0, 1) === '-') {
            res.push(newval);
        }
    }
    return res;
}
exports.testing = {
    setPandocOptions,
    getArguments,
    findFileRecursive,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFuZG9jLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wYW5kb2MtaGVscGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNEJBQTRCO0FBQzVCLG9DQUFvQztBQUNwQyx5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLGlDQUFtQztBQUtuQyxNQUFNLGNBQWMsR0FBRyxDQUFDO0lBQ3RCLElBQUksTUFBTSxHQUFrQixJQUFJLENBQUE7SUFDaEMsT0FBTztRQUNMLElBQUksTUFBTSxLQUFLLElBQUksRUFBRTtZQUNuQixPQUFPLE1BQU0sQ0FBQTtTQUNkO1FBQ0QsSUFBSTtZQUNGLE9BQU8sQ0FBQyxNQUFNLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFBO1NBQzdDO1FBQUMsT0FBTyxDQUFDLEVBQUU7WUFDVixPQUFPLEVBQUUsQ0FBQTtTQUNWO0lBQ0gsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtBQUVKLDJCQUEyQixRQUFnQixFQUFFLFFBQWdCO0lBQzNELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQTtJQUNwRCxJQUFJLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUU7UUFDMUIsT0FBTyxPQUFPLENBQUE7S0FDZjtTQUFNO1FBQ0wsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDeEMsSUFBSSxPQUFPLEtBQUssUUFBUSxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFO1lBQ3pFLE9BQU8saUJBQWlCLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFBO1NBQzVDO2FBQU07WUFDTCxPQUFPLEtBQUss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QUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO29CQUNqQixHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7aUJBQzFCO1lBQ0gsQ0FBQyxDQUFDLENBQUE7U0FDSDtRQUNELE9BQU8sR0FBRyxDQUFBO0lBQ1osQ0FBQyxFQUNELEVBQUUsQ0FDSCxDQUFBO0lBQ0QsTUFBTSxHQUFHLEdBQWEsRUFBRSxDQUFBO0lBQ3hCLEtBQUssTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLElBQUksRUFBRSxHQUFHLGlCQUFVLEVBQUUsQ0FBQyxZQUFZLENBQUMsZUFBZSxDQUFDLEVBQUU7UUFDekUsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxPQUFPLENBQUMsQ0FBQTtRQUMzRCxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUMvQixHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1NBQ2pCO0tBQ0Y7SUFDRCxPQUFPLEdBQUcsQ0FBQTtBQUNaLENBQUM7QUFFWSxRQUFBLE9BQU8sR0FBRztJQUNyQixnQkFBZ0I7SUFDaEIsWUFBWTtJQUNaLGlCQUFpQjtDQUNsQixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxyXG5pbXBvcnQgQ1AgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJylcclxuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMnKVxyXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKVxyXG5pbXBvcnQgeyBhdG9tQ29uZmlnIH0gZnJvbSAnLi91dGlsJ1xyXG5cclxuLyoqXHJcbiAqIFNldHMgbG9jYWwgbWF0aGpheFBhdGggaWYgYXZhaWxhYmxlXHJcbiAqL1xyXG5jb25zdCBnZXRNYXRoSmF4UGF0aCA9IChmdW5jdGlvbigpIHtcclxuICBsZXQgY2FjaGVkOiBzdHJpbmcgfCBudWxsID0gbnVsbFxyXG4gIHJldHVybiBmdW5jdGlvbigpIHtcclxuICAgIGlmIChjYWNoZWQgIT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIGNhY2hlZFxyXG4gICAgfVxyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIChjYWNoZWQgPSByZXF1aXJlLnJlc29sdmUoJ21hdGhqYXgnKSlcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgcmV0dXJuICcnXHJcbiAgICB9XHJcbiAgfVxyXG59KSgpXHJcblxyXG5mdW5jdGlvbiBmaW5kRmlsZVJlY3Vyc2l2ZShmaWxlUGF0aDogc3RyaW5nLCBmaWxlTmFtZTogc3RyaW5nKTogc3RyaW5nIHwgZmFsc2Uge1xyXG4gIGNvbnN0IGJpYkZpbGUgPSBwYXRoLmpvaW4oZmlsZVBhdGgsICcuLi8nLCBmaWxlTmFtZSlcclxuICBpZiAoZnMuZXhpc3RzU3luYyhiaWJGaWxlKSkge1xyXG4gICAgcmV0dXJuIGJpYkZpbGVcclxuICB9IGVsc2Uge1xyXG4gICAgY29uc3QgbmV3UGF0aCA9IHBhdGguam9pbihiaWJGaWxlLCAnLi4nKVxyXG4gICAgaWYgKG5ld1BhdGggIT09IGZpbGVQYXRoICYmICFfLmluY2x1ZGVzKGF0b20ucHJvamVjdC5nZXRQYXRocygpLCBuZXdQYXRoKSkge1xyXG4gICAgICByZXR1cm4gZmluZEZpbGVSZWN1cnNpdmUobmV3UGF0aCwgZmlsZU5hbWUpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICAgIH1cclxuICB9XHJcbn1cclxuXHJcbi8vIGV4cG9ydGVkIGZvciB0ZXN0c1xyXG5leHBvcnQgaW50ZXJmYWNlIEFyZ3Mge1xyXG4gIGZyb206IHN0cmluZ1xyXG4gIHRvOiAnaHRtbCdcclxuICBtYXRoamF4Pzogc3RyaW5nXHJcbiAgZmlsdGVyOiBzdHJpbmdbXVxyXG4gIGJpYmxpb2dyYXBoeT86IHN0cmluZ1xyXG4gIGNzbD86IHN0cmluZ1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRQYW5kb2NPcHRpb25zKGZpbGVQYXRoOiBzdHJpbmcgfCB1bmRlZmluZWQsIHJlbmRlck1hdGg6IGJvb2xlYW4pIHtcclxuICAvLyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2F0b20tY29tbXVuaXR5L21hcmtkb3duLXByZXZpZXctcGx1cy9pc3N1ZXMvMzE2XHJcbiAgY29uc3Qgb3B0czogQ1AuRXhlY0ZpbGVPcHRpb25zID0geyBtYXhCdWZmZXI6IEluZmluaXR5IH1cclxuICBpZiAoZmlsZVBhdGggIT09IHVuZGVmaW5lZCkge1xyXG4gICAgb3B0cy5jd2QgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpXHJcbiAgfVxyXG4gIGNvbnN0IG1hdGhqYXhQYXRoID0gZ2V0TWF0aEpheFBhdGgoKVxyXG4gIGNvbnN0IGNvbmZpZyA9IGF0b21Db25maWcoKS5wYW5kb2NDb25maWdcclxuICBjb25zdCBhcmdzOiBBcmdzID0ge1xyXG4gICAgZnJvbTogY29uZmlnLnBhbmRvY01hcmtkb3duRmxhdm9yLFxyXG4gICAgdG86ICdodG1sJyxcclxuICAgIG1hdGhqYXg6IHJlbmRlck1hdGggPyBtYXRoamF4UGF0aCA6IHVuZGVmaW5lZCxcclxuICAgIGZpbHRlcjogY29uZmlnLnBhbmRvY0ZpbHRlcnMsXHJcbiAgfVxyXG4gIGlmIChjb25maWcucGFuZG9jQmlibGlvZ3JhcGh5KSB7XHJcbiAgICBhcmdzLmZpbHRlci5wdXNoKCdwYW5kb2MtY2l0ZXByb2MnKVxyXG4gICAgbGV0IGJpYkZpbGUgPSBmaWxlUGF0aCAmJiBmaW5kRmlsZVJlY3Vyc2l2ZShmaWxlUGF0aCwgY29uZmlnLnBhbmRvY0JJQkZpbGUpXHJcbiAgICBpZiAoIWJpYkZpbGUpIHtcclxuICAgICAgYmliRmlsZSA9IGNvbmZpZy5wYW5kb2NCSUJGaWxlRmFsbGJhY2tcclxuICAgIH1cclxuICAgIGFyZ3MuYmlibGlvZ3JhcGh5ID0gYmliRmlsZSA/IGJpYkZpbGUgOiB1bmRlZmluZWRcclxuICAgIGxldCBjc2xGaWxlID0gZmlsZVBhdGggJiYgZmluZEZpbGVSZWN1cnNpdmUoZmlsZVBhdGgsIGNvbmZpZy5wYW5kb2NDU0xGaWxlKVxyXG4gICAgaWYgKCFjc2xGaWxlKSB7XHJcbiAgICAgIGNzbEZpbGUgPSBjb25maWcucGFuZG9jQ1NMRmlsZUZhbGxiYWNrXHJcbiAgICB9XHJcbiAgICBhcmdzLmNzbCA9IGNzbEZpbGUgPyBjc2xGaWxlIDogdW5kZWZpbmVkXHJcbiAgfVxyXG4gIHJldHVybiB7IGFyZ3MsIG9wdHMgfVxyXG59XHJcblxyXG4vKipcclxuICogSGFuZGxlIGVycm9yIHJlc3BvbnNlIGZyb20gUGFuZG9jXHJcbiAqIEBwYXJhbSB7ZXJyb3J9IFJldHVybmVkIGVycm9yXHJcbiAqIEBwYXJhbSB7c3RyaW5nfSBSZXR1cm5lZCBIVE1MXHJcbiAqIEByZXR1cm4ge2FycmF5fSB3aXRoIEFyZ3VtZW50cyBmb3IgY2FsbGJhY2tGdW5jdGlvbiAoZXJyb3Igc2V0IHRvIG51bGwpXHJcbiAqL1xyXG5mdW5jdGlvbiBoYW5kbGVFcnJvcihlcnJvcjogc3RyaW5nLCBodG1sOiBzdHJpbmcsIHJlbmRlck1hdGg6IGJvb2xlYW4pOiBuZXZlciB7XHJcbiAgY29uc3QgZXJyID0gbmV3IEVycm9yKGVycm9yKSBhcyBFcnJvciAmIHsgaHRtbDogc3RyaW5nIH1cclxuICBlcnIuaHRtbCA9IGhhbmRsZVN1Y2Nlc3MoaHRtbCwgcmVuZGVyTWF0aClcclxuICB0aHJvdyBlcnJcclxufVxyXG5cclxuLyoqXHJcbiAqIEFkanVzdHMgYWxsIG1hdGggZW52aXJvbm1lbnRzIGluIEhUTUxcclxuICogQHBhcmFtIHtzdHJpbmd9IEhUTUwgdG8gYmUgYWRqdXN0ZWRcclxuICogQHJldHVybiB7c3RyaW5nfSBIVE1MIHdpdGggYWRqdXN0ZWQgbWF0aCBlbnZpcm9ubWVudHNcclxuICovXHJcbmZ1bmN0aW9uIGhhbmRsZU1hdGgoaHRtbDogc3RyaW5nKTogc3RyaW5nIHtcclxuICBjb25zdCBkb2MgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxyXG4gIGRvYy5pbm5lckhUTUwgPSBodG1sXHJcbiAgZG9jLnF1ZXJ5U2VsZWN0b3JBbGwoJy5tYXRoJykuZm9yRWFjaChmdW5jdGlvbihlbGVtKSB7XHJcbiAgICBsZXQgbWF0aCA9IChlbGVtIGFzIEhUTUxFbGVtZW50KS5pbm5lclRleHRcclxuICAgIC8vIFNldCBtb2RlIGlmIGl0IGlzIGJsb2NrIG1hdGhcclxuICAgIGNvbnN0IG1vZGUgPSBtYXRoLmluZGV4T2YoJ1xcXFxbJykgPiAtMSA/ICc7IG1vZGU9ZGlzcGxheScgOiAnJ1xyXG5cclxuICAgIC8vIFJlbW92ZSBzb3Vycm91bmRpbmcgXFxbIFxcXSBhbmQgXFwoIFxcKVxyXG4gICAgbWF0aCA9IG1hdGgucmVwbGFjZSgvXFxcXFtbKClcXF1dL2csICcnKVxyXG4gICAgcmV0dXJuIChlbGVtLm91dGVySFRNTCA9XHJcbiAgICAgICc8c3BhbiBjbGFzcz1cIm1hdGhcIj4nICtcclxuICAgICAgYDxzY3JpcHQgdHlwZT0nbWF0aC90ZXgke21vZGV9Jz4ke21hdGh9PC9zY3JpcHQ+YCArXHJcbiAgICAgICc8L3NwYW4+JylcclxuICB9KVxyXG5cclxuICByZXR1cm4gZG9jLmlubmVySFRNTFxyXG59XHJcblxyXG5mdW5jdGlvbiByZW1vdmVSZWZlcmVuY2VzKGh0bWw6IHN0cmluZykge1xyXG4gIGNvbnN0IGRvYyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXHJcbiAgZG9jLmlubmVySFRNTCA9IGh0bWxcclxuICBkb2MucXVlcnlTZWxlY3RvckFsbCgnLnJlZmVyZW5jZXMnKS5mb3JFYWNoKChlbGVtKSA9PiB7XHJcbiAgICBlbGVtLnJlbW92ZSgpXHJcbiAgfSlcclxuICByZXR1cm4gZG9jLmlubmVySFRNTFxyXG59XHJcblxyXG4vKipcclxuICogSGFuZGxlIHN1Y2Nlc3NmdWwgcmVzcG9uc2UgZnJvbSBQYW5kb2NcclxuICogQHBhcmFtIFJldHVybmVkIEhUTUxcclxuICogQHJldHVybiBQb3NzaWJseSBtb2RpZmllZCByZXR1cm5lZCBIVE1MXHJcbiAqL1xyXG5mdW5jdGlvbiBoYW5kbGVTdWNjZXNzKGh0bWw6IHN0cmluZywgcmVuZGVyTWF0aDogYm9vbGVhbik6IHN0cmluZyB7XHJcbiAgaWYgKHJlbmRlck1hdGgpIHtcclxuICAgIGh0bWwgPSBoYW5kbGVNYXRoKGh0bWwpXHJcbiAgfVxyXG4gIGlmIChhdG9tQ29uZmlnKCkucGFuZG9jQ29uZmlnLnBhbmRvY1JlbW92ZVJlZmVyZW5jZXMpIHtcclxuICAgIGh0bWwgPSByZW1vdmVSZWZlcmVuY2VzKGh0bWwpXHJcbiAgfVxyXG4gIHJldHVybiBodG1sXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBIYW5kbGUgcmVzcG9uc2UgZnJvbSBQYW5kb2NcclxuICogQHBhcmFtIHtPYmplY3R9IGVycm9yIGlmIHRocm93blxyXG4gKiBAcGFyYW0ge3N0cmluZ30gUmV0dXJuZWQgSFRNTFxyXG4gKi9cclxuZnVuY3Rpb24gaGFuZGxlUmVzcG9uc2UoZXJyb3I6IHN0cmluZywgaHRtbDogc3RyaW5nLCByZW5kZXJNYXRoOiBib29sZWFuKSB7XHJcbiAgaWYgKGVycm9yKSB7XHJcbiAgICByZXR1cm4gaGFuZGxlRXJyb3IoZXJyb3IsIGh0bWwsIHJlbmRlck1hdGgpXHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiBoYW5kbGVTdWNjZXNzKGh0bWwsIHJlbmRlck1hdGgpXHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogUmVuZGVycyBtYXJrZG93biB3aXRoIHBhbmRvY1xyXG4gKiBAcGFyYW0ge3N0cmluZ30gZG9jdW1lbnQgaW4gbWFya2Rvd25cclxuICogQHBhcmFtIHtib29sZWFufSB3aGV0aGVyIHRvIHJlbmRlciB0aGUgbWF0aCB3aXRoIG1hdGhqYXhcclxuICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2tGdW5jdGlvblxyXG4gKi9cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbmRlclBhbmRvYyhcclxuICB0ZXh0OiBzdHJpbmcsXHJcbiAgZmlsZVBhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCxcclxuICByZW5kZXJNYXRoOiBib29sZWFuLFxyXG4pOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gIGNvbnN0IHsgYXJncywgb3B0cyB9ID0gc2V0UGFuZG9jT3B0aW9ucyhmaWxlUGF0aCwgcmVuZGVyTWF0aClcclxuICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICBjb25zdCBjcCA9IENQLmV4ZWNGaWxlKFxyXG4gICAgICBhdG9tQ29uZmlnKCkucGFuZG9jQ29uZmlnLnBhbmRvY1BhdGgsXHJcbiAgICAgIGdldEFyZ3VtZW50cyhhcmdzKSxcclxuICAgICAgb3B0cyxcclxuICAgICAgZnVuY3Rpb24oZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSB7XHJcbiAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoZXJyb3IudG9TdHJpbmcoKSwge1xyXG4gICAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXHJcbiAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlLFxyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIHJlamVjdChlcnJvcilcclxuICAgICAgICB9XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGhhbmRsZVJlc3BvbnNlKHN0ZGVyciB8fCAnJywgc3Rkb3V0IHx8ICcnLCByZW5kZXJNYXRoKVxyXG4gICAgICAgICAgcmVzb2x2ZShyZXN1bHQpXHJcbiAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgcmVqZWN0KGUpXHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgKVxyXG4gICAgY3Auc3RkaW4ud3JpdGUodGV4dClcclxuICAgIGNwLnN0ZGluLmVuZCgpXHJcbiAgfSlcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0QXJndW1lbnRzKGlhcmdzOiBBcmdzKSB7XHJcbiAgY29uc3QgYXJncyA9IF8ucmVkdWNlKFxyXG4gICAgaWFyZ3MsXHJcbiAgICBmdW5jdGlvbihyZXM6IHN0cmluZ1tdLCB2YWwsIGtleSkge1xyXG4gICAgICBpZiAodmFsICYmICFfLmlzRW1wdHkodmFsKSkge1xyXG4gICAgICAgIGNvbnN0IG52YWw6IHN0cmluZ1tdID0gXy5mbGF0dGVuKFt2YWxdKVxyXG4gICAgICAgIF8uZm9yRWFjaChudmFsLCBmdW5jdGlvbih2OiBzdHJpbmcpIHtcclxuICAgICAgICAgIGlmICghXy5pc0VtcHR5KHYpKSB7XHJcbiAgICAgICAgICAgIHJlcy5wdXNoKGAtLSR7a2V5fT0ke3Z9YClcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiByZXNcclxuICAgIH0sXHJcbiAgICBbXSxcclxuICApXHJcbiAgY29uc3QgcmVzOiBzdHJpbmdbXSA9IFtdXHJcbiAgZm9yIChjb25zdCB2YWwgb2YgWy4uLmFyZ3MsIC4uLmF0b21Db25maWcoKS5wYW5kb2NDb25maWcucGFuZG9jQXJndW1lbnRzXSkge1xyXG4gICAgY29uc3QgbmV3dmFsID0gdmFsLnJlcGxhY2UoL14oLS1bXFx3XFwtXSspXFxzKC4rKSQvaSwgJyQxPSQyJylcclxuICAgIGlmIChuZXd2YWwuc3Vic3RyKDAsIDEpID09PSAnLScpIHtcclxuICAgICAgcmVzLnB1c2gobmV3dmFsKVxyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gcmVzXHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCB0ZXN0aW5nID0ge1xyXG4gIHNldFBhbmRvY09wdGlvbnMsXHJcbiAgZ2V0QXJndW1lbnRzLFxyXG4gIGZpbmRGaWxlUmVjdXJzaXZlLFxyXG59XHJcbiJdfQ==