"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const table_1 = require("./lib/table");
function skipTextCommand(state, max) {
    const textCommand = state.src.slice(state.pos, state.pos + 5);
    const curPos = state.pos;
    if (textCommand === '\\text') {
        state.pos += 5;
        while (state.src[state.pos] === ' ') {
            state.pos++;
        }
        if (state.src[state.pos] !== '{') {
            state.pos = curPos;
        }
        else {
            while (state.src[state.pos] !== '}' && state.pos < max) {
                state.pos++;
            }
        }
    }
}
function scanDelims(state, start, delimLength) {
    let pos = start;
    let lastChar;
    let nextChar;
    let count;
    let canOpen;
    let canClose;
    let isLastWhiteSpace;
    let isLastPunctChar;
    let isNextWhiteSpace;
    let isNextPunctChar;
    let leftFlanking = true;
    let rightFlanking = true;
    const max = state.posMax;
    const isWhiteSpace = state.md.utils.isWhiteSpace;
    const isPunctChar = state.md.utils.isPunctChar;
    const isMdAsciiPunct = state.md.utils.isMdAsciiPunct;
    lastChar = start > 0 ? state.src.charCodeAt(start - 1) : 0x20;
    if (pos >= max) {
        canOpen = false;
    }
    pos += delimLength;
    count = pos - start;
    nextChar = pos < max ? state.src.charCodeAt(pos) : 0x20;
    isLastPunctChar =
        isMdAsciiPunct(lastChar) || isPunctChar(String.fromCharCode(lastChar));
    isNextPunctChar =
        isMdAsciiPunct(nextChar) || isPunctChar(String.fromCharCode(nextChar));
    isLastWhiteSpace = isWhiteSpace(lastChar);
    isNextWhiteSpace = isWhiteSpace(nextChar);
    if (isNextWhiteSpace) {
        leftFlanking = false;
    }
    else if (isNextPunctChar) {
        if (!(isLastWhiteSpace || isLastPunctChar)) {
            leftFlanking = false;
        }
    }
    if (isLastWhiteSpace) {
        rightFlanking = false;
    }
    else if (isLastPunctChar) {
        if (!(isNextWhiteSpace || isNextPunctChar)) {
            rightFlanking = false;
        }
    }
    canOpen = leftFlanking;
    canClose = rightFlanking;
    return {
        can_open: canOpen,
        can_close: canClose,
        delims: count,
    };
}
function makeMath_inline(delims) {
    return function math_inline(state, silent) {
        let startCount;
        let found;
        let res;
        let token;
        let closeDelim;
        const max = state.posMax;
        const start = state.pos;
        const foundDelims = delims.find(function (i) {
            const open = i[0];
            const openDelim = state.src.slice(start, start + open.length);
            return openDelim === open;
        });
        if (!foundDelims) {
            return false;
        }
        const open = foundDelims[0];
        const close = foundDelims[1];
        if (silent) {
            return false;
        }
        res = scanDelims(state, start, open.length);
        startCount = res.delims;
        if (!res.can_open) {
            state.pos += startCount;
            state.pending += state.src.slice(start, state.pos);
            return true;
        }
        state.pos = start + open.length;
        while (state.pos < max) {
            closeDelim = state.src.slice(state.pos, state.pos + close.length);
            if (closeDelim === close) {
                res = scanDelims(state, state.pos, close.length);
                if (res.can_close) {
                    found = true;
                    break;
                }
            }
            skipTextCommand(state, max);
            state.md.inline.skipToken(state);
        }
        if (!found) {
            state.pos = start;
            return false;
        }
        state.posMax = state.pos;
        state.pos = start + close.length;
        token = state.push('math_inline', 'math', 0);
        token.content = state.src.slice(state.pos, state.posMax);
        token.markup = open;
        state.pos = state.posMax + close.length;
        state.posMax = max;
        return true;
    };
}
function makeMath_block(delims) {
    return function math_block(state, startLine, endLine, silent) {
        let len;
        let nextLine;
        let token;
        let firstLine;
        let lastLine;
        let lastLinePos;
        let closeDelim;
        let haveEndMarker = false;
        let closeStartsAtNewline = false;
        let pos = state.bMarks[startLine] + state.tShift[startLine];
        let max = state.eMarks[startLine];
        const foundDelims = delims.find(function (i) {
            const open = i[0];
            const openDelim = state.src.slice(pos, pos + open.length);
            return openDelim === open;
        });
        if (!foundDelims) {
            return false;
        }
        const open = foundDelims[0];
        let close = foundDelims[1];
        if (close[0] === '\n') {
            closeStartsAtNewline = true;
            close = close.slice(1);
        }
        if (pos + open.length > max + 1) {
            return false;
        }
        pos += open.length;
        firstLine = state.src.slice(pos, max);
        if (silent) {
            return true;
        }
        if (firstLine.trim().slice(-close.length) === close) {
            firstLine = firstLine.trim().slice(0, -close.length);
            haveEndMarker = true;
        }
        nextLine = startLine;
        for (;;) {
            if (haveEndMarker) {
                break;
            }
            nextLine++;
            if (nextLine >= endLine) {
                break;
            }
            pos = state.bMarks[nextLine] + state.tShift[nextLine];
            max = state.eMarks[nextLine];
            if (pos < max && state.tShift[nextLine] < state.blkIndent) {
                break;
            }
            closeDelim = closeStartsAtNewline
                ? state.src.slice(pos, max).trim()
                : state.src
                    .slice(pos, max)
                    .trim()
                    .slice(-close.length);
            if (closeDelim !== close) {
                continue;
            }
            if (state.tShift[nextLine] - state.blkIndent >= 4) {
                continue;
            }
            lastLinePos = state.src.slice(0, max).lastIndexOf(close);
            lastLine = state.src.slice(pos, lastLinePos);
            pos += lastLine.length + close.length;
            pos = state.skipSpaces(pos);
            if (pos < max) {
                continue;
            }
            haveEndMarker = true;
        }
        len = state.tShift[startLine];
        state.line = nextLine + (haveEndMarker ? 1 : 0);
        token = state.push('math_block', 'math', 0);
        token.block = true;
        token.content =
            (firstLine && firstLine.trim() ? firstLine + '\n' : '') +
                state.getLines(startLine + 1, nextLine, len, true) +
                (lastLine && lastLine.trim() ? lastLine : '');
        token.map = [startLine, state.line];
        token.markup = open;
        return true;
    };
}
function makeMathRenderer(renderingOptions = {}) {
    return renderingOptions.display === 'block'
        ? function (tokens, idx) {
            return '<div class="math block">' + tokens[idx].content + '</div>\n';
        }
        : function (tokens, idx) {
            return '<span class="math inline">' + tokens[idx].content + '</span>';
        };
}
function math_plugin(md, options = {}) {
    const inlineDelim = options.inlineDelim || [['$$', '$$']];
    const blockDelim = options.blockDelim || [['$$$', '$$$']];
    const oInlineRenderer = options.inlineRenderer;
    const oBlockRenderer = options.blockRenderer;
    const inlineRenderer = oInlineRenderer
        ? function (tokens, idx) {
            return oInlineRenderer(tokens[idx].content);
        }
        : makeMathRenderer(options.renderingOptions);
    const blockRenderer = oBlockRenderer
        ? function (tokens, idx) {
            return oBlockRenderer(tokens[idx].content) + '\n';
        }
        : makeMathRenderer(Object.assign({ display: 'block' }, options.renderingOptions));
    const mathInline = makeMath_inline(inlineDelim);
    const mathBlock = makeMath_block(blockDelim);
    md.inline.ruler.before('escape', 'math_inline', mathInline);
    md.block.ruler.after('blockquote', 'math_block', mathBlock, {
        alt: ['paragraph', 'reference', 'blockquote', 'list'],
    });
    md.renderer.rules.math_inline = inlineRenderer;
    md.renderer.rules.math_block = blockRenderer;
    const tableBlock = table_1.makeTable({
        inlineDelim,
        blockDelim,
    });
    md.block.ruler.at('table', tableBlock, {
        alt: ['paragraph', 'reference'],
    });
}
exports.math_plugin = math_plugin;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbWFya2Rvd24taXQtbWF0aC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUlBLHVDQUF1QztBQUV2QyxTQUFTLGVBQWUsQ0FBQyxLQUFVLEVBQUUsR0FBVztJQUM5QyxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDN0QsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQTtJQUN4QixJQUFJLFdBQVcsS0FBSyxRQUFRLEVBQUU7UUFDNUIsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUE7UUFDZCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUNuQyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUE7U0FDWjtRQUNELElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUssR0FBRyxFQUFFO1lBQ2hDLEtBQUssQ0FBQyxHQUFHLEdBQUcsTUFBTSxDQUFBO1NBQ25CO2FBQU07WUFDTCxPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsR0FBRyxHQUFHLEdBQUcsRUFBRTtnQkFDdEQsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFBO2FBQ1o7U0FDRjtLQUNGO0FBQ0gsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLEtBQVUsRUFBRSxLQUFhLEVBQUUsV0FBbUI7SUFDaEUsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFBO0lBQ2YsSUFBSSxRQUFRLENBQUE7SUFDWixJQUFJLFFBQVEsQ0FBQTtJQUNaLElBQUksS0FBSyxDQUFBO0lBQ1QsSUFBSSxPQUFP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LFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxHQUFHLGNBQWMsQ0FBQTtJQUM5QyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxVQUFVLEdBQUcsYUFBYSxDQUFBO0lBRzVDLE1BQU0sVUFBVSxHQUFHLGlCQUFTLENBQUM7UUFDM0IsV0FBVztRQUNYLFVBQVU7S0FDWCxDQUFDLENBQUE7SUFDRixFQUFFLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQVUsRUFBRTtRQUNyQyxHQUFHLEVBQUUsQ0FBQyxXQUFXLEVBQUUsV0FBVyxDQUFDO0tBQ2hDLENBQUMsQ0FBQTtBQUNKLENBQUM7QUFyQ0Qsa0NBcUNDIiwic291cmNlc0NvbnRlbnQiOlsiLyogUHJvY2VzcyBpbmxpbmUgbWF0aCAqL1xyXG4vLyB0c2xpbnQ6ZGlzYWJsZTpuby11bnNhZmUtYW55XHJcblxyXG5pbXBvcnQgKiBhcyBtZEl0IGZyb20gJ21hcmtkb3duLWl0J1xyXG5pbXBvcnQgeyBtYWtlVGFibGUgfSBmcm9tICcuL2xpYi90YWJsZSdcclxuXHJcbmZ1bmN0aW9uIHNraXBUZXh0Q29tbWFuZChzdGF0ZTogYW55LCBtYXg6IG51bWJlcikge1xyXG4gIGNvbnN0IHRleHRDb21tYW5kID0gc3RhdGUuc3JjLnNsaWNlKHN0YXRlLnBvcywgc3RhdGUucG9zICsgNSlcclxuICBjb25zdCBjdXJQb3MgPSBzdGF0ZS5wb3NcclxuICBpZiAodGV4dENvbW1hbmQgPT09ICdcXFxcdGV4dCcpIHtcclxuICAgIHN0YXRlLnBvcyArPSA1XHJcbiAgICB3aGlsZSAoc3RhdGUuc3JjW3N0YXRlLnBvc10gPT09ICcgJykge1xyXG4gICAgICBzdGF0ZS5wb3MrK1xyXG4gICAgfVxyXG4gICAgaWYgKHN0YXRlLnNyY1tzdGF0ZS5wb3NdICE9PSAneycpIHtcclxuICAgICAgc3RhdGUucG9zID0gY3VyUG9zXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB3aGlsZSAoc3RhdGUuc3JjW3N0YXRlLnBvc10gIT09ICd9JyAmJiBzdGF0ZS5wb3MgPCBtYXgpIHtcclxuICAgICAgICBzdGF0ZS5wb3MrK1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBzY2FuRGVsaW1zKHN0YXRlOiBhbnksIHN0YXJ0OiBudW1iZXIsIGRlbGltTGVuZ3RoOiBudW1iZXIpIHtcclxuICBsZXQgcG9zID0gc3RhcnRcclxuICBsZXQgbGFzdENoYXJcclxuICBsZXQgbmV4dENoYXJcclxuICBsZXQgY291bnRcclxuICBsZXQgY2FuT3BlblxyXG4gIGxldCBjYW5DbG9zZVxyXG4gIGxldCBpc0xhc3RXaGl0ZVNwYWNlXHJcbiAgbGV0IGlzTGFzdFB1bmN0Q2hhclxyXG4gIGxldCBpc05leHRXaGl0ZVNwYWNlXHJcbiAgbGV0IGlzTmV4dFB1bmN0Q2hhclxyXG4gIGxldCBsZWZ0RmxhbmtpbmcgPSB0cnVlXHJcbiAgbGV0IHJpZ2h0RmxhbmtpbmcgPSB0cnVlXHJcbiAgY29uc3QgbWF4ID0gc3RhdGUucG9zTWF4XHJcbiAgY29uc3QgaXNXaGl0ZVNwYWNlID0gc3RhdGUubWQudXRpbHMuaXNXaGl0ZVNwYWNlXHJcbiAgY29uc3QgaXNQdW5jdENoYXIgPSBzdGF0ZS5tZC51dGlscy5pc1B1bmN0Q2hhclxyXG4gIGNvbnN0IGlzTWRBc2NpaVB1bmN0ID0gc3RhdGUubWQudXRpbHMuaXNNZEFzY2lpUHVuY3RcclxuXHJcbiAgLy8gdHJlYXQgYmVnaW5uaW5nIG9mIHRoZSBsaW5lIGFzIGEgd2hpdGVzcGFjZVxyXG4gIGxhc3RDaGFyID0gc3RhcnQgPiAwID8gc3RhdGUuc3JjLmNoYXJDb2RlQXQoc3RhcnQgLSAxKSA6IDB4MjBcclxuXHJcbiAgaWYgKHBvcyA+PSBtYXgpIHtcclxuICAgIGNhbk9wZW4gPSBmYWxzZVxyXG4gIH1cclxuXHJcbiAgcG9zICs9IGRlbGltTGVuZ3RoXHJcblxyXG4gIGNvdW50ID0gcG9zIC0gc3RhcnRcclxuXHJcbiAgLy8gdHJlYXQgZW5kIG9mIHRoZSBsaW5lIGFzIGEgd2hpdGVzcGFjZVxyXG4gIG5leHRDaGFyID0gcG9zIDwgbWF4ID8gc3RhdGUuc3JjLmNoYXJDb2RlQXQocG9zKSA6IDB4MjBcclxuXHJcbiAgaXNMYXN0UHVuY3RDaGFyID1cclxuICAgIGlzTWRBc2NpaVB1bmN0KGxhc3RDaGFyKSB8fCBpc1B1bmN0Q2hhcihTdHJpbmcuZnJvbUNoYXJDb2RlKGxhc3RDaGFyKSlcclxuICBpc05leHRQdW5jdENoYXIgPVxyXG4gICAgaXNNZEFzY2lpUHVuY3QobmV4dENoYXIpIHx8IGlzUHVuY3RDaGFyKFN0cmluZy5mcm9tQ2hhckNvZGUobmV4dENoYXIpKVxyXG5cclxuICBpc0xhc3RXaGl0ZVNwYWNlID0gaXNXaGl0ZVNwYWNlKGxhc3RDaGFyKVxyXG4gIGlzTmV4dFdoaXRlU3BhY2UgPSBpc1doaXRlU3BhY2UobmV4dENoYXIpXHJcblxyXG4gIGlmIChpc05leHRXaGl0ZVNwYWNlKSB7XHJcbiAgICBsZWZ0RmxhbmtpbmcgPSBmYWxzZVxyXG4gIH0gZWxzZSBpZiAoaXNOZXh0UHVuY3RDaGFyKSB7XHJcbiAgICBpZiAoIShpc0xhc3RXaGl0ZVNwYWNlIHx8IGlzTGFzdFB1bmN0Q2hhcikpIHtcclxuICAgICAgbGVmdEZsYW5raW5nID0gZmFsc2VcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlmIChpc0xhc3RXaGl0ZVNwYWNlKSB7XHJcbiAgICByaWdodEZsYW5raW5nID0gZmFsc2VcclxuICB9IGVsc2UgaWYgKGlzTGFzdFB1bmN0Q2hhcikge1xyXG4gICAgaWYgKCEoaXNOZXh0V2hpdGVTcGFjZSB8fCBpc05leHRQdW5jdENoYXIpKSB7XHJcbiAgICAgIHJpZ2h0RmxhbmtpbmcgPSBmYWxzZVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgY2FuT3BlbiA9IGxlZnRGbGFua2luZ1xyXG4gIGNhbkNsb3NlID0gcmlnaHRGbGFua2luZ1xyXG5cclxuICByZXR1cm4ge1xyXG4gICAgY2FuX29wZW46IGNhbk9wZW4sXHJcbiAgICBjYW5fY2xvc2U6IGNhbkNsb3NlLFxyXG4gICAgZGVsaW1zOiBjb3VudCxcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1ha2VNYXRoX2lubGluZShkZWxpbXM6IFtbc3RyaW5nLCBzdHJpbmddXSkge1xyXG4gIHJldHVybiBmdW5jdGlvbiBtYXRoX2lubGluZShzdGF0ZTogYW55LCBzaWxlbnQ6IGJvb2xlYW4pIHtcclxuICAgIGxldCBzdGFydENvdW50XHJcbiAgICBsZXQgZm91bmRcclxuICAgIGxldCByZXNcclxuICAgIGxldCB0b2tlblxyXG4gICAgbGV0IGNsb3NlRGVsaW1cclxuICAgIGNvbnN0IG1heCA9IHN0YXRlLnBvc01heCBhcyBudW1iZXJcclxuICAgIGNvbnN0IHN0YXJ0ID0gc3RhdGUucG9zIGFzIG51bWJlclxyXG4gICAgY29uc3QgZm91bmREZWxpbXMgPSBkZWxpbXMuZmluZChmdW5jdGlvbihpKSB7XHJcbiAgICAgIGNvbnN0IG9wZW4gPSBpWzBdXHJcbiAgICAgIGNvbnN0IG9wZW5EZWxpbSA9IHN0YXRlLnNyYy5zbGljZShzdGFydCwgc3RhcnQgKyBvcGVuLmxlbmd0aCkgYXMgc3RyaW5nXHJcbiAgICAgIHJldHVybiBvcGVuRGVsaW0gPT09IG9wZW5cclxuICAgIH0pXHJcbiAgICBpZiAoIWZvdW5kRGVsaW1zKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gICAgY29uc3Qgb3BlbiA9IGZvdW5kRGVsaW1zWzBdXHJcbiAgICBjb25zdCBjbG9zZSA9IGZvdW5kRGVsaW1zWzFdXHJcbiAgICBpZiAoc2lsZW50KSB7XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfSAvLyBEb27igJl0IHJ1biBhbnkgcGFpcnMgaW4gdmFsaWRhdGlvbiBtb2RlXHJcblxyXG4gICAgcmVzID0gc2NhbkRlbGltcyhzdGF0ZSwgc3RhcnQsIG9wZW4ubGVuZ3RoKVxyXG4gICAgc3RhcnRDb3VudCA9IHJlcy5kZWxpbXNcclxuXHJcbiAgICBpZiAoIXJlcy5jYW5fb3Blbikge1xyXG4gICAgICBzdGF0ZS5wb3MgKz0gc3RhcnRDb3VudFxyXG4gICAgICAvLyBFYXJsaWVyIHdlIGNoZWNrZWQgIXNpbGVudCwgYnV0IHRoaXMgaW1wbGVtZW50YXRpb24gZG9lcyBub3QgbmVlZCBpdFxyXG4gICAgICBzdGF0ZS5wZW5kaW5nICs9IHN0YXRlLnNyYy5zbGljZShzdGFydCwgc3RhdGUucG9zKVxyXG4gICAgICByZXR1cm4gdHJ1ZVxyXG4gICAgfVxyXG5cclxuICAgIHN0YXRlLnBvcyA9IHN0YXJ0ICsgb3Blbi5sZW5ndGhcclxuXHJcbiAgICB3aGlsZSAoc3RhdGUucG9zIDwgbWF4KSB7XHJcbiAgICAgIGNsb3NlRGVsaW0gPSBzdGF0ZS5zcmMuc2xpY2Uoc3RhdGUucG9zLCBzdGF0ZS5wb3MgKyBjbG9zZS5sZW5ndGgpXHJcbiAgICAgIGlmIChjbG9zZURlbGltID09PSBjbG9zZSkge1xyXG4gICAgICAgIHJlcyA9IHNjYW5EZWxpbXMoc3RhdGUsIHN0YXRlLnBvcywgY2xvc2UubGVuZ3RoKVxyXG4gICAgICAgIGlmIChyZXMuY2FuX2Nsb3NlKSB7XHJcbiAgICAgICAgICBmb3VuZCA9IHRydWVcclxuICAgICAgICAgIGJyZWFrXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIHNraXBUZXh0Q29tbWFuZChzdGF0ZSwgbWF4KVxyXG5cclxuICAgICAgc3RhdGUubWQuaW5saW5lLnNraXBUb2tlbihzdGF0ZSlcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWZvdW5kKSB7XHJcbiAgICAgIC8vIFBhcnNlciBmYWlsZWQgdG8gZmluZCBlbmRpbmcgdGFnLCBzbyBpdCBpcyBub3QgYSB2YWxpZCBtYXRoXHJcbiAgICAgIHN0YXRlLnBvcyA9IHN0YXJ0XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIC8vIEZvdW5kIVxyXG4gICAgc3RhdGUucG9zTWF4ID0gc3RhdGUucG9zXHJcbiAgICBzdGF0ZS5wb3MgPSBzdGFydCArIGNsb3NlLmxlbmd0aFxyXG5cclxuICAgIC8vIEVhcmxpZXIgd2UgY2hlY2tlZCAhc2lsZW50LCBidXQgdGhpcyBpbXBsZW1lbnRhdGlvbiBkb2VzIG5vdCBuZWVkIGl0XHJcbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ21hdGhfaW5saW5lJywgJ21hdGgnLCAwKVxyXG4gICAgdG9rZW4uY29udGVudCA9IHN0YXRlLnNyYy5zbGljZShzdGF0ZS5wb3MsIHN0YXRlLnBvc01heClcclxuICAgIHRva2VuLm1hcmt1cCA9IG9wZW5cclxuXHJcbiAgICBzdGF0ZS5wb3MgPSBzdGF0ZS5wb3NNYXggKyBjbG9zZS5sZW5ndGhcclxuICAgIHN0YXRlLnBvc01heCA9IG1heFxyXG5cclxuICAgIHJldHVybiB0cnVlXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBtYWtlTWF0aF9ibG9jayhkZWxpbXM6IFtbc3RyaW5nLCBzdHJpbmddXSkge1xyXG4gIHJldHVybiBmdW5jdGlvbiBtYXRoX2Jsb2NrKFxyXG4gICAgc3RhdGU6IGFueSxcclxuICAgIHN0YXJ0TGluZTogbnVtYmVyLFxyXG4gICAgZW5kTGluZTogbnVtYmVyLFxyXG4gICAgc2lsZW50OiBib29sZWFuLFxyXG4gICkge1xyXG4gICAgbGV0IGxlblxyXG4gICAgbGV0IG5leHRMaW5lXHJcbiAgICBsZXQgdG9rZW5cclxuICAgIGxldCBmaXJzdExpbmU6IHN0cmluZ1xyXG4gICAgbGV0IGxhc3RMaW5lXHJcbiAgICBsZXQgbGFzdExpbmVQb3NcclxuICAgIGxldCBjbG9zZURlbGltXHJcbiAgICBsZXQgaGF2ZUVuZE1hcmtlciA9IGZhbHNlXHJcbiAgICBsZXQgY2xvc2VTdGFydHNBdE5ld2xpbmUgPSBmYWxzZVxyXG4gICAgbGV0IHBvczogbnVtYmVyID0gc3RhdGUuYk1hcmtzW3N0YXJ0TGluZV0gKyBzdGF0ZS50U2hpZnRbc3RhcnRMaW5lXVxyXG4gICAgbGV0IG1heDogbnVtYmVyID0gc3RhdGUuZU1hcmtzW3N0YXJ0TGluZV1cclxuXHJcbiAgICBjb25zdCBmb3VuZERlbGltcyA9IGRlbGltcy5maW5kKGZ1bmN0aW9uKGkpIHtcclxuICAgICAgY29uc3Qgb3BlbiA9IGlbMF1cclxuICAgICAgY29uc3Qgb3BlbkRlbGltID0gc3RhdGUuc3JjLnNsaWNlKHBvcywgcG9zICsgb3Blbi5sZW5ndGgpXHJcbiAgICAgIHJldHVybiBvcGVuRGVsaW0gPT09IG9wZW5cclxuICAgIH0pXHJcbiAgICBpZiAoIWZvdW5kRGVsaW1zKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gICAgY29uc3Qgb3BlbiA9IGZvdW5kRGVsaW1zWzBdXHJcbiAgICBsZXQgY2xvc2UgPSBmb3VuZERlbGltc1sxXVxyXG5cclxuICAgIGlmIChjbG9zZVswXSA9PT0gJ1xcbicpIHtcclxuICAgICAgY2xvc2VTdGFydHNBdE5ld2xpbmUgPSB0cnVlXHJcbiAgICAgIGNsb3NlID0gY2xvc2Uuc2xpY2UoMSlcclxuICAgIH1cclxuXHJcbiAgICBpZiAocG9zICsgb3Blbi5sZW5ndGggPiBtYXggKyAxKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG5cclxuICAgIHBvcyArPSBvcGVuLmxlbmd0aFxyXG4gICAgZmlyc3RMaW5lID0gc3RhdGUuc3JjLnNsaWNlKHBvcywgbWF4KVxyXG5cclxuICAgIC8vIFNpbmNlIHN0YXJ0IGlzIGZvdW5kLCB3ZSBjYW4gcmVwb3J0IHN1Y2Nlc3MgaGVyZSBpbiB2YWxpZGF0aW9uIG1vZGVcclxuICAgIGlmIChzaWxlbnQpIHtcclxuICAgICAgcmV0dXJuIHRydWVcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZmlyc3RMaW5lLnRyaW0oKS5zbGljZSgtY2xvc2UubGVuZ3RoKSA9PT0gY2xvc2UpIHtcclxuICAgICAgLy8gU2luZ2xlIGxpbmUgZXhwcmVzc2lvblxyXG4gICAgICBmaXJzdExpbmUgPSBmaXJzdExpbmUudHJpbSgpLnNsaWNlKDAsIC1jbG9zZS5sZW5ndGgpXHJcbiAgICAgIGhhdmVFbmRNYXJrZXIgPSB0cnVlXHJcbiAgICB9XHJcblxyXG4gICAgLy8gc2VhcmNoIGVuZCBvZiBibG9ja1xyXG4gICAgbmV4dExpbmUgPSBzdGFydExpbmVcclxuXHJcbiAgICBmb3IgKDs7KSB7XHJcbiAgICAgIGlmIChoYXZlRW5kTWFya2VyKSB7XHJcbiAgICAgICAgYnJlYWtcclxuICAgICAgfVxyXG5cclxuICAgICAgbmV4dExpbmUrK1xyXG5cclxuICAgICAgaWYgKG5leHRMaW5lID49IGVuZExpbmUpIHtcclxuICAgICAgICAvLyB1bmNsb3NlZCBibG9jayBzaG91bGQgYmUgYXV0b2Nsb3NlZCBieSBlbmQgb2YgZG9jdW1lbnQuXHJcbiAgICAgICAgLy8gYWxzbyBibG9jayBzZWVtcyB0byBiZSBhdXRvY2xvc2VkIGJ5IGVuZCBvZiBwYXJlbnRcclxuICAgICAgICBicmVha1xyXG4gICAgICB9XHJcblxyXG4gICAgICBwb3MgPSBzdGF0ZS5iTWFya3NbbmV4dExpbmVdICsgc3RhdGUudFNoaWZ0W25leHRMaW5lXVxyXG4gICAgICBtYXggPSBzdGF0ZS5lTWFya3NbbmV4dExpbmVdXHJcblxyXG4gICAgICBpZiAocG9zIDwgbWF4ICYmIHN0YXRlLnRTaGlmdFtuZXh0TGluZV0gPCBzdGF0ZS5ibGtJbmRlbnQpIHtcclxuICAgICAgICAvLyBub24tZW1wdHkgbGluZSB3aXRoIG5lZ2F0aXZlIGluZGVudCBzaG91bGQgc3RvcCB0aGUgbGlzdDpcclxuICAgICAgICBicmVha1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjbG9zZURlbGltID0gY2xvc2VTdGFydHNBdE5ld2xpbmVcclxuICAgICAgICA/IHN0YXRlLnNyYy5zbGljZShwb3MsIG1heCkudHJpbSgpXHJcbiAgICAgICAgOiBzdGF0ZS5zcmNcclxuICAgICAgICAgICAgLnNsaWNlKHBvcywgbWF4KVxyXG4gICAgICAgICAgICAudHJpbSgpXHJcbiAgICAgICAgICAgIC5zbGljZSgtY2xvc2UubGVuZ3RoKVxyXG5cclxuICAgICAgaWYgKGNsb3NlRGVsaW0gIT09IGNsb3NlKSB7XHJcbiAgICAgICAgY29udGludWVcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKHN0YXRlLnRTaGlmdFtuZXh0TGluZV0gLSBzdGF0ZS5ibGtJbmRlbnQgPj0gNCkge1xyXG4gICAgICAgIC8vIGNsb3NpbmcgYmxvY2sgbWF0aCBzaG91bGQgYmUgaW5kZW50ZWQgbGVzcyB0aGVuIDQgc3BhY2VzXHJcbiAgICAgICAgY29udGludWVcclxuICAgICAgfVxyXG5cclxuICAgICAgbGFzdExpbmVQb3MgPSBzdGF0ZS5zcmMuc2xpY2UoMCwgbWF4KS5sYXN0SW5kZXhPZihjbG9zZSlcclxuICAgICAgbGFzdExpbmUgPSBzdGF0ZS5zcmMuc2xpY2UocG9zLCBsYXN0TGluZVBvcylcclxuXHJcbiAgICAgIHBvcyArPSBsYXN0TGluZS5sZW5ndGggKyBjbG9zZS5sZW5ndGhcclxuXHJcbiAgICAgIC8vIG1ha2Ugc3VyZSB0YWlsIGhhcyBzcGFjZXMgb25seVxyXG4gICAgICBwb3MgPSBzdGF0ZS5za2lwU3BhY2VzKHBvcylcclxuXHJcbiAgICAgIGlmIChwb3MgPCBtYXgpIHtcclxuICAgICAgICBjb250aW51ZVxyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBmb3VuZCFcclxuICAgICAgaGF2ZUVuZE1hcmtlciA9IHRydWVcclxuICAgIH1cclxuXHJcbiAgICAvLyBJZiBtYXRoIGJsb2NrIGhhcyBoZWFkaW5nIHNwYWNlcywgdGhleSBzaG91bGQgYmUgcmVtb3ZlZCBmcm9tIGl0cyBpbm5lciBibG9ja1xyXG4gICAgbGVuID0gc3RhdGUudFNoaWZ0W3N0YXJ0TGluZV1cclxuXHJcbiAgICBzdGF0ZS5saW5lID0gbmV4dExpbmUgKyAoaGF2ZUVuZE1hcmtlciA/IDEgOiAwKVxyXG5cclxuICAgIHRva2VuID0gc3RhdGUucHVzaCgnbWF0aF9ibG9jaycsICdtYXRoJywgMClcclxuICAgIHRva2VuLmJsb2NrID0gdHJ1ZVxyXG4gICAgdG9rZW4uY29udGVudCA9XHJcbiAgICAgIChmaXJzdExpbmUgJiYgZmlyc3RMaW5lLnRyaW0oKSA/IGZpcnN0TGluZSArICdcXG4nIDogJycpICtcclxuICAgICAgc3RhdGUuZ2V0TGluZXMoc3RhcnRMaW5lICsgMSwgbmV4dExpbmUsIGxlbiwgdHJ1ZSkgK1xyXG4gICAgICAobGFzdExpbmUgJiYgbGFzdExpbmUudHJpbSgpID8gbGFzdExpbmUgOiAnJylcclxuICAgIHRva2VuLm1hcCA9IFtzdGFydExpbmUsIHN0YXRlLmxpbmVdXHJcbiAgICB0b2tlbi5tYXJrdXAgPSBvcGVuXHJcblxyXG4gICAgcmV0dXJuIHRydWVcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVuZGVyaW5nT3B0aW9ucyB7XHJcbiAgZGlzcGxheT86ICdibG9jaydcclxufVxyXG5cclxuZnVuY3Rpb24gbWFrZU1hdGhSZW5kZXJlcihyZW5kZXJpbmdPcHRpb25zOiBSZW5kZXJpbmdPcHRpb25zID0ge30pIHtcclxuICByZXR1cm4gcmVuZGVyaW5nT3B0aW9ucy5kaXNwbGF5ID09PSAnYmxvY2snXHJcbiAgICA/IGZ1bmN0aW9uKHRva2VuczogbWRJdC5Ub2tlbltdLCBpZHg6IG51bWJlcikge1xyXG4gICAgICAgIHJldHVybiAnPGRpdiBjbGFzcz1cIm1hdGggYmxvY2tcIj4nICsgdG9rZW5zW2lkeF0uY29udGVudCArICc8L2Rpdj5cXG4nXHJcbiAgICAgIH1cclxuICAgIDogZnVuY3Rpb24odG9rZW5zOiBtZEl0LlRva2VuW10sIGlkeDogbnVtYmVyKSB7XHJcbiAgICAgICAgcmV0dXJuICc8c3BhbiBjbGFzcz1cIm1hdGggaW5saW5lXCI+JyArIHRva2Vuc1tpZHhdLmNvbnRlbnQgKyAnPC9zcGFuPidcclxuICAgICAgfVxyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFBsdWdpbk9wdGlvbnMge1xyXG4gIGlubGluZURlbGltPzogW1tzdHJpbmcsIHN0cmluZ11dXHJcbiAgYmxvY2tEZWxpbT86IFtbc3RyaW5nLCBzdHJpbmddXVxyXG4gIGlubGluZVJlbmRlcmVyPzogKGRhdGE6IHN0cmluZykgPT4gc3RyaW5nXHJcbiAgYmxvY2tSZW5kZXJlcj86IChkYXRhOiBzdHJpbmcpID0+IHN0cmluZ1xyXG4gIHJlbmRlcmluZ09wdGlvbnM/OiBSZW5kZXJpbmdPcHRpb25zXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYXRoX3BsdWdpbihtZDogbWRJdC5NYXJrZG93bkl0LCBvcHRpb25zOiBQbHVnaW5PcHRpb25zID0ge30pIHtcclxuICAvLyBEZWZhdWx0IG9wdGlvbnNcclxuICBjb25zdCBpbmxpbmVEZWxpbSA9IG9wdGlvbnMuaW5saW5lRGVsaW0gfHwgW1snJCQnLCAnJCQnXV1cclxuICBjb25zdCBibG9ja0RlbGltID0gb3B0aW9ucy5ibG9ja0RlbGltIHx8IFtbJyQkJCcsICckJCQnXV1cclxuICBjb25zdCBvSW5saW5lUmVuZGVyZXIgPSBvcHRpb25zLmlubGluZVJlbmRlcmVyXHJcbiAgY29uc3Qgb0Jsb2NrUmVuZGVyZXIgPSBvcHRpb25zLmJsb2NrUmVuZGVyZXJcclxuICBjb25zdCBpbmxpbmVSZW5kZXJlciA9IG9JbmxpbmVSZW5kZXJlclxyXG4gICAgPyBmdW5jdGlvbih0b2tlbnM6IG1kSXQuVG9rZW5bXSwgaWR4OiBudW1iZXIpIHtcclxuICAgICAgICByZXR1cm4gb0lubGluZVJlbmRlcmVyKHRva2Vuc1tpZHhdLmNvbnRlbnQpXHJcbiAgICAgIH1cclxuICAgIDogbWFrZU1hdGhSZW5kZXJlcihvcHRpb25zLnJlbmRlcmluZ09wdGlvbnMpXHJcbiAgY29uc3QgYmxvY2tSZW5kZXJlciA9IG9CbG9ja1JlbmRlcmVyXHJcbiAgICA/IGZ1bmN0aW9uKHRva2VuczogbWRJdC5Ub2tlbltdLCBpZHg6IG51bWJlcikge1xyXG4gICAgICAgIHJldHVybiBvQmxvY2tSZW5kZXJlcih0b2tlbnNbaWR4XS5jb250ZW50KSArICdcXG4nXHJcbiAgICAgIH1cclxuICAgIDogbWFrZU1hdGhSZW5kZXJlcihcclxuICAgICAgICBPYmplY3QuYXNzaWduKHsgZGlzcGxheTogJ2Jsb2NrJyB9LCBvcHRpb25zLnJlbmRlcmluZ09wdGlvbnMpLFxyXG4gICAgICApXHJcblxyXG4gIGNvbnN0IG1hdGhJbmxpbmUgPSAobWFrZU1hdGhfaW5saW5lKGlubGluZURlbGltKSBhcyBhbnkpIGFzIG1kSXQuUnVsZVxyXG4gIGNvbnN0IG1hdGhCbG9jayA9IChtYWtlTWF0aF9ibG9jayhibG9ja0RlbGltKSBhcyBhbnkpIGFzIG1kSXQuUnVsZVxyXG5cclxuICBtZC5pbmxpbmUucnVsZXIuYmVmb3JlKCdlc2NhcGUnLCAnbWF0aF9pbmxpbmUnLCBtYXRoSW5saW5lKVxyXG4gIG1kLmJsb2NrLnJ1bGVyLmFmdGVyKCdibG9ja3F1b3RlJywgJ21hdGhfYmxvY2snLCBtYXRoQmxvY2ssIHtcclxuICAgIGFsdDogWydwYXJhZ3JhcGgnLCAncmVmZXJlbmNlJywgJ2Jsb2NrcXVvdGUnLCAnbGlzdCddLFxyXG4gIH0pXHJcbiAgbWQucmVuZGVyZXIucnVsZXMubWF0aF9pbmxpbmUgPSBpbmxpbmVSZW5kZXJlclxyXG4gIG1kLnJlbmRlcmVyLnJ1bGVzLm1hdGhfYmxvY2sgPSBibG9ja1JlbmRlcmVyXHJcblxyXG4gIC8vIFJlcGxhY2UgZXhpc3RpbmcgdGFibGUgcGFyc2VyIHdpdGggcGFyc2VyIHRoYXQgcmVzcGVjdHMgbmV3IGlubGluZSBkZWxpbXNcclxuICBjb25zdCB0YWJsZUJsb2NrID0gbWFrZVRhYmxlKHtcclxuICAgIGlubGluZURlbGltLFxyXG4gICAgYmxvY2tEZWxpbSxcclxuICB9KVxyXG4gIG1kLmJsb2NrLnJ1bGVyLmF0KCd0YWJsZScsIHRhYmxlQmxvY2ssIHtcclxuICAgIGFsdDogWydwYXJhZ3JhcGgnLCAncmVmZXJlbmNlJ10sXHJcbiAgfSlcclxufVxyXG4iXX0=