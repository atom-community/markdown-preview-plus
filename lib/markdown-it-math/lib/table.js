"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function getLine(state, line) {
    const pos = state.bMarks[line] + state.blkIndent;
    const max = state.eMarks[line];
    return state.src.substr(pos, max - pos);
}
function escapedSplit(str, openDelims, closeDelims) {
    const result = [];
    let pos = 0;
    const max = str.length;
    let ch;
    let escapes = 0;
    let lastPos = 0;
    let lastDelim = 0;
    let delimed = false;
    let delimMaskMap;
    let openDelimIdx = -1;
    let closeDelimIdx = -1;
    ch = str.charCodeAt(pos);
    delimMaskMap = function (e) {
        return str.substring(pos, pos + e.length) === e;
    };
    while (pos < max) {
        openDelimIdx = openDelims.map(delimMaskMap).indexOf(true);
        closeDelimIdx = closeDelims.map(delimMaskMap).indexOf(true);
        if (openDelimIdx > -1 && escapes % 2 === 0 && !delimed) {
            delimed = !delimed;
            lastDelim = pos + openDelims[openDelimIdx].length - 1;
            pos += openDelims[openDelimIdx].length - 1;
        }
        else if (closeDelimIdx > -1 && escapes % 2 === 0 && delimed) {
            delimed = !delimed;
            lastDelim = pos + closeDelims[closeDelimIdx].length - 1;
            pos += closeDelims[closeDelimIdx].length - 1;
        }
        else if (ch === 0x7c && escapes % 2 === 0 && !delimed) {
            result.push(str.substring(lastPos, pos));
            lastPos = pos + 1;
        }
        else if (ch === 0x5c) {
            escapes++;
        }
        else {
            escapes = 0;
        }
        pos++;
        if (pos === max && delimed) {
            delimed = false;
            pos = lastDelim + 1;
        }
        ch = str.charCodeAt(pos);
    }
    result.push(str.substring(lastPos));
    return result;
}
function table(openDelims, closeDelims, state, startLine, endLine, silent) {
    let ch;
    let lineText;
    let pos;
    let i;
    let nextLine;
    let columns;
    let columnCount;
    let token;
    let aligns;
    let t;
    let tableLines;
    let tbodyLines;
    if (startLine + 2 > endLine) {
        return false;
    }
    nextLine = startLine + 1;
    if (state.sCount[nextLine] < state.blkIndent) {
        return false;
    }
    pos = state.bMarks[nextLine] + state.tShift[nextLine];
    if (pos >= state.eMarks[nextLine]) {
        return false;
    }
    ch = state.src.charCodeAt(pos);
    if (ch !== 0x7c && ch !== 0x2d && ch !== 0x3a) {
        return false;
    }
    lineText = getLine(state, startLine + 1);
    if (!/^[-:| ]+$/.test(lineText)) {
        return false;
    }
    columns = lineText.split('|');
    aligns = [];
    for (i = 0; i < columns.length; i++) {
        t = columns[i].trim();
        if (!t) {
            if (i === 0 || i === columns.length - 1) {
                continue;
            }
            else {
                return false;
            }
        }
        if (!/^:?-+:?$/.test(t)) {
            return false;
        }
        if (t.charCodeAt(t.length - 1) === 0x3a) {
            aligns.push(t.charCodeAt(0) === 0x3a ? 'center' : 'right');
        }
        else if (t.charCodeAt(0) === 0x3a) {
            aligns.push('left');
        }
        else {
            aligns.push('');
        }
    }
    lineText = getLine(state, startLine).trim();
    if (lineText.indexOf('|') === -1) {
        return false;
    }
    columns = escapedSplit(lineText.replace(/^\||\|$/g, ''), openDelims, closeDelims);
    columnCount = columns.length;
    if (columnCount > aligns.length) {
        return false;
    }
    if (silent) {
        return true;
    }
    token = state.push('table_open', 'table', 1);
    token.map = tableLines = [startLine, 0];
    token = state.push('thead_open', 'thead', 1);
    token.map = [startLine, startLine + 1];
    token = state.push('tr_open', 'tr', 1);
    token.map = [startLine, startLine + 1];
    for (i = 0; i < columns.length; i++) {
        token = state.push('th_open', 'th', 1);
        token.map = [startLine, startLine + 1];
        if (aligns[i]) {
            token.attrs = [['style', 'text-align:' + aligns[i]]];
        }
        token = state.push('inline', '', 0);
        token.content = columns[i].trim();
        token.map = [startLine, startLine + 1];
        token.children = [];
        token = state.push('th_close', 'th', -1);
    }
    token = state.push('tr_close', 'tr', -1);
    token = state.push('thead_close', 'thead', -1);
    token = state.push('tbody_open', 'tbody', 1);
    token.map = tbodyLines = [startLine + 2, 0];
    for (nextLine = startLine + 2; nextLine < endLine; nextLine++) {
        if (state.sCount[nextLine] < state.blkIndent) {
            break;
        }
        lineText = getLine(state, nextLine).trim();
        if (lineText.indexOf('|') === -1) {
            break;
        }
        columns = escapedSplit(lineText.replace(/^\||\|$/g, ''), openDelims, closeDelims);
        token = state.push('tr_open', 'tr', 1);
        for (i = 0; i < columnCount; i++) {
            token = state.push('td_open', 'td', 1);
            if (aligns[i]) {
                token.attrs = [['style', 'text-align:' + aligns[i]]];
            }
            token = state.push('inline', '', 0);
            token.content = columns[i] ? columns[i].trim() : '';
            token.children = [];
            token = state.push('td_close', 'td', -1);
        }
        token = state.push('tr_close', 'tr', -1);
    }
    token = state.push('tbody_close', 'tbody', -1);
    token = state.push('table_close', 'table', -1);
    tableLines[1] = tbodyLines[1] = nextLine;
    state.line = nextLine;
    return true;
}
function makeTable(options) {
    const openDelims = options.inlineDelim.map((i) => i[0]);
    const closeDelims = options.inlineDelim.map((i) => i[1]);
    openDelims.unshift('`');
    closeDelims.unshift('`');
    return table.bind(null, openDelims, closeDelims);
}
exports.makeTable = makeTable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbWFya2Rvd24taXQtbWF0aC9saWIvdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFJQSxTQUFTLE9BQU8sQ0FBQyxLQUFVLEVBQUUsSUFBWTtJQUN2QyxNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUE7SUFDaEQsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUU5QixPQUFPLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUE7QUFDekMsQ0FBQztBQWtCRCxTQUFTLFlBQVksQ0FDbkIsR0FBVyxFQUNYLFVBQW9CLEVBQ3BCLFdBQXFCO0lBRXJCLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQTtJQUNqQixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUE7SUFDWCxNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFBO0lBQ3RCLElBQUksRUFBRSxDQUFBO0lBQ04sSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ2YsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ2YsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFBO0lBQ2pCLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQTtJQUNuQixJQUFJLFlBQVksQ0FBQTtJQUNoQixJQUFJLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNyQixJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUV0QixFQUFFLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUd4QixZQUFZLEdBQUcsVUFBUyxDQUFTO1FBQy9CLE9BQU8sR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDakQsQ0FBQyxDQUFBO0lBRUQsT0FBTyxHQUFHLEdBQUcsR0FBRyxFQUFFO1FBRWhCLFlBQVksR0FBRyxVQUFVLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN6RCxhQUFhLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7UUFHM0QsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDLElBQUksT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDdEQsT0FBTyxHQUFHLENBQUMsT0FBTyxDQUFBO1lBQ2xCLFNBQVMsR0FBRyxHQUFHLEdBQUcsVUFBVSxDQUFDLFlBQVksQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7WUFDckQsR0FBRyxJQUFJLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1NBRTNDO2FBQU0sSUFBSSxhQUFhLEdBQUcsQ0FBQyxDQUFDLElBQUksT0FBTyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksT0FBTyxFQUFFO1lBQzdELE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQTtZQUNsQixTQUFTLEdBQUcsR0FBRyxHQUFHLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1lBQ3ZELEdBQUcsSUFBSSxXQUFXLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQTtTQUM3QzthQUFNLElBQUksRUFBRSxLQUFLLElBQUksSUFBWSxPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUMvRCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUE7WUFDeEMsT0FBTyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUE7U0FDbEI7YUFBTSxJQUFJLEVBQUUsS0FBSyxJQUFJLEVBQVU7WUFDOUIsT0FBTyxFQUFFLENBQUE7U0FDVjthQUFNO1lBQ0wsT0FBTyxHQUFHLENBQUMsQ0FBQTtTQUNaO1FBRUQsR0FBRyxFQUFFLENBQUE7UUFJTCxJQUFJLEdBQUcsS0FBSyxHQUFHLElBQUksT0FBTyxFQUFFO1lBQzFCLE9BQU8sR0FBRyxLQUFLLENBQUE7WUFDZixHQUFHLEdBQUcsU0FBUyxHQUFHLENBQUMsQ0FBQTtTQUNwQjtRQUVELEVBQUUsR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0tBQ3pCO0lBRUQsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUE7SUFFbkMsT0FBTyxNQUFNLENBQUE7QUFDZixDQUFDO0FBZUQsU0FBUyxLQUFLLENBQ1osVUFBb0IsRUFDcEIsV0FBcUIsRUFDckIsS0FBVSxFQUNWLFNBQWlCLEVBQ2pCLE9BQWUsRUFDZixNQUFlO0lBRWYsSUFBSSxFQUFFLENBQUE7SUFDTixJQUFJLFFBQVEsQ0FBQTtJQUNaLElBQUksR0FBRyxDQUFBO0lBQ1AsSUFBSSxDQUFDLENBQUE7SUFDTCxJQUFJLFFBQVEsQ0FBQTtJQUNaLElBQUksT0FBTyxDQUFBO0lBQ1gsSUFBSSxXQUFXLENBQUE7SUFDZixJQUFJLEtBQUssQ0FBQTtJQUNULElBQUksTUFBTSxDQUFBO0lBQ1YsSUFBSSxDQUFDLENBQUE7SUFDTCxJQUFJLFVBQVUsQ0FBQTtJQUNkLElBQUksVUFBVSxDQUFBO0lBR2QsSUFBSSxTQUFTLEdBQUcsQ0FBQyxHQUFHLE9BQU8sRUFBRTtRQUMzQixPQUFPLEtBQUssQ0FBQTtLQUNiO0lBRUQsUUFBUSxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUE7SUFFeEIsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQyxTQUFTLEVBQUU7UUFDNUMsT0FBTyxLQUFLLENBQUE7S0FDYjtJQUlELEdBQUcsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7SUFDckQsSUFBSSxHQUFHLElBQUksS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUNqQyxPQUFPLEtBQUssQ0FBQTtLQUNiO0lBRUQsRUFBRSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQzlCLElBQUksRUFBRSxLQUFLLElBQUksSUFBWSxFQUFFLEtBQUssSUFBSSxJQUFZLEVBQUUsS0FBSyxJQUFJLEVBQVU7UUFDckUsT0FBTyxLQUFLLENBQUE7S0FDYjtJQUVELFFBQVEsR0FBRyxPQUFPLENBQUMsS0FBSyxFQUFFLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUN4QyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUMvQixPQUFPLEtBQUssQ0FBQTtLQUNiO0lBRUQsT0FBTyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7SUFDN0IsTUFBTSxHQUFHLEVBQUUsQ0FBQTtJQUNYLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNuQyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ3JCLElBQUksQ0FBQyxDQUFDLEVBQUU7WUFHTixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUN2QyxTQUFRO2FBQ1Q7aUJBQU07Z0JBQ0wsT0FBTyxLQUFLLENBQUE7YUFDYjtTQUNGO1FBRUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDdkIsT0FBTyxLQUFLLENBQUE7U0FDYjtRQUNELElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBVTtZQUMvQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFTLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1NBQ25FO2FBQU0sSUFBSSxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksRUFBVTtZQUMzQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1NBQ3BCO2FBQU07WUFDTCxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1NBQ2hCO0tBQ0Y7SUFFRCxRQUFRLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQTtJQUMzQyxJQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUU7UUFDaEMsT0FBTyxLQUFLLENBQUE7S0FDYjtJQUNELE9BQU8sR0FBRyxZQUFZLENBQ3BCLFFBQVEsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxFQUNoQyxVQUFVLEVBQ1YsV0FBVyxDQUNaLENBQUE7SUFJRCxXQUFXLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQTtJQUM1QixJQUFJLFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxFQUFFO1FBQy9CLE9BQU8sS0FBSyxDQUFBO0tBQ2I7SUFFRCxJQUFJLE1BQU0sRUFBRTtRQUNWLE9BQU8sSUFBSSxDQUFBO0tBQ1o7SUFFRCxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBQzVDLEtBQUssQ0FBQyxHQUFHLEdBQUcsVUFBVSxHQUFHLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFBO0lBRXZDLEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUE7SUFDNUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFFdEMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtJQUN0QyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsU0FBUyxFQUFFLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUV0QyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7UUFDbkMsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUN0QyxLQUFLLENBQUMsR0FBRyxHQUFHLENBQUMsU0FBUyxFQUFFLFNBQVMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUN0QyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUNiLEtBQUssQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxhQUFhLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtTQUNyRDtRQUVELEtBQUssR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDbkMsS0FBSyxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUE7UUFDakMsS0FBSyxDQUFDLEdBQUcsR0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDdEMsS0FBSyxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUE7UUFFbkIsS0FBSyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksRUFBRSxDQUFD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R0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUN2RCxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFFeEQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUN2QixXQUFXLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBRXhCLE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFLFdBQVcsQ0FBQyxDQUFBO0FBQ2xELENBQUM7QUFSRCw4QkFRQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIG1hcmtkb3duLWl0LW1hdGhANDgwMjQzOTpsaWIvcnVsZXNfYmxvY2svdGFibGUuanNcclxuLy8gR0ZNIHRhYmxlLCBub24tc3RhbmRhcmRcclxuLy8gdHNsaW50OmRpc2FibGU6bm8tdW5zYWZlLWFueVxyXG5cclxuZnVuY3Rpb24gZ2V0TGluZShzdGF0ZTogYW55LCBsaW5lOiBudW1iZXIpIHtcclxuICBjb25zdCBwb3MgPSBzdGF0ZS5iTWFya3NbbGluZV0gKyBzdGF0ZS5ibGtJbmRlbnRcclxuICBjb25zdCBtYXggPSBzdGF0ZS5lTWFya3NbbGluZV1cclxuXHJcbiAgcmV0dXJuIHN0YXRlLnNyYy5zdWJzdHIocG9zLCBtYXggLSBwb3MpXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBQYXJzZSBhIHRhYmxlIHJvdyBmb3IgY29sdW1ucy9jZWxsc1xyXG4gKlxyXG4gKiBAcGFyYW0gc3RyaW5nIHN0clxyXG4gKiAgIFRoZSB0YWJsZSByb3cgdG8gcGFyc2UgZm9yIGNvbHVtbnMuXHJcbiAqIEBwYXJhbSAgYXJyYXkgb2Ygc3RyaW5nIG9wZW5EZWxpbXNcclxuICogICBUaGUgb3BlbmluZyBkZWxpbWl0ZXIgc2VxdWVuY2VzIGZvciBpbmxpbmVzIHRoYXQgcHJldmVudHMgYW55IGNvbnRhaW5lZFxyXG4gKiAgIHBpcGVzIGZyb20gZGVsaW1pdGluZyBjb2x1bW5zIG9mIHRoZSBwYXJlbnQgdGFibGUgYmxvY2suXHJcbiAqIEBwYXJhbSAgYXJyYXkgb2Ygc3RyaW5nIGNsb3NlRGVsaW1zXHJcbiAqICAgVGhlIGNsb3NpbmcgZGVsaW1pdGVyIHNlcXVlbmNlIGZvciBhbiBpbmxpbmUgdGhhdCBwcmV2ZW50cyBhbnkgY29udGFpbmluZ1xyXG4gKiAgIHBpcGVzIGZyb20gZGVsaW1pdGluZyBjb2x1bW5zIG9mIHRoZSBwYXJlbnQgdGFibGUgYmxvY2suXHJcbiAqIEByZXR1cm4gYXJyYXkgb2Ygc3RyaW5nXHJcbiAqICAgVGhlIHVucGFyc2VkIGNvbnRlbnQgb2YgdGhlIGNlbGxzL2NvbHVtbnMgaWRlbnRpZmllZCBpbiBzdHIgcmV0dXJuZWQgYXNcclxuICogICBpbmRpdmlkdWFsIGVsZW1lbnRzIG9mIGFuIGFycmF5LiBUaGUgY29udGVudCBpcyBzdGlsbCB0byBiZSBwYXJzZWQgYnkgdGhlXHJcbiAqICAgaW5saW5lIHJ1bGVzLlxyXG4gKi9cclxuZnVuY3Rpb24gZXNjYXBlZFNwbGl0KFxyXG4gIHN0cjogc3RyaW5nLFxyXG4gIG9wZW5EZWxpbXM6IHN0cmluZ1tdLFxyXG4gIGNsb3NlRGVsaW1zOiBzdHJpbmdbXSxcclxuKSB7XHJcbiAgY29uc3QgcmVzdWx0ID0gW11cclxuICBsZXQgcG9zID0gMFxyXG4gIGNvbnN0IG1heCA9IHN0ci5sZW5ndGhcclxuICBsZXQgY2hcclxuICBsZXQgZXNjYXBlcyA9IDBcclxuICBsZXQgbGFzdFBvcyA9IDBcclxuICBsZXQgbGFzdERlbGltID0gMFxyXG4gIGxldCBkZWxpbWVkID0gZmFsc2VcclxuICBsZXQgZGVsaW1NYXNrTWFwXHJcbiAgbGV0IG9wZW5EZWxpbUlkeCA9IC0xXHJcbiAgbGV0IGNsb3NlRGVsaW1JZHggPSAtMVxyXG5cclxuICBjaCA9IHN0ci5jaGFyQ29kZUF0KHBvcylcclxuXHJcbiAgLy8gRGVmIG1hcCBmb3IgbWF0Y2hpbmcgb3Blbi9jbG9zZSBkZWxpbWl0ZXIgc2VxdWVuY2Ugd2l0aCBzdHJAcG9zXHJcbiAgZGVsaW1NYXNrTWFwID0gZnVuY3Rpb24oZTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gc3RyLnN1YnN0cmluZyhwb3MsIHBvcyArIGUubGVuZ3RoKSA9PT0gZVxyXG4gIH1cclxuXHJcbiAgd2hpbGUgKHBvcyA8IG1heCkge1xyXG4gICAgLy8gRGV0ZXJtaW5lIElEIG9mIGZpcnN0IG1hdGNoaW5nIG9wZW4vY2xvc2UgZGVsaW1pdGVyIHNlcXVlbmNlXHJcbiAgICBvcGVuRGVsaW1JZHggPSBvcGVuRGVsaW1zLm1hcChkZWxpbU1hc2tNYXApLmluZGV4T2YodHJ1ZSlcclxuICAgIGNsb3NlRGVsaW1JZHggPSBjbG9zZURlbGltcy5tYXAoZGVsaW1NYXNrTWFwKS5pbmRleE9mKHRydWUpXHJcblxyXG4gICAgLy8gRG9lcyBzdHJAcG9zIG1hdGNoIGFueSBvcGVuaW5nIGRlbGltaXRlcj9cclxuICAgIGlmIChvcGVuRGVsaW1JZHggPiAtMSAmJiBlc2NhcGVzICUgMiA9PT0gMCAmJiAhZGVsaW1lZCkge1xyXG4gICAgICBkZWxpbWVkID0gIWRlbGltZWRcclxuICAgICAgbGFzdERlbGltID0gcG9zICsgb3BlbkRlbGltc1tvcGVuRGVsaW1JZHhdLmxlbmd0aCAtIDFcclxuICAgICAgcG9zICs9IG9wZW5EZWxpbXNbb3BlbkRlbGltSWR4XS5sZW5ndGggLSAxXHJcbiAgICAgIC8vIERvZXMgc3RyQHBvcyBtYXRjaCBhbnkgY2xvc2luZyBkZWxpbWl0ZXI/XHJcbiAgICB9IGVsc2UgaWYgKGNsb3NlRGVsaW1JZHggPiAtMSAmJiBlc2NhcGVzICUgMiA9PT0gMCAmJiBkZWxpbWVkKSB7XHJcbiAgICAgIGRlbGltZWQgPSAhZGVsaW1lZFxyXG4gICAgICBsYXN0RGVsaW0gPSBwb3MgKyBjbG9zZURlbGltc1tjbG9zZURlbGltSWR4XS5sZW5ndGggLSAxXHJcbiAgICAgIHBvcyArPSBjbG9zZURlbGltc1tjbG9zZURlbGltSWR4XS5sZW5ndGggLSAxXHJcbiAgICB9IGVsc2UgaWYgKGNoID09PSAweDdjIC8qIHwgKi8gJiYgZXNjYXBlcyAlIDIgPT09IDAgJiYgIWRlbGltZWQpIHtcclxuICAgICAgcmVzdWx0LnB1c2goc3RyLnN1YnN0cmluZyhsYXN0UG9zLCBwb3MpKVxyXG4gICAgICBsYXN0UG9zID0gcG9zICsgMVxyXG4gICAgfSBlbHNlIGlmIChjaCA9PT0gMHg1YyAvKiBcXCAqLykge1xyXG4gICAgICBlc2NhcGVzKytcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGVzY2FwZXMgPSAwXHJcbiAgICB9XHJcblxyXG4gICAgcG9zKytcclxuXHJcbiAgICAvLyBJZiB0aGVyZSB3YXMgYW4gdW4tY2xvc2VkIGRlbGltaXRlciBzZXF1ZW5jZSwgZ28gYmFjayB0byBqdXN0IGFmdGVyXHJcbiAgICAvLyB0aGUgbGFzdCBkZWxpbWl0ZXIgc2VxdWVuY2UsIGJ1dCBhcyBpZiBpdCB3YXMgYSBub3JtYWwgY2hhcmFjdGVyXHJcbiAgICBpZiAocG9zID09PSBtYXggJiYgZGVsaW1lZCkge1xyXG4gICAgICBkZWxpbWVkID0gZmFsc2VcclxuICAgICAgcG9zID0gbGFzdERlbGltICsgMVxyXG4gICAgfVxyXG5cclxuICAgIGNoID0gc3RyLmNoYXJDb2RlQXQocG9zKVxyXG4gIH1cclxuXHJcbiAgcmVzdWx0LnB1c2goc3RyLnN1YnN0cmluZyhsYXN0UG9zKSlcclxuXHJcbiAgcmV0dXJuIHJlc3VsdFxyXG59XHJcblxyXG4vKipcclxuICogQSB0YWJsZSBwbG9jayBwYXJzZXIgd2l0aCByZXN0cmljdGlvbnMgb24gcGlwZSBwbGFjZW1lbnRcclxuICpcclxuICogUGFydGlhbGx5IHBvdWxhdGVkIGRvY3N0cmluZyBkZXNjcmliaW5nIHBhcmFtZXRlcnMgYWRkZWQgdG9cclxuICogYG1hcmtkb3duLWl0LW1hdGhANDgwMjQzOTpsaWIvcnVsZXNfYmxvY2svdGFibGUuanNgLlxyXG4gKlxyXG4gKiBAcGFyYW0gIGFycmF5IG9mIHN0cmluZyBvcGVuRGVsaW1zXHJcbiAqICAgVGhlIG9wZW5pbmcgZGVsaW1pdGVyIHNlcXVlbmNlcyBmb3IgaW5saW5lcyB0aGF0IHByZXZlbnRzIGFueSBjb250YWluZWRcclxuICogICBwaXBlcyBmcm9tIGRlbGltaXRpbmcgY29sdW1ucyBvZiB0aGUgcGFyZW50IHRhYmxlIGJsb2NrLlxyXG4gKiBAcGFyYW0gIGFycmF5IG9mIHN0cmluZyBjbG9zZURlbGltc1xyXG4gKiAgIFRoZSBjbG9zaW5nIGRlbGltaXRlciBzZXF1ZW5jZSBmb3IgYW4gaW5saW5lIHRoYXQgcHJldmVudHMgYW55IGNvbnRhaW5pbmdcclxuICogICBwaXBlcyBmcm9tIGRlbGltaXRpbmcgY29sdW1ucyBvZiB0aGUgcGFyZW50IHRhYmxlIGJsb2NrLlxyXG4gKi9cclxuZnVuY3Rpb24gdGFibGUoXHJcbiAgb3BlbkRlbGltczogc3RyaW5nW10sXHJcbiAgY2xvc2VEZWxpbXM6IHN0cmluZ1tdLFxyXG4gIHN0YXRlOiBhbnksXHJcbiAgc3RhcnRMaW5lOiBudW1iZXIsXHJcbiAgZW5kTGluZTogbnVtYmVyLFxyXG4gIHNpbGVudDogYm9vbGVhbixcclxuKSB7XHJcbiAgbGV0IGNoXHJcbiAgbGV0IGxpbmVUZXh0XHJcbiAgbGV0IHBvc1xyXG4gIGxldCBpXHJcbiAgbGV0IG5leHRMaW5lXHJcbiAgbGV0IGNvbHVtbnNcclxuICBsZXQgY29sdW1uQ291bnRcclxuICBsZXQgdG9rZW5cclxuICBsZXQgYWxpZ25zXHJcbiAgbGV0IHRcclxuICBsZXQgdGFibGVMaW5lc1xyXG4gIGxldCB0Ym9keUxpbmVzXHJcblxyXG4gIC8vIHNob3VsZCBoYXZlIGF0IGxlYXN0IHRocmVlIGxpbmVzXHJcbiAgaWYgKHN0YXJ0TGluZSArIDIgPiBlbmRMaW5lKSB7XHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcblxyXG4gIG5leHRMaW5lID0gc3RhcnRMaW5lICsgMVxyXG5cclxuICBpZiAoc3RhdGUuc0NvdW50W25leHRMaW5lXSA8IHN0YXRlLmJsa0luZGVudCkge1xyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG5cclxuICAvLyBmaXJzdCBjaGFyYWN0ZXIgb2YgdGhlIHNlY29uZCBsaW5lIHNob3VsZCBiZSAnfCcgb3IgJy0nXHJcblxyXG4gIHBvcyA9IHN0YXRlLmJNYXJrc1tuZXh0TGluZV0gKyBzdGF0ZS50U2hpZnRbbmV4dExpbmVdXHJcbiAgaWYgKHBvcyA+PSBzdGF0ZS5lTWFya3NbbmV4dExpbmVdKSB7XHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcblxyXG4gIGNoID0gc3RhdGUuc3JjLmNoYXJDb2RlQXQocG9zKVxyXG4gIGlmIChjaCAhPT0gMHg3YyAvKiB8ICovICYmIGNoICE9PSAweDJkIC8qIC0gKi8gJiYgY2ggIT09IDB4M2EgLyogOiAqLykge1xyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG5cclxuICBsaW5lVGV4dCA9IGdldExpbmUoc3RhdGUsIHN0YXJ0TGluZSArIDEpXHJcbiAgaWYgKCEvXlstOnwgXSskLy50ZXN0KGxpbmVUZXh0KSkge1xyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG5cclxuICBjb2x1bW5zID0gbGluZVRleHQuc3BsaXQoJ3wnKVxyXG4gIGFsaWducyA9IFtdXHJcbiAgZm9yIChpID0gMDsgaSA8IGNvbHVtbnMubGVuZ3RoOyBpKyspIHtcclxuICAgIHQgPSBjb2x1bW5zW2ldLnRyaW0oKVxyXG4gICAgaWYgKCF0KSB7XHJcbiAgICAgIC8vIGFsbG93IGVtcHR5IGNvbHVtbnMgYmVmb3JlIGFuZCBhZnRlciB0YWJsZSwgYnV0IG5vdCBpbiBiZXR3ZWVuIGNvbHVtbnM7XHJcbiAgICAgIC8vIGUuZy4gYWxsb3cgYCB8LS0tfCBgLCBkaXNhbGxvdyBgIC0tLXx8LS0tIGBcclxuICAgICAgaWYgKGkgPT09IDAgfHwgaSA9PT0gY29sdW1ucy5sZW5ndGggLSAxKSB7XHJcbiAgICAgICAgY29udGludWVcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICByZXR1cm4gZmFsc2VcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmICghL146Py0rOj8kLy50ZXN0KHQpKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gICAgaWYgKHQuY2hhckNvZGVBdCh0Lmxlbmd0aCAtIDEpID09PSAweDNhIC8qIDogKi8pIHtcclxuICAgICAgYWxpZ25zLnB1c2godC5jaGFyQ29kZUF0KDApID09PSAweDNhIC8qIDogKi8gPyAnY2VudGVyJyA6ICdyaWdodCcpXHJcbiAgICB9IGVsc2UgaWYgKHQuY2hhckNvZGVBdCgwKSA9PT0gMHgzYSAvKiA6ICovKSB7XHJcbiAgICAgIGFsaWducy5wdXNoKCdsZWZ0JylcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGFsaWducy5wdXNoKCcnKVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbGluZVRleHQgPSBnZXRMaW5lKHN0YXRlLCBzdGFydExpbmUpLnRyaW0oKVxyXG4gIGlmIChsaW5lVGV4dC5pbmRleE9mKCd8JykgPT09IC0xKSB7XHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbiAgY29sdW1ucyA9IGVzY2FwZWRTcGxpdChcclxuICAgIGxpbmVUZXh0LnJlcGxhY2UoL15cXHx8XFx8JC9nLCAnJyksXHJcbiAgICBvcGVuRGVsaW1zLFxyXG4gICAgY2xvc2VEZWxpbXMsXHJcbiAgKVxyXG5cclxuICAvLyBoZWFkZXIgcm93IHdpbGwgZGVmaW5lIGFuIGFtb3VudCBvZiBjb2x1bW5zIGluIHRoZSBlbnRpcmUgdGFibGUsXHJcbiAgLy8gYW5kIGFsaWduIHJvdyBzaG91bGRuJ3QgYmUgc21hbGxlciB0aGFuIHRoYXQgKHRoZSByZXN0IG9mIHRoZSByb3dzIGNhbilcclxuICBjb2x1bW5Db3VudCA9IGNvbHVtbnMubGVuZ3RoXHJcbiAgaWYgKGNvbHVtbkNvdW50ID4gYWxpZ25zLmxlbmd0aCkge1xyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG5cclxuICBpZiAoc2lsZW50KSB7XHJcbiAgICByZXR1cm4gdHJ1ZVxyXG4gIH1cclxuXHJcbiAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0YWJsZV9vcGVuJywgJ3RhYmxlJywgMSlcclxuICB0b2tlbi5tYXAgPSB0YWJsZUxpbmVzID0gW3N0YXJ0TGluZSwgMF1cclxuXHJcbiAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0aGVhZF9vcGVuJywgJ3RoZWFkJywgMSlcclxuICB0b2tlbi5tYXAgPSBbc3RhcnRMaW5lLCBzdGFydExpbmUgKyAxXVxyXG5cclxuICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RyX29wZW4nLCAndHInLCAxKVxyXG4gIHRva2VuLm1hcCA9IFtzdGFydExpbmUsIHN0YXJ0TGluZSArIDFdXHJcblxyXG4gIGZvciAoaSA9IDA7IGkgPCBjb2x1bW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RoX29wZW4nLCAndGgnLCAxKVxyXG4gICAgdG9rZW4ubWFwID0gW3N0YXJ0TGluZSwgc3RhcnRMaW5lICsgMV1cclxuICAgIGlmIChhbGlnbnNbaV0pIHtcclxuICAgICAgdG9rZW4uYXR0cnMgPSBbWydzdHlsZScsICd0ZXh0LWFsaWduOicgKyBhbGlnbnNbaV1dXVxyXG4gICAgfVxyXG5cclxuICAgIHRva2VuID0gc3RhdGUucHVzaCgnaW5saW5lJywgJycsIDApXHJcbiAgICB0b2tlbi5jb250ZW50ID0gY29sdW1uc1tpXS50cmltKClcclxuICAgIHRva2VuLm1hcCA9IFtzdGFydExpbmUsIHN0YXJ0TGluZSArIDFdXHJcbiAgICB0b2tlbi5jaGlsZHJlbiA9IFtdXHJcblxyXG4gICAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0aF9jbG9zZScsICd0aCcsIC0xKVxyXG4gIH1cclxuXHJcbiAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0cl9jbG9zZScsICd0cicsIC0xKVxyXG4gIHRva2VuID0gc3RhdGUucHVzaCgndGhlYWRfY2xvc2UnLCAndGhlYWQnLCAtMSlcclxuXHJcbiAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0Ym9keV9vcGVuJywgJ3Rib2R5JywgMSlcclxuICB0b2tlbi5tYXAgPSB0Ym9keUxpbmVzID0gW3N0YXJ0TGluZSArIDIsIDBdXHJcblxyXG4gIGZvciAobmV4dExpbmUgPSBzdGFydExpbmUgKyAyOyBuZXh0TGluZSA8IGVuZExpbmU7IG5leHRMaW5lKyspIHtcclxuICAgIGlmIChzdGF0ZS5zQ291bnRbbmV4dExpbmVdIDwgc3RhdGUuYmxrSW5kZW50KSB7XHJcbiAgICAgIGJyZWFrXHJcbiAgICB9XHJcblxyXG4gICAgbGluZVRleHQgPSBnZXRMaW5lKHN0YXRlLCBuZXh0TGluZSkudHJpbSgpXHJcbiAgICBpZiAobGluZVRleHQuaW5kZXhPZignfCcpID09PSAtMSkge1xyXG4gICAgICBicmVha1xyXG4gICAgfVxyXG4gICAgY29sdW1ucyA9IGVzY2FwZWRTcGxpdChcclxuICAgICAgbGluZVRleHQucmVwbGFjZSgvXlxcfHxcXHwkL2csICcnKSxcclxuICAgICAgb3BlbkRlbGltcyxcclxuICAgICAgY2xvc2VEZWxpbXMsXHJcbiAgICApXHJcblxyXG4gICAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0cl9vcGVuJywgJ3RyJywgMSlcclxuICAgIGZvciAoaSA9IDA7IGkgPCBjb2x1bW5Db3VudDsgaSsrKSB7XHJcbiAgICAgIHRva2VuID0gc3RhdGUucHVzaCgndGRfb3BlbicsICd0ZCcsIDEpXHJcbiAgICAgIGlmIChhbGlnbnNbaV0pIHtcclxuICAgICAgICB0b2tlbi5hdHRycyA9IFtbJ3N0eWxlJywgJ3RleHQtYWxpZ246JyArIGFsaWduc1tpXV1dXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHRva2VuID0gc3RhdGUucHVzaCgnaW5saW5lJywgJycsIDApXHJcbiAgICAgIHRva2VuLmNvbnRlbnQgPSBjb2x1bW5zW2ldID8gY29sdW1uc1tpXS50cmltKCkgOiAnJ1xyXG4gICAgICB0b2tlbi5jaGlsZHJlbiA9IFtdXHJcblxyXG4gICAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RkX2Nsb3NlJywgJ3RkJywgLTEpXHJcbiAgICB9XHJcbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RyX2Nsb3NlJywgJ3RyJywgLTEpXHJcbiAgfVxyXG4gIHRva2VuID0gc3RhdGUucHVzaCgndGJvZHlfY2xvc2UnLCAndGJvZHknLCAtMSlcclxuICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RhYmxlX2Nsb3NlJywgJ3RhYmxlJywgLTEpXHJcblxyXG4gIHRhYmxlTGluZXNbMV0gPSB0Ym9keUxpbmVzWzFdID0gbmV4dExpbmVcclxuICBzdGF0ZS5saW5lID0gbmV4dExpbmVcclxuICByZXR1cm4gdHJ1ZVxyXG59XHJcblxyXG4vKipcclxuICogUHJlcGFyZSBhIHRhYmxlIHBsb2NrIHBhcnNlciB3aXRoIHJlc3RyaWN0aW9ucyBvbiBwaXBlIHBsYWNlbWVudFxyXG4gKlxyXG4gKiBAcGFyYW0gIHN0cmluZyBvcGVuXHJcbiAqICAgVGhlIG9wZW5pbmcgZGVsaW1pdGVyIHNlcXVlbmNlIGZvciBhbiBpbmxpbmUgdGhhdCBwcmV2ZW50cyBhbnkgY29udGFpbmVkXHJcbiAqICAgcGlwZXMgZnJvbSBkZWxpbWl0aW5nIGNvbHVtbnMgb2YgdGhlIHBhcmVudCB0YWJsZSBibG9jay5cclxuICogQHBhcmFtICBzdHJpbmcgY2xvc2VcclxuICogICBUaGUgY2xvc2luZyBkZWxpbWl0ZXIgc2VxdWVuY2UgZm9yIGFuIGlubGluZSB0aGF0IHByZXZlbnRzIGFueSBjb250YWluaW5nXHJcbiAqICAgcGlwZXMgZnJvbSBkZWxpbWl0aW5nIGNvbHVtbnMgb2YgdGhlIHBhcmVudCB0YWJsZSBibG9jay5cclxuICogQHJldHVybiBmdW5jdGlvblxyXG4gKiAgIFRoZSB0YWJsZSBibG9jayBwYXJzZXIgdGhhdCBzaG91bGQgYmUgdXNlZCBpbiBwbGFjZSBvZiB0aGUgZXhpc3RpbmcgdGFibGVcclxuICogICBibG9jayBwYXJzZXIgc3VjaCB0aGF0IHRoZSBzcGVjaWZpZWQgaW5saW5lIGJ5IGBvcGVuYCBhbmQgYGNsb3NlYCBpc1xyXG4gKiAgIHJlc3BlY3RlZC4gVGhlIGRlbGltaXRlcnMgYXJlIGFkZGVkIHRvIGV4aXN0aW5nIGxpc3Qgb2YgZGVsaW1pdGVyIHBhaXJzIGluXHJcbiAqICAgYGVzY2FwZWRTcGxpdERlbGltaXRlcnNgIGFsbG93aW5nIGBtYXJrZG93bi1pdC1tYXRoYCB0byBiZSBgdXNlYCdkIG11bHRpcGxlXHJcbiAqICAgdGltZXMgbGVhZGluZyB0byBtdWx0aXBsZSBpbmxpbmUgZGVsaW1pdGVycy5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBtYWtlVGFibGUob3B0aW9uczogT3B0aW9ucykge1xyXG4gIGNvbnN0IG9wZW5EZWxpbXMgPSBvcHRpb25zLmlubGluZURlbGltLm1hcCgoaSkgPT4gaVswXSlcclxuICBjb25zdCBjbG9zZURlbGltcyA9IG9wdGlvbnMuaW5saW5lRGVsaW0ubWFwKChpKSA9PiBpWzFdKVxyXG5cclxuICBvcGVuRGVsaW1zLnVuc2hpZnQoJ2AnKVxyXG4gIGNsb3NlRGVsaW1zLnVuc2hpZnQoJ2AnKVxyXG5cclxuICByZXR1cm4gdGFibGUuYmluZChudWxsLCBvcGVuRGVsaW1zLCBjbG9zZURlbGltcylcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcclxuICBpbmxpbmVEZWxpbTogW1tzdHJpbmcsIHN0cmluZ11dXHJcbiAgYmxvY2tEZWxpbTogW1tzdHJpbmcsIHN0cmluZ11dXHJcbn1cclxuIl19