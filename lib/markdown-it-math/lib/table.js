"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function getLine(state, line) {
    const pos = state.bMarks[line] + state.blkIndent;
    const max = state.eMarks[line];
    return state.src.substr(pos, max - pos);
}
function escapedSplit(str, openDelims, closeDelims) {
    const result = [];
    let pos = 0;
    const max = str.length;
    let ch;
    let escapes = 0;
    let lastPos = 0;
    let lastDelim = 0;
    let delimed = false;
    let delimMaskMap;
    let openDelimIdx = -1;
    let closeDelimIdx = -1;
    ch = str.charCodeAt(pos);
    delimMaskMap = function (e) {
        return str.substring(pos, pos + e.length) === e;
    };
    while (pos < max) {
        openDelimIdx = openDelims.map(delimMaskMap).indexOf(true);
        closeDelimIdx = closeDelims.map(delimMaskMap).indexOf(true);
        if (openDelimIdx > -1 && escapes % 2 === 0 && !delimed) {
            delimed = !delimed;
            lastDelim = pos + openDelims[openDelimIdx].length - 1;
            pos += openDelims[openDelimIdx].length - 1;
        }
        else if (closeDelimIdx > -1 && escapes % 2 === 0 && delimed) {
            delimed = !delimed;
            lastDelim = pos + closeDelims[closeDelimIdx].length - 1;
            pos += closeDelims[closeDelimIdx].length - 1;
        }
        else if (ch === 0x7c && escapes % 2 === 0 && !delimed) {
            result.push(str.substring(lastPos, pos));
            lastPos = pos + 1;
        }
        else if (ch === 0x5c) {
            escapes++;
        }
        else {
            escapes = 0;
        }
        pos++;
        if (pos === max && delimed) {
            delimed = false;
            pos = lastDelim + 1;
        }
        ch = str.charCodeAt(pos);
    }
    result.push(str.substring(lastPos));
    return result;
}
function table(openDelims, closeDelims, state, startLine, endLine, silent) {
    let ch;
    let lineText;
    let pos;
    let i;
    let nextLine;
    let columns;
    let columnCount;
    let token;
    let aligns;
    let t;
    let tableLines;
    let tbodyLines;
    if (startLine + 2 > endLine) {
        return false;
    }
    nextLine = startLine + 1;
    if (state.sCount[nextLine] < state.blkIndent) {
        return false;
    }
    pos = state.bMarks[nextLine] + state.tShift[nextLine];
    if (pos >= state.eMarks[nextLine]) {
        return false;
    }
    ch = state.src.charCodeAt(pos);
    if (ch !== 0x7c && ch !== 0x2d && ch !== 0x3a) {
        return false;
    }
    lineText = getLine(state, startLine + 1);
    if (!/^[-:| ]+$/.test(lineText)) {
        return false;
    }
    columns = lineText.split('|');
    aligns = [];
    for (i = 0; i < columns.length; i++) {
        t = columns[i].trim();
        if (!t) {
            if (i === 0 || i === columns.length - 1) {
                continue;
            }
            else {
                return false;
            }
        }
        if (!/^:?-+:?$/.test(t)) {
            return false;
        }
        if (t.charCodeAt(t.length - 1) === 0x3a) {
            aligns.push(t.charCodeAt(0) === 0x3a ? 'center' : 'right');
        }
        else if (t.charCodeAt(0) === 0x3a) {
            aligns.push('left');
        }
        else {
            aligns.push('');
        }
    }
    lineText = getLine(state, startLine).trim();
    if (lineText.indexOf('|') === -1) {
        return false;
    }
    columns = escapedSplit(lineText.replace(/^\||\|$/g, ''), openDelims, closeDelims);
    columnCount = columns.length;
    if (columnCount > aligns.length) {
        return false;
    }
    if (silent) {
        return true;
    }
    token = state.push('table_open', 'table', 1);
    token.map = tableLines = [startLine, 0];
    token = state.push('thead_open', 'thead', 1);
    token.map = [startLine, startLine + 1];
    token = state.push('tr_open', 'tr', 1);
    token.map = [startLine, startLine + 1];
    for (i = 0; i < columns.length; i++) {
        token = state.push('th_open', 'th', 1);
        token.map = [startLine, startLine + 1];
        if (aligns[i]) {
            token.attrs = [['style', 'text-align:' + aligns[i]]];
        }
        token = state.push('inline', '', 0);
        token.content = columns[i].trim();
        token.map = [startLine, startLine + 1];
        token.children = [];
        token = state.push('th_close', 'th', -1);
    }
    token = state.push('tr_close', 'tr', -1);
    token = state.push('thead_close', 'thead', -1);
    token = state.push('tbody_open', 'tbody', 1);
    token.map = tbodyLines = [startLine + 2, 0];
    for (nextLine = startLine + 2; nextLine < endLine; nextLine++) {
        if (state.sCount[nextLine] < state.blkIndent) {
            break;
        }
        lineText = getLine(state, nextLine).trim();
        if (lineText.indexOf('|') === -1) {
            break;
        }
        columns = escapedSplit(lineText.replace(/^\||\|$/g, ''), openDelims, closeDelims);
        token = state.push('tr_open', 'tr', 1);
        for (i = 0; i < columnCount; i++) {
            token = state.push('td_open', 'td', 1);
            if (aligns[i]) {
                token.attrs = [['style', 'text-align:' + aligns[i]]];
            }
            token = state.push('inline', '', 0);
            token.content = columns[i] ? columns[i].trim() : '';
            token.children = [];
            token = state.push('td_close', 'td', -1);
        }
        token = state.push('tr_close', 'tr', -1);
    }
    token = state.push('tbody_close', 'tbody', -1);
    token = state.push('table_close', 'table', -1);
    tableLines[1] = tbodyLines[1] = nextLine;
    state.line = nextLine;
    return true;
}
function makeTable(options) {
    const openDelims = options.inlineDelim.map((i) => i[0]);
    const closeDelims = options.inlineDelim.map((i) => i[1]);
    openDelims.unshift('`');
    closeDelims.unshift('`');
    return table.bind(null, openDelims, closeDelims);
}
exports.makeTable = makeTable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvbWFya2Rvd24taXQtbWF0aC9saWIvdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFJQSxpQkFBaUIsS0FBVSxFQUFFLElBQVk7SUFDdkMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFBO0lBQ2hELE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUE7SUFFOUIsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFBO0FBQ3pDLENBQUM7QUFrQkQsc0JBQ0UsR0FBVyxFQUNYLFVBQW9CLEVBQ3BCLFdBQXFCO0lBRXJCLE1BQU0sTUFBTSxHQUFHLEVBQUUsQ0FBQTtJQUNqQixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUE7SUFDWCxNQUFNLEdBQUcsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFBO0lBQ3RCLElBQUksRUFBRSxDQUFBO0lBQ04sSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ2YsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFBO0lBQ2YsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFBO0lBQ2pCLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQTtJQUNuQixJQUFJLFlBQVksQ0FBQTtJQUNoQixJQUFJLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUNyQixJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUV0QixFQUFFLEdBQUcsR0FBRyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUd4QixZQUFZLEdBQUcsVUFBUyxDQUFTO1FBQy9CLE9BQU8sR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMs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QUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQ3ZELE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUV4RCxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQ3ZCLFdBQVcsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUE7SUFFeEIsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsV0FBVyxDQUFDLENBQUE7QUFDbEQsQ0FBQztBQVJELDhCQVFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbWFya2Rvd24taXQtbWF0aEA0ODAyNDM5OmxpYi9ydWxlc19ibG9jay90YWJsZS5qc1xuLy8gR0ZNIHRhYmxlLCBub24tc3RhbmRhcmRcbi8vIHRzbGludDpkaXNhYmxlOm5vLXVuc2FmZS1hbnlcblxuZnVuY3Rpb24gZ2V0TGluZShzdGF0ZTogYW55LCBsaW5lOiBudW1iZXIpIHtcbiAgY29uc3QgcG9zID0gc3RhdGUuYk1hcmtzW2xpbmVdICsgc3RhdGUuYmxrSW5kZW50XG4gIGNvbnN0IG1heCA9IHN0YXRlLmVNYXJrc1tsaW5lXVxuXG4gIHJldHVybiBzdGF0ZS5zcmMuc3Vic3RyKHBvcywgbWF4IC0gcG9zKVxufVxuXG4vKipcbiAqIFBhcnNlIGEgdGFibGUgcm93IGZvciBjb2x1bW5zL2NlbGxzXG4gKlxuICogQHBhcmFtIHN0cmluZyBzdHJcbiAqICAgVGhlIHRhYmxlIHJvdyB0byBwYXJzZSBmb3IgY29sdW1ucy5cbiAqIEBwYXJhbSAgYXJyYXkgb2Ygc3RyaW5nIG9wZW5EZWxpbXNcbiAqICAgVGhlIG9wZW5pbmcgZGVsaW1pdGVyIHNlcXVlbmNlcyBmb3IgaW5saW5lcyB0aGF0IHByZXZlbnRzIGFueSBjb250YWluZWRcbiAqICAgcGlwZXMgZnJvbSBkZWxpbWl0aW5nIGNvbHVtbnMgb2YgdGhlIHBhcmVudCB0YWJsZSBibG9jay5cbiAqIEBwYXJhbSAgYXJyYXkgb2Ygc3RyaW5nIGNsb3NlRGVsaW1zXG4gKiAgIFRoZSBjbG9zaW5nIGRlbGltaXRlciBzZXF1ZW5jZSBmb3IgYW4gaW5saW5lIHRoYXQgcHJldmVudHMgYW55IGNvbnRhaW5pbmdcbiAqICAgcGlwZXMgZnJvbSBkZWxpbWl0aW5nIGNvbHVtbnMgb2YgdGhlIHBhcmVudCB0YWJsZSBibG9jay5cbiAqIEByZXR1cm4gYXJyYXkgb2Ygc3RyaW5nXG4gKiAgIFRoZSB1bnBhcnNlZCBjb250ZW50IG9mIHRoZSBjZWxscy9jb2x1bW5zIGlkZW50aWZpZWQgaW4gc3RyIHJldHVybmVkIGFzXG4gKiAgIGluZGl2aWR1YWwgZWxlbWVudHMgb2YgYW4gYXJyYXkuIFRoZSBjb250ZW50IGlzIHN0aWxsIHRvIGJlIHBhcnNlZCBieSB0aGVcbiAqICAgaW5saW5lIHJ1bGVzLlxuICovXG5mdW5jdGlvbiBlc2NhcGVkU3BsaXQoXG4gIHN0cjogc3RyaW5nLFxuICBvcGVuRGVsaW1zOiBzdHJpbmdbXSxcbiAgY2xvc2VEZWxpbXM6IHN0cmluZ1tdLFxuKSB7XG4gIGNvbnN0IHJlc3VsdCA9IFtdXG4gIGxldCBwb3MgPSAwXG4gIGNvbnN0IG1heCA9IHN0ci5sZW5ndGhcbiAgbGV0IGNoXG4gIGxldCBlc2NhcGVzID0gMFxuICBsZXQgbGFzdFBvcyA9IDBcbiAgbGV0IGxhc3REZWxpbSA9IDBcbiAgbGV0IGRlbGltZWQgPSBmYWxzZVxuICBsZXQgZGVsaW1NYXNrTWFwXG4gIGxldCBvcGVuRGVsaW1JZHggPSAtMVxuICBsZXQgY2xvc2VEZWxpbUlkeCA9IC0xXG5cbiAgY2ggPSBzdHIuY2hhckNvZGVBdChwb3MpXG5cbiAgLy8gRGVmIG1hcCBmb3IgbWF0Y2hpbmcgb3Blbi9jbG9zZSBkZWxpbWl0ZXIgc2VxdWVuY2Ugd2l0aCBzdHJAcG9zXG4gIGRlbGltTWFza01hcCA9IGZ1bmN0aW9uKGU6IHN0cmluZykge1xuICAgIHJldHVybiBzdHIuc3Vic3RyaW5nKHBvcywgcG9zICsgZS5sZW5ndGgpID09PSBlXG4gIH1cblxuICB3aGlsZSAocG9zIDwgbWF4KSB7XG4gICAgLy8gRGV0ZXJtaW5lIElEIG9mIGZpcnN0IG1hdGNoaW5nIG9wZW4vY2xvc2UgZGVsaW1pdGVyIHNlcXVlbmNlXG4gICAgb3BlbkRlbGltSWR4ID0gb3BlbkRlbGltcy5tYXAoZGVsaW1NYXNrTWFwKS5pbmRleE9mKHRydWUpXG4gICAgY2xvc2VEZWxpbUlkeCA9IGNsb3NlRGVsaW1zLm1hcChkZWxpbU1hc2tNYXApLmluZGV4T2YodHJ1ZSlcblxuICAgIC8vIERvZXMgc3RyQHBvcyBtYXRjaCBhbnkgb3BlbmluZyBkZWxpbWl0ZXI/XG4gICAgaWYgKG9wZW5EZWxpbUlkeCA+IC0xICYmIGVzY2FwZXMgJSAyID09PSAwICYmICFkZWxpbWVkKSB7XG4gICAgICBkZWxpbWVkID0gIWRlbGltZWRcbiAgICAgIGxhc3REZWxpbSA9IHBvcyArIG9wZW5EZWxpbXNbb3BlbkRlbGltSWR4XS5sZW5ndGggLSAxXG4gICAgICBwb3MgKz0gb3BlbkRlbGltc1tvcGVuRGVsaW1JZHhdLmxlbmd0aCAtIDFcbiAgICAgIC8vIERvZXMgc3RyQHBvcyBtYXRjaCBhbnkgY2xvc2luZyBkZWxpbWl0ZXI/XG4gICAgfSBlbHNlIGlmIChjbG9zZURlbGltSWR4ID4gLTEgJiYgZXNjYXBlcyAlIDIgPT09IDAgJiYgZGVsaW1lZCkge1xuICAgICAgZGVsaW1lZCA9ICFkZWxpbWVkXG4gICAgICBsYXN0RGVsaW0gPSBwb3MgKyBjbG9zZURlbGltc1tjbG9zZURlbGltSWR4XS5sZW5ndGggLSAxXG4gICAgICBwb3MgKz0gY2xvc2VEZWxpbXNbY2xvc2VEZWxpbUlkeF0ubGVuZ3RoIC0gMVxuICAgIH0gZWxzZSBpZiAoY2ggPT09IDB4N2MgLyogfCAqLyAmJiBlc2NhcGVzICUgMiA9PT0gMCAmJiAhZGVsaW1lZCkge1xuICAgICAgcmVzdWx0LnB1c2goc3RyLnN1YnN0cmluZyhsYXN0UG9zLCBwb3MpKVxuICAgICAgbGFzdFBvcyA9IHBvcyArIDFcbiAgICB9IGVsc2UgaWYgKGNoID09PSAweDVjIC8qIFxcICovKSB7XG4gICAgICBlc2NhcGVzKytcbiAgICB9IGVsc2Uge1xuICAgICAgZXNjYXBlcyA9IDBcbiAgICB9XG5cbiAgICBwb3MrK1xuXG4gICAgLy8gSWYgdGhlcmUgd2FzIGFuIHVuLWNsb3NlZCBkZWxpbWl0ZXIgc2VxdWVuY2UsIGdvIGJhY2sgdG8ganVzdCBhZnRlclxuICAgIC8vIHRoZSBsYXN0IGRlbGltaXRlciBzZXF1ZW5jZSwgYnV0IGFzIGlmIGl0IHdhcyBhIG5vcm1hbCBjaGFyYWN0ZXJcbiAgICBpZiAocG9zID09PSBtYXggJiYgZGVsaW1lZCkge1xuICAgICAgZGVsaW1lZCA9IGZhbHNlXG4gICAgICBwb3MgPSBsYXN0RGVsaW0gKyAxXG4gICAgfVxuXG4gICAgY2ggPSBzdHIuY2hhckNvZGVBdChwb3MpXG4gIH1cblxuICByZXN1bHQucHVzaChzdHIuc3Vic3RyaW5nKGxhc3RQb3MpKVxuXG4gIHJldHVybiByZXN1bHRcbn1cblxuLyoqXG4gKiBBIHRhYmxlIHBsb2NrIHBhcnNlciB3aXRoIHJlc3RyaWN0aW9ucyBvbiBwaXBlIHBsYWNlbWVudFxuICpcbiAqIFBhcnRpYWxseSBwb3VsYXRlZCBkb2NzdHJpbmcgZGVzY3JpYmluZyBwYXJhbWV0ZXJzIGFkZGVkIHRvXG4gKiBgbWFya2Rvd24taXQtbWF0aEA0ODAyNDM5OmxpYi9ydWxlc19ibG9jay90YWJsZS5qc2AuXG4gKlxuICogQHBhcmFtICBhcnJheSBvZiBzdHJpbmcgb3BlbkRlbGltc1xuICogICBUaGUgb3BlbmluZyBkZWxpbWl0ZXIgc2VxdWVuY2VzIGZvciBpbmxpbmVzIHRoYXQgcHJldmVudHMgYW55IGNvbnRhaW5lZFxuICogICBwaXBlcyBmcm9tIGRlbGltaXRpbmcgY29sdW1ucyBvZiB0aGUgcGFyZW50IHRhYmxlIGJsb2NrLlxuICogQHBhcmFtICBhcnJheSBvZiBzdHJpbmcgY2xvc2VEZWxpbXNcbiAqICAgVGhlIGNsb3NpbmcgZGVsaW1pdGVyIHNlcXVlbmNlIGZvciBhbiBpbmxpbmUgdGhhdCBwcmV2ZW50cyBhbnkgY29udGFpbmluZ1xuICogICBwaXBlcyBmcm9tIGRlbGltaXRpbmcgY29sdW1ucyBvZiB0aGUgcGFyZW50IHRhYmxlIGJsb2NrLlxuICovXG5mdW5jdGlvbiB0YWJsZShcbiAgb3BlbkRlbGltczogc3RyaW5nW10sXG4gIGNsb3NlRGVsaW1zOiBzdHJpbmdbXSxcbiAgc3RhdGU6IGFueSxcbiAgc3RhcnRMaW5lOiBudW1iZXIsXG4gIGVuZExpbmU6IG51bWJlcixcbiAgc2lsZW50OiBib29sZWFuLFxuKSB7XG4gIGxldCBjaFxuICBsZXQgbGluZVRleHRcbiAgbGV0IHBvc1xuICBsZXQgaVxuICBsZXQgbmV4dExpbmVcbiAgbGV0IGNvbHVtbnNcbiAgbGV0IGNvbHVtbkNvdW50XG4gIGxldCB0b2tlblxuICBsZXQgYWxpZ25zXG4gIGxldCB0XG4gIGxldCB0YWJsZUxpbmVzXG4gIGxldCB0Ym9keUxpbmVzXG5cbiAgLy8gc2hvdWxkIGhhdmUgYXQgbGVhc3QgdGhyZWUgbGluZXNcbiAgaWYgKHN0YXJ0TGluZSArIDIgPiBlbmRMaW5lKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBuZXh0TGluZSA9IHN0YXJ0TGluZSArIDFcblxuICBpZiAoc3RhdGUuc0NvdW50W25leHRMaW5lXSA8IHN0YXRlLmJsa0luZGVudCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgLy8gZmlyc3QgY2hhcmFjdGVyIG9mIHRoZSBzZWNvbmQgbGluZSBzaG91bGQgYmUgJ3wnIG9yICctJ1xuXG4gIHBvcyA9IHN0YXRlLmJNYXJrc1tuZXh0TGluZV0gKyBzdGF0ZS50U2hpZnRbbmV4dExpbmVdXG4gIGlmIChwb3MgPj0gc3RhdGUuZU1hcmtzW25leHRMaW5lXSkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgY2ggPSBzdGF0ZS5zcmMuY2hhckNvZGVBdChwb3MpXG4gIGlmIChjaCAhPT0gMHg3YyAvKiB8ICovICYmIGNoICE9PSAweDJkIC8qIC0gKi8gJiYgY2ggIT09IDB4M2EgLyogOiAqLykge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgbGluZVRleHQgPSBnZXRMaW5lKHN0YXRlLCBzdGFydExpbmUgKyAxKVxuICBpZiAoIS9eWy06fCBdKyQvLnRlc3QobGluZVRleHQpKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBjb2x1bW5zID0gbGluZVRleHQuc3BsaXQoJ3wnKVxuICBhbGlnbnMgPSBbXVxuICBmb3IgKGkgPSAwOyBpIDwgY29sdW1ucy5sZW5ndGg7IGkrKykge1xuICAgIHQgPSBjb2x1bW5zW2ldLnRyaW0oKVxuICAgIGlmICghdCkge1xuICAgICAgLy8gYWxsb3cgZW1wdHkgY29sdW1ucyBiZWZvcmUgYW5kIGFmdGVyIHRhYmxlLCBidXQgbm90IGluIGJldHdlZW4gY29sdW1ucztcbiAgICAgIC8vIGUuZy4gYWxsb3cgYCB8LS0tfCBgLCBkaXNhbGxvdyBgIC0tLXx8LS0tIGBcbiAgICAgIGlmIChpID09PSAwIHx8IGkgPT09IGNvbHVtbnMubGVuZ3RoIC0gMSkge1xuICAgICAgICBjb250aW51ZVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCEvXjo/LSs6PyQvLnRlc3QodCkpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBpZiAodC5jaGFyQ29kZUF0KHQubGVuZ3RoIC0gMSkgPT09IDB4M2EgLyogOiAqLykge1xuICAgICAgYWxpZ25zLnB1c2godC5jaGFyQ29kZUF0KDApID09PSAweDNhIC8qIDogKi8gPyAnY2VudGVyJyA6ICdyaWdodCcpXG4gICAgfSBlbHNlIGlmICh0LmNoYXJDb2RlQXQoMCkgPT09IDB4M2EgLyogOiAqLykge1xuICAgICAgYWxpZ25zLnB1c2goJ2xlZnQnKVxuICAgIH0gZWxzZSB7XG4gICAgICBhbGlnbnMucHVzaCgnJylcbiAgICB9XG4gIH1cblxuICBsaW5lVGV4dCA9IGdldExpbmUoc3RhdGUsIHN0YXJ0TGluZSkudHJpbSgpXG4gIGlmIChsaW5lVGV4dC5pbmRleE9mKCd8JykgPT09IC0xKSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbiAgY29sdW1ucyA9IGVzY2FwZWRTcGxpdChcbiAgICBsaW5lVGV4dC5yZXBsYWNlKC9eXFx8fFxcfCQvZywgJycpLFxuICAgIG9wZW5EZWxpbXMsXG4gICAgY2xvc2VEZWxpbXMsXG4gIClcblxuICAvLyBoZWFkZXIgcm93IHdpbGwgZGVmaW5lIGFuIGFtb3VudCBvZiBjb2x1bW5zIGluIHRoZSBlbnRpcmUgdGFibGUsXG4gIC8vIGFuZCBhbGlnbiByb3cgc2hvdWxkbid0IGJlIHNtYWxsZXIgdGhhbiB0aGF0ICh0aGUgcmVzdCBvZiB0aGUgcm93cyBjYW4pXG4gIGNvbHVtbkNvdW50ID0gY29sdW1ucy5sZW5ndGhcbiAgaWYgKGNvbHVtbkNvdW50ID4gYWxpZ25zLmxlbmd0aCkge1xuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgaWYgKHNpbGVudCkge1xuICAgIHJldHVybiB0cnVlXG4gIH1cblxuICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RhYmxlX29wZW4nLCAndGFibGUnLCAxKVxuICB0b2tlbi5tYXAgPSB0YWJsZUxpbmVzID0gW3N0YXJ0TGluZSwgMF1cblxuICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RoZWFkX29wZW4nLCAndGhlYWQnLCAxKVxuICB0b2tlbi5tYXAgPSBbc3RhcnRMaW5lLCBzdGFydExpbmUgKyAxXVxuXG4gIHRva2VuID0gc3RhdGUucHVzaCgndHJfb3BlbicsICd0cicsIDEpXG4gIHRva2VuLm1hcCA9IFtzdGFydExpbmUsIHN0YXJ0TGluZSArIDFdXG5cbiAgZm9yIChpID0gMDsgaSA8IGNvbHVtbnMubGVuZ3RoOyBpKyspIHtcbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RoX29wZW4nLCAndGgnLCAxKVxuICAgIHRva2VuLm1hcCA9IFtzdGFydExpbmUsIHN0YXJ0TGluZSArIDFdXG4gICAgaWYgKGFsaWduc1tpXSkge1xuICAgICAgdG9rZW4uYXR0cnMgPSBbWydzdHlsZScsICd0ZXh0LWFsaWduOicgKyBhbGlnbnNbaV1dXVxuICAgIH1cblxuICAgIHRva2VuID0gc3RhdGUucHVzaCgnaW5saW5lJywgJycsIDApXG4gICAgdG9rZW4uY29udGVudCA9IGNvbHVtbnNbaV0udHJpbSgpXG4gICAgdG9rZW4ubWFwID0gW3N0YXJ0TGluZSwgc3RhcnRMaW5lICsgMV1cbiAgICB0b2tlbi5jaGlsZHJlbiA9IFtdXG5cbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RoX2Nsb3NlJywgJ3RoJywgLTEpXG4gIH1cblxuICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RyX2Nsb3NlJywgJ3RyJywgLTEpXG4gIHRva2VuID0gc3RhdGUucHVzaCgndGhlYWRfY2xvc2UnLCAndGhlYWQnLCAtMSlcblxuICB0b2tlbiA9IHN0YXRlLnB1c2goJ3Rib2R5X29wZW4nLCAndGJvZHknLCAxKVxuICB0b2tlbi5tYXAgPSB0Ym9keUxpbmVzID0gW3N0YXJ0TGluZSArIDIsIDBdXG5cbiAgZm9yIChuZXh0TGluZSA9IHN0YXJ0TGluZSArIDI7IG5leHRMaW5lIDwgZW5kTGluZTsgbmV4dExpbmUrKykge1xuICAgIGlmIChzdGF0ZS5zQ291bnRbbmV4dExpbmVdIDwgc3RhdGUuYmxrSW5kZW50KSB7XG4gICAgICBicmVha1xuICAgIH1cblxuICAgIGxpbmVUZXh0ID0gZ2V0TGluZShzdGF0ZSwgbmV4dExpbmUpLnRyaW0oKVxuICAgIGlmIChsaW5lVGV4dC5pbmRleE9mKCd8JykgPT09IC0xKSB7XG4gICAgICBicmVha1xuICAgIH1cbiAgICBjb2x1bW5zID0gZXNjYXBlZFNwbGl0KFxuICAgICAgbGluZVRleHQucmVwbGFjZSgvXlxcfHxcXHwkL2csICcnKSxcbiAgICAgIG9wZW5EZWxpbXMsXG4gICAgICBjbG9zZURlbGltcyxcbiAgICApXG5cbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RyX29wZW4nLCAndHInLCAxKVxuICAgIGZvciAoaSA9IDA7IGkgPCBjb2x1bW5Db3VudDsgaSsrKSB7XG4gICAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RkX29wZW4nLCAndGQnLCAxKVxuICAgICAgaWYgKGFsaWduc1tpXSkge1xuICAgICAgICB0b2tlbi5hdHRycyA9IFtbJ3N0eWxlJywgJ3RleHQtYWxpZ246JyArIGFsaWduc1tpXV1dXG4gICAgICB9XG5cbiAgICAgIHRva2VuID0gc3RhdGUucHVzaCgnaW5saW5lJywgJycsIDApXG4gICAgICB0b2tlbi5jb250ZW50ID0gY29sdW1uc1tpXSA/IGNvbHVtbnNbaV0udHJpbSgpIDogJydcbiAgICAgIHRva2VuLmNoaWxkcmVuID0gW11cblxuICAgICAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0ZF9jbG9zZScsICd0ZCcsIC0xKVxuICAgIH1cbiAgICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RyX2Nsb3NlJywgJ3RyJywgLTEpXG4gIH1cbiAgdG9rZW4gPSBzdGF0ZS5wdXNoKCd0Ym9keV9jbG9zZScsICd0Ym9keScsIC0xKVxuICB0b2tlbiA9IHN0YXRlLnB1c2goJ3RhYmxlX2Nsb3NlJywgJ3RhYmxlJywgLTEpXG5cbiAgdGFibGVMaW5lc1sxXSA9IHRib2R5TGluZXNbMV0gPSBuZXh0TGluZVxuICBzdGF0ZS5saW5lID0gbmV4dExpbmVcbiAgcmV0dXJuIHRydWVcbn1cblxuLyoqXG4gKiBQcmVwYXJlIGEgdGFibGUgcGxvY2sgcGFyc2VyIHdpdGggcmVzdHJpY3Rpb25zIG9uIHBpcGUgcGxhY2VtZW50XG4gKlxuICogQHBhcmFtICBzdHJpbmcgb3BlblxuICogICBUaGUgb3BlbmluZyBkZWxpbWl0ZXIgc2VxdWVuY2UgZm9yIGFuIGlubGluZSB0aGF0IHByZXZlbnRzIGFueSBjb250YWluZWRcbiAqICAgcGlwZXMgZnJvbSBkZWxpbWl0aW5nIGNvbHVtbnMgb2YgdGhlIHBhcmVudCB0YWJsZSBibG9jay5cbiAqIEBwYXJhbSAgc3RyaW5nIGNsb3NlXG4gKiAgIFRoZSBjbG9zaW5nIGRlbGltaXRlciBzZXF1ZW5jZSBmb3IgYW4gaW5saW5lIHRoYXQgcHJldmVudHMgYW55IGNvbnRhaW5pbmdcbiAqICAgcGlwZXMgZnJvbSBkZWxpbWl0aW5nIGNvbHVtbnMgb2YgdGhlIHBhcmVudCB0YWJsZSBibG9jay5cbiAqIEByZXR1cm4gZnVuY3Rpb25cbiAqICAgVGhlIHRhYmxlIGJsb2NrIHBhcnNlciB0aGF0IHNob3VsZCBiZSB1c2VkIGluIHBsYWNlIG9mIHRoZSBleGlzdGluZyB0YWJsZVxuICogICBibG9jayBwYXJzZXIgc3VjaCB0aGF0IHRoZSBzcGVjaWZpZWQgaW5saW5lIGJ5IGBvcGVuYCBhbmQgYGNsb3NlYCBpc1xuICogICByZXNwZWN0ZWQuIFRoZSBkZWxpbWl0ZXJzIGFyZSBhZGRlZCB0byBleGlzdGluZyBsaXN0IG9mIGRlbGltaXRlciBwYWlycyBpblxuICogICBgZXNjYXBlZFNwbGl0RGVsaW1pdGVyc2AgYWxsb3dpbmcgYG1hcmtkb3duLWl0LW1hdGhgIHRvIGJlIGB1c2VgJ2QgbXVsdGlwbGVcbiAqICAgdGltZXMgbGVhZGluZyB0byBtdWx0aXBsZSBpbmxpbmUgZGVsaW1pdGVycy5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG1ha2VUYWJsZShvcHRpb25zOiBPcHRpb25zKSB7XG4gIGNvbnN0IG9wZW5EZWxpbXMgPSBvcHRpb25zLmlubGluZURlbGltLm1hcCgoaSkgPT4gaVswXSlcbiAgY29uc3QgY2xvc2VEZWxpbXMgPSBvcHRpb25zLmlubGluZURlbGltLm1hcCgoaSkgPT4gaVsxXSlcblxuICBvcGVuRGVsaW1zLnVuc2hpZnQoJ2AnKVxuICBjbG9zZURlbGltcy51bnNoaWZ0KCdgJylcblxuICByZXR1cm4gdGFibGUuYmluZChudWxsLCBvcGVuRGVsaW1zLCBjbG9zZURlbGltcylcbn1cblxuZXhwb3J0IGludGVyZmFjZSBPcHRpb25zIHtcbiAgaW5saW5lRGVsaW06IFtbc3RyaW5nLCBzdHJpbmddXVxuICBibG9ja0RlbGltOiBbW3N0cmluZywgc3RyaW5nXV1cbn1cbiJdfQ==