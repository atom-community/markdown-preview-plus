"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const wrapped_dom_tree_1 = require("./wrapped-dom-tree");
const MathJaxHelper = require("./mathjax-helper");
const renderer = require("./renderer");
const util_1 = require("./util");
class UpdatePreview {
    constructor(dom) {
        this.tree = new wrapped_dom_tree_1.WrappedDomTree(dom, true);
    }
    update(domFragment, renderLaTeX) {
        prepareCodeBlocksForAtomEditors(domFragment);
        if (this.domFragment && domFragment.isEqualNode(this.domFragment)) {
            return undefined;
        }
        const firstTime = this.domFragment === undefined;
        this.domFragment = domFragment.cloneNode(true);
        const newDom = document.createElement('div');
        newDom.className = 'update-preview';
        newDom.appendChild(domFragment);
        const newTree = new wrapped_dom_tree_1.WrappedDomTree(newDom, false);
        const r = this.tree.diffTo(newTree);
        newTree.removeSelf();
        if (firstTime) {
            r.possibleReplace = undefined;
            r.last = undefined;
        }
        if (renderLaTeX) {
            r.inserted = r.inserted.map(function (elm) {
                while (elm.parentElement && !elm.innerHTML) {
                    elm = elm.parentElement;
                }
                return elm;
            });
            r.inserted = r.inserted.filter((elm) => !!elm);
            util_1.handlePromise(MathJaxHelper.mathProcessor(r.inserted));
        }
        if (!atom.config.get('markdown-preview-plus.enablePandoc') ||
            !atom.config.get('markdown-preview-plus.useNativePandocCodeStyles')) {
            for (const elm of r.inserted) {
                if (elm instanceof Element) {
                    renderer.convertCodeBlocksToAtomEditors(elm);
                }
            }
        }
        this.updateOrderedListsStart(this.domFragment);
        return r;
    }
    updateOrderedListsStart(fragment) {
        if (this.tree.shownTree === undefined) {
            throw new Error('shownTree undefined in updateOrderedListsStart');
        }
        const previewOLs = this.tree.shownTree.dom.querySelectorAll('ol');
        const parsedOLs = fragment.querySelectorAll('ol');
        const end = parsedOLs.length - 1;
        for (let i = 0; i <= end; i++) {
            const previewStart = previewOLs[i].getAttribute('start');
            const parsedStart = parsedOLs[i].getAttribute('start');
            if (previewStart === parsedStart) {
                continue;
            }
            else if (parsedStart !== null) {
                previewOLs[i].setAttribute('start', parsedStart);
            }
            else {
                previewOLs[i].removeAttribute('start');
            }
        }
    }
}
exports.UpdatePreview = UpdatePreview;
function prepareCodeBlocksForAtomEditors(domFragment) {
    for (const preElement of Array.from(domFragment.querySelectorAll('pre'))) {
        const preWrapper = document.createElement('span');
        preWrapper.className = 'atom-text-editor';
        preElement.parentNode.insertBefore(preWrapper, preElement);
        preWrapper.appendChild(preElement);
    }
    return domFragment;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXBkYXRlLXByZXZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXBkYXRlLXByZXZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFzQkEseURBQW1EO0FBQ25ELGtEQUFrRDtBQUNsRCx1Q0FBdUM7QUFDdkMsaUNBQXNDO0FBRXRDO0lBS0UsWUFBWSxHQUFZO1FBQ3RCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxpQ0FBYyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUMzQyxDQUFDO0lBRU0sTUFBTSxDQUFDLFdBQW9CLEVBQUUsV0FBb0I7UUFDdEQsK0JBQStCLENBQUMsV0FBVyxDQUFDLENBQUE7UUFFNUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbEUsTUFBTSxDQUFDLFNBQVMsQ0FBQTtRQUNsQixDQUFDO1FBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsS0FBSyxTQUFTLENBQUE7UUFDaEQsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBWSxDQUFBO1FBRXpELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7UUFDNUMsTUFBTSxDQUFDLFNBQVMsR0FBRyxnQkFBZ0IsQ0FBQTtRQUNuQyxNQUFNLENBQUMsV0FBVyxDQUFDLFdBQVcsQ0FBQyxDQUFBO1FBQy9CLE1BQU0sT0FBTyxHQUFHLElBQUksaUNBQWMsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUE7UUFFakQsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDbkMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBRXBCLEVBQUUsQ0FBQyxDQUFDLFNBQVMs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ZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBQ3hDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBaEZELHNDQWdGQztBQUVELHlDQUF5QyxXQUFvQjtJQUMzRCxHQUFHLENBQUMsQ0FBQyxNQUFNLFVBQVUsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RSxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1FBQ2pELFVBQVUsQ0FBQyxTQUFTLEdBQUcsa0JBQWtCLENBQUE7UUFDekMsVUFBVSxDQUFDLFVBQVcsQ0FBQyxZQUFZLENBQUMsVUFBVSxFQUFFLFVBQVUsQ0FBQyxDQUFBO1FBQzNELFVBQVUsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDcEMsQ0FBQztJQUNELE1BQU0sQ0FBQyxXQUFXLENBQUE7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgZmlsZSBpbmNvcnBvcmF0ZXMgY29kZSBmcm9tIFttYXJrbW9uXShodHRwczovL2dpdGh1Yi5jb20veXlqaGFvL21hcmttb24pXG4vLyBjb3ZlcmVkIGJ5IHRoZSBmb2xsb3dpbmcgdGVybXM6XG4vL1xuLy8gQ29weXJpZ2h0IChjKSAyMDE0LCBZYW8gWXVqaWFuLCBodHRwOi8veWp5YW8uY29tXG4vL1xuLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuLy8gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuLy8gaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuLy8gY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4vLyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuLy9cbi8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluXG4vLyBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbi8vXG4vLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4vLyBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbi8vIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuLy8gTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbi8vIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU5cbi8vIFRIRSBTT0ZUV0FSRS5cbmltcG9ydCB7IFdyYXBwZWREb21UcmVlIH0gZnJvbSAnLi93cmFwcGVkLWRvbS10cmVlJ1xuaW1wb3J0IE1hdGhKYXhIZWxwZXIgPSByZXF1aXJlKCcuL21hdGhqYXgtaGVscGVyJylcbmltcG9ydCByZW5kZXJlciA9IHJlcXVpcmUoJy4vcmVuZGVyZXInKVxuaW1wb3J0IHsgaGFuZGxlUHJvbWlzZSB9IGZyb20gJy4vdXRpbCdcblxuZXhwb3J0IGNsYXNzIFVwZGF0ZVByZXZpZXcge1xuICBwcml2YXRlIGRvbUZyYWdtZW50PzogRWxlbWVudFxuICBwcml2YXRlIHRyZWU6IFdyYXBwZWREb21UcmVlXG4gIC8vIEBwYXJhbSBkb20gQSBET00gZWxlbWVudCBvYmplY3RcbiAgLy8gICAgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL2VsZW1lbnRcbiAgY29uc3RydWN0b3IoZG9tOiBFbGVtZW50KSB7XG4gICAgdGhpcy50cmVlID0gbmV3IFdyYXBwZWREb21UcmVlKGRvbSwgdHJ1ZSlcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUoZG9tRnJhZ21lbnQ6IEVsZW1lbnQsIHJlbmRlckxhVGVYOiBib29sZWFuKSB7XG4gICAgcHJlcGFyZUNvZGVCbG9ja3NGb3JBdG9tRWRpdG9ycyhkb21GcmFnbWVudClcblxuICAgIGlmICh0aGlzLmRvbUZyYWdtZW50ICYmIGRvbUZyYWdtZW50LmlzRXF1YWxOb2RlKHRoaXMuZG9tRnJhZ21lbnQpKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkXG4gICAgfVxuXG4gICAgY29uc3QgZmlyc3RUaW1lID0gdGhpcy5kb21GcmFnbWVudCA9PT0gdW5kZWZpbmVkXG4gICAgdGhpcy5kb21GcmFnbWVudCA9IGRvbUZyYWdtZW50LmNsb25lTm9kZSh0cnVlKSBhcyBFbGVtZW50XG5cbiAgICBjb25zdCBuZXdEb20gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKVxuICAgIG5ld0RvbS5jbGFzc05hbWUgPSAndXBkYXRlLXByZXZpZXcnXG4gICAgbmV3RG9tLmFwcGVuZENoaWxkKGRvbUZyYWdtZW50KVxuICAgIGNvbnN0IG5ld1RyZWUgPSBuZXcgV3JhcHBlZERvbVRyZWUobmV3RG9tLCBmYWxzZSlcblxuICAgIGNvbnN0IHIgPSB0aGlzLnRyZWUuZGlmZlRvKG5ld1RyZWUpXG4gICAgbmV3VHJlZS5yZW1vdmVTZWxmKClcblxuICAgIGlmIChmaXJzdFRpbWUpIHtcbiAgICAgIHIucG9zc2libGVSZXBsYWNlID0gdW5kZWZpbmVkXG4gICAgICByLmxhc3QgPSB1bmRlZmluZWRcbiAgICB9XG5cbiAgICBpZiAocmVuZGVyTGFUZVgpIHtcbiAgICAgIHIuaW5zZXJ0ZWQgPSByLmluc2VydGVkLm1hcChmdW5jdGlvbihlbG06IE5vZGUpIHtcbiAgICAgICAgd2hpbGUgKGVsbS5wYXJlbnRFbGVtZW50ICYmICEoZWxtIGFzIEhUTUxFbGVtZW50KS5pbm5lckhUTUwpIHtcbiAgICAgICAgICBlbG0gPSBlbG0ucGFyZW50RWxlbWVudFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBlbG1cbiAgICAgIH0pXG4gICAgICByLmluc2VydGVkID0gci5pbnNlcnRlZC5maWx0ZXIoKGVsbSkgPT4gISFlbG0pXG4gICAgICBoYW5kbGVQcm9taXNlKE1hdGhKYXhIZWxwZXIubWF0aFByb2Nlc3NvcihyLmluc2VydGVkKSlcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICAhYXRvbS5jb25maWcuZ2V0KCdtYXJrZG93bi1wcmV2aWV3LXBsdXMuZW5hYmxlUGFuZG9jJykgfHxcbiAgICAgICFhdG9tLmNvbmZpZy5nZXQoJ21hcmtkb3duLXByZXZpZXctcGx1cy51c2VOYXRpdmVQYW5kb2NDb2RlU3R5bGVzJylcbiAgICApIHtcbiAgICAgIGZvciAoY29uc3QgZWxtIG9mIHIuaW5zZXJ0ZWQpIHtcbiAgICAgICAgaWYgKGVsbSBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcbiAgICAgICAgICByZW5kZXJlci5jb252ZXJ0Q29kZUJsb2Nrc1RvQXRvbUVkaXRvcnMoZWxtKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy51cGRhdGVPcmRlcmVkTGlzdHNTdGFydCh0aGlzLmRvbUZyYWdtZW50KVxuXG4gICAgcmV0dXJuIHJcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlT3JkZXJlZExpc3RzU3RhcnQoZnJhZ21lbnQ6IEVsZW1lbnQpIHtcbiAgICBpZiAodGhpcy50cmVlLnNob3duVHJlZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Nob3duVHJlZSB1bmRlZmluZWQgaW4gdXBkYXRlT3JkZXJlZExpc3RzU3RhcnQnKVxuICAgIH1cbiAgICBjb25zdCBwcmV2aWV3T0xzID0gdGhpcy50cmVlLnNob3duVHJlZS5kb20ucXVlcnlTZWxlY3RvckFsbCgnb2wnKVxuICAgIGNvbnN0IHBhcnNlZE9McyA9IGZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ29sJylcblxuICAgIGNvbnN0IGVuZCA9IHBhcnNlZE9Mcy5sZW5ndGggLSAxXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gZW5kOyBpKyspIHtcbiAgICAgIGNvbnN0IHByZXZpZXdTdGFydCA9IHByZXZpZXdPTHNbaV0uZ2V0QXR0cmlidXRlKCdzdGFydCcpXG4gICAgICBjb25zdCBwYXJzZWRTdGFydCA9IHBhcnNlZE9Mc1tpXS5nZXRBdHRyaWJ1dGUoJ3N0YXJ0JylcblxuICAgICAgaWYgKHByZXZpZXdTdGFydCA9PT0gcGFyc2VkU3RhcnQpIHtcbiAgICAgICAgY29udGludWVcbiAgICAgIH0gZWxzZSBpZiAocGFyc2VkU3RhcnQgIT09IG51bGwpIHtcbiAgICAgICAgcHJldmlld09Mc1tpXS5zZXRBdHRyaWJ1dGUoJ3N0YXJ0JywgcGFyc2VkU3RhcnQpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcmV2aWV3T0xzW2ldLnJlbW92ZUF0dHJpYnV0ZSgnc3RhcnQnKVxuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBwcmVwYXJlQ29kZUJsb2Nrc0ZvckF0b21FZGl0b3JzKGRvbUZyYWdtZW50OiBFbGVtZW50KSB7XG4gIGZvciAoY29uc3QgcHJlRWxlbWVudCBvZiBBcnJheS5mcm9tKGRvbUZyYWdtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3ByZScpKSkge1xuICAgIGNvbnN0IHByZVdyYXBwZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJylcbiAgICBwcmVXcmFwcGVyLmNsYXNzTmFtZSA9ICdhdG9tLXRleHQtZWRpdG9yJ1xuICAgIHByZUVsZW1lbnQucGFyZW50Tm9kZSEuaW5zZXJ0QmVmb3JlKHByZVdyYXBwZXIsIHByZUVsZW1lbnQpXG4gICAgcHJlV3JhcHBlci5hcHBlbmRDaGlsZChwcmVFbGVtZW50KVxuICB9XG4gIHJldHVybiBkb21GcmFnbWVudFxufVxuIl19