"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const CSON = require("season");
const fs = require("fs");
const util_1 = require("./util");
const mjAPI = require("mathjax-node");
let isMathJaxDisabled = false;
let isMathJaxLoaded = false;
async function mathProcessor(domElements) {
    if (isMathJaxDisabled)
        return;
    loadMathJax();
    for (const elem of domElements) {
        await processHTMLElement(elem);
    }
}
exports.mathProcessor = mathProcessor;
async function processHTMLString(html) {
    if (isMathJaxDisabled) {
        return html;
    }
    loadMathJax();
    const element = document.createElement('div');
    element.innerHTML = html;
    await processHTMLElement(element);
    return element.innerHTML;
}
exports.processHTMLString = processHTMLString;
async function processHTMLElement(element) {
    const maths = element.querySelectorAll('script[type^="math/tex"]');
    await Promise.all(Array.from(maths).map(async (math) => {
        try {
            const display = math.type
                .split(';')
                .some((x) => x.trim() === 'mode=display');
            const res = await mjAPI.typeset({
                svg: true,
                format: display ? 'TeX' : 'inline-TeX',
                math: math.text,
            });
            if (res.svg)
                math.outerHTML = res.svg;
        }
        catch (e) {
            console.error(e);
        }
    }));
}
function disableMathJax(disable) {
    isMathJaxDisabled = disable;
}
function loadMathJax(listener) {
    if (!isMathJaxLoaded) {
        isMathJaxLoaded = true;
        attachMathJax();
    }
    if (listener) {
        listener();
    }
}
function attachMathJax() {
    if (atom.inDevMode()) {
        atom.notifications.addInfo('Loading maths rendering engine MathJax');
    }
    configureMathJax();
}
function resetMathJax() {
    mjAPI.start();
}
exports.testing = {
    loadMathJax,
    resetMathJax,
    disableMathJax,
};
const namePattern = new RegExp(`\
^[^a-zA-Z\\d\\s]$\
|\
^[a-zA-Z]*$\
`);
function getUserMacrosPath() {
    const userMacrosPath = CSON.resolve(path.join(atom.getConfigDirPath(), 'markdown-preview-plus'));
    return userMacrosPath != null
        ? userMacrosPath
        : path.join(atom.getConfigDirPath(), 'markdown-preview-plus.cson');
}
function loadMacrosFile(filePath) {
    if (!CSON.isObjectPath(filePath)) {
        return {};
    }
    return CSON.readFileSync(filePath, function (error, object) {
        if (object === undefined) {
            object = {};
        }
        if (error !== undefined) {
            console.warn(`Error reading Latex Macros file '${filePath}': ${error.stack !== undefined ? error.stack : error}`);
            atom.notifications.addError(`Failed to load Latex Macros from '${filePath}'`, { detail: error.message, dismissable: true });
        }
        return object;
    });
}
function loadUserMacros() {
    const userMacrosPath = getUserMacrosPath();
    if (util_1.isFileSync(userMacrosPath)) {
        return loadMacrosFile(userMacrosPath);
    }
    else {
        console.debug('Creating markdown-preview-plus.cson, this is a one-time operation.');
        createMacrosTemplate(userMacrosPath);
        return loadMacrosFile(userMacrosPath);
    }
}
function createMacrosTemplate(filePath) {
    const templatePath = path.join(__dirname, '../assets/macros-template.cson');
    const templateFile = fs.readFileSync(templatePath, 'utf8');
    fs.writeFileSync(filePath, templateFile);
}
function checkMacros(macrosObject) {
    for (const name in macrosObject) {
        const value = macrosObject[name];
        if (!name.match(namePattern) || !valueMatchesPattern(value)) {
            delete macrosObject[name];
            atom.notifications.addError(`Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/Galadirith/markdown-preview-plus/blob/master/LATEX.md#macro-names)`, { dismissable: true });
        }
    }
    return macrosObject;
}
function valueMatchesPattern(value) {
    if (Array.isArray(value)) {
        const macroDefinition = value[0];
        const numberOfArgs = value[1];
        if (typeof numberOfArgs === 'number') {
            return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string';
        }
        else {
            return false;
        }
    }
    else if (typeof value === 'string') {
        return true;
    }
    else {
        return false;
    }
}
const configureMathJax = function () {
    let userMacros = loadUserMacros();
    if (userMacros) {
        userMacros = checkMacros(userMacros);
    }
    else {
        userMacros = {};
    }
    mjAPI.config({
        MathJax: {
            jax: ['input/TeX', 'output/SVG'],
            extensions: [],
            TeX: {
                extensions: [
                    'AMSmath.js',
                    'AMSsymbols.js',
                    'noErrors.js',
                    'noUndefined.js',
                ],
                Macros: userMacros,
            },
            messageStyle: 'none',
            showMathMenu: false,
        },
    });
    if (atom.inDevMode()) {
        atom.notifications.addSuccess('Loaded maths rendering engine MathJax');
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aGpheC1oZWxwZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbWF0aGpheC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFPQSw2QkFBNkI7QUFDN0IsK0JBQStCO0FBQy9CLHlCQUF5QjtBQUN6QixpQ0FBbUM7QUFFbkMsc0NBQXNDO0FBRXRDLElBQUksaUJBQWlCLEdBQUcsS0FBSyxDQUFBO0FBQzdCLElBQUksZUFBZSxHQUFHLEtBQUssQ0FBQTtBQVNwQixLQUFLLHdCQUF3QixXQUFtQjtJQUNyRCxFQUFFLENBQUMsQ0FBQyxpQkFBaUIsQ0FBQztRQUFDLE1BQU0sQ0FBQTtJQUM3QixXQUFXLEVBQUUsQ0FBQTtJQUNiLEdBQUcsQ0FBQyxDQUFDLE1BQU0sSUFBSSxJQUFJLFdBQTRCLENBQUMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUE7SUFDaEMsQ0FBQztBQUNILENBQUM7QUFORCxzQ0FNQztBQVNNLEtBQUssNEJBQTRCLElBQVk7SUFDbEQsRUFBRSxDQUFDLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1FBQ3RCLE1BQU0sQ0FBQyxJQUFJLENBQUE7SUFDYixDQUFDO0lBQ0QsV0FBVyxFQUFFLENBQUE7SUFDYixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQzdDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO0lBRXhCLE1BQU0sa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUE7SUFFakMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUE7QUFDMUIsQ0FBQztBQVhELDhDQVdDO0FBRUQsS0FBSyw2QkFBNkIsT0FBb0I7SUFDcEQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUNwQywwQkFBMEIsQ0FDTSxDQUFBO0lBRWxDLE1BQU0sT0FBTyxDQUFDLEdBQUcsQ0FDZixLQUFLLENBQUMs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QixHQUFHO0lBQ3ZCLElBQUksVUFBVSxHQUFHLGNBQWMsRUFBRSxDQUFBO0lBQ2pDLEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDZixVQUFVLEdBQUcsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFBO0lBQ3RDLENBQUM7SUFBQyxJQUFJLENBQUMsQ0FBQztRQUNOLFVBQVUsR0FBRyxFQUFFLENBQUE7SUFDakIsQ0FBQztJQUdELEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDWCxPQUFPLEVBQUU7WUFDUCxHQUFHLEVBQUUsQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDO1lBQ2hDLFVBQVUsRUFBRSxFQUFFO1lBQ2QsR0FBRyxFQUFFO2dCQUNILFVBQVUsRUFBRTtvQkFDVixZQUFZO29CQUNaLGVBQWU7b0JBQ2YsYUFBYTtvQkFDYixnQkFBZ0I7aUJBQ2pCO2dCQUNELE1BQU0sRUFBRSxVQUFVO2FBQ25CO1lBQ0QsWUFBWSxFQUFFLE1BQU07WUFDcEIsWUFBWSxFQUFFLEtBQUs7U0FFcEI7S0FDRixDQUFDLENBQUE7SUFHRixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLHVDQUF1QyxDQUFDLENBQUE7SUFDeEUsQ0FBQztBQUNILENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vXG4vLyBtYXRoamF4LWhlbHBlclxuLy9cbi8vIFRoaXMgbW9kdWxlIHdpbGwgaGFuZGxlIGxvYWRpbmcgdGhlIE1hdGhKYXggZW52aXJvbm1lbnQgYW5kIHByb3ZpZGUgYSB3cmFwcGVyXG4vLyBmb3IgY2FsbHMgdG8gTWF0aEpheCB0byBwcm9jZXNzIExhVGVYIGVxdWF0aW9ucy5cbi8vXG5cbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgQ1NPTiA9IHJlcXVpcmUoJ3NlYXNvbicpXG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcycpXG5pbXBvcnQgeyBpc0ZpbGVTeW5jIH0gZnJvbSAnLi91dGlsJ1xuLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXZhci1yZXF1aXJlc1xuaW1wb3J0IG1qQVBJID0gcmVxdWlyZSgnbWF0aGpheC1ub2RlJylcblxubGV0IGlzTWF0aEpheERpc2FibGVkID0gZmFsc2VcbmxldCBpc01hdGhKYXhMb2FkZWQgPSBmYWxzZVxuXG4vL1xuLy8gUHJvY2VzcyBET00gZWxlbWVudHMgZm9yIExhVGVYIGVxdWF0aW9ucyB3aXRoIE1hdGhKYXhcbi8vXG4vLyBAcGFyYW0gZG9tRWxlbWVudHMgQW4gYXJyYXkgb2YgRE9NIGVsZW1lbnRzIHRvIGJlIHByb2Nlc3NlZCBieSBNYXRoSmF4LiBTZWVcbi8vICAgW2VsZW1lbnRdKGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvV2ViL0FQSS9lbGVtZW50KSBmb3Jcbi8vICAgZGV0YWlscyBvbiBET00gZWxlbWVudHMuXG4vL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIG1hdGhQcm9jZXNzb3IoZG9tRWxlbWVudHM6IE5vZGVbXSkge1xuICBpZiAoaXNNYXRoSmF4RGlzYWJsZWQpIHJldHVyblxuICBsb2FkTWF0aEpheCgpXG4gIGZvciAoY29uc3QgZWxlbSBvZiBkb21FbGVtZW50cyBhcyBIVE1MRWxlbWVudFtdKSB7XG4gICAgYXdhaXQgcHJvY2Vzc0hUTUxFbGVtZW50KGVsZW0pXG4gIH1cbn1cblxuLy9cbi8vIFByb2Nlc3MgbWF0aHMgaW4gSFRNTCBmcmFnbWVudCB3aXRoIE1hdGhKYXhcbi8vXG4vLyBAcGFyYW0gaHRtbCBBIEhUTUwgZnJhZ21lbnQgc3RyaW5nXG4vLyBAcGFyYW0gY2FsbGJhY2sgQSBjYWxsYmFjayBtZXRob2QgdGhhdCBhY2NlcHRzIGEgc2luZ2xlIHBhcmFtZXRlciwgYSBIVE1MXG4vLyAgIGZyYWdtZW50IHN0cmluZyB0aGF0IGlzIHRoZSByZXN1bHQgb2YgaHRtbCBwcm9jZXNzZWQgYnkgTWF0aEpheFxuLy9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcm9jZXNzSFRNTFN0cmluZyhodG1sOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICBpZiAoaXNNYXRoSmF4RGlzYWJsZWQpIHtcbiAgICByZXR1cm4gaHRtbFxuICB9XG4gIGxvYWRNYXRoSmF4KClcbiAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpXG4gIGVsZW1lbnQuaW5uZXJIVE1MID0gaHRtbFxuXG4gIGF3YWl0IHByb2Nlc3NIVE1MRWxlbWVudChlbGVtZW50KVxuXG4gIHJldHVybiBlbGVtZW50LmlubmVySFRNTFxufVxuXG5hc3luYyBmdW5jdGlvbiBwcm9jZXNzSFRNTEVsZW1lbnQoZWxlbWVudDogSFRNTEVsZW1lbnQpIHtcbiAgY29uc3QgbWF0aHMgPSBlbGVtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXG4gICAgJ3NjcmlwdFt0eXBlXj1cIm1hdGgvdGV4XCJdJyxcbiAgKSBhcyBOb2RlTGlzdE9mPEhUTUxTY3JpcHRFbGVtZW50PlxuXG4gIGF3YWl0IFByb21pc2UuYWxsKFxuICAgIEFycmF5LmZyb20obWF0aHMpLm1hcChhc3luYyAobWF0aCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgZGlzcGxheSA9IG1hdGgudHlwZVxuICAgICAgICAgIC5zcGxpdCgnOycpXG4gICAgICAgICAgLnNvbWUoKHgpID0+IHgudHJpbSgpID09PSAnbW9kZT1kaXNwbGF5JylcbiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgbWpBUEkudHlwZXNldCh7XG4gICAgICAgICAgc3ZnOiB0cnVlLFxuICAgICAgICAgIGZvcm1hdDogZGlzcGxheSA/ICdUZVgnIDogJ2lubGluZS1UZVgnLFxuICAgICAgICAgIG1hdGg6IG1hdGgudGV4dCxcbiAgICAgICAgfSlcbiAgICAgICAgaWYgKHJlcy5zdmcpIG1hdGgub3V0ZXJIVE1MID0gcmVzLnN2Z1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgICB9XG4gICAgfSksXG4gIClcbn1cblxuLy8gRm9yIHRlc3RpbmdcbmZ1bmN0aW9uIGRpc2FibGVNYXRoSmF4KGRpc2FibGU6IGJvb2xlYW4pIHtcbiAgaXNNYXRoSmF4RGlzYWJsZWQgPSBkaXNhYmxlXG59XG5cbi8vXG4vLyBMb2FkIE1hdGhKYXggZW52aXJvbm1lbnRcbi8vXG4vLyBAcGFyYW0gbGlzdGVuZXIgbWV0aG9kIHRvIGNhbGwgd2hlbiB0aGUgTWF0aEpheCBzY3JpcHQgd2FzIGJlZW5cbi8vICAgbG9hZGVkIHRvIHRoZSB3aW5kb3cuIFRoZSBtZXRob2QgaXMgcGFzc2VkIG5vIGFyZ3VtZW50cy5cbi8vXG5mdW5jdGlvbiBsb2FkTWF0aEpheChsaXN0ZW5lcj86ICgpID0+IGFueSkge1xuICBpZiAoIWlzTWF0aEpheExvYWRlZCkge1xuICAgIGlzTWF0aEpheExvYWRlZCA9IHRydWVcbiAgICBhdHRhY2hNYXRoSmF4KClcbiAgfVxuICBpZiAobGlzdGVuZXIpIHtcbiAgICBsaXN0ZW5lcigpXG4gIH1cbn1cblxuLy9cbi8vIEF0dGFjaCBtYWluIE1hdGhKYXggc2NyaXB0IHRvIHRoZSBkb2N1bWVudFxuLy9cbmZ1bmN0aW9uIGF0dGFjaE1hdGhKYXgoKSB7XG4gIC8vIE5vdGlmeSB1c2VyIE1hdGhKYXggaXMgbG9hZGluZ1xuICBpZiAoYXRvbS5pbkRldk1vZGUoKSkge1xuICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRJbmZvKCdMb2FkaW5nIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cblxuICAvLyBBdHRhY2ggTWF0aEpheCBzY3JpcHRcbiAgY29uZmlndXJlTWF0aEpheCgpXG59XG5cbi8vXG4vLyBSZW1vdmUgTWF0aEpheCBmcm9tIHRoZSBkb2N1bWVudCBhbmQgcmVzZXQgYXR0YWNoIG1ldGhvZFxuLy9cbmZ1bmN0aW9uIHJlc2V0TWF0aEpheCgpIHtcbiAgbWpBUEkuc3RhcnQoKVxufVxuXG5leHBvcnQgY29uc3QgdGVzdGluZyA9IHtcbiAgbG9hZE1hdGhKYXgsXG4gIHJlc2V0TWF0aEpheCxcbiAgZGlzYWJsZU1hdGhKYXgsXG59XG5cbi8vIHByaXZhdGVcblxuLy9cbi8vIERlZmluZSBzb21lIGZ1bmN0aW9ucyB0byBoZWxwIGdldCBhIGhvbGQgb2YgdGhlIHVzZXIncyBMYXRleFxuLy8gTWFjcm9zLlxuLy9cbmNvbnN0IG5hbWVQYXR0ZXJuID0gbmV3IFJlZ0V4cChgXFxcbl5bXmEtekEtWlxcXFxkXFxcXHNdJFxcXG58XFxcbl5bYS16QS1aXSokXFxcbmApIC8vIGxldHRlcnMsIGJ1dCBubyBudW1lcmFscy5cblxuZnVuY3Rpb24gZ2V0VXNlck1hY3Jvc1BhdGgoKTogc3RyaW5nIHtcbiAgY29uc3QgdXNlck1hY3Jvc1BhdGg6IHN0cmluZyB8IHVuZGVmaW5lZCB8IG51bGwgPSBDU09OLnJlc29sdmUoXG4gICAgcGF0aC5qb2luKGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpLCAnbWFya2Rvd24tcHJldmlldy1wbHVzJyksXG4gIClcbiAgcmV0dXJuIHVzZXJNYWNyb3NQYXRoICE9IG51bGxcbiAgICA/IHVzZXJNYWNyb3NQYXRoXG4gICAgOiBwYXRoLmpvaW4oYXRvbS5nZXRDb25maWdEaXJQYXRoKCksICdtYXJrZG93bi1wcmV2aWV3LXBsdXMuY3NvbicpXG59XG5cbmZ1bmN0aW9uIGxvYWRNYWNyb3NGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBvYmplY3Qge1xuICBpZiAoIUNTT04uaXNPYmplY3RQYXRoKGZpbGVQYXRoKSkge1xuICAgIHJldHVybiB7fVxuICB9XG4gIHJldHVybiBDU09OLnJlYWRGaWxlU3luYyhmaWxlUGF0aCwgZnVuY3Rpb24oZXJyb3I/OiBFcnJvciwgb2JqZWN0Pzogb2JqZWN0KSB7XG4gICAgaWYgKG9iamVjdCA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICBvYmplY3QgPSB7fVxuICAgIH1cbiAgICBpZiAoZXJyb3IgIT09IHVuZGVmaW5lZCkge1xuICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICBgRXJyb3IgcmVhZGluZyBMYXRleCBNYWNyb3MgZmlsZSAnJHtmaWxlUGF0aH0nOiAke1xuICAgICAgICAgIGVycm9yLnN0YWNrICE9PSB1bmRlZmluZWQgPyBlcnJvci5zdGFjayA6IGVycm9yXG4gICAgICAgIH1gLFxuICAgICAgKVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGF0ZXggTWFjcm9zIGZyb20gJyR7ZmlsZVBhdGh9J2AsXG4gICAgICAgIHsgZGV0YWlsOiBlcnJvci5tZXNzYWdlLCBkaXNtaXNzYWJsZTogdHJ1ZSB9LFxuICAgICAgKVxuICAgIH1cbiAgICByZXR1cm4gb2JqZWN0XG4gIH0pXG59XG5cbmZ1bmN0aW9uIGxvYWRVc2VyTWFjcm9zKCkge1xuICBjb25zdCB1c2VyTWFjcm9zUGF0aCA9IGdldFVzZXJNYWNyb3NQYXRoKClcbiAgaWYgKGlzRmlsZVN5bmModXNlck1hY3Jvc1BhdGgpKSB7XG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUuZGVidWcoXG4gICAgICAnQ3JlYXRpbmcgbWFya2Rvd24tcHJldmlldy1wbHVzLmNzb24sIHRoaXMgaXMgYSBvbmUtdGltZSBvcGVyYXRpb24uJyxcbiAgICApXG4gICAgY3JlYXRlTWFjcm9zVGVtcGxhdGUodXNlck1hY3Jvc1BhdGgpXG4gICAgcmV0dXJuIGxvYWRNYWNyb3NGaWxlKHVzZXJNYWNyb3NQYXRoKVxuICB9XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZU1hY3Jvc1RlbXBsYXRlKGZpbGVQYXRoOiBzdHJpbmcpIHtcbiAgY29uc3QgdGVtcGxhdGVQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2Fzc2V0cy9tYWNyb3MtdGVtcGxhdGUuY3NvbicpXG4gIGNvbnN0IHRlbXBsYXRlRmlsZSA9IGZzLnJlYWRGaWxlU3luYyh0ZW1wbGF0ZVBhdGgsICd1dGY4JylcbiAgZnMud3JpdGVGaWxlU3luYyhmaWxlUGF0aCwgdGVtcGxhdGVGaWxlKVxufVxuXG5mdW5jdGlvbiBjaGVja01hY3JvcyhtYWNyb3NPYmplY3Q6IG9iamVjdCkge1xuICBmb3IgKGNvbnN0IG5hbWUgaW4gbWFjcm9zT2JqZWN0KSB7XG4gICAgY29uc3QgdmFsdWUgPSBtYWNyb3NPYmplY3RbbmFtZV1cbiAgICBpZiAoIW5hbWUubWF0Y2gobmFtZVBhdHRlcm4pIHx8ICF2YWx1ZU1hdGNoZXNQYXR0ZXJuKHZhbHVlKSkge1xuICAgICAgZGVsZXRlIG1hY3Jvc09iamVjdFtuYW1lXVxuICAgICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgTGFUZVggbWFjcm8gbmFtZWQgJyR7bmFtZX0nLiBQbGVhc2Ugc2VlIHRoZSBbTGFUZVggZ3VpZGVdKGh0dHBzOi8vZ2l0aHViLmNvbS9HYWxhZGlyaXRoL21hcmtkb3duLXByZXZpZXctcGx1cy9ibG9iL21hc3Rlci9MQVRFWC5tZCNtYWNyby1uYW1lcylgLFxuICAgICAgICB7IGRpc21pc3NhYmxlOiB0cnVlIH0sXG4gICAgICApXG4gICAgfVxuICB9XG4gIHJldHVybiBtYWNyb3NPYmplY3Rcbn1cblxuZnVuY3Rpb24gdmFsdWVNYXRjaGVzUGF0dGVybih2YWx1ZTogYW55KSB7XG4gIC8vIERpZmZlcmVudCBjaGVjayBiYXNlZCBvbiB3aGV0aGVyIHZhbHVlIGlzIHN0cmluZyBvciBhcnJheVxuICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICBjb25zdCBtYWNyb0RlZmluaXRpb24gPSB2YWx1ZVswXVxuICAgIGNvbnN0IG51bWJlck9mQXJncyA9IHZhbHVlWzFdXG4gICAgaWYgKHR5cGVvZiBudW1iZXJPZkFyZ3MgPT09ICdudW1iZXInKSB7XG4gICAgICByZXR1cm4gbnVtYmVyT2ZBcmdzICUgMSA9PT0gMCAmJiB0eXBlb2YgbWFjcm9EZWZpbml0aW9uID09PSAnc3RyaW5nJ1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgIHJldHVybiB0cnVlXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cbn1cblxuLy8gQ29uZmlndXJlIE1hdGhKYXggZW52aXJvbm1lbnQuIFNpbWlsYXIgdG8gdGhlIFRlWC1BTVNfSFRNTCBjb25maWd1cmF0aW9uIHdpdGhcbi8vIGEgZmV3IHVubmVjZXNzYXJ5IGZlYXR1cmVzIHN0cmlwcGVkIGF3YXlcbi8vXG5jb25zdCBjb25maWd1cmVNYXRoSmF4ID0gZnVuY3Rpb24oKSB7XG4gIGxldCB1c2VyTWFjcm9zID0gbG9hZFVzZXJNYWNyb3MoKVxuICBpZiAodXNlck1hY3Jvcykge1xuICAgIHVzZXJNYWNyb3MgPSBjaGVja01hY3Jvcyh1c2VyTWFjcm9zKVxuICB9IGVsc2Uge1xuICAgIHVzZXJNYWNyb3MgPSB7fVxuICB9XG5cbiAgLy8gTm93IENvbmZpZ3VyZSBNYXRoSmF4XG4gIG1qQVBJLmNvbmZpZyh7XG4gICAgTWF0aEpheDoge1xuICAgICAgamF4OiBbJ2lucHV0L1RlWCcsICdvdXRwdXQvU1ZHJ10sXG4gICAgICBleHRlbnNpb25zOiBbXSxcbiAgICAgIFRlWDoge1xuICAgICAgICBleHRlbnNpb25zOiBbXG4gICAgICAgICAgJ0FNU21hdGguanMnLFxuICAgICAgICAgICdBTVNzeW1ib2xzLmpzJyxcbiAgICAgICAgICAnbm9FcnJvcnMuanMnLFxuICAgICAgICAgICdub1VuZGVmaW5lZC5qcycsXG4gICAgICAgIF0sXG4gICAgICAgIE1hY3JvczogdXNlck1hY3JvcyxcbiAgICAgIH0sXG4gICAgICBtZXNzYWdlU3R5bGU6ICdub25lJyxcbiAgICAgIHNob3dNYXRoTWVudTogZmFsc2UsXG4gICAgICAvLyBza2lwU3RhcnR1cFR5cGVzZXQ6IHRydWUsXG4gICAgfSxcbiAgfSlcblxuICAvLyBOb3RpZnkgdXNlciBNYXRoSmF4IGhhcyBsb2FkZWRcbiAgaWYgKGF0b20uaW5EZXZNb2RlKCkpIHtcbiAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcygnTG9hZGVkIG1hdGhzIHJlbmRlcmluZyBlbmdpbmUgTWF0aEpheCcpXG4gIH1cbn1cbiJdfQ==