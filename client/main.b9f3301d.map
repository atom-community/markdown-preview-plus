{"version":3,"sources":["util.ts","mathjax-helper.ts","update-preview.ts","../src/util-common.ts","main.ts"],"names":["Object","defineProperty","exports","value","getMedia","document","querySelectorAll"],"mappings":"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,ACYU,QEdwC,AHElD,aGFkD,AHElD,GGFkD,AHElD,SCaM,IDbN,CCaW,gBAAL,KAA0B,SAA1B,GAAsC,UAAtC,GAAmD,KAAK,gBADpD;AEbR,AHSF,ACMI,WEfK,QAAP,CAAgB,CFeT,GEfP,CAAqB,OAArB,CAA6B,IFe3B,GAAwB,CEf1B,SFeE;AEdF,AHSF,WGTS,QAAP,CAAgB,UAAhB,CAA2B,OAA3B,CAAmC,IFgBtB,GAAC,GEhBd;AACD,AHSD,ACOM,CEnBN,uBFmBY,OAAO,EAAE,iBAAf;AEdN,AHQA,ACOM,WEfN,WAAA,CAAY,CFeF,CEfV,AFeW,CEfsB,GFevB,IAAS,KAAK,IEfxB,EAAmD,EFehC,KAAkB,GEfe,IAAD,CFe7C,CEfoD,EAAP,EAAc;AHSjE,ACOM,QEhBsD,MAAA,GAAA,KFgBpD,UAAF,GAAe,UAAS,MAAT,EAAqB;AEfxC,AHSF,ACOQ,QEhBA,OAAO,SAAS,IFgBZ,SEhBG,CAAuB,SFgBP,UAAvB,CEhBO,CAAb,AFgByC,OAAO,KAAP;AEfzC,AHSF,ACOQ,QEhBF,CAAC,IAAL,EAAW,MAAM,IAAI,GFgBX,EEhBO,CAAU,IFgBV,QAAP,KAAoB,CEhBb,CAAN,IFgBL,EAAgC,OAAO,KAAP;AEftC,AHSF,ACOQ,QEhBA,CHSR,MGTe,IAAI,GAAJ,EAAb,EHSF,CAAwC,CCO1B,KAAK,CDPnB,EAAwD,GCOhD;AEfN,AFgBM,QEhBA,MAAM,IAAI,OAAJ,EAAZ,CFgBU,CAAC,GAAG,SAAH,CAAa,QAAb,CAAsB,MAAtB,CAAL,EAAoC,OAAO,KAAP;AEf1C,AFgBM,SEhBc,IAAA,KAAA,CAAA,EAAA,KAAA,EFgBR,KEhBe,CFgBT,GEhBE,AFgBC,CEhBW,GAAZ,CAApB,EAAoB,KAAA,CFgBF,CAAiB,CEhBf,MAApB,CFgBkB,CEhBE,AFgBd,IEhBN,EAAoC;AAA/B,AFiBC,YEjBK,QAAK,GAAA,EAAA,CAAX,EFiBK,CAAC,GAAL,EAAU,OAAO,KAAP;AEhBd,AHOI,ACUA,YEjBE,OAAO,CHOD,QGPU,CHOD,ECUV,EEjBE,EAAgB,CFiBb,CEjBH,CAAb,KHOY,CAAwB,CCUzB,KAAmB,I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","file":"main.b9f3301d.map","sourceRoot":"../src-client","sourcesContent":["export function handlePromise(promise: Promise<any>): void {\n  if (!promise) return\n  promise.catch((error: Error) => {\n    console.error(error)\n  })\n}\nimport { lstatSync, existsSync } from 'fs'\nexport function isFileSync(filePath: string) {\n  if (!existsSync(filePath)) return false\n  return lstatSync(filePath).isFile()\n}\n\nexport function resolveElement(\n  root: Element,\n  pathToToken: Array<{ tag: string; index: number }>,\n): Element | undefined {\n  let element = root\n  for (const token of pathToToken) {\n    const candidateElement: HTMLElement | null = element\n      .querySelectorAll(`:scope > ${token.tag}`)\n      .item(token.index) as HTMLElement\n    if (candidateElement) {\n      element = candidateElement\n    } else {\n      break\n    }\n  }\n\n  if (element === root) return undefined // Do not jump to the top of the preview for bad syncs\n  return element\n}\n","//\n// mathjax-helper\n//\n// This module will handle loading the MathJax environment and provide a wrapper\n// for calls to MathJax to process LaTeX equations.\n//\n\nimport path = require('path')\nimport CSON = require('season')\nimport fs = require('fs')\nimport { isFileSync } from './util'\n\nconst mjSrc = `${global.require.resolve(\n  'mathjax',\n)}?delayStartupUntil=configured`\nconst defaultRenderer: MathJaxRenderer = 'HTML-CSS'\n\n//\n// Process DOM elements for LaTeX equations with MathJax\n//\n// @param domElements An array of DOM elements to be processed by MathJax. See\n//   [element](https://developer.mozilla.org/en-US/docs/Web/API/element) for\n//   details on DOM elements.\n//\nexport async function mathProcessor(\n  domElement: Node,\n  renderer: MathJaxRenderer,\n) {\n  await loadMathJax()\n  await queueTypeset(domElement, renderer)\n}\n\n//\n// Process maths in HTML fragment with MathJax\n//\n// @param html A HTML fragment string\n// @param callback A callback method that accepts a single parameter, a HTML\n//   fragment string that is the result of html processed by MathJax\n//\nexport async function processHTMLString(element: Element) {\n  const msvgh = document.getElementById('MathJax_SVG_Hidden')\n  const svgGlyphs = msvgh && msvgh.parentElement\n  if (svgGlyphs !== null) {\n    return svgGlyphs.innerHTML + element.innerHTML\n  } else {\n    return element.innerHTML\n  }\n}\n\n//\n// Load MathJax environment\n//\n// @param listener method to call when the MathJax script was been\n//   loaded to the window. The method is passed no arguments.\n//\nlet mjPromise: Promise<void> | undefined\nasync function loadMathJax(): Promise<void> {\n  if (mjPromise) return mjPromise\n  mjPromise = attachMathJax()\n  return mjPromise\n}\n\n// for testing\nexport function unloadMathJax(): void {\n  mjPromise = undefined\n  const script = document.head.querySelector(`script[src='${mjSrc}']`)\n  if (script) script.remove()\n}\n\nexport async function jaxTeXConfig() {\n  let userMacros = await loadUserMacros()\n  if (userMacros) {\n    userMacros = checkMacros(userMacros)\n  } else {\n    userMacros = {}\n  }\n  const numberEqns = await window.atomVars.numberEqns\n\n  return {\n    extensions: [\n      'AMSmath.js',\n      'AMSsymbols.js',\n      'noErrors.js',\n      'noUndefined.js',\n    ],\n    Macros: userMacros,\n    equationNumbers: numberEqns\n      ? {\n          autoNumber: 'AMS',\n          useLabelIds: false,\n        }\n      : {},\n  }\n}\n\n// private\n\nasync function getUserMacrosPath(): Promise<string> {\n  const home = await window.atomVars.home\n  const userMacrosPath: string | undefined | null = CSON.resolve(\n    path.join(home, 'markdown-preview-plus'),\n  )\n  return userMacrosPath != null\n    ? userMacrosPath\n    : path.join(home, 'markdown-preview-plus.cson')\n}\n\nfunction loadMacrosFile(filePath: string): object {\n  if (!CSON.isObjectPath(filePath)) {\n    return {}\n  }\n  return CSON.readFileSync(filePath, function(error?: Error, object?: object) {\n    if (object === undefined) {\n      object = {}\n    }\n    if (error !== undefined) {\n      console.warn(\n        `Error reading Latex Macros file '${filePath}': ${\n          error.stack !== undefined ? error.stack : error\n        }`,\n      )\n      console.error(`Failed to load Latex Macros from '${filePath}'`, {\n        detail: error.message,\n        dismissable: true,\n      })\n    }\n    return object\n  })\n}\n\nasync function loadUserMacros() {\n  const userMacrosPath = await getUserMacrosPath()\n  if (isFileSync(userMacrosPath)) {\n    return loadMacrosFile(userMacrosPath)\n  } else {\n    console.debug(\n      'Creating markdown-preview-plus.cson, this is a one-time operation.',\n    )\n    createMacrosTemplate(userMacrosPath)\n    return loadMacrosFile(userMacrosPath)\n  }\n}\n\nfunction createMacrosTemplate(filePath: string) {\n  const templatePath = path.join(__dirname, '../assets/macros-template.cson')\n  const templateFile = fs.readFileSync(templatePath, 'utf8')\n  fs.writeFileSync(filePath, templateFile)\n}\n\nfunction checkMacros(macrosObject: object) {\n  const namePattern = /^[^a-zA-Z\\d\\s]$|^[a-zA-Z]*$/ // letters, but no numerals.\n  for (const name in macrosObject) {\n    const value = macrosObject[name]\n    if (!name.match(namePattern) || !valueMatchesPattern(value)) {\n      delete macrosObject[name]\n      console.error(\n        `Failed to load LaTeX macro named '${name}'. Please see the [LaTeX guide](https://github.com/atom-community/markdown-preview-plus/blob/master/docs/math.md#macro-names)`,\n      )\n    }\n  }\n  return macrosObject\n}\n\nfunction valueMatchesPattern(value: any) {\n  // Different check based on whether value is string or array\n  if (Array.isArray(value)) {\n    const macroDefinition = value[0]\n    const numberOfArgs = value[1]\n    if (typeof numberOfArgs === 'number') {\n      return numberOfArgs % 1 === 0 && typeof macroDefinition === 'string'\n    } else {\n      return false\n    }\n  } else if (typeof value === 'string') {\n    return true\n  } else {\n    return false\n  }\n}\n\n// Configure MathJax environment. Similar to the TeX-AMS_HTML configuration with\n// a few unnecessary features stripped away\n//\nasync function configureMathJax() {\n  MathJax.Hub.Config({\n    jax: ['input/TeX', `output/${defaultRenderer}`],\n    extensions: [],\n    TeX: await jaxTeXConfig(),\n    'HTML-CSS': {\n      availableFonts: [],\n      webFont: 'TeX',\n      imageFont: null as any, // TODO: complain on DT\n    },\n    messageStyle: 'none',\n    showMathMenu: false,\n    skipStartupTypeset: true,\n  })\n  MathJax.Hub.Configured()\n\n  // Notify user MathJax has loaded\n  console.log('Loaded maths rendering engine MathJax')\n}\n\n//\n// Attach main MathJax script to the document\n//\nasync function attachMathJax(): Promise<void> {\n  console.log('Loading maths rendering engine MathJax')\n\n  // Attach MathJax script\n  await Promise.all([injectScript(mjSrc)])\n  await configureMathJax()\n}\n\nasync function injectScript(scriptSrc: string) {\n  const script = document.createElement('script')\n  script.src = scriptSrc\n  script.type = 'text/javascript'\n  document.head.appendChild(script)\n  return new Promise<void>((resolve) => {\n    script.addEventListener('load', () => resolve())\n  })\n}\n\nasync function queueTypeset(domElement: Node, renderer: MathJaxRenderer) {\n  const hasUnprocessedMath = Array.from(\n    document.querySelectorAll('script[type^=\"math/tex\"]'),\n  ).some((x) => !x.id)\n  if (!hasUnprocessedMath) return\n  const numberEqns = await window.atomVars.numberEqns\n  return new Promise<void>((resolve) => {\n    if (MathJax.InputJax.TeX) {\n      MathJax.Hub.Queue(['resetEquationNumbers', MathJax.InputJax.TeX])\n      if (numberEqns) {\n        MathJax.Hub.Queue(['PreProcess', MathJax.Hub])\n        MathJax.Hub.Queue(['Reprocess', MathJax.Hub])\n      }\n    }\n\n    MathJax.Hub.Queue(['setRenderer', MathJax.Hub, renderer])\n    MathJax.Hub.Queue(['Typeset', MathJax.Hub, domElement])\n    MathJax.Hub.Queue(['setRenderer', MathJax.Hub, defaultRenderer])\n    MathJax.Hub.Queue([resolve])\n  })\n}\n","// This file incorporates code from [markmon](https://github.com/yyjhao/markmon)\n// covered by the following terms:\n//\n// Copyright (c) 2014, Yao Yujian, http://yjyao.com\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\nimport morph = require('morphdom')\nimport MathJaxHelper = require('./mathjax-helper')\n\nexport class UpdatePreview {\n  private cachedMJRenderer?: MathJaxRenderer\n  constructor(private dom: HTMLElement) {\n    /* no-op */\n  }\n\n  public async update(\n    newDom: Element,\n    renderLaTeX: boolean,\n    mjrenderer: MathJaxRenderer,\n  ): Promise<void> {\n    const lastMJRenderer =\n      this.cachedMJRenderer === undefined ? mjrenderer : this.cachedMJRenderer\n    this.cachedMJRenderer = mjrenderer\n\n    for (const m of Array.from(newDom.querySelectorAll('span.math'))) {\n      const mscr = m.firstElementChild as HTMLScriptElement | null\n      if (!mscr || mscr.nodeName !== 'SCRIPT') continue\n      m.isSameNode = function(target: Node) {\n        if (lastMJRenderer !== mjrenderer) return false\n        if (target.nodeName !== 'SPAN') return false\n        const el = target as HTMLSpanElement\n        if (!el.classList.contains('math')) return false\n        const scr = el.querySelector('script')\n        if (!scr) return false\n        return mscr.innerHTML === scr.innerHTML\n      }\n    }\n\n    morph(this.dom, newDom, {\n      childrenOnly: true,\n      onElUpdated: function(el) {\n        if (el.tagName === 'LI') el.innerHTML = el.innerHTML // force re-render\n      },\n    })\n\n    if (renderLaTeX) {\n      return MathJaxHelper.mathProcessor(this.dom, mjrenderer)\n    }\n  }\n}\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nfunction getMedia(document) {\n    return document.querySelectorAll('img[src],audio[src],video[src]');\n}\nexports.getMedia = getMedia;\n//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC1jb21tb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvdXRpbC1jb21tb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxrQkFBeUIsUUFBc0I7SUFDN0MsT0FBTyxRQUFRLENBQUMsZ0JBQWdCLENBQzlCLGdDQUFnQyxDQUNxQyxDQUFBO0FBQ3pFLENBQUM7QUFKRCw0QkFJQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBmdW5jdGlvbiBnZXRNZWRpYShkb2N1bWVudDogSFRNTERvY3VtZW50KSB7XG4gIHJldHVybiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFxuICAgICdpbWdbc3JjXSxhdWRpb1tzcmNdLHZpZGVvW3NyY10nLFxuICApIGFzIE5vZGVMaXN0T2Y8SFRNTEltYWdlRWxlbWVudCB8IEhUTUxBdWRpb0VsZW1lbnQgfCBIVE1MVmlkZW9FbGVtZW50PlxufVxuIl19","import { ipcRenderer } from 'electron'\nimport { UpdatePreview } from './update-preview'\nimport { processHTMLString, jaxTeXConfig } from './mathjax-helper'\nimport * as util from './util'\nimport { getMedia } from '../src/util-common'\n\nfunction mkResPromise<T>(): ResolvablePromise<T> {\n  let resFn: (value?: T | PromiseLike<T> | undefined) => void\n  const p = new Promise<T>((resolve) => (resFn = resolve)) as ResolvablePromise<\n    T\n  >\n  p.resolve = resFn!\n  return p\n}\n\nwindow.atomVars = {\n  home: mkResPromise(),\n  numberEqns: mkResPromise(),\n  sourceLineMap: new Map(),\n  revSourceMap: new WeakMap(),\n}\n\nipcRenderer.on<'init'>('init', (_evt, { atomHome, numberEqns }) => {\n  window.atomVars.home.resolve(atomHome)\n  window.atomVars.numberEqns.resolve(numberEqns)\n})\n\nipcRenderer.on<'set-source-map'>('set-source-map', (_evt, { map }) => {\n  const root = document.querySelector('div.update-preview')\n  if (!root) throw new Error('No root element!')\n  const slsm = new Map<number, Element>()\n  const rsm = new WeakMap<Element, number[]>()\n  for (const lineS of Object.keys(map)) {\n    const line = parseInt(lineS, 10)\n    const path = map[line]\n    const elem = util.resolveElement(root, path)\n    if (elem) {\n      slsm.set(line, elem)\n      const rsmel = rsm.get(elem)\n      if (rsmel) rsmel.push(line)\n      else rsm.set(elem, [line])\n    }\n  }\n  window.atomVars.sourceLineMap = slsm\n  window.atomVars.revSourceMap = rsm\n})\n\nipcRenderer.on<'scroll-sync'>(\n  'scroll-sync',\n  (_evt, { firstLine, lastLine }) => {\n    const mean = Math.floor(0.5 * (firstLine + lastLine))\n    const slm = window.atomVars.sourceLineMap\n    let topLine\n    let topBound\n    for (topLine = mean; topLine >= 0; topLine -= 1) {\n      topBound = slm.get(topLine)\n      if (topBound) break\n    }\n    if (!topBound) return\n\n    const max = Math.max(...Array.from(slm.keys()))\n    let bottomLine\n    let bottomBound\n    for (bottomLine = mean + 1; bottomLine < max; bottomLine += 1) {\n      bottomBound = slm.get(bottomLine)\n      if (bottomBound) break\n    }\n    if (!bottomBound) return\n    const topScroll = topBound.getBoundingClientRect().top\n    const bottomScroll = bottomBound.getBoundingClientRect().top\n    const frac = (mean - firstLine) / (lastLine - firstLine)\n    const offset = document.documentElement.scrollTop\n    const clientHeight = document.documentElement.clientHeight\n    const top =\n      offset - clientHeight / 2 + topScroll + frac * (bottomScroll - topScroll)\n    window.scroll({ top })\n  },\n)\n\nipcRenderer.on<'style'>('style', (_event, { styles }) => {\n  let styleElem = document.head.querySelector('style#atom-styles')\n  if (!styleElem) {\n    styleElem = document.createElement('style')\n    styleElem.id = 'atom-styles'\n    document.head.appendChild(styleElem)\n  }\n  styleElem.innerHTML = styles.join('\\n')\n})\n\nipcRenderer.on<'update-images'>('update-images', (_event, { oldsrc, v }) => {\n  const imgs = getMedia(document)\n  for (const img of Array.from(imgs)) {\n    let ovs: string | undefined\n    let ov: number | undefined\n    let src = img.getAttribute('src')!\n    const match = src.match(/^(.*)\\?v=(\\d+)$/)\n    if (match) [, src, ovs] = match\n    if (src === oldsrc) {\n      if (ovs !== undefined) ov = parseInt(ovs, 10)\n      if (v !== ov) img.src = v ? `${src}?v=${v}` : `${src}`\n    }\n  }\n})\n\nipcRenderer.on<'sync'>('sync', (_event, { line }) => {\n  const root = document.querySelector('div.update-preview')\n  if (!root) return\n\n  let element = window.atomVars.sourceLineMap.get(line)\n\n  if (!element) {\n    for (let i = line - 1; i >= 0; i -= 1) {\n      element = window.atomVars.sourceLineMap.get(line)\n      if (element) break\n    }\n  }\n\n  if (!element) return\n\n  element.scrollIntoViewIfNeeded(true)\n\n  element.classList.add('flash')\n  setTimeout(() => element!.classList.remove('flash'), 1000)\n})\n\nipcRenderer.on<'use-github-style'>('use-github-style', (_event, { value }) => {\n  const elem = document.querySelector('markdown-preview-plus-view')\n  if (!elem) throw new Error(`Can't find MPP-view`)\n  if (value) {\n    elem.setAttribute('data-use-github-style', '')\n  } else {\n    elem.removeAttribute('data-use-github-style')\n  }\n})\n\nlet updatePreview: UpdatePreview | undefined\n\nipcRenderer.on<'update-preview'>(\n  'update-preview',\n  (_event, { id, html, renderLaTeX, mjrenderer }) => {\n    // div.update-preview created after constructor st UpdatePreview cannot\n    // be instanced in the constructor\n    const preview = document.querySelector('div.update-preview')\n    if (!preview) return\n    if (!updatePreview) {\n      updatePreview = new UpdatePreview(preview as HTMLElement)\n    }\n    const parser = new DOMParser()\n    const domDocument = parser.parseFromString(html, 'text/html')\n    util.handlePromise(\n      updatePreview\n        .update(domDocument.body, renderLaTeX, mjrenderer)\n        .then(async () => {\n          ipcRenderer.sendToHost<'request-reply'>('request-reply', {\n            id,\n            request: 'update-preview',\n            result: await processHTMLString(preview),\n          })\n        }),\n    )\n    const doc = document\n    if (doc && domDocument.head.hasChildNodes) {\n      let container = doc.head.querySelector('original-elements')\n      if (!container) {\n        container = doc.createElement('original-elements')\n        doc.head.appendChild(container)\n      }\n      container.innerHTML = ''\n      for (const headElement of Array.from(domDocument.head.childNodes)) {\n        container.appendChild(headElement)\n      }\n    }\n  },\n)\n\nconst baseElement = document.createElement('base')\ndocument.head.appendChild(baseElement)\n\nipcRenderer.on<'set-base-path'>('set-base-path', (_evt, { path }) => {\n  if (path) baseElement.href = path\n  else baseElement.href = ''\n})\n\nipcRenderer.on<'error'>('error', (_evt, { msg }) => {\n  const preview = document.querySelector('div.update-preview')\n  if (!preview) return\n  const errorDiv = document.createElement('div')\n  errorDiv.innerHTML = `<h2>Previewing Markdown Failed</h2><h3>${msg}</h3>`\n  preview.appendChild(errorDiv)\n})\n\ndocument.addEventListener('mousewheel', (event) => {\n  if (event.ctrlKey) {\n    if (event.wheelDeltaY > 0) {\n      ipcRenderer.sendToHost<'zoom-in'>('zoom-in', undefined)\n    } else if (event.wheelDeltaY < 0) {\n      ipcRenderer.sendToHost<'zoom-out'>('zoom-out', undefined)\n    }\n    event.preventDefault()\n    event.stopPropagation()\n  }\n})\n\ndocument.addEventListener('scroll', (_event) => {\n  const el = document.documentElement\n  const height = el.clientHeight\n  const visible = Array.from(window.atomVars.sourceLineMap.entries())\n    .filter(([_line, elem]) => {\n      const { top, bottom } = elem.getBoundingClientRect()\n      return top > 0 && bottom < height\n    })\n    .map(([line, _elem]) => line)\n  ipcRenderer.sendToHost<'did-scroll-preview'>('did-scroll-preview', {\n    max: Math.max(...visible),\n    min: Math.min(...visible),\n  })\n})\n\nlet lastContextMenuTarget: HTMLElement\ndocument.addEventListener('contextmenu', (e) => {\n  lastContextMenuTarget = e.target as HTMLElement\n})\n\nipcRenderer.on<'sync-source'>('sync-source', (_, { id }) => {\n  let element = lastContextMenuTarget\n  const rsm = window.atomVars.revSourceMap\n  let lines = rsm.get(element)\n\n  while (!lines && element.parentElement) {\n    element = element.parentElement\n    lines = rsm.get(element)\n  }\n  if (!lines) return\n\n  ipcRenderer.sendToHost<'request-reply'>('request-reply', {\n    id,\n    request: 'sync-source',\n    result: Math.min(...lines),\n  })\n})\n\nipcRenderer.on<'reload'>('reload', (_, { id }) => {\n  window.onbeforeunload = null\n  ipcRenderer.sendToHost<'request-reply'>('request-reply', {\n    id,\n    request: 'reload',\n    result: undefined,\n  })\n})\n\nwindow.onbeforeunload = function() {\n  return false\n}\n\nipcRenderer.on<'get-tex-config'>('get-tex-config', async (_, { id }) => {\n  ipcRenderer.sendToHost<'request-reply'>('request-reply', {\n    id,\n    request: 'get-tex-config',\n    result: await jaxTeXConfig(),\n  })\n})\n"]}